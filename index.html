<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leave Booking System</title>
  <link rel="stylesheet" href="style.css?v=1.3.5">
</head>
<body>
  <h1>Leave Booking System</h1>
  <form id="leaveForm">
    <input type="text" id="staffName" placeholder="Name" required>
    <input type="text" id="staffID" placeholder="Staff ID" required>
    <input type="date" id="startDate" required>
    <input type="date" id="endDate" required>
    <button type="submit">Submit</button>
  </form>
  <div id="calendar"></div>
  <div id="adminSummary"></div>
  <footer>v1.3.5 - Mar 19, 2025</footer>
  <script>
    let leaveData = JSON.parse(localStorage.getItem('leaveData') || '[]');
    const calendar = document.getElementById('calendar');
    const summary = document.getElementById('adminSummary');

    function renderCalendar() {
      calendar.innerHTML = '';
      let dateMap = {};
      leaveData.forEach((req, i) => {
        let d = new Date(req.start);
        let end = new Date(req.end);
        while (d <= end) {
          const k = d.toISOString().split('T')[0];
          if (!dateMap[k]) dateMap[k] = [];
          dateMap[k].push({...req, index: i});
          d.setDate(d.getDate() + 1);
        }
      });

      Object.entries(dateMap).forEach(([date, entries]) => {
        const div = document.createElement('div');
        div.className = 'date-block';
        if (entries.filter(e => e.status !== 'Rejected').length > 2) {
          div.innerHTML += '<span class="red-dot"></span>';
        }
        div.innerHTML += `<strong>${date}</strong>`;
        entries.forEach(e => {
          let cls = e.status.toLowerCase();
          let style = cls === 'rejected' ? 'class="rejected"' :
                      cls === 'approved' ? 'class="approved"' : 'class="pending"';
          div.innerHTML += `<div ${style}>${e.name} (${e.id})</div>`;
        });
        calendar.appendChild(div);
      });
    }

    function renderSummary() {
      summary.innerHTML = '<h3>Admin Panel</h3>';
      leaveData.forEach((e, i) => {
        const div = document.createElement('div');
        div.className = 'admin-card';
        div.innerHTML = `
          <b>${e.name}</b> (${e.id})<br>
          ${e.start} to ${e.end} |
          <select data-index="${i}">
            <option ${e.status==='Pending'?'selected':''}>Pending</option>
            <option ${e.status==='Approved'?'selected':''}>Approved</option>
            <option ${e.status==='Rejected'?'selected':''}>Rejected</option>
          </select>
        `;
        summary.appendChild(div);
      });
      document.querySelectorAll('select').forEach(sel => {
        sel.onchange = () => {
          leaveData[sel.dataset.index].status = sel.value;
          localStorage.setItem('leaveData', JSON.stringify(leaveData));
          renderCalendar(); renderSummary();
        };
      });
    }

    document.getElementById('leaveForm').onsubmit = (e) => {
      e.preventDefault();
      const name = document.getElementById('staffName').value;
      const id = document.getElementById('staffID').value;
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      if (!name || !id || !start || !end) return alert("All fields required");
      leaveData.push({ name, id, start, end, status: 'Pending' });
      localStorage.setItem('leaveData', JSON.stringify(leaveData));
      renderCalendar(); renderSummary();
      e.target.reset();
    }

    renderCalendar();
    renderSummary();
  </script>
</body>
</html>
