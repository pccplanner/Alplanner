
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <title>Leave & Roster Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Optional: Include jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Base Styles */
    body {
      font-family: Arial, sans-serif; 
      font-size: 13px; 
    }
    
    /* Custom styles for leave entries (from original) */
    .leave-entry.pending   { background: #fff3cd; }
    .leave-entry.approved  { background: #d4edda; font-weight: 600; }
    .leave-entry.rejected  { background: #f8d7da; color: #721c24; text-decoration: line-through; }
    /* MODIFICATION: Changed write-in color from #ffeeba to light purple */
    .leave-entry.write-in  { background: #e9d5ff; } 
    
    /* Custom styles for accordion summary */
    .status-dot.pending   { background: #e67e22; }
    .status-dot.approved  { background: #27ae60; }
    .status-dot.rejected  { background: #e74c3c; }
    /* MODIFICATION: Changed write-in color from #f1c40f to purple */
    .status-dot.write-in  { background: #9333ea; } 

    /* Custom styles for summary table */
    .range-block.approved  .status-dot { background: #27ae60; }
    .range-block.pending   .status-dot { background: #e67e22; }
    .range-block.rejected  .status-dot { background: #e74c3c; }
    /* MODIFICATION: Changed write-in color from #f1c40f to purple */
    .range-block.write-in  .status-dot { background: #9333ea; } 

    /* Hide spinners on number inputs */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    /* Team Management Modal Styles */
    .team-li:hover .edit-team-btn { opacity: 1; }
    .modal-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    
    /* UPDATED: Main Nav Tab Styling */
    .main-nav-button {
      display: inline-block;
      padding: 0.5rem 1rem; /* py-2 px-4 */
      border-radius: 9999px; /* rounded-full */
      font-weight: 500; /* font-medium */
      font-size: 0.875rem; /* text-sm */
      transition: all 0.2s ease-in-out;
      white-space: nowrap;
      border: none;
      cursor: pointer;
    }
    .main-nav-button:not(.active-tab) {
      background-color: #f3f4f6; /* bg-gray-100 */
      color: #4b5563; /* text-gray-600 */
    }
    .main-nav-button:not(.active-tab):hover {
      background-color: #e5e7eb; /* bg-gray-200 */
      color: #1f2937; /* text-gray-800 */
    }
    .main-nav-button.active-tab {
      background-color: #2563eb; /* bg-blue-600 */
      color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
    }

    /* NEW: Animation for Leave Freeze dates */
    @keyframes stripes {
        from { background-position: 0 0; }
        to { background-position: 40px 0; }
    }
    .bg-stripes {
        background-image: repeating-linear-gradient(-45deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.1) 10px, transparent 10px, transparent 20px);
        animation: stripes 1s linear infinite;
    }
  </style>
</head>
<body class="bg-white min-h-screen p-0 md:p-4">

  <!-- LOADING SPINNER -->
  <div id="loading" class="absolute inset-0 bg-gray-100/80 flex flex-col items-center justify-center z-[100]" style="display: flex;">
    <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-4 text-lg font-semibold text-gray-700">Loading Planner...</p>
  </div>

  <!-- LOGIN SECTION -->
  <div id="loginSection" class="max-w-md w-full bg-white p-6 rounded-lg shadow-md min-h-[calc(100vh-2rem)] mx-auto flex flex-col justify-center" style="display: none;">
    <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Leave Planner Login</h2>
    
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="password" id="loginPassword" placeholder="Password" class="w-full px-4 py-2 mb-4 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <button id="loginButton" type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">Login</button>
      <button onclick="showRegisterForm()" type="button" class="w-full mt-2 text-blue-600 hover:underline">Don't have an account? Register</button>
    </form>
    
    <form id="userRegisterForm" style="display: none;">
      <input type="text" id="regUsername" placeholder="Full Name (e.g., John Doe)" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="text" id="regStaffID" placeholder="Staff ID (e.g., S999)" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="tel" id="regMobile" placeholder="Mobile Number (e.g. +6512345678)" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="email" id="regEmail" placeholder="Email" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="password" id="regPassword" placeholder="Password" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <select id="regTeam" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        <option value="">Select a team...</option>
      </select>
      
      <!-- NEW: Leave Balance Inputs -->
      <div class="grid grid-cols-2 gap-3 mb-3">
        <input type="number" id="regAnnualLeave" placeholder="Allocated Annual Leave" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" step="0.5">
        <input type="number" id="regPublicHoliday" placeholder="Earned Public Holidays" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" step="0.5">
      </div>
      
      <input type="password" id="regAdminSecret" placeholder="Admin Secret Code (if any)" class="w-full px-4 py-2 mb-4 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button id="registerButton" type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition-colors">Register</button>
      <button onclick="showLoginForm()" type="button" class="w-full mt-2 text-blue-600 hover:underline">Already have an account? Login</button>
    </form>

    <!-- Custom Alert Box -->
    <div id="customAlert" class="fixed top-5 right-5 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg" style="display: none; z-index: 1000;">
      <span id="customAlertMessage"></span>
    </div>

  </div>
  
  <!-- Main Container (hidden until login) -->
  <div class="container max-w-7xl w-full mx-auto bg-white p-4 rounded-lg shadow-lg min-h-[calc(100vh-2rem)]" style="display: none;">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800">Leave & Roster System <sup class="text-xs text-blue-500">v14.6 ID Fix</sup></h1>
      <button id="logoutButton" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors text-sm">Logout</button>
    </div>
    <div class="text-sm text-gray-600 mb-2">Logged in as: <span id="currentUserDisplay" class="font-semibold"></span></div>
    
    <!-- TABS -->
    <div id="mainTabs" class="mb-4">
      <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap pb-2">
        <button onclick="showMyProfile()" class="main-nav-button">My Profile</button>
        <button onclick="showLeaveManagement()" class="main-nav-button active-tab">Leave Management</button>
        <button id="tab-leave-balances" onclick="showLeaveBalanceReport()" class="main-nav-button" style="display: none;">Leave Balances</button>
        <button id="tab-user-mgmt" onclick="showUserManagement()" class="main-nav-button" style="display: none;">User Management</button>
        <button id="tab-team-mgmt" onclick="showTeamManagement()" class="main-nav-button" style="display: none;">Team Management</button>
        <!-- NEW: Leave Freeze Tab -->
        <button id="tab-leave-freeze" onclick="showLeaveFreeze()" class="main-nav-button" style="display: none;">Leave Freeze</button>
        <!-- NEW: Staff History Tab -->
        <button id="tab-staff-history" onclick="showStaffHistory()" class="main-nav-button" style="display: none;">Staff History</button>
      </nav>
    </div>
    
    <!-- My Profile Panel (All Users) -->
    <div id="myProfilePanel" class="p-4" style="display: none;">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">My Profile & Leave Balances</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
            
            <!-- Profile Details -->
            <div class="bg-gray-50 p-4 rounded-lg border">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">My Details</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="profileName" class="w-full px-3 py-2 mt-1 border rounded-md bg-gray-200" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Staff ID</label>
                        <input type="text" id="profileStaffID" class="w-full px-3 py-2 mt-1 border rounded-md bg-gray-200" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="text" id="profileEmail" class="w-full px-3 py-2 mt-1 border rounded-md bg-gray-200" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Team</label>
                        <input type="text" id="profileTeam" class="w-full px-3 py-2 mt-1 border rounded-md bg-gray-200" readonly>
                    </div>
                </div>
            </div>
            
            <!-- Leave Balances -->
            <div class="bg-gray-50 p-4 rounded-lg border">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">My Leave Balances</h3>
                <form id="profileLeaveForm" class="space-y-4">
                    <!-- Annual Leave -->
                    <div>
                        <label for="profileAnnualLeave" class="block text-sm font-medium text-gray-700">Allocated Annual Leave (Days)</label>
                        <input type="number" id="profileAnnualLeave" min="0" step="0.5" class="w-full px-3 py-2 mt-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex justify-between text-sm mt-2 p-2 bg-white rounded border">
                            <span>Used: <strong id="profileUsedAL" class="text-red-600">0</strong></span>
                            <span>Balance: <strong id="profileBalanceAL" class="text-green-700">0</strong></span>
                        </div>
                    </div>
                    
                    <!-- Public Holidays -->
                    <div>
                        <label for="profilePublicHoliday" class="block text-sm font-medium text-gray-700">Earned Public Holidays (Days)</label>
                        <input type="number" id="profilePublicHoliday" min="0" step="0.5" class="w-full px-3 py-2 mt-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                         <div class="flex justify-between text-sm mt-2 p-2 bg-white rounded border">
                            <span>Used: <strong id="profileUsedPH" class="text-red-600">0</strong></span>
                            <span>Balance: <strong id="profileBalancePH" class="text-green-700">0</strong></span>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">Save Balance Allocations</button>
                    <div id="profileSaveStatus" class="text-center text-green-600 h-4"></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Leave Management Panel -->
    <div id="leaveManagementPanel" style="display: block;">
      <!-- Leave Form -->
      <form id="leaveForm" class="grid grid-cols-1 md:grid-cols-6 items-center gap-3 p-4 bg-gray-50 rounded-lg mb-4">
        <div class="md:col-span-2">
            <label class="font-semibold text-gray-700 text-sm">Name:</label>
            <input type="text" id="staffName" placeholder="Enter full name" class="w-full px-3 py-1.5 border rounded-md" required readonly>
        </div>
        <div>
            <label class="font-semibold text-gray-700 text-sm">ID:</label>
            <input type="text" id="staffID" placeholder="e.g., S123" class="w-full px-3 py-1.5 border rounded-md" required readonly>
        </div>
        <div>
            <label class="font-semibold text-gray-700 text-sm">From:</label>
            <input type="date" id="startDate" class="w-full px-3 py-1.5 border rounded-md" required>
        </div>
        <div>
            <label class="font-semibold text-gray-700 text-sm">To:</label>
            <input type="date" id="endDate" class="w-full px-3 py-1.5 border rounded-md" required>
        </div>
        <div class="md:col-span-2">
            <label class="font-semibold text-gray-700 text-sm">Leave Type:</label>
            <select id="leaveType" class="w-full px-3 py-1.5 border rounded-md" required>
                <option value="Annual Leave">Annual Leave</option>
                <option value="Public Holiday">Public Holiday</option>
            </select>
        </div>
        <button type="submit" class="md:col-span-4 bg-blue-600 text-white px-4 py-1.5 rounded-md hover:bg-blue-700 transition-colors">Submit Leave Request</button>
      </form>
      
      <!-- Calendar View Toggle -->
      <div class="flex justify-center items-center mb-4 p-2 bg-white rounded-lg border shadow-sm max-w-lg mx-auto">
          <span class="text-sm font-medium text-gray-700 mr-4 whitespace-nowrap">Calendar View:</span>
          <div id="viewToggle" class="flex p-1 rounded-full bg-gray-200 w-full max-w-xs">
              <button id="personalViewBtn" onclick="setCalendarView('personal')" class="flex-1 px-4 py-1.5 text-sm font-semibold rounded-full transition-colors bg-blue-600 text-white shadow-md">
                  My Calendar
              </button>
              <button id="masterViewBtn" onclick="setCalendarView('master')" class="flex-1 px-4 py-1.5 text-sm font-semibold rounded-full transition-colors text-gray-700 hover:bg-gray-300">
                  Master View
              </button>
          </div>
      </div>
      
      <!-- NEW: JSON Smart Import Section (Admin Only) -->
      <div id="importSection" class="p-4 rounded-lg bg-indigo-50 border border-indigo-200 mb-4 max-w-3xl mx-auto" style="display: none;">
        <h3 class="text-lg font-bold mb-2 text-indigo-800 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            Smart Import Leave Data
        </h3>
        <p class="text-xs text-indigo-600 mb-3">
            <b>Advanced Processing:</b> Select the <b>Year</b> and <b>Month</b>. The system will <b>DELETE existing entries</b> for that specific range only, then import new data. 
            <br><b>Note:</b> Block leave requests in your JSON file will be automatically split into individual daily entries.
        </p>
        
        <div class="flex flex-col sm:flex-row gap-3 items-center bg-white p-3 rounded border border-indigo-100">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <label for="importYear" class="text-sm font-bold text-gray-700">Year:</label>
                <input type="number" id="importYear" class="border rounded px-2 py-1 w-20 text-center font-semibold" value="2026" min="2024" max="2030">
            </div>
            
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <label for="importMonth" class="text-sm font-bold text-gray-700">Month:</label>
                <select id="importMonth" class="border rounded px-2 py-1 font-semibold text-gray-700">
                    <option value="all">All Months</option>
                    <option value="1" selected>January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            
            <div class="w-full h-px bg-gray-200 sm:w-px sm:h-8"></div>

            <input type="file" id="jsonImportInput" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 cursor-pointer"/>
            
            <button id="triggerImportBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 text-sm font-semibold whitespace-nowrap shadow-sm">
                Clear & Import
            </button>
        </div>
      </div>

      <!-- Team Buttons -->
      <div id="team-buttons" class="team-buttons text-center my-3 space-x-2">
        <!-- Buttons populated by JS -->
      </div>
      
      <!-- Month Navigation -->
      <div class="month-nav flex justify-center items-center gap-4 my-3">
        <button onclick="prevMonth()" class="bg-gray-600 text-white px-3 py-1 rounded-md hover:bg-gray-700">←</button>
        <span id="monthLabel" class="font-bold text-lg text-gray-800">Loading...</span>
        <button onclick="nextMonth()" class="bg-gray-600 text-white px-3 py-1 rounded-md hover:bg-gray-700">→</button>
      </div>
      
      <!-- Calendar Container -->
      <div id="calendarGrid" class="grid grid-cols-7 gap-1 max-w-6xl mx-auto mb-4"></div>
      
      <!-- Leave Requests Accordion View -->
      <div id="adminSummary" class="p-4 rounded-lg bg-white border max-h-96 overflow-y-auto">
        <h3 class="text-lg font-semibold mb-3 text-gray-800">Leave Requests</h3>
        <div id="adminList" class="space-y-2"></div>
      </div>
      
      <!-- Monthly Summary (Admin Only) -->
      <div id="monthlySummary" class="p-4 rounded-lg bg-white border mt-6" style="display: none;">
        <h3 class="text-lg font-semibold mb-3 text-gray-800 flex justify-between items-center">
          Monthly Leave Summary
          <button class="download-btn bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 text-sm" onclick="downloadSummaryPDF()">Download PDF</button>
        </h3>
        <table class="summary-table w-full border-collapse text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2 text-left font-semibold text-gray-700 border-b" style="width: 30%;">Staff & Leave Type</th>
              <th class="p-2 text-left font-semibold text-gray-700 border-b" style="width: 50%;">Leave Dates</th>
              <th class="p-2 text-left font-semibold text-gray-700 border-b" style="width: 20%;">Total Days</th>
            </tr>
          </thead>
          <tbody id="summaryTableBody"></tbody>
        </table>
      </div>
    </div>
    
    <!-- Leave Balance Report Panel (Admin Only) -->
    <div id="leaveBalancePanel" class="p-4" style="display: none;">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Leave Balance Report</h2>
      <div class="overflow-x-auto">
        <table id="leaveBalanceTable" class="min-w-full bg-white border rounded-lg">
          <thead>
            <tr class="bg-gray-100">
              <th rowspan="2" class="p-3 text-left font-semibold text-gray-700 align-middle border-b border-gray-200">Staff</th>
              <th rowspan="2" class="p-3 text-left font-semibold text-gray-700 align-middle border-b border-gray-200">Team</th>
              <th colspan="3" class="p-3 text-center font-semibold text-blue-800 bg-blue-100 border-b border-blue-200">Annual Leave (AL)</th>
              <th colspan="3" class="p-3 text-center font-semibold text-purple-800 bg-purple-100 border-b border-purple-200">Public Holiday (PH)</th>
            </tr>
            <tr class="bg-gray-100">
              <th class="p-3 text-center font-semibold text-gray-700 border-b border-gray-200">Alloc.</th>
              <th class="p-3 text-center font-semibold text-gray-700 border-b border-gray-200">Used</th>
              <th class="p-3 text-center font-semibold text-blue-800 bg-blue-50 border-b border-gray-200">Balance</th>
              <th class="p-3 text-center font-semibold text-gray-700 border-b border-gray-200">Alloc.</th>
              <th class="p-3 text-center font-semibold text-gray-700 border-b border-gray-200">Used</th>
              <th class="p-3 text-center font-semibold text-purple-800 bg-purple-50 border-b border-gray-200">Balance</th>
            </tr>
          </thead>
          <tbody id="leaveBalanceTableBody">
            <!-- Dynamically inserted rows -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- User Management Panel (Admin Only) -->
    <div id="userManagementPanel" class="p-4" style="display: none;">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">User Management</h2>
      <p class="text-center text-gray-600 mb-4">Users who register will appear here. You can then grant them admin status.</p>
      <div class="overflow-x-auto">
        <table id="usersTable" class="min-w-full bg-white border rounded-lg">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-3 text-left font-semibold text-gray-700">Username</th>
              <th class="p-3 text-left font-semibold text-gray-700">Staff ID</th>
              <th class="p-3 text-left font-semibold text-gray-700">Mobile</th>
              <th class="p-3 text-left font-semibold text-gray-700">Email</th>
              <th class="p-3 text-left font-semibold text-gray-700">Team</th>
              <th class="p-3 text-left font-semibold text-gray-700">Admin</th>
              <th class="p-3 text-left font-semibold text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamically inserted rows -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Team Management Panel (Admin Only) -->
    <div id="teamManagementPanel" class="p-4" style="display: none;">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Team Management</h2>
      
      <div class="mb-6 max-w-md mx-auto">
        <h4 class="text-lg font-medium text-gray-800 mb-2">Add New Team</h4>
        <form id="add-team-form" class="flex space-x-2">
            <input type="text" id="new-team-name" class="flex-1 block w-full rounded-lg border-gray-300 shadow-sm" placeholder="New team name" required>
            <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">Add</button>
        </form>
        <div id="add-team-error" class="text-red-600 text-sm mt-1 h-4"></div>
      </div>
      
      <div class="max-w-md mx-auto">
        <h4 class="text-lg font-medium text-gray-800 mb-2">Current Teams</h4>
        <div id="delete-team-error" class="text-red-600 text-sm mb-2 h-4"></div>
        <ul id="team-list-ul" class="divide-y divide-gray-200 h-64 overflow-y-auto border rounded-lg p-2 bg-gray-50">
            <!-- Team list populated by JS -->
        </ul>
      </div>
    </div>

    <!-- Leave Freeze Panel (Admin Only) -->
    <div id="leaveFreezePanel" class="p-4" style="display: none;">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Leave Freeze Management</h2>
      <div class="mb-6 max-w-md mx-auto">
        <h4 class="text-lg font-medium text-gray-800 mb-2">Add Freeze Range</h4>
        <form id="add-freeze-date-form" class="grid grid-cols-1 sm:grid-cols-5 gap-2 items-end">
          <div class="sm:col-span-1">
            <label class="block text-xs font-semibold text-gray-600 mb-1">Start Date</label>
            <input type="date" id="freeze-start-date-input" class="block w-full rounded-lg border-gray-300 shadow-sm" required>
          </div>

          <div class="sm:col-span-1">
            <label class="block text-xs font-semibold text-gray-600 mb-1">End Date</label>
            <input type="date" id="freeze-end-date-input" class="block w-full rounded-lg border-gray-300 shadow-sm">
          </div>

          <div class="sm:col-span-1">
            <label class="block text-xs font-semibold text-gray-600 mb-1">Type</label>
            <select id="freeze-type-input" class="block w-full rounded-lg border-gray-300 shadow-sm" required>
              <option value="Event">Event</option>
              <option value="Festive">Festive</option>
            </select>
          </div>

          <div class="sm:col-span-1">
            <label class="block text-xs font-semibold text-gray-600 mb-1">Reason</label>
            <input type="text" id="freeze-reason-input" class="block w-full rounded-lg border-gray-300 shadow-sm" placeholder="e.g., Deepavali / Training Day">
          </div>

          <button type="submit" class="sm:col-span-1 px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">Add Range</button>
        </form>
      </div>
      
      <div class="max-w-md mx-auto">
        <h4 class="text-lg font-medium text-gray-800 mb-2">Current Frozen Dates</h4>
        <ul id="freeze-date-list" class="divide-y divide-gray-200 h-64 overflow-y-auto border rounded-lg p-2 bg-gray-50">
            <!-- Frozen dates populated by JS -->
        </ul>
      </div>
    </div>
    
    <!-- NEW: Staff History Panel (Admin Only) -->
    <div id="staffHistoryPanel" class="p-4" style="display: none;">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Staff Leave History</h2>
      <div class="max-w-5xl mx-auto bg-white p-6 rounded-lg border shadow-sm">
        
<div class="mb-6 space-y-3">
            <label class="block text-sm font-bold text-gray-700">Select Staff & Date Range</label>

            <div class="flex flex-col md:flex-row gap-2">
                <select id="historyStaffSelect" class="w-full md:w-1/2 p-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 bg-gray-50">
                    <option value="">-- Select a Staff Member --</option>
                </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-end">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">From</label>
                    <input type="date" id="historyFromDate" class="block w-full rounded-lg border-gray-300 shadow-sm" />
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">To</label>
                    <input type="date" id="historyToDate" class="block w-full rounded-lg border-gray-300 shadow-sm" />
                </div>
                <button id="historyGenerateBtn" type="button" class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Generate
                </button>
                <button id="historyDownloadBtn" type="button" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Download PDF
                </button>
            </div>

            <p class="text-xs text-gray-500">1) Select a staff member. 2) Pick a date range. 3) Click <b>Generate</b> to view history.</p>
            <!-- Display the selected staff name and ID above the history table -->
            <h3 id="historyStaffLabel" class="text-lg font-semibold text-gray-800 mb-2"></h3>
        </div>

        <div class="overflow-hidden border rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-32">Leave Type</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-40">Date Range</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider w-20">Days</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider w-32">Status Overview</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Details</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                    <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500 italic">Select a staff member above to view history.</td></tr>
                </tbody>
            </table>
        </div>
      </div>
    </div>

    <div class="footer text-center text-xs text-gray-500 mt-6">
      @ 2025; t’va (Leave/Roster)
    </div>
  </div>
  
  <!-- PDF Viewer Modal (hidden by default) -->
  <div id="pdfViewerContainer" class="fixed inset-0 bg-black/80 z-50 p-10" style="display: none;">
    <div class="relative w-full h-full bg-white rounded-lg overflow-hidden">
      <iframe id="pdfViewerFrame" style="width: 100%; height: 100%; border: none;"></iframe>
      <button id="exitPDFViewer" class="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Exit</button>
    </div>
  </div>
  
  <!-- Edit Team Modal -->
  <div id="edit-team-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start z-50 hidden p-4 overflow-y-auto">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl modal-fade-in">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Edit Team & Pattern</h3>
            <button id="close-edit-team-modal" class="text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <form id="edit-team-form">
            <input type="hidden" id="edit-team-id">
            <div class="space-y-4">
                <div>
                    <label for="edit-team-name" class="block text-sm font-medium text-gray-700">Team Name</label>
                    <input type="text" id="edit-team-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-team-pattern-length" class="block text-sm font-medium text-gray-700">Pattern Length</label>
                        <input type="number" id="edit-team-pattern-length" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" min="1" max="31" value="6">
                    </div>
                    <div>
                        <label for="edit-team-anchor-date" class="block text-sm font-medium text-gray-700">Pattern Anchor Date</label>
                        <input type="date" id="edit-team-anchor-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" required>
                        <p class="mt-1 text-xs text-gray-500">The "Day 1" of the rotation.</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Visual Pattern</label>
                    <p class="mt-1 text-xs text-gray-500">Click the cells below to set the repeating pattern.</p>
                    <div id="visual-pattern-cells" class="mt-2 flex flex-wrap gap-2 p-3 bg-gray-50 rounded-lg border">
                    </div>
                </div>
                <div id="edit-team-error" class="text-red-600 text-sm h-4"></div>
                <div class="text-right">
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
  </div>

  <!-- Shift Selector Modal (for Pattern Builder) -->
  <div id="pattern-shift-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-start z-[60] hidden p-4 overflow-y-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md modal-fade-in">
          <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold">Set Pattern Shift</h3>
              <button id="close-pattern-modal" class="text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
          </div>
          <p class="mb-4 text-gray-600">Select shift for <strong id="pattern-modal-day">Day X</strong> of the pattern.</p>
          <div id="pattern-shift-options" class="grid grid-cols-4 gap-3"></div>
      </div>
  </div>
  
  <!-- Delete Team Confirmation Modal -->
  <div id="delete-team-confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] hidden">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
          <h3 class="text-xl font-semibold text-red-700">Confirm Team Deletion</h3>
          <p class="my-4 text-gray-600">Are you sure you want to delete <strong id="delete-team-modal-name"></strong>?</p>
          <div id="delete-team-warning" class="my-4 text-red-600 text-sm font-medium"></div>
          <div class="flex justify-end space-x-3">
              <button id="cancel-delete-team-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
              <button id="confirm-delete-team-btn" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm Delete</button>
          </div>
      </div>
  </div>

  <!-- Leave Freeze Confirmation Modal -->
  <div id="freezeConfirmModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] hidden">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
          <h3 class="text-xl font-semibold text-yellow-700">Leave Freeze Warning</h3>
          <p class="my-4 text-gray-600">One or more dates in your selection are frozen. Do you want to proceed by submitting this request as a **Write-in**?</p>
          <div class="flex justify-end space-x-3">
              <button id="freezeCancelBtn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
              <button id="freezeProceedBtn" class="px-5 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">Proceed as Write-in</button>
          </div>
      </div>
  </div>

  <!-- User Delete Confirmation Modal -->
  <div id="userDeleteConfirmModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] hidden">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
          <h3 class="text-xl font-semibold text-red-700">Confirm Deletion</h3>
          <p class="my-4 text-gray-600">Are you sure you want to delete this pending leave request?</p>
          <p id="user-delete-request-info" class="my-4 text-gray-800 font-semibold"></p>
          <div class="flex justify-end space-x-3">
              <button id="cancel-user-delete-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
              <button id="confirm-user-delete-btn" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm Delete</button>
          </div>
      </div>
  </div>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      sendPasswordResetEmail,
      signInAnonymously,
      signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      setDoc, 
      addDoc, 
      updateDoc, 
      deleteDoc, 
      onSnapshot, 
      collection, 
      query, 
      where,
      writeBatch,
      setLogLevel,
      deleteField,
      getDocs // Added for advanced import logic
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- !! IMPORTANT !! ---
    const ADMIN_SECRET_KEY = "ADMIN2025";
    const defaultPattern = ['1', '1', '2', '2', 'OFF', 'OFF'];
    const patternAnchorDate = '2025-01-01'; // Default anchor date
    
    const teamColorPalette = [
        { dot: 'bg-blue-500', btn: 'bg-blue-100 text-blue-700', selected: 'bg-blue-500 text-white' },
        { dot: 'bg-green-500', btn: 'bg-green-100 text-green-700', selected: 'bg-green-500 text-white' },
        { dot: 'bg-indigo-500', btn: 'bg-indigo-100 text-indigo-700', selected: 'bg-indigo-500 text-white' },
        { dot: 'bg-pink-500', btn: 'bg-pink-100 text-pink-700', selected: 'bg-pink-500 text-white' },
        { dot: 'bg-yellow-500', btn: 'bg-yellow-100 text-yellow-700', selected: 'bg-yellow-500 text-white' },
        { dot: 'bg-purple-500', btn: 'bg-purple-100 text-purple-700', selected: 'bg-purple-500 text-white' },
        { dot: 'bg-red-500', btn: 'bg-red-100 text-red-700', selected: 'bg-red-500 text-white' },
        { dot: 'bg-cyan-500', btn: 'bg-cyan-100 text-cyan-700', selected: 'bg-cyan-500 text-white' },
        { dot: 'bg-gray-500', btn: 'bg-gray-100 text-gray-700', selected: 'bg-gray-500 text-white' },
        { dot: 'bg-orange-500', btn: 'bg-orange-100 text-orange-700', selected: 'bg-orange-500 text-white' }
    ];


    // --- Firebase Configuration ---
    let firebaseConfig;
    if (typeof __firebase_config !== 'undefined') {
      firebaseConfig = JSON.parse(__firebase_config);
      console.log("Using provided __firebase_config.");
    } else {
      // Fallback config ('apo-leave-planner')
      firebaseConfig = {
        apiKey: "AIzaSyBtMiev72-UUyL8NEFk0bSIDAGJskU4Dj4",
        authDomain: "apo-leave-planner.firebaseapp.com",
        projectId: "apo-leave-planner",
        storageBucket: "apo-leave-planner.firebasestorage.app",
        messagingSenderId: "240953713168",
        appId: "1:240953713168:web:61ff4cd347c2a3ce4aa095",
        measurementId: "G-NX0TJPK0Q3"
      };
      console.warn("Using fallback Firebase config (apo-leave-planner). __firebase_config not found.");
    }

    // --- App & Auth Initialization ---
    let app, auth, db;
    let userType = null; // "admin" or "user"
    let currentUserProfile = null; // Store user's firestore doc
    let leaveRequestsCollectionPath;
    let usersCollectionPath;
    let teamsCollectionPath; 
    let leaveFreezeCollectionPath; 

    // --- Global State Variables ---
    let selectedTeamId = null; 
    let now = new Date();
    var currentYear = now.getFullYear();
    var currentMonth = now.getMonth();
    var referenceDate = new Date(currentYear, currentMonth, 1);
    var requests = []; 
    var allUsers = []; 
    var teamsMap = new Map(); 
    var tempPatternArray = []; 
    var teamIdToDelete = null; 
    var openAccordions = new Set();
    var leaveFreezeDates = new Set();
    var leaveFreezeMeta = new Map();
    var requestIdToDelete = null; 
    let leaveRequestsUnsubscriber = null;
    let usersUnsubscriber = null;
    let teamsUnsubscriber = null; 
    let leaveFreezeUnsubscriber = null; 
    var calendarViewMode = 'personal'; 

    // Additional global state for roster employees.  This map caches names keyed by
    // staff ID (emp_id) from the roster's employees collection.  It is
    // populated via a Firestore listener in attachDataListeners(), so that
    // employees who are not yet registered as users can still have their
    // names displayed in the leave planner.
    var employeesMap = new Map();
    var employeesUnsubscriber = null;

    const leaveTypeCodes = {
        'Annual Leave': 'AL',
        'Public Holiday': 'PH'
    };

    const shiftCodesMap = {
        '1':    { text: '1',    color: 'bg-green-600', textColor: 'text-white' },         // Morning (dark green)
        '2':    { text: '2',    color: 'bg-green-400', textColor: 'text-gray-800' },      // Night (light green)
        '1A':   { text: '1A',   color: 'bg-green-600', textColor: 'text-white' },         // Morning
        '2N':   { text: '2N',   color: 'bg-green-400', textColor: 'text-gray-800' },      // Night
        'OFF':  { text: 'OFF',  color: 'bg-gray-300', textColor: 'text-gray-800' },       // Off (gray)
        'AD':   { text: 'AD',   color: 'bg-cyan-200', textColor: 'text-cyan-800' },
        'PPT':  { text: 'PPT',  color: 'bg-lime-200', textColor: 'text-lime-800' },
        'PCT':  { text: 'PCT',  color: 'bg-orange-200', textColor: 'text-orange-800' },
        'BCLS': { text: 'BCLS', color: 'bg-red-200', textColor: 'text-red-800' },
        '_EMPTY': { text: '',   color: 'bg-gray-50', textColor: 'text-gray-400' },
        'AL':   { text: 'AL',   color: 'bg-blue-500', textColor: 'text-white' },
        'PH':   { text: 'PH',   color: 'bg-purple-500', textColor: 'text-white' }
    };

    // --- DOM Elements ---
    const loadingEl = document.getElementById("loading");
    const loginSection = document.getElementById("loginSection");
    const mainContainer = document.querySelector(".container");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("userRegisterForm");
    const logoutButton = document.getElementById("logoutButton");
    const regTeamSelect = document.getElementById("regTeam");
    const teamManagementPanel = document.getElementById("teamManagementPanel");
    const addTeamForm = document.getElementById("add-team-form");
    const newTeamNameInput = document.getElementById("new-team-name");
    const addTeamError = document.getElementById("add-team-error");
    const deleteTeamError = document.getElementById("delete-team-error");
    const teamListUl = document.getElementById("team-list-ul");
    const editTeamModal = document.getElementById('edit-team-modal');
    const closeEditTeamModalBtn = document.getElementById('close-edit-team-modal');
    const editTeamForm = document.getElementById('edit-team-form');
    const editTeamId = document.getElementById('edit-team-id');
    const editTeamName = document.getElementById('edit-team-name');
    const editTeamPatternLength = document.getElementById('edit-team-pattern-length');
    const editTeamAnchorDate = document.getElementById('edit-team-anchor-date');
    const visualPatternCells = document.getElementById('visual-pattern-cells');
    const editTeamError = document.getElementById('edit-team-error');
    const patternShiftModal = document.getElementById('pattern-shift-modal');
    const closePatternModalBtn = document.getElementById('close-pattern-modal');
    const patternShiftOptionsContainer = document.getElementById('pattern-shift-options');
    const patternModalDay = document.getElementById('pattern-modal-day');
    const deleteTeamConfirmModal = document.getElementById('delete-team-confirm-modal');
    const cancelDeleteTeamBtn = document.getElementById('cancel-delete-team-btn');
    const confirmDeleteTeamBtn = document.getElementById('confirm-delete-team-btn');
    const deleteTeamModalName = document.getElementById('delete-team-modal-name');
    const deleteTeamWarning = document.getElementById('delete-team-warning');
    
    // Profile Panel DOMs
    const profileLeaveForm = document.getElementById('profileLeaveForm');
    const profileSaveStatus = document.getElementById('profileSaveStatus');
    const profileName = document.getElementById('profileName');
    const profileStaffID = document.getElementById('profileStaffID');
    const profileEmail = document.getElementById('profileEmail');
    const profileTeam = document.getElementById('profileTeam');
    const profileAnnualLeave = document.getElementById('profileAnnualLeave');
    const profilePublicHoliday = document.getElementById('profilePublicHoliday');
    const profileUsedAL = document.getElementById('profileUsedAL');
    const profileBalanceAL = document.getElementById('profileBalanceAL');
    const profileUsedPH = document.getElementById('profileUsedPH');
    const profileBalancePH = document.getElementById('profileBalancePH');

    // Leave Freeze DOMs
    const leaveFreezePanel = document.getElementById('leaveFreezePanel');
    const addFreezeDateForm = document.getElementById('add-freeze-date-form');
    const freezeStartDateInput = document.getElementById('freeze-start-date-input');
    const freezeEndDateInput = document.getElementById('freeze-end-date-input');
    const freezeTypeInput = document.getElementById('freeze-type-input');
    const freezeReasonInput = document.getElementById('freeze-reason-input');
    const freezeDateList = document.getElementById('freeze-date-list');
    const freezeConfirmModal = document.getElementById('freezeConfirmModal');
    const freezeCancelBtn = document.getElementById('freezeCancelBtn');
    const freezeProceedBtn = document.getElementById('freezeProceedBtn');

    // User Delete Modal DOMs
    const userDeleteConfirmModal = document.getElementById('userDeleteConfirmModal');
    const userDeleteRequestInfo = document.getElementById('user-delete-request-info');
    const cancelUserDeleteBtn = document.getElementById('cancel-user-delete-btn');
    const confirmUserDeleteBtn = document.getElementById('confirm-user-delete-btn');

    // Calendar View Toggle DOMs
    const personalViewBtn = document.getElementById('personalViewBtn');
    const masterViewBtn = document.getElementById('masterViewBtn');
    
    // NEW: Staff History DOMs
    const historyStaffSelect = document.getElementById('historyStaffSelect');
    const historyFromDate = document.getElementById('historyFromDate');
    const historyToDate = document.getElementById('historyToDate');
    const historyGenerateBtn = document.getElementById('historyGenerateBtn');
    const historyDownloadBtn = document.getElementById('historyDownloadBtn');
    const historyTableBody = document.getElementById('historyTableBody');

// --- Utility Functions ---
    function showAlert(message, isError = true) {
      const alertBox = document.getElementById("customAlert");
      const alertMessage = document.getElementById("customAlertMessage");
      alertMessage.textContent = message;
      alertBox.classList.remove(isError ? "bg-green-500" : "bg-red-500");
      alertBox.classList.add(isError ? "bg-red-500" : "bg-green-500");
      alertBox.style.display = "block";
      setTimeout(() => { alertBox.style.display = "none"; }, 4000);
    }
    
    function getDaysBetween(dateStr1, dateStr2) {
        try {
            const [y1, m1, d1] = dateStr1.split('-').map(Number);
            const [y2, m2, d2] = dateStr2.split('-').map(Number);
            const utcDate1 = Date.UTC(y1, m1 - 1, d1);
            const utcDate2 = Date.UTC(y2, m2 - 1, d2);
            if (isNaN(utcDate1) || isNaN(utcDate2)) { return 0; }
            return Math.round((utcDate1 - utcDate2) / 86400000);
        } catch (e) { console.error("Error in getDaysBetween", e); return 0; }
    }


    // --- Firebase Initialization ---
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      setLogLevel('debug');
      console.log("Firebase initialized successfully with projectId:", firebaseConfig.projectId);

      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      
      usersCollectionPath = `/artifacts/${appId}/public/data/users`;
      leaveRequestsCollectionPath = `/artifacts/${appId}/public/data/leaveRequests`;
      teamsCollectionPath = `/artifacts/${appId}/public/data/teams`; 
      leaveFreezeCollectionPath = `/artifacts/${appId}/public/data/leaveFreezeDates`; 

      console.log("Using Users Collection:", usersCollectionPath);
      console.log("Using Leave Requests Collection:", leaveRequestsCollectionPath);
      console.log("Using Teams Collection:", teamsCollectionPath); 
      console.log("Using Leave Freeze Collection:", leaveFreezeCollectionPath); 

      initializeAuth();

    } catch (error) {
      console.error("Firebase initialization error:", error);
      showAlert("Error initializing application. Check console.");
      loadingEl.style.display = "none";
      loginSection.style.display = "block";
    }

    /**
     * Handles the authentication state changes.
     */
    async function initializeAuth() {
      // Load teams for registration dropdown
      const teamsQuery = collection(db, teamsCollectionPath);
      teamsUnsubscriber = onSnapshot(teamsQuery, (snapshot) => {
          console.log("Teams data updated (all users):", snapshot.size, "teams");
          teamsMap.clear();
          const sortedTeams = [];
          snapshot.forEach(doc => {
              const teamData = { docId: doc.id, ...doc.data() };
              teamsMap.set(doc.id, teamData);
              sortedTeams.push(teamData);
          });
          
          sortedTeams.sort((a, b) => a.name.localeCompare(b.name));
          
          // Assign colors to teams
          let colorIndex = 0;
          sortedTeams.forEach(team => {
              const teamData = teamsMap.get(team.docId);
              teamData.colorSet = teamColorPalette[colorIndex % teamColorPalette.length];
              colorIndex++;
          });
          
          regTeamSelect.innerHTML = '<option value="">Select a team...</option>';
          sortedTeams.forEach(team => {
              regTeamSelect.innerHTML += `<option value="${team.docId}">${team.name}</option>`;
          });
          
          if (currentUserProfile) {
              populateTeamButtons();
              renderMyProfile(); // Re-render profile if team name changes
              if (userType === "admin") {
                  renderUserManagement(); // Re-render admin user table to show updated team names
                  renderLeaveBalanceReport(); // Re-render balance report
              }
          }
          
      }, (error) => {
          console.error("Error listening to teams collection:", error);
          showAlert("Error loading teams. Registration may fail.");
      });

      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          console.log("Signing in with custom token...");
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          console.log("Signing in anonymously...");
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth initialization error:", error);
        showAlert("Authentication failed. Please refresh.");
        loadingEl.style.display = "none";
        loginSection.style.display = "block";
      }

      onAuthStateChanged(auth, async (user) => {
        if (user && !user.isAnonymous) {
          console.log("User is logged in:", user.uid);
          try { 
            const userDocRef = doc(db, usersCollectionPath, user.uid);
            
            // Use onSnapshot for real-time profile updates
            onSnapshot(userDocRef, (userDoc) => {
                if (userDoc.exists()) {
                  const wasNull = currentUserProfile === null;
                  currentUserProfile = { id: user.uid, ...userDoc.data() };
                  userType = currentUserProfile.isAdmin ? "admin" : "user";
                  
                  if (wasNull) {
                    console.log("User profile found. User type:", userType);
                    // First time load
                    document.getElementById("currentUserDisplay").textContent = `${currentUserProfile.username} (${currentUserProfile.email})`;
                    document.getElementById("staffName").value = currentUserProfile.username;
                    document.getElementById("staffID").value = currentUserProfile.staffID;
                    
                    loginSection.style.display = "none";
                    mainContainer.style.display = "block";
                    loadingEl.style.display = "none";
                    
                    renderUI(); // Initial render
                    attachDataListeners(); // Attach main data listeners
                  }
                  
                  // Always update profile panel
                  renderMyProfile(); 

                } else {
                  console.error("User document not found in Firestore!");
                  showAlert("Error: User profile missing. Logging out.");
                  signOut(auth);
                }
            }, (error) => {
                 console.error("Error listening to user profile:", error);
                 showAlert("Error loading user profile: " + error.message);
                 signOut(auth);
            });

          } catch (error) { 
            console.error("Error setting up user profile listener:", error);
            showAlert("Error loading user profile: " + error.message);
            await signOut(auth);
            loadingEl.style.display = "none";
          }
        } else {
          console.log("User is logged out or anonymous.");
          userType = null;
          currentUserProfile = null;
          
          if (leaveRequestsUnsubscriber) leaveRequestsUnsubscriber();
          if (usersUnsubscriber) usersUnsubscriber();
          if (leaveFreezeUnsubscriber) leaveFreezeUnsubscriber(); 
          
          loginSection.style.display = "block";
          mainContainer.style.display = "none";
          loadingEl.style.display = "none";
          showLoginForm();
        }
      });
    }

    // --- Authentication Functions ---

    window.showRegisterForm = () => {
      loginForm.style.display = "none";
      registerForm.style.display = "block";
    }

    window.showLoginForm = () => {
      loginForm.style.display = "block";
      registerForm.style.display = "none";
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault(); 
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) {
        return showAlert("Please enter both email and password.");
      }
      
      loadingEl.style.display = "flex"; 
      try {
        await signInWithEmailAndPassword(auth, email, password);
        console.log("Login successful.");
      } catch (err) {
        console.error("Login error:", err);
        showAlert(err.message);
        loadingEl.style.display = "none"; 
      }
    });

    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault(); 
      
      const username = document.getElementById("regUsername").value.trim();
      const staffID = document.getElementById("regStaffID").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;
      const teamId = document.getElementById("regTeam").value; 
      const mobile = document.getElementById("regMobile").value.trim(); 
      const adminSecret = document.getElementById("regAdminSecret").value.trim();
      
      const annualLeave = parseFloat(document.getElementById("regAnnualLeave").value) || 0;
      const publicHoliday = parseFloat(document.getElementById("regPublicHoliday").value) || 0;

      if (!username || !staffID || !email || !password || !teamId || !mobile) { 
        return showAlert("Please fill in all fields, including mobile and team.");
      }

      loadingEl.style.display = "flex";
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        const isAdmin = (adminSecret === ADMIN_SECRET_KEY);
        if (isAdmin) {
          showAlert("Admin secret correct! Admin user will be created.", false);
        }

        const userDocRef = doc(db, usersCollectionPath, user.uid);
        await setDoc(userDocRef, {
          username: username,
          staffID: staffID,
          email: email,
          isAdmin: isAdmin,
          team_id: teamId,
          mobile: mobile,
          annualLeaveAllocated: annualLeave, // NEW
          publicHolidayAllocated: publicHoliday // NEW
        });
        // -----------------------------------------------------------------------------------
        // Integrate with the roster's employees collection.  Create or update the employee
        // document so that leave planning and roster share the same staff data.  Use the
        // Firebase Auth UID as the document ID and include both roster fields and leave
        // balance fields.  Merging prevents overwriting existing roster-specific fields
        // such as patternOffset or role if they already exist.
        try {
          const empDocRef = doc(db, "employees", user.uid);
          const empData = {
            id: user.uid,
            docId: user.uid,
            name: username,
            emp_id: staffID,
            team_id: teamId,
            role: "member",
            patternOffset: 0,
            email: email,
            mobile: mobile,
            annualLeaveAllocated: annualLeave,
            publicHolidayAllocated: publicHoliday
          };
          await setDoc(empDocRef, empData, { merge: true });
        } catch (empError) {
          console.error("Error writing to employees collection: ", empError);
        }
        
        console.log("Registration successful, user doc created.");
        showAlert("Registration successful! Please log in.", false);
        
        await signOut(auth);

        showLoginForm();
        registerForm.reset(); 

      } catch (err) {
        console.error("Registration error:", err);
        if (err.code === 'permission-denied' || err.code === 7) {
           showAlert("Registration failed. Check Firestore permissions.");
        } else {
           showAlert(err.message);
        }
      } finally {
        loadingEl.style.display = "none";
      }
    });

    logoutButton.addEventListener("click", async () => {
      loadingEl.style.display = "flex";
      await signOut(auth);
      console.log("User logged out.");
    });

    
    // --- Date Picker Setup & Sync ---
    function setupDateAutoFill() {
        const startInput = document.getElementById("startDate");
        const endInput = document.getElementById("endDate");

        const getTodayStr = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        if (!startInput.value) {
            startInput.value = getTodayStr();
        }

        if (!startInput.dataset.listenerAttached) {
            startInput.addEventListener('change', function() {
                if (this.value) {
                    endInput.value = this.value;
                    endInput.min = this.value; 
                }
            });
            startInput.dataset.listenerAttached = "true";
        }
    }

/* Render UI based on user type */
    async function renderUI() {
      // Show/hide admin tabs
      const isAdmin = userType === "admin";
      document.getElementById("tab-leave-balances").style.display = isAdmin ? "block" : "none";
      document.getElementById("tab-user-mgmt").style.display = isAdmin ? "block" : "none";
      document.getElementById("tab-team-mgmt").style.display = isAdmin ? "block" : "none";
      document.getElementById("tab-leave-freeze").style.display = isAdmin ? "block" : "none";
      document.getElementById("tab-staff-history").style.display = isAdmin ? "block" : "none"; // NEW
      document.getElementById("monthlySummary").style.display = isAdmin ? "block" : "none";
      
      // NEW: Show import section only for admins
      document.getElementById("importSection").style.display = isAdmin ? "block" : "none";

      // Set leave form readonly state
      document.getElementById("staffName").readOnly = !isAdmin; 
      document.getElementById("staffID").readOnly = !isAdmin;  

      // Set default tab
      showLeaveManagement(); // Default to leave management
      
      populateTeamButtons(); 
      await renderCalendar(); 
    
      setupDateAutoFill();
    }
    
    // --- Firestore Data Listeners ---
    
    function attachDataListeners() {
      if (leaveRequestsUnsubscriber) leaveRequestsUnsubscriber();
      if (usersUnsubscriber) usersUnsubscriber();
      if (leaveFreezeUnsubscriber) leaveFreezeUnsubscriber(); 
      
      // Fetch ALL leave requests for filtered views
      let q = collection(db, leaveRequestsCollectionPath);
      
      leaveRequestsUnsubscriber = onSnapshot(q, (snapshot) => {
        console.log("Leave requests snapshot received:", snapshot.size, "docs");
        requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Re-render components that depend on requests
        renderCalendar(); 
        renderMyProfile(); // Update balance calculation
        if (userType === "admin") {
            if (document.getElementById("leaveBalancePanel").style.display === "block") {
                renderLeaveBalanceReport(); 
            }
            // NEW: If History panel is open and staff selected, refresh table
            if (document.getElementById("staffHistoryPanel").style.display === "block" && historyStaffSelect.value) {
                updateHistoryTable(historyStaffSelect.value);
            }
        }
        
      }, (error) => {
        console.error("Error listening to leave requests:", error);
        showAlert("Error loading leave requests.");
      });

      // Leave Freeze Listener
      const freezeQuery = collection(db, leaveFreezeCollectionPath);
      leaveFreezeUnsubscriber = onSnapshot(freezeQuery, (snapshot) => {
          console.log("Leave freeze dates updated:", snapshot.size, "dates");
          leaveFreezeDates.clear();
          leaveFreezeMeta.clear();
          snapshot.forEach(doc => {
              leaveFreezeDates.add(doc.id); // The doc ID is the "YYYY-MM-DD" string
              leaveFreezeMeta.set(doc.id, doc.data() || {});
          });
          
          if (userType === "admin" && document.getElementById("leaveFreezePanel").style.display === "block") {
              renderLeaveFreezeList(); // Re-render admin list if visible
          }
          renderCalendar(); // Re-render calendar to show new freeze dates
          
      }, (error) => {
          console.error("Error listening to leave freeze dates:", error);
          showAlert("Error loading leave freeze dates.");
      });
      
      if (userType === "admin") {
        const usersQuery = collection(db, usersCollectionPath);
        usersUnsubscriber = onSnapshot(usersQuery, (snapshot) => {
          console.log("Users snapshot received:", snapshot.size, "docs");
          allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          
          if (document.getElementById("userManagementPanel").style.display === "block") {
            renderUserManagement(); 
          }
          if (document.getElementById("leaveBalancePanel").style.display === "block") {
            renderLeaveBalanceReport(); 
          }
          renderCalendar(); 
          
        }, (error) => {
          console.error("Error listening to users:", error);
          showAlert("Error loading users.");
        });
      }

      // Listen to the roster employees collection to pick up names for staff IDs
      // that are not registered in the users collection.  This collection stores
      // employee documents keyed by auth UID, containing properties like emp_id and name.
      if (employeesUnsubscriber) employeesUnsubscriber();
      try {
        const employeesQuery = collection(db, "employees");
        employeesUnsubscriber = onSnapshot(employeesQuery, (snapshot) => {
          console.log("Employees snapshot received:", snapshot.size, "docs");
        employeesMap.clear();
          snapshot.forEach(doc => {
            const data = doc.data() || {};
            // emp_id is the staff ID in the roster and name is the employee name
            if (data.emp_id && data.name) {
              const raw = String(data.emp_id);
              // We want to support IDs that may have a leading alphabet character
              // (e.g., "T075540"). Remove any leading alphabet(s) first, then remove
              // leading zeros. We'll store all forms as keys so that lookups work
              // regardless of format.
              const cleaned = raw.replace(/^[A-Za-z]+/, '');
              const trimmed = cleaned.replace(/^0+/, '');
              // Always store the raw form as well as the cleaned and trimmed forms
              employeesMap.set(raw, data.name);
              if (cleaned && cleaned !== raw) {
                employeesMap.set(cleaned, data.name);
              }
              if (trimmed && trimmed !== raw && trimmed !== cleaned) {
                employeesMap.set(trimmed, data.name);
              }
            }
          });
          // After updating employeesMap, re-render name-dependent components
          renderCalendar();
          if (userType === "admin") {
            renderMonthlySummary();
            // Update staff history panel if visible
            renderStaffHistoryPanel();
            if (document.getElementById("staffHistoryPanel").style.display === "block" && historyStaffSelect.value) {
              updateHistoryTable(historyStaffSelect.value, historyFromDate.value, historyToDate.value);
            }
          }
        }, (error) => {
          console.error("Error listening to employees collection:", error);
        });
      } catch (empErr) {
        console.error("Could not set up employees listener:", empErr);
      }
    }

    // --- Date & shift helpers ---
    
    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + dd;
    }

    //
    // Helper: Get the display name for a staff ID.
    // Returns the user's username if found in allUsers, then
    // falls back to the staffName found on any leave request, and
    // finally to the staffID itself.  This ensures that names are
    // displayed consistently across the calendar, summary, and history.
    function getDisplayName(staffID) {
      try {
        if (!staffID) return '';
        const staffStr = String(staffID).trim();
        
        // Check roster employees map first.  Try the exact form, then form
        // without leading alphabet(s), then trimmed of leading zeros.  This
        // allows IDs like "T075540" to match entries stored as "075540"
        // or "75450".
        if (employeesMap) {
          if (employeesMap.has(staffStr)) {
            return employeesMap.get(staffStr);
          }
          // Remove leading alphabet characters
          const cleanedID = staffStr.replace(/^[A-Za-z]+/, '');
          if (employeesMap.has(cleanedID)) {
            return employeesMap.get(cleanedID);
          }
          // Remove leading zeros from the cleaned ID
          const trimmedID = cleanedID.replace(/^0+/, '');
          if (employeesMap.has(trimmedID)) {
            return employeesMap.get(trimmedID);
          }
        }
        // Look up in the users list (match normalized IDs: remove leading alpha and zeros)
        if (Array.isArray(allUsers)) {
          const cleanedStaffID = staffStr.replace(/^[A-Za-z]+/, '');
          const trimmedStaffID = cleanedStaffID.replace(/^0+/, '');
          const userMatch = allUsers.find(u => {
            const userIdStr = String(u.staffID);
            const userClean = userIdStr.replace(/^[A-Za-z]+/, '');
            const userTrim = userClean.replace(/^0+/, '');
            return userIdStr === staffStr || userClean === cleanedStaffID || userTrim === trimmedStaffID;
          });
          if (userMatch && userMatch.username) {
            return userMatch.username;
          }
        }
        // Look up in leave requests for a name (exact match only)
        if (Array.isArray(requests)) {
          const reqMatch = requests.find(r => r.staffID === staffStr && r.staffName);
          if (reqMatch && reqMatch.staffName) {
            return reqMatch.staffName;
          }
        }
        return staffStr;
      } catch (err) {
        console.error('Error in getDisplayName for staffID', staffID, err);
        return staffID || '';
      }
    }
    
    function displayFormatDate(yyyyMmDd) {
        if (!yyyyMmDd) return '';
        const parts = yyyyMmDd.split('-');
        if (parts.length === 3) {
            return `${parts[2]}-${parts[1]}-${parts[0]}`; // dd-mm-yyyy
        }
        return yyyyMmDd; // fallback
    }

    // Escape user-provided text before injecting into HTML
    function escapeHTML(str) {
        return String(str || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function getShift(d) {
      if (!selectedTeamId) {
        return { shift: '', shiftInfo: shiftCodesMap['_EMPTY'] };
      }
      const team = teamsMap.get(selectedTeamId);
      if (!team || !team.shiftPattern || team.shiftPattern.length === 0) {
        return { shift: '', shiftInfo: shiftCodesMap['_EMPTY'] };
      }
      const pattern = team.shiftPattern;
      const anchorDate = team.patternStartDate || patternAnchorDate;
      const daysSinceAnchor = getDaysBetween(formatDate(d), anchorDate);
      const patternIndex = (daysSinceAnchor % pattern.length + pattern.length) % pattern.length;
      const shift = pattern[patternIndex];
      const shiftInfo = shiftCodesMap[shift] || { ...shiftCodesMap['_EMPTY'], text: shift }; 
      return { shift, shiftInfo };
    }
    
    function populateTeamButtons() {
        const teamButtonsContainer = document.getElementById("team-buttons");
        teamButtonsContainer.innerHTML = ""; 
        const sortedTeams = [...teamsMap.values()].sort((a, b) => a.name.localeCompare(b.name));
        
        let defaultTeamId = null;
        if (userType === 'user' && teamsMap.has(currentUserProfile.team_id)) {
            defaultTeamId = currentUserProfile.team_id;
        } else if (sortedTeams.length > 0) {
            defaultTeamId = sortedTeams[0].docId;
        }
        
        if (defaultTeamId && (!selectedTeamId || !teamsMap.has(selectedTeamId))) {
             selectedTeamId = defaultTeamId;
        }

        sortedTeams.forEach((team) => {
            const button = document.createElement("button");
            const colorSet = team.colorSet || teamColorPalette[0]; // Fallback color
            
            const isSelected = team.docId === selectedTeamId;
            const buttonClasses = isSelected ? colorSet.selected : colorSet.btn;
            
            button.className = `team-button px-3 py-1.5 rounded-md text-sm transition-colors ${buttonClasses}`;
            button.textContent = team.name;
            button.dataset.teamId = team.docId; // Store teamId for selectTeam function
            button.onclick = () => selectTeam(team.docId);
            teamButtonsContainer.appendChild(button);
        });
        
        if (selectedTeamId) {
            selectTeam(selectedTeamId);
        }
    }
    
    
    /* Render Calendar */
    async function renderCalendar() {
      if (!isFinite(currentYear) || !isFinite(currentMonth)) {
          console.error("Invalid date state:", currentYear, currentMonth);
          currentYear = new Date().getFullYear();
          currentMonth = new Date().getMonth();
      }
        
      const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
      const isPersonalView = calendarViewMode === 'personal';

      const renderRequests = requests.filter(req => {
          if (userType === 'admin') {
              return true;
          }
          if (isPersonalView) {
              return req.userId === currentUserId;
          } else {
              return true;
          }
      });
        
      const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
      document.getElementById("monthLabel").textContent = monthNames[currentMonth] + " " + currentYear;
      const grid = document.getElementById("calendarGrid");
      grid.innerHTML = "";
      
      const fragment = document.createDocumentFragment();
      
      const weekdays = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
      weekdays.forEach(day => {
          const dayCell = document.createElement("div");
          dayCell.className = "text-center font-semibold text-xs text-gray-500 py-2";
          dayCell.textContent = day;
          fragment.appendChild(dayCell);
      });
      
      const firstDay = new Date(currentYear, currentMonth, 1);
      const offset = (firstDay.getDay() + 6) % 7; // 0 = Monday
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      for (let i = 0; i < offset; i++) {
        fragment.appendChild(document.createElement("div")).className = "day-cell bg-gray-50 rounded";
      }
      
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(currentYear, currentMonth, d);
        const dateStr = formatDate(dateObj); // Use yyyy-mm-dd for logic
        const cell = document.createElement("div");
        cell.className = "day-cell bg-white border border-gray-200 rounded-md min-h-[70px] p-1 text-xs relative";
        
        // Find Approved Leave (AL/PH) to override shift
        let approvedLeaveReq = null;
        
        renderRequests.forEach(req => { // <-- Use renderRequests here
            const dayData = req.days.find(day => day.date === dateStr && (day.status === "Approved" || day.status === "Write-in"));
            if(dayData) {
                if (req.leaveType === 'Annual Leave' || req.leaveType === 'Public Holiday') {
                    approvedLeaveReq = req;
                }
            }
        });
        
        const shiftBox = document.createElement("div");
        shiftBox.className = `shift-box font-bold p-1 rounded text-center mb-1`;
        
        if (approvedLeaveReq) { 
            const leaveCode = leaveTypeCodes[approvedLeaveReq.leaveType];
            const shiftInfo = shiftCodesMap[leaveCode] || { text: (approvedLeaveReq.leaveType || '??').substring(0, 3), color: 'bg-gray-500', textColor: 'text-white' };
            shiftBox.textContent = shiftInfo.text;
            shiftBox.classList.add(shiftInfo.color, shiftInfo.textColor);
            
            // Add day number to corner
            const dayNumberEl = document.createElement("div");
            dayNumberEl.className = "absolute top-1 left-1 font-bold text-gray-700 text-xs";
            dayNumberEl.textContent = d;
            cell.appendChild(dayNumberEl);
            
        } else {
            // No approved AL/PH leave, show shift
            const { shift, shiftInfo } = getShift(dateObj);
            shiftBox.textContent = d; // Show day number IN the box
            if (shiftInfo && shiftInfo.color) {
                shiftBox.classList.add(shiftInfo.color, shiftInfo.textColor);
            } else {
                shiftBox.classList.add('bg-gray-200', 'text-gray-700'); // Fallback for unknown
            }
        }
        
        cell.appendChild(shiftBox);
        
        // Find *all* entries for the list
        const dayEntries = [];
        renderRequests.forEach(req => { // <-- Use renderRequests here
          const dayData = req.days.find(day => day.date === dateStr);
          if (dayData) {
            dayEntries.push({ 
              staffName: req.staffName, 
              staffID: req.staffID, 
              status: dayData.status 
            });
          }
        });
        
        const approvedCount = dayEntries.filter(e => e.status === "Approved" || e.status === "Write-in").length;
        const pendingCount = dayEntries.filter(e => e.status === "Pending").length;

        if (approvedCount > 2) {
            // Show PULSING RED dot for quota exceeded
            cell.appendChild(document.createElement("div")).className = "w-2 h-2 bg-red-500 rounded-full absolute top-1 right-1 animate-pulse";
        } else if (pendingCount > 0) {
            // Show SOLID YELLOW dot for pending leaves
            cell.appendChild(document.createElement("div")).className = "w-2 h-2 bg-yellow-400 rounded-full absolute top-1 right-1";
        }

        // Leave Freeze Highlighter
        if (leaveFreezeDates.has(dateStr)) {
            cell.classList.add("bg-stripes"); // Add striped background
            // Add lock icon
            const lockIcon = document.createElement("div");
            lockIcon.className = "absolute bottom-1 right-1 text-red-700";
            lockIcon.innerHTML = `🔒`;
            cell.appendChild(lockIcon);
        }
        
        dayEntries.forEach(e => {
          // The CSS class will handle the color
          const entry = document.createElement("div");
          entry.className = `leave-entry ${e.status.toLowerCase()} p-1 rounded mt-0.5 truncate`;
          
          let teamColorClass = 'bg-gray-400'; // Default
          let userForLeave = null;
          
          if (userType === 'admin') {
              userForLeave = allUsers.find(u => u.staffID === e.staffID);
          } else if (currentUserProfile && currentUserProfile.staffID === e.staffID) {
              userForLeave = currentUserProfile;
          } else if (userType === 'user' && calendarViewMode === 'master') {
              // Master view for regular users: find the user in allUsers
               userForLeave = allUsers.find(u => u.staffID === e.staffID);
          }
          
          if(userForLeave) {
              const team = teamsMap.get(userForLeave.team_id);
              if (team && team.colorSet) {
                  teamColorClass = team.colorSet.dot;
              }
          }
          // Always display the staff ID in the calendar, even if a name exists.  Remove
          // any leading alphabet characters from the ID for clarity (e.g., "T075540" -> "075540").
          const numericId = String(e.staffID).replace(/^[A-Za-z]+/, '');
          entry.innerHTML = `<div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full ${teamColorClass} flex-shrink-0"></div><span>${numericId}</span></div>`;

          cell.appendChild(entry);
        });
        
        fragment.appendChild(cell);
      }
      
      grid.appendChild(fragment);
      
      renderAdmin();
      if (userType === "admin") {
        renderMonthlySummary();
      }
    }
    
    function groupRequestsByStaffID(requests) {
      const grouped = {};
      
      // Helper to check if a name is likely just the ID (fallback case)
      const isNameJustID = (name, id) => {
          if (!name) return true;
          return String(name).trim() === String(id).trim() || 
                 String(name).trim() === String(id).replace(/^[A-Za-z]+/, '').trim();
      };
      
      requests.forEach(req => {
        const staffID = req.staffID;
        
        if (!grouped[staffID]) {
          // Try standard global lookup first
          let bestName = getDisplayName(staffID);
          
          // If global lookup failed (returned ID) AND request has a better name, use it
          if (isNameJustID(bestName, staffID) && req.staffName && !isNameJustID(req.staffName, staffID)) {
             bestName = req.staffName;
          }
          
          // Initialize group with best available name
          grouped[staffID] = { staffName: bestName, staffID: staffID, requests: [] };
        } else {
             // If we already have a group, but the name is just the ID...
             // ...and THIS request has a real name, update the group name!
             const currentName = grouped[staffID].staffName;
             if (isNameJustID(currentName, staffID) && req.staffName && !isNameJustID(req.staffName, staffID)) {
                 grouped[staffID].staffName = req.staffName;
             }
        }
        
        grouped[staffID].requests.push(req);
      });
      return Object.values(grouped);
    }
    
    function renderAdmin() {
      const adminList = document.getElementById("adminList");
      const adminSummaryEl = document.getElementById("adminSummary");
      adminList.innerHTML = "";

      const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
      let listRequests = requests; 
      
      if (userType === "user" && calendarViewMode === 'master') {
          adminSummaryEl.style.display = "none";
          return;
      } else {
          adminSummaryEl.style.display = "block";
      }

      if (userType === "user") {
          listRequests = listRequests.filter(req => req.userId === currentUserId);
      } else { 
          // Admin View: filter by date (keep original admin date filter)
          const currentDate = new Date();
          const currentYearMonth = currentDate.getFullYear() * 12 + currentDate.getMonth();
          listRequests = listRequests.filter(req => { 
            return req.days.some(day => {
              const [year, month] = day.date.split("-").map(Number);
              const requestYearMonth = year * 12 + (month - 1);
              return requestYearMonth >= currentYearMonth;
            });
          });
      }
      
      if (listRequests.length === 0) {
        adminList.innerHTML = `<div class="text-gray-500 text-center p-4">No leave requests found.</div>`;
        return;
      }

      const groupedRequests = groupRequestsByStaffID(listRequests);
      groupedRequests.forEach((group) => {
        const groupID = group.staffID; 
        const item = document.createElement("div");
        item.className = "accordion-item border border-gray-200 rounded-md";
        
        const totalDays = group.requests.reduce((sum, r) => sum + r.days.length, 0);
        const pendingCount = group.requests.reduce((sum, r) =>
          sum + r.days.filter(d => d.status === "Pending").length, 0
        );
        
        let teamColorClass = 'bg-gray-400';
        let userForGroup = null;
        // Determine the team color using the user record if available
        if (userType === 'admin') {
            userForGroup = allUsers.find(u => u.staffID === group.staffID);
        } else if (currentUserProfile.staffID === group.staffID) {
            userForGroup = currentUserProfile;
        }
        if(userForGroup) {
            const team = teamsMap.get(userForGroup.team_id);
            if (team && team.colorSet) {
                teamColorClass = team.colorSet.dot;
            }
        }
        
        // Compute display name using helper (group.staffName is prioritised now)
        let displayName = group.staffName || getDisplayName(group.staffID);
        
        // Final fallback to ID if empty
        if (!displayName) displayName = group.staffID;
        
        // For display purposes, remove any leading alphabet characters from the staff ID
        const numericIdForGroup = String(group.staffID).replace(/^[A-Za-z]+/, '');
        
        item.innerHTML = `
          <div class="accordion-header flex justify-between items-start p-3 bg-gray-50 cursor-pointer hover:bg-gray-100" data-group-id="${groupID}">
            <span class="font-semibold text-gray-700 flex items-center gap-2">
              <div class="w-3 h-3 rounded-full ${teamColorClass} flex-shrink-0"></div>
              ${displayName} (${numericIdForGroup})
            </span>
            <span class="badge text-xs px-2 py-0.5 rounded-full ${pendingCount > 0 ? "bg-yellow-500 text-white" : "bg-blue-500 text-white"} whitespace-nowrap">
              ${totalDays} days (${pendingCount} pending)
            </span>
          </div>
          <div class="accordion-content p-3 bg-white" data-group-id="${groupID}" style="display: none;">
            ${group.requests.sort((a,b) => new Date(b.fromDate) - new Date(a.fromDate)).map((req) => {
              const isPending = req.days.every(d => d.status === 'Pending');
              return `
              <div class="mb-3 border-b pb-3">
                <div class="font-semibold text-gray-800 mb-2">${req.leaveType || 'Leave'} 
                  <span class="font-normal text-gray-600">(${displayFormatDate(req.fromDate)} to ${displayFormatDate(req.toDate)})</span>
                </div>
                <div class="timeline flex flex-wrap gap-2">
                  ${req.days.map((day, dayIndex) => `
                    <div class="day-block flex items-center gap-2 p-2 bg-gray-100 rounded">
                      <span>${displayFormatDate(day.date)}</span>
                      <div class="status-dot w-2 h-2 rounded-full ${day.status.toLowerCase()}"></div>
                      <select data-request-id="${req.id}" data-day-index="${dayIndex}" 
                              class="text-xs p-1 border rounded"
                              ${userType === "user" ? "disabled" : ""}>
                        <option value="Pending"  ${day.status === "Pending" ? "selected" : ""}>Pending</option>
                        <option value="Approved" ${day.status === "Approved" ? "selected" : ""}>Approved</option>
                        <option value="Rejected" ${day.status === "Rejected" ? "selected" : ""}>Rejected</option>
                        <option value="Write-in" ${day.status === "Write-in" ? "selected" : ""}>Write-in</option>
                      </select>
                    </div>
                  `).join("")}
                </div>
                <div class="action-buttons text-right mt-2 space-x-2">
                  ${userType === "admin" ? `<button class="delete-request-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" data-request-id="${req.id}">Delete Req</button>` : ""}
                  
                  <!-- User Delete Button -->
                  ${userType === "user" && isPending ? `
                    <button class="user-delete-request-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" 
                            data-request-id="${req.id}" 
                            data-request-info="${req.leaveType || 'Leave'} (${displayFormatDate(req.fromDate)} to ${displayFormatDate(req.toDate)})">
                      Delete Request
                    </button>
                  ` : ""}
                  
                  <button class="whatsapp-btn bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600" data-request-id="${req.id}">WhatsApp</button>
                </div>
              </div>
            `}).join("")}
          </div>
        `;
        adminList.appendChild(item);
      });
      
      adminList.querySelectorAll(".accordion-header").forEach(header => {
        const groupID = header.getAttribute("data-group-id");
        const content = header.nextElementSibling;
        content.style.display = openAccordions.has(groupID) ? "block" : "none";
        
        header.onclick = function() {
          if (content.style.display === "block") {
            content.style.display = "none";
            openAccordions.delete(groupID);
          } else {
            content.style.display = "block";
            openAccordions.add(groupID);
          }
        };
      });
      
      adminList.querySelectorAll("select").forEach(sel => {
        sel.onchange = async function() {
          if (userType !== "admin") return;
          const requestId = sel.getAttribute("data-request-id");
          const dayIndex = parseInt(sel.getAttribute("data-day-index"), 10);
          const newStatus = sel.value;
          const reqDocRef = doc(db, leaveRequestsCollectionPath, requestId);
          try {
            const reqDoc = await getDoc(reqDocRef);
            if (!reqDoc.exists()) throw new Error("Request document not found.");
            const reqData = reqDoc.data();
            const updatedDays = [...reqData.days]; 
            if (updatedDays[dayIndex]) {
              updatedDays[dayIndex].status = newStatus;
            }
            await updateDoc(reqDocRef, { days: updatedDays });
            console.log("Day status updated.");
          } catch (err) {
            console.error("Day status update error:", err);
            showAlert("Error updating day status: " + err.message);
          }
        };
      });
      
      adminList.querySelectorAll(".delete-request-btn").forEach(btn => {
        btn.onclick = async function() {
          const requestId = btn.getAttribute("data-request-id");
          requestIdToDelete = requestId;
          userDeleteRequestInfo.textContent = "Admin action: Deleting this request permanently.";
          userDeleteConfirmModal.classList.remove('hidden');
        };
      });

      adminList.querySelectorAll(".user-delete-request-btn").forEach(btn => {
        btn.onclick = function() {
          requestIdToDelete = btn.getAttribute("data-request-id");
          userDeleteRequestInfo.textContent = btn.getAttribute("data-request-info");
          userDeleteConfirmModal.classList.remove('hidden');
        };
      });
      
      adminList.querySelectorAll(".whatsapp-btn").forEach(btn => {
        btn.onclick = function() {
          const requestId = btn.getAttribute("data-request-id");
          const req = requests.find(r => r.id === requestId);
          if (!req) return;

          let mobileNumber = '';
          
          if (userType === 'admin') {
            const user = allUsers.find(u => u.staffID === req.staffID);
            mobileNumber = user ? user.mobile : '';
          } else {
            if (currentUserProfile && currentUserProfile.staffID === req.staffID) {
                mobileNumber = currentUserProfile.mobile || '';
            }
          }

          const msg = `Hello ${req.staffName} (${req.staffID}), your status for ${req.leaveType || 'Leave'} request (${displayFormatDate(req.fromDate)} to ${displayFormatDate(req.toDate)}):\n` +
            req.days.map(d => `${displayFormatDate(d.date)}: ${d.status}`).join('\n');
            
          if (mobileNumber) {
            let formattedNumber = mobileNumber.replace(/[\s+()-]/g, '');
            if (formattedNumber.startsWith('00')) {
              formattedNumber = formattedNumber.substring(2);
            }
            
            if (/^\d{8,}$/.test(formattedNumber)) {
              window.open(`https://wa.me/${formattedNumber}?text=${encodeURIComponent(msg)}`, "_blank");
            } else {
              showAlert(`Invalid mobile number for ${req.staffName}: ${mobileNumber}. Please update in User Management.`);
              window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
            }
          } else {
            showAlert(`No mobile number found for ${req.staffName}. Opening general WhatsApp.`);
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
          }
        };
      });
    }
    
    // --- Leave Form Submission ---
    async function submitLeaveRequest(status, daysArray, name, id, start, end, leaveType) {
        const finalDaysArray = daysArray.map(day => ({ date: day.date, status: status }));

        try {
            await addDoc(collection(db, leaveRequestsCollectionPath), {
            staffName: name,
            staffID: id,
            userId: (userType === 'admin' && currentUserProfile.staffID !== id) ? `admin_entry_${id}` : auth.currentUser.uid, 
            fromDate: start, // yyyy-mm-dd
            toDate: end,     // yyyy-mm-dd
            leaveType: leaveType,
            days: finalDaysArray 
            });
            showAlert(status === 'Write-in' ? "Request submitted as Write-in." : "Leave request submitted successfully.", false);
            document.getElementById("leaveForm").reset(); 
            setupDateAutoFill(); 
            
            if(userType === 'user') {
                document.getElementById("staffName").value = currentUserProfile.username;
                document.getElementById("staffID").value = currentUserProfile.staffID;
            }
            document.getElementById("leaveType").value = "Annual Leave"; 
            
        } catch (error) {
            console.error("Error submitting leave request:", error);
            showAlert("An error occurred: " + error.message);
        } finally {
            loadingEl.style.display = "none";
        }
    }

    document.getElementById("leaveForm").onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById("staffName").value.trim();
      const id   = document.getElementById("staffID").value.trim();
      const start = document.getElementById("startDate").value;
      const end   = document.getElementById("endDate").value;
      const leaveType = document.getElementById("leaveType").value;
      
      if (!name || !id || !start || !end || !leaveType) {
        return showAlert("Please fill all fields.");
      }
      if (end < start) {
        return showAlert("End date cannot be before start date.");
      }
      
      loadingEl.style.display = "flex";
      
      const startDate = new Date(start + "T12:00:00"); 
      const endDate = new Date(end + "T12:00:00");
      const daysArray = [];
      for (let d = new Date(startDate.getTime()); d <= endDate; d.setDate(d.getDate() + 1)) {
          daysArray.push({ date: formatDate(d), status: "Pending" }); // Status is temporary here
      }
      
      if (daysArray.length === 0) {
        loadingEl.style.display = "none";
        return showAlert("No valid days in range.");
      }

      // Check for frozen dates
      const frozenDaysFound = daysArray.some(day => leaveFreezeDates.has(day.date));

      if (frozenDaysFound) {
          // Show custom modal
          freezeConfirmModal.classList.remove('hidden');
          loadingEl.style.display = "none"; // Hide loading spinner while modal is open

          freezeCancelBtn.onclick = () => {
              freezeConfirmModal.classList.add('hidden');
          };

          freezeProceedBtn.onclick = () => {
              freezeConfirmModal.classList.add('hidden');
              loadingEl.style.display = "flex"; // Show spinner again
              submitLeaveRequest("Write-in", daysArray, name, id, start, end, leaveType);
          };

      } else {
          // No frozen dates, submit as "Pending"
          submitLeaveRequest("Pending", daysArray, name, id, start, end, leaveType);
      }
    };
    
    // --- Monthly Summary & PDF (Admin) ---
    
    function renderMonthlySummary() {
      if (userType !== "admin") return;
      
      const summaryTableBody = document.getElementById("summaryTableBody");
      summaryTableBody.innerHTML = "";
      const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}`;
      
      // Group by Staff ID *and* Leave Type
      const allDaysByStaffAndType = {};
      
      requests.forEach(req => {
        const staffID = req.staffID;
        const staffName = req.staffName;
        const leaveType = req.leaveType; 
        
        if (leaveType && leaveType !== 'Annual Leave' && leaveType !== 'Public Holiday') {
            return; 
        }
        
        const displayLeaveType = leaveType || 'Leave'; 

        const key = `${staffID}::${displayLeaveType}`; 
        
        if (!allDaysByStaffAndType[key]) {
          allDaysByStaffAndType[key] = { staffName, staffID, leaveType: displayLeaveType, days: {} };
        }
        
        req.days.forEach(day => {
          if (day.date.startsWith(monthStr) && 
             (day.status === "Approved" || day.status === "Write-in")) {
            // Store status, prioritizing "Approved"
            if (!allDaysByStaffAndType[key].days[day.date] || day.status === "Approved") {
              allDaysByStaffAndType[key].days[day.date] = day.status;
            }
          }
        });
      });
      
      const groupedRequests = Object.values(allDaysByStaffAndType).filter(
        g => Object.keys(g.days).length > 0
      );
      
      // Sort by display name (fallback to staff ID) using helper, then leave type
      groupedRequests.sort((a, b) => {
          const nameA = getDisplayName(a.staffID);
          const nameB = getDisplayName(b.staffID);
          if (nameA < nameB) return -1;
          if (nameA > nameB) return 1;
          const leaveA = a.leaveType || '';
          const leaveB = b.leaveType || '';
          if (leaveA < leaveB) return -1;
          if (leaveA > leaveB) return 1;
          return 0;
      });
      
      groupedRequests.forEach(group => {
        const dayEntries = Object.entries(group.days).map(([date, status]) => ({ date, status }));
        dayEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const ranges = [];
        if (dayEntries.length > 0) {
          let currentRange = [dayEntries[0]];
          for (let i = 1; i < dayEntries.length; i++) {
            const prevDateStr = currentRange[currentRange.length - 1].date;
            const currDateStr = dayEntries[i].date;
            const dateDiff = getDaysBetween(currDateStr, prevDateStr);
            // Group by date *and* status
            if (dateDiff === 1 && currentRange[0].status === dayEntries[i].status) {
              currentRange.push(dayEntries[i]);
            } else {
              ranges.push(currentRange);
              currentRange = [dayEntries[i]];
            }
          }
          ranges.push(currentRange);
        }
        
        const totalDays = dayEntries.length;
        
        const leaveCode = leaveTypeCodes[group.leaveType]; 
        const shiftInfo = shiftCodesMap[leaveCode] || { 
            text: (group.leaveType === 'Leave' ? 'LEAVE' : (group.leaveType || '??').substring(0, 3)), 
            color: 'bg-gray-500', 
            textColor: 'text-white' 
        };

        const row = document.createElement("tr");
        row.className = "border-b hover:bg-gray-50";
        // Determine a display name using helper
        const displayName = getDisplayName(group.staffID);
        // Remove any leading alphabet characters for display ID
        const displayId = String(group.staffID).replace(/^[A-Za-z]+/, '');
        row.innerHTML = `
          <td class="p-2 staff-name font-medium text-gray-800">
            ${displayName} (${displayId})
            <span class="ml-2 px-2 py-0.5 rounded text-xs font-semibold ${shiftInfo.color} ${shiftInfo.textColor}">
              ${shiftInfo.text}
            </span>
          </td>
          <td class="p-2 leave-range">
            <div class="flex flex-col gap-1">
            ${ranges.map(range => {
              const startDate = range[0].date; 
              const endDate = range[range.length - 1].date; 
              const startDisplay = displayFormatDate(startDate); 
              const endDisplay = displayFormatDate(endDate); 
              const displayText = (startDate === endDate) ? startDisplay.split('-')[0] : `${startDisplay.split('-')[0]}-${endDisplay.split('-')[0]}`; 
              const monthYear = `${startDisplay.split('-')[1]}-${startDisplay.split('-')[2]}`;
              const statusLabel = range[0].status; // "Approved" or "Write-in"
              return `
                <div class="range-block ${statusLabel.toLowerCase()} inline-flex items-center gap-1.5 text-xs">
                  <span class="status-dot w-1.5 h-1.5 rounded-full"></span>
                  ${displayText} (${monthYear}) - ${statusLabel}
                </div>
              `;
            }).join("")}
            </div>
          </td>
          <td class="p-2 total-days font-medium text-gray-800 text-right">${totalDays}</td>
        `;
        summaryTableBody.appendChild(row);
      });
      
      if (summaryTableBody.children.length === 0) {
        summaryTableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">No approved or write-in leave requests for this month.</td></tr>`;
      }
    }
    
    window.downloadSummaryPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const bodyData = [];
      const rows = document.querySelectorAll("#summaryTableBody tr");
      
      rows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        if (cells.length === 3) {
          const staffName = cells[0].cloneNode(true);
          staffName.querySelector('span')?.remove();
          
          const dateRanges = [];
          cells[1].querySelectorAll('.range-block').forEach(div => {
              let text = div.innerText.trim(); 
              dateRanges.push(text);
          });
          const formattedDates = dateRanges.join("\n");
          
          bodyData.push([
            staffName.innerText.trim(), 
            formattedDates, 
            cells[2].innerText.trim() 
          ]);
        }
      });
      doc.text(`Monthly Leave Summary - ${document.getElementById("monthLabel").textContent}`, 14, 15);
      doc.autoTable({
        head: [["Staff & Leave Type", "Dates", "Days"]],
        body: bodyData,
        startY: 20,
        theme: "grid",
        styles: { fontSize: 10, cellPadding: 2 },
        columnStyles: {
          0: { cellWidth: 50 },
          1: { cellWidth: 'auto' },
          2: { cellWidth: 20, halign: 'right' }
        }
      });
      showPDFPreview(doc);
    }
    
    function showPDFPreview(doc) {
      const pdfBlob = doc.output("blob");
      const pdfURL = URL.createObjectURL(pdfBlob);
      const container = document.getElementById("pdfViewerContainer");
      document.getElementById("pdfViewerFrame").src = pdfURL;
      container.style.display = "block";
      
      document.getElementById("exitPDFViewer").onclick = function() {
        container.style.display = "none";
        document.getElementById("pdfViewerFrame").src = "about:blank";
        URL.revokeObjectURL(pdfURL);
      };
    }

    // --- NEW: JSON Smart Import Logic (Clear & Replace with Flattening) ---
    document.getElementById('triggerImportBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('jsonImportInput');
        const file = fileInput.files[0];
        const targetYear = parseInt(document.getElementById('importYear').value);
        const targetMonthVal = document.getElementById('importMonth').value; // 'all' or '1'...'12'

        if (!file) {
            return showAlert("Please select a JSON file to import.");
        }
        if (!targetYear || targetYear < 2020 || targetYear > 2030) {
            return showAlert("Please enter a valid target year (e.g., 2026).");
        }

        let confirmMsg = "";
        let deleteStartStr = "";
        let deleteEndStr = "";
        
        if (targetMonthVal === 'all') {
            confirmMsg = `WARNING: This will DELETE ALL existing leave requests for the FULL YEAR ${targetYear} and replace them with the data from the file.\n\nAre you sure?`;
            deleteStartStr = `${targetYear}-01-01`;
            deleteEndStr = `${targetYear}-12-31`;
        } else {
            const mInt = parseInt(targetMonthVal);
            const mStr = String(mInt).padStart(2, '0');
            const monthName = document.getElementById('importMonth').options[document.getElementById('importMonth').selectedIndex].text;
            
            // Calculate last day of month
            const lastDay = new Date(targetYear, mInt, 0).getDate();
            
            confirmMsg = `WARNING: This will DELETE existing leave requests for ${monthName} ${targetYear} ONLY, and replace them with matching data from the file.\n\nAre you sure?`;
            deleteStartStr = `${targetYear}-${mStr}-01`;
            deleteEndStr = `${targetYear}-${mStr}-${lastDay}`;
        }

        if (!confirm(confirmMsg)) {
            return;
        }

        if (!allUsers || allUsers.length === 0) {
            showAlert("System users not loaded. Please wait or refresh.", true);
            return;
        }

        // Show loading
        loadingEl.style.display = "flex";

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const data = JSON.parse(event.target.result);
                if (!data.leaveRequests || !Array.isArray(data.leaveRequests)) {
                    throw new Error("Invalid JSON format. Expected 'leaveRequests' array.");
                }

                // 1. DELETE existing entries for the target range
                console.log(`Starting deletion range: ${deleteStartStr} to ${deleteEndStr}`);
                const q = query(
                    collection(db, leaveRequestsCollectionPath),
                    where("fromDate", ">=", deleteStartStr),
                    where("fromDate", "<=", deleteEndStr)
                );
                
                const existingDocs = await getDocs(q);
                const deleteBatch = writeBatch(db);
                let deleteCount = 0;
                
                existingDocs.forEach((doc) => {
                    deleteBatch.delete(doc.ref);
                    deleteCount++;
                });

                if (deleteCount > 0) {
                    await deleteBatch.commit();
                    console.log(`Deleted ${deleteCount} existing records.`);
                }

                // 2. Import New Data (FLATTENING LOGIC)
                const batchArray = [];
                let batch = writeBatch(db);
                let opCount = 0;
                let processedCount = 0;

                for (const req of data.leaveRequests) {
                    // Check if 'days' array exists
                    if (!req.days || !Array.isArray(req.days)) continue;

                    // Iterate through EACH DAY in the 'days' array
                    // This forces every day to be a separate database entry
                    for (const dayObj of req.days) {
                        const dateStr = dayObj.date;
                        
                        // Filter: Check if this specific day falls within the selected import range
                        // Simple string comparison works for ISO dates (yyyy-mm-dd)
                        if (dateStr < deleteStartStr || dateStr > deleteEndStr) {
                            continue; // Skip if outside range
                        }

                        // Map Employee ID to Real User
                        const targetStaffId = req.staffID;
                        // Attempt to match users ignoring leading alphabet characters on the staff ID
                        const cleanedTargetId = String(targetStaffId).replace(/^[A-Za-z]+/, '');
                        const userObj = allUsers.find(u => {
                            const userClean = String(u.staffID).replace(/^[A-Za-z]+/, '');
                            return userClean === cleanedTargetId;
                        });

                        let targetUserId = "IMPORT_Admin"; 
                        // Prefer the staffName from the JSON if provided
                        let targetUserName = req.staffName;

                        if (userObj) {
                            targetUserId = userObj.id; // The auth uid
                            targetUserName = userObj.username;
                        } else {
                            // If no registered user exists and no name provided, try to look up a display name
                            // using the helper that checks the employees roster and other sources
                            if (!targetUserName || targetUserName === targetStaffId) {
                                const lookupName = typeof getDisplayName === 'function' ? getDisplayName(targetStaffId) : null;
                                if (lookupName && lookupName !== targetStaffId) {
                                    targetUserName = lookupName;
                                } else {
                                    targetUserName = targetStaffId;
                                }
                            }
                        }

                        // Create a single-day request object
                        // Note: userId is key for permissions. If mapped correctly, user can see it.
                        const newDocRef = doc(collection(db, leaveRequestsCollectionPath));
                        batch.set(newDocRef, {
                            staffName: targetUserName,
                            staffID: targetStaffId,
                            userId: targetUserId,
                            fromDate: dateStr,  // Single day start
                            toDate: dateStr,    // Single day end
                            leaveType: req.leaveType,
                            days: [{ date: dateStr, status: "Pending" }], // Always "Pending" status
                            importedAt: new Date().toISOString()
                        });

                        processedCount++;
                        opCount++;
                        
                        // Handle batch limits
                        if (opCount >= 450) { 
                            batchArray.push(batch);
                            batch = writeBatch(db);
                            opCount = 0;
                        }
                    }
                }

                if (opCount > 0) batchArray.push(batch);

                // Commit all batches
                for (const b of batchArray) {
                    await b.commit();
                }

                showAlert(`Advanced Sync Successful! Cleared ${deleteCount} old records. Imported ${processedCount} new daily entries for selected period.`, false);
                fileInput.value = ''; // Reset input

            } catch (err) {
                console.error(err);
                showAlert("Error importing: " + err.message);
            } finally {
                loadingEl.style.display = "none";
            }
        };
        reader.readAsText(file);
    });
    
    // --- User Management (Admin) ---

    function renderUserManagement() {
      if (userType !== 'admin') return;
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      
      if (allUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No users have registered yet.</td></tr>`;
        return;
      }
      
      allUsers.sort((a,b) => a.username.localeCompare(b.username)).forEach(user => {
        const isSelf = (user.id === auth.currentUser.uid);
        const team = teamsMap.get(user.team_id);
        const teamName = team ? team.name : 'N/A';
        const teamColorClass = team ? (team.colorSet.dot || 'bg-gray-400') : 'bg-gray-400';
        
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3">${user.username}</td>
          <td class="p-3">${user.staffID}</td>
          <td class="p-3">${user.mobile || 'N/A'}</td>
          <td class="p-3">${user.email}</td>
          <td class="p-3">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-full ${teamColorClass} flex-shrink-0"></div>
              <span>${teamName}</span>
            </div>
          </td>
          <td class="p-3">
            <span class="px-2 py-1 text-xs rounded-full ${user.isAdmin ? "bg-green-200 text-green-800" : "bg-gray-200 text-gray-800"}">
              ${user.isAdmin ? "Yes" : "No"}
            </span>
          </td>
          <td class="p-3 space-x-2 whitespace-nowrap">
            <button class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs hover:bg-blue-200 ${isSelf ? 'opacity-50 cursor-not-allowed' : ''}" 
                    onclick="window.toggleAdminStatus('${user.id}', ${user.isAdmin})" ${isSelf ? 'disabled' : ''}>
              ${user.isAdmin ? "Revoke Admin" : "Make Admin"}
            </button>
            <button class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-xs hover:bg-yellow-200" 
                    onclick="window.resetUserPassword('${user.email}')">
              Reset Password
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.toggleAdminStatus = async (userId, isCurrentlyAdmin) => {
      if (userId === auth.currentUser.uid) {
        return showAlert("You cannot change your own admin status.");
      }
      if (!confirm(`Are you sure you want to ${isCurrentlyAdmin ? 'revoke' : 'grant'} admin status for this user?`)) return;
      loadingEl.style.display = "flex";
      try {
        const userDocRef = doc(db, usersCollectionPath, userId);
        await updateDoc(userDocRef, { isAdmin: !isCurrentlyAdmin });
        showAlert("Admin status updated successfully.", false);
      } catch (err) {
        console.error("Toggle admin error:", err);
        showAlert("Error updating admin status: " + err.message);
      } finally {
        loadingEl.style.display = "none";
      }
    }
    
    window.resetUserPassword = async (email) => {
      if (!confirm(`Are you sure you want to send a password reset email to ${email}?`)) return;
      loadingEl.style.display = "flex";
      try {
        await sendPasswordResetEmail(auth, email);
        showAlert(`Password reset email sent to ${email}.`, false);
      } catch (err) {
        console.error("Password reset error:", err);
        showAlert("Error sending password reset: " + err.message);
      } finally {
        loadingEl.style.display = "none";
      }
    }
    
    
    // --- Team Management Functions ---
    
    window.openManageTeamsModal = () => {
        deleteTeamError.textContent = '';
        addTeamError.textContent = '';
        populateManageTeamsModal();
    }
    
    function populateManageTeamsModal() {
        if (!teamListUl) return; 
        teamListUl.innerHTML = '';
        const sortedTeams = [...teamsMap.values()].sort((a, b) => a.name.localeCompare(b.name));
        
        if (sortedTeams.length === 0) {
            teamListUl.innerHTML = '<li class="p-3 text-gray-500 italic">No teams found.</li>'; return;
        }
        
        sortedTeams.forEach((team) => {
            const li = document.createElement('li');
            li.className = 'team-li flex justify-between items-center p-3';
            li.innerHTML = `
                <span class="flex items-center gap-2">
                  <div class="w-3 h-3 rounded-full ${team.colorSet.dot || 'bg-gray-400'}"></div>
                  ${team.name}
                </span>
                <div class="flex items-center">
                    <button class="edit-team-btn text-sm text-indigo-600 hover:text-indigo-800 font-medium mr-3 opacity-100 transition-opacity" data-team-id="${team.docId}">Edit</button>
                    <button class="delete-team-btn text-red-400 hover:text-red-700 font-bold text-xl p-0 rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-100" title="Delete ${team.name}" data-team-id="${team.docId}" data-team-name="${team.name}">&#215;</button>
                </div>
            `;
            teamListUl.appendChild(li);
        });
        
        teamListUl.querySelectorAll('.edit-team-btn').forEach(btn => {
            btn.onclick = () => openEditTeamModal(btn.dataset.teamId);
        });
        teamListUl.querySelectorAll('.delete-team-btn').forEach(btn => {
            btn.onclick = () => checkAndDeleteTeam(btn.dataset.teamId, btn.dataset.teamName);
        });
    }

    addTeamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        addTeamError.textContent = '';
        const newTeamName = newTeamNameInput.value.trim();
        if (!newTeamName) { addTeamError.textContent = 'Please enter a name.'; return; }
        
        const newTeamDocId = newTeamName.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_{2,}/g, '_') + '_' + Date.now();
        
        if ([...teamsMap.values()].some(team => team.name.toLowerCase() === newTeamName.toLowerCase())) {
            addTeamError.textContent = 'A team with this name already exists.'; return;
        }
        
        try {
            const newTeam = { 
                id: newTeamDocId, docId: newTeamDocId, name: newTeamName,
                shiftPattern: defaultPattern, patternStartDate: patternAnchorDate
            };
            await setDoc(doc(db, teamsCollectionPath, newTeamDocId), newTeam);
            newTeamNameInput.value = '';
        } catch (error) {
            console.error("Error adding team: ", error);
            addTeamError.textContent = 'Error saving team.';
        }
    });

    window.openEditTeamModal = (teamId) => {
        const team = teamsMap.get(teamId);
        if (!team) { console.error("Could not find team with ID:", teamId); return; }
        editTeamId.value = teamId;
        editTeamName.value = team.name;
        editTeamAnchorDate.value = team.patternStartDate || patternAnchorDate;
        tempPatternArray = [...(team.shiftPattern || defaultPattern)];
        editTeamPatternLength.value = tempPatternArray.length;
        renderVisualPatternCells();
        editTeamError.textContent = '';
        editTeamModal.classList.remove('hidden');
    }
    
    function renderVisualPatternCells() {
        const emptyShiftInfo = shiftCodesMap['_EMPTY'];
        const len = parseInt(editTeamPatternLength.value) || 0;
        
        while (tempPatternArray.length < len) tempPatternArray.push('_EMPTY');
        if (tempPatternArray.length > len) tempPatternArray = tempPatternArray.slice(0, len);
        
        visualPatternCells.innerHTML = '';
        for (let i = 0; i < len; i++) {
            const shiftCode = tempPatternArray[i] || '_EMPTY';
            const shiftInfo = shiftCodesMap[shiftCode] || { ...emptyShiftInfo, text: '???' };
            const cell = document.createElement('div');
            cell.className = `w-16 h-16 flex flex-col items-center justify-center rounded-lg border-2 cursor-pointer ${shiftInfo.color} ${shiftInfo.textColor} hover:shadow-md`;
            cell.dataset.index = i;
            cell.innerHTML = `
                <span class="text-xs font-medium text-gray-500">Day ${i + 1}</span>
                <span class="text-lg font-bold">${shiftInfo.text || '...'}</span>
            `;
            cell.addEventListener('click', () => openPatternShiftModal(i));
            visualPatternCells.appendChild(cell);
        }
    }
    
    window.openPatternShiftModal = (index) => {
        patternModalDay.textContent = `Day ${index + 1}`;
        patternShiftOptionsContainer.innerHTML = '';
        
        Object.keys(shiftCodesMap).sort().forEach(code => {
            const shiftInfo = shiftCodesMap[code];
            const button = document.createElement('button');
            button.textContent = shiftInfo.text || 'Empty';
            button.className = `p-3 rounded-lg border font-medium transition duration-150 ${shiftInfo.color} ${shiftInfo.textColor} hover:shadow-md hover:ring-2 hover:ring-indigo-400`;
            button.addEventListener('click', () => {
                tempPatternArray[index] = code;
                renderVisualPatternCells();
                closePatternShiftModal();
            });
            patternShiftOptionsContainer.appendChild(button);
        });
        patternShiftModal.classList.remove('hidden');
    }
    
    function closePatternShiftModal() { patternShiftModal.classList.add('hidden'); }
    function closeEditTeamModal() { editTeamModal.classList.add('hidden'); editTeamForm.reset(); }

    editTeamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        editTeamError.textContent = '';
        const teamId = editTeamId.value;
        if (tempPatternArray.some(code => code === undefined || code === null)) {
            editTeamError.textContent = 'All pattern days must have a shift selected.'; return;
        }
        const updatedData = {
            name: editTeamName.value.trim(),
            shiftPattern: tempPatternArray,
            patternStartDate: editTeamAnchorDate.value
        };
        try {
            await updateDoc(doc(db, teamsCollectionPath, teamId), updatedData);
            closeEditTeamModal();
        } catch (error) {
            console.error("Error updating team: ", error);
            editTeamError.textContent = 'Error saving changes.';
        }
    });

    window.checkAndDeleteTeam = (teamId, teamName) => {
        deleteTeamError.textContent = '';
        deleteTeamWarning.textContent = '';
        
        const employeesOnTeam = allUsers.filter(user => user.team_id === teamId);
        
        if (employeesOnTeam.length > 0) {
            deleteTeamWarning.textContent = `Cannot delete "${teamName}". ${employeesOnTeam.length} user(s) are still assigned to it.`;
            confirmDeleteTeamBtn.disabled = true;
            confirmDeleteTeamBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
             deleteTeamWarning.textContent = '';
             confirmDeleteTeamBtn.disabled = false;
             confirmDeleteTeamBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        teamIdToDelete = teamId;
        deleteTeamModalName.textContent = teamName;
        deleteTeamConfirmModal.classList.remove('hidden');
    }

    async function performDeleteTeam() {
        if (!teamIdToDelete || confirmDeleteTeamBtn.disabled) return;
        try {
            await deleteDoc(doc(db, teamsCollectionPath, teamIdToDelete));
        } catch (error) {
            console.error("Error deleting team: ", error);
            deleteTeamError.textContent = 'Error deleting team.';
        }
        closeDeleteTeamModal();
    }
    
    function closeDeleteTeamModal() {
        teamIdToDelete = null;
        deleteTeamConfirmModal.classList.add('hidden');
    }

    closeEditTeamModalBtn.addEventListener('click', closeEditTeamModal);
    editTeamModal.addEventListener('click', (e) => { if (e.target === editTeamModal) closeEditTeamModal(); });
    editTeamPatternLength.addEventListener('change', renderVisualPatternCells);
    
    closePatternModalBtn.addEventListener('click', closePatternShiftModal);
    patternShiftModal.addEventListener('click', (e) => { if (e.target === patternShiftModal) closePatternShiftModal(); });
    
    cancelDeleteTeamBtn.addEventListener('click', closeDeleteTeamModal); 
    confirmDeleteTeamBtn.addEventListener('click', performDeleteTeam);
    deleteTeamConfirmModal.addEventListener('click', (e) => { if (e.target === deleteTeamConfirmModal) closeDeleteTeamModal(); });

    
    // --- Profile Management ---
    
    function getLeaveUsage(leaveType) {
        if (!currentUserProfile) return { used: 0, allocated: 0 };
        
        let allocated = 0;
        if (leaveType === 'Annual Leave') {
            allocated = currentUserProfile.annualLeaveAllocated || 0;
        } else if (leaveType === 'Public Holiday') {
            allocated = currentUserProfile.publicHolidayAllocated || 0;
        }
        
        const used = requests.reduce((total, req) => {
            if (req.userId === auth.currentUser.uid && req.leaveType === leaveType) {
                const approvedDays = req.days.filter(day => day.status === 'Approved' || day.status === 'Write-in').length;
                return total + approvedDays;
            }
            return total;
        }, 0);
        
        return { used, allocated };
    }
    
    function renderMyProfile() {
        if (!currentUserProfile) return;
        
        profileName.value = currentUserProfile.username;
        profileStaffID.value = currentUserProfile.staffID;
        profileEmail.value = currentUserProfile.email;
        const team = teamsMap.get(currentUserProfile.team_id);
        profileTeam.value = team ? team.name : 'N/A';
        
        profileAnnualLeave.value = currentUserProfile.annualLeaveAllocated || 0;
        profilePublicHoliday.value = currentUserProfile.publicHolidayAllocated || 0;
        
        const al = getLeaveUsage('Annual Leave');
        profileUsedAL.textContent = al.used;
        profileBalanceAL.textContent = al.allocated - al.used;
        profileBalanceAL.className = (al.allocated - al.used) < 0 ? 'text-red-600 font-bold' : 'text-green-700 font-bold';
        
        const ph = getLeaveUsage('Public Holiday');
        profileUsedPH.textContent = ph.used;
        profileBalancePH.textContent = ph.allocated - ph.used;
        profileBalancePH.className = (ph.allocated - ph.used) < 0 ? 'text-red-600 font-bold' : 'text-green-700 font-bold';
    }
    
    profileLeaveForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        profileSaveStatus.textContent = "Saving...";
        
        const newAL = parseFloat(profileAnnualLeave.value) || 0;
        const newPH = parseFloat(profilePublicHoliday.value) || 0;
        
        try {
            const userDocRef = doc(db, usersCollectionPath, currentUserProfile.id);
            await updateDoc(userDocRef, {
                annualLeaveAllocated: newAL,
                publicHolidayAllocated: newPH
            });

            // Also update the shared employees collection so that roster and leave planner
            // remain in sync.  Only update the leave balance fields.
            try {
                const empDocRef = doc(db, "employees", currentUserProfile.id);
                await updateDoc(empDocRef, {
                    annualLeaveAllocated: newAL,
                    publicHolidayAllocated: newPH
                });
            } catch (empUpdateError) {
                console.error("Error updating employees collection:", empUpdateError);
            }

            profileSaveStatus.textContent = "Saved successfully!";
            setTimeout(() => { profileSaveStatus.textContent = ""; }, 3000);

        } catch (err) {
            console.error("Error saving profile:", err);
            profileSaveStatus.textContent = "Error saving.";
            showAlert("Error saving profile: " + err.message);
        }
    });

    
    // --- Admin Leave Balance Report ---
    
    function renderLeaveBalanceReport() {
        if (userType !== 'admin') return;
        
        const tbody = document.getElementById("leaveBalanceTableBody");
        tbody.innerHTML = "";
        
        if (allUsers.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">No users found.</td></tr>`;
            return;
        }

        allUsers.sort((a,b) => a.username.localeCompare(b.username)).forEach(user => {
            const team = teamsMap.get(user.team_id);
            const teamName = team ? team.name : 'N/A';
            const teamColorClass = team ? (team.colorSet.dot || 'bg-gray-400') : 'bg-gray-400';

            const allocatedAL = user.annualLeaveAllocated || 0;
            const usedAL = requests.reduce((total, req) => {
                if (req.staffID === user.staffID && req.leaveType === 'Annual Leave' && (req.userId === user.id || req.userId.startsWith('admin_entry_'))) {
                    return total + req.days.filter(d => d.status === 'Approved' || d.status === 'Write-in').length;
                }
                return total;
            }, 0);
            const balanceAL = allocatedAL - usedAL;
            
            const allocatedPH = user.publicHolidayAllocated || 0;
            const usedPH = requests.reduce((total, req) => {
                if (req.staffID === user.staffID && req.leaveType === 'Public Holiday' && (req.userId === user.id || req.userId.startsWith('admin_entry_'))) {
                    return total + req.days.filter(d => d.status === 'Approved' || d.status === 'Write-in').length;
                }
                return total;
            }, 0);
            const balancePH = allocatedPH - usedPH;

            const tr = document.createElement("tr");
            tr.className = "border-b hover:bg-gray-50";
            const numericIdForUser = String(user.staffID).replace(/^[A-Za-z]+/, '');
            tr.innerHTML = `
                <td class="p-3">${user.username} (${numericIdForUser})</td>
                <td class="p-3">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full ${teamColorClass} flex-shrink-0"></div>
                        <span>${teamName}</span>
                    </div>
                </td>
                <td class="p-3 text-center">${allocatedAL}</td>
                <td class="p-3 text-center">${usedAL}</td>
                <td class="p-3 text-center font-bold bg-blue-50 ${balanceAL < 0 ? 'text-red-600' : 'text-green-700'}">${balanceAL}</td>
                <td class="p-3 text-center">${allocatedPH}</td>
                <td class="p-3 text-center">${usedPH}</td>
                <td class="p-3 text-center font-bold bg-purple-50 ${balancePH < 0 ? 'text-red-600' : 'text-green-700'}">${balancePH}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Leave Freeze Functions (Admin) ---
    
    function renderLeaveFreezeList() {
        if (userType !== 'admin') return;
        freezeDateList.innerHTML = "";
        
        if (leaveFreezeDates.size === 0) {
            freezeDateList.innerHTML = '<li class="p-3 text-gray-500 italic">No leave freeze dates set.</li>';
            return;
        }

        const sortedDates = [...leaveFreezeDates].sort();
        
        sortedDates.forEach(dateStr => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-3';
            li.innerHTML = `
                <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                  <span class="font-medium">${displayFormatDate(dateStr)}</span>
                  ${(() => {
                      const meta = leaveFreezeMeta.get(dateStr) || {};
                      const t = meta.type || '';
                      const r = meta.reason || '';
                      const badge = t ? `<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">${escapeHTML(t)}</span>` : '';
                      const reason = r ? `<span class="text-xs text-gray-500">${escapeHTML(r)}</span>` : '';
                      return badge + reason;
                  })()}
                </div>
                <button class="remove-freeze-date-btn text-red-500 hover:text-red-700 text-xs font-semibold" data-date="${dateStr}">
                  Remove
                </button>
            `;
            freezeDateList.appendChild(li);
        });

        freezeDateList.querySelectorAll('.remove-freeze-date-btn').forEach(btn => {
            btn.onclick = async () => {
                const dateStr = btn.dataset.date;
                requestIdToDelete = `FREEZE_${dateStr}`; 
                userDeleteRequestInfo.textContent = `Removing freeze for: ${displayFormatDate(dateStr)}`;
                userDeleteConfirmModal.classList.remove('hidden');
            };
        });
    }

    addFreezeDateForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const startStr = (freezeStartDateInput?.value || '').trim();
        let endStr = (freezeEndDateInput?.value || '').trim();

        if (!startStr) {
            return showAlert("Please select a start date.");
        }
        if (!endStr) endStr = startStr; 

        if (endStr < startStr) {
            return showAlert("End date cannot be earlier than start date.");
        }

        const startDate = new Date(startStr + 'T00:00:00');
        const endDate = new Date(endStr + 'T00:00:00');

        const batch = writeBatch(db);
        let added = 0;
        let skipped = 0;
        const newlyAdded = [];

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const iso = formatDate(d);
            if (leaveFreezeDates.has(iso)) {
                skipped++;
                continue;
            }
            batch.set(doc(db, leaveFreezeCollectionPath, iso), {
                frozen: true,
                type: (freezeTypeInput?.value || 'Event'),
                reason: (freezeReasonInput?.value || '').trim(),
                addedAt: new Date().toISOString(),
                addedBy: (auth.currentUser?.email || '')
            });
            added++;
            newlyAdded.push(iso);
        }

        if (added === 0) {
            return showAlert(skipped > 0 ? "All selected dates are already frozen." : "No dates selected.");
        }

        try {
            await batch.commit();
            newlyAdded.forEach(iso => {
                leaveFreezeDates.add(iso);
                leaveFreezeMeta.set(iso, {
                    frozen: true,
                    type: (freezeTypeInput?.value || 'Event'),
                    reason: (freezeReasonInput?.value || '').trim()
                });
            });
            if (userType === "admin") { renderLeaveFreezeList(); }
            renderCalendar();
            showAlert(`Freeze added: ${added} date(s)${skipped ? ` (skipped ${skipped} already frozen)` : ""}.`, false);
            addFreezeDateForm.reset();
        } catch (err) {
            console.error("Error adding freeze range:", err);
            showAlert("Error adding freeze range: " + err.message);
        }
    });

    function closeUserDeleteModal() {
        requestIdToDelete = null;
        userDeleteConfirmModal.classList.add('hidden');
    }

    cancelUserDeleteBtn.addEventListener('click', closeUserDeleteModal);
    userDeleteConfirmModal.addEventListener('click', (e) => { if (e.target === userDeleteConfirmModal) closeUserDeleteModal(); });

    confirmUserDeleteBtn.addEventListener('click', async () => {
        if (!requestIdToDelete) return;
        
        try {
            if (requestIdToDelete.startsWith('FREEZE_')) {
                const dateStr = requestIdToDelete.substring(7);
                await deleteDoc(doc(db, leaveFreezeCollectionPath, dateStr));
                showAlert("Freeze date removed.", false);
            } else {
                await deleteDoc(doc(db, leaveRequestsCollectionPath, requestIdToDelete));
                showAlert("Request deleted successfully.", false);
            }
        } catch (err) {
            console.error("Delete error:", err);
            showAlert("Error deleting item: " + err.message);
        }
        
        closeUserDeleteModal();
    });

    
    // --- NEW: Staff History Logic ---

    // Populate the dropdown
    function renderStaffHistoryPanel() {
        // Clear existing options
        historyStaffSelect.innerHTML = '<option value="">-- Select a Staff Member --</option>';
        // Reset the label showing the selected staff name/ID
        const historyStaffLabelEl = document.getElementById('historyStaffLabel');
        if (historyStaffLabelEl) {
            historyStaffLabelEl.textContent = '';
        }
        // Default date range = current month
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2,'0');
        historyFromDate.value = `${y}-${m}-01`;
        historyToDate.value = `${y}-${m}-${String(new Date(y, now.getMonth()+1, 0).getDate()).padStart(2,'0')}`;
        historyGenerateBtn.disabled = true;
        historyDownloadBtn.disabled = true;
        historyTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500 italic">Select a staff member above.</td></tr>`;
        
        if (!allUsers || allUsers.length === 0) return;
        
        // Build a unique set of staff IDs from leave requests, user profiles,
        // and roster employees.  This ensures that all staff who have either
        // submitted leave requests, are registered users, or exist in the roster
        // appear in the dropdown.
        const staffIdsSet = new Set();
        if (Array.isArray(requests)) {
            requests.forEach(req => {
                if (req && req.staffID) staffIdsSet.add(req.staffID);
            });
        }
        if (Array.isArray(allUsers)) {
            allUsers.forEach(user => {
                if (user && user.staffID) staffIdsSet.add(user.staffID);
            });
        }
        if (employeesMap && employeesMap.size > 0) {
            employeesMap.forEach((name, empId) => {
                staffIdsSet.add(empId);
            });
        }
        // Build canonical IDs by normalizing staff IDs.  We remove any leading
        // alphabet characters (e.g., 'T' for training IDs) and then strip
        // leading zeros.  If multiple IDs normalize to the same trimmed form,
        // keep the first encountered as the canonical value.  This avoids
        // duplicate entries such as "T05045", "05045" and "5045".
        const idToCanonical = {};
        staffIdsSet.forEach((origId) => {
            const rawStr = String(origId);
            const cleaned = rawStr.replace(/^[A-Za-z]+/, '');
            const trimmed = cleaned.replace(/^0+/, '');
            if (!(trimmed in idToCanonical)) {
                idToCanonical[trimmed] = origId;
            }
        });
        const canonicalIds = Object.values(idToCanonical);
        // Convert to array with names using helper
        const staffList = canonicalIds.map(id => {
            return { id, name: getDisplayName(id) };
        });
        // Sort alphabetically by name
        staffList.sort((a,b) => a.name.localeCompare(b.name));
        // Populate the dropdown
        staffList.forEach(({ id, name }) => {
            const opt = document.createElement("option");
            opt.value = id;
            // Remove any leading alphabet characters for display only
            const displayId = String(id).replace(/^[A-Za-z]+/, '');
            opt.textContent = `${name} (${displayId})`;
            historyStaffSelect.appendChild(opt);
        });
    }

    // Update the table when a user is selected
    window.updateHistoryTable = (selectedStaffID, fromStr, toStr) => {
        historyTableBody.innerHTML = "";
        // Display the selected staff name and ID when generating history
        const staffLabelElement = document.getElementById('historyStaffLabel');
        if (staffLabelElement) {
            if (selectedStaffID) {
                const name = getDisplayName(selectedStaffID);
                // Remove any leading alphabet characters for display ID
                const displayId = String(selectedStaffID).replace(/^[A-Za-z]+/, '');
                staffLabelElement.textContent = `${name} (${displayId})`;
            } else {
                staffLabelElement.textContent = '';
            }
        }

        // Guard
            if (!selectedStaffID) {
            historyTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500 italic">Select a staff member above.</td></tr>`;
            historyDownloadBtn.disabled = true;
            // Clear the label when nothing is selected
            if (staffLabelElement) staffLabelElement.textContent = '';
            return;
        }

        if (!fromStr || !toStr) {
            historyTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500 italic">Please select a <b>From</b> and <b>To</b> date, then click <b>Generate</b>.</td></tr>`;
            historyDownloadBtn.disabled = true;
            return;
        }

        // Normalize range (swap if needed)
        let from = new Date(fromStr);
        let to = new Date(toStr);
        if (from > to) [from, to] = [to, from];

        // Filter requests for this staffID, by overlap with the selected date range
        const userRequests = requests.filter(req => {
            if (req.staffID !== selectedStaffID) return false;
            if (!req.fromDate || !req.toDate) return false;

            const reqFrom = new Date(req.fromDate);
            const reqTo = new Date(req.toDate);
            return (reqFrom <= to && reqTo >= from);
        });

        if (userRequests.length === 0) {
            historyTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No leave history found for this user in the selected range.</td></tr>`;
            historyDownloadBtn.disabled = true;
            return;
        }

        // Sort by newest date first
        userRequests.sort((a,b) => new Date(b.fromDate) - new Date(a.fromDate));

        userRequests.forEach(req => {
            // Calculate status overview (limit to days inside range, if days array exists)
            const daysInRange = (req.days || []).filter(d => {
                if (!d.date) return false;
                const dd = new Date(d.date);
                return dd >= from && dd <= to;
            });

            const baseDays = daysInRange.length ? daysInRange : (req.days || []);
            const totalDays = baseDays.length;

            const approvedCount = baseDays.filter(d => d.status === 'Approved').length;
            const pendingCount = baseDays.filter(d => d.status === 'Pending').length;
            const rejectedCount = baseDays.filter(d => d.status === 'Rejected').length;
            const writeInCount = baseDays.filter(d => d.status === 'Write-in').length;

            let statusBadge = '';
            let details = '';
            if (approvedCount === totalDays) {
                statusBadge = '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Approved</span>';
            } else if (pendingCount === totalDays) {
                statusBadge = '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">Pending</span>';
            } else if (rejectedCount === totalDays) {
                statusBadge = '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">Rejected</span>';
            } else if (writeInCount === totalDays) {
                statusBadge = '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">Write-in</span>';
            } else {
                statusBadge = '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">Mixed</span>';
                const parts = [];
                if(approvedCount) parts.push(`${approvedCount} Appr`);
                if(pendingCount) parts.push(`${pendingCount} Pend`);
                if(rejectedCount) parts.push(`${rejectedCount} Rej`);
                if(writeInCount) parts.push(`${writeInCount} W-in`);
                details = `<span class="text-xs text-gray-500">(${parts.join(', ')})</span>`;
            }

            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50";
            tr.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-900">${req.leaveType || 'Leave'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-gray-600">${displayFormatDate(req.fromDate)} - ${displayFormatDate(req.toDate)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-center text-gray-600 font-semibold">${totalDays}</td>
                <td class="px-4 py-3 whitespace-nowrap text-center">${statusBadge}</td>
                <td class="px-4 py-3 text-gray-500 text-sm">
                    ${details ? details : ''}
                    <div class="text-xs text-gray-400 mt-0.5">Ref: ${req.id.substring(0,8)}...</div>
                </td>
            `;
            historyTableBody.appendChild(tr);
        });

        historyDownloadBtn.disabled = false;
    };

    // Export current history table to PDF
    window.downloadHistoryPDF = () => {
        const selectedId = historyStaffSelect.value;
        let staffLabel;
        if (selectedId) {
            const name = getDisplayName(selectedId);
            // Remove leading alphabet characters for display ID
            const displayId = String(selectedId).replace(/^[A-Za-z]+/, '');
            staffLabel = `${name} (${displayId})`;
        } else {
            const staffOpt = historyStaffSelect.options[historyStaffSelect.selectedIndex];
            staffLabel = staffOpt ? staffOpt.textContent : (historyStaffSelect.value || 'Staff');
        }
        const fromStr = historyFromDate.value;
        const toStr = historyToDate.value;

        const rows = document.querySelectorAll("#historyTableBody tr");
        const bodyData = [];
        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            if (cells.length === 5) {
                bodyData.push([
                    cells[0].innerText.trim(),
                    cells[1].innerText.trim(),
                    cells[2].innerText.trim(),
                    cells[3].innerText.trim(),
                    cells[4].innerText.replace(/\s+/g,' ').trim()
                ]);
            }
        });

        if (bodyData.length === 0) {
            showAlert("No history data to export.", true);
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Staff Leave History`, 14, 14);
        doc.setFontSize(10);
        doc.text(`${staffLabel}`, 14, 20);
        doc.text(`Range: ${fromStr || '-'} to ${toStr || '-'}`, 14, 25);

        doc.autoTable({
            head: [["Type", "Date Range", "Days", "Status", "Details"]],
            body: bodyData,
            startY: 30,
            theme: "grid",
            styles: { fontSize: 9, cellPadding: 2 },
            columnStyles: {
                0: { cellWidth: 26 },
                1: { cellWidth: 45 },
                2: { cellWidth: 12, halign: 'center' },
                3: { cellWidth: 20 },
                4: { cellWidth: 'auto' }
            }
        });

        showPDFPreview(doc);
    };


    // Attach event listeners (require date selection before generating)
    historyStaffSelect.addEventListener('change', (e) => {
        historyGenerateBtn.disabled = !e.target.value;
        historyDownloadBtn.disabled = true;
        historyTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500 italic">Pick a date range and click <b>Generate</b>.</td></tr>`;
    });

    historyGenerateBtn.addEventListener('click', () => {
        const staffId = historyStaffSelect.value;
        window.updateHistoryTable(staffId, historyFromDate.value, historyToDate.value);
    });

    historyDownloadBtn.addEventListener('click', () => {
        window.downloadHistoryPDF();
    });

    
    // --- Tab & Navigation Functions ---
    
    window.setCalendarView = (mode) => {
        calendarViewMode = mode;

        if (mode === 'personal') {
            personalViewBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            personalViewBtn.classList.remove('bg-transparent', 'text-gray-700', 'hover:bg-gray-300');
            masterViewBtn.classList.add('bg-transparent', 'text-gray-700', 'hover:bg-gray-300');
            masterViewBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
        } else {
            masterViewBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            masterViewBtn.classList.remove('bg-transparent', 'text-gray-700', 'hover:bg-gray-300');
            personalViewBtn.classList.add('bg-transparent', 'text-gray-700', 'hover:bg-gray-300');
            personalViewBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
        }

        renderCalendar();
        renderAdmin(); 
    }

    window.selectTeam = (teamId) => {
      selectedTeamId = teamId;
      
      const teamButtonsContainer = document.getElementById("team-buttons");
      teamButtonsContainer.querySelectorAll('button.team-button').forEach(btn => {
          const btnTeamId = btn.dataset.teamId;
          const team = teamsMap.get(btnTeamId);
          if (!team || !team.colorSet) return; 

          if (btnTeamId === teamId) {
              btn.className = `team-button px-3 py-1.5 rounded-md text-sm transition-colors ${team.colorSet.selected}`;
          } else {
              btn.className = `team-button px-3 py-1.5 rounded-md text-sm transition-colors ${team.colorSet.btn}`;
          }
      });
      
      renderCalendar();
    }
    
    window.prevMonth = async () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      referenceDate = new Date(currentYear, currentMonth, 1);
      await renderCalendar();
    }
    window.nextMonth = async () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      referenceDate = new Date(currentYear, currentMonth, 1);
      await renderCalendar();
    }
    
    function setActiveTab(activeIndex) {
        // Hide all panels
        document.getElementById("myProfilePanel").style.display = "none";
        document.getElementById("leaveManagementPanel").style.display = "none";
        
        const leaveBalancePanel = document.getElementById("leaveBalancePanel");
        if (leaveBalancePanel) leaveBalancePanel.style.display = "none";
        
        const userManagementPanel = document.getElementById("userManagementPanel");
        if (userManagementPanel) userManagementPanel.style.display = "none";
        
        const teamManagementPanel = document.getElementById("teamManagementPanel");
        if (teamManagementPanel) teamManagementPanel.style.display = "none";

        const leaveFreezePanel = document.getElementById("leaveFreezePanel"); 
        if (leaveFreezePanel) leaveFreezePanel.style.display = "none"; 
        
        // NEW: Hide Staff History
        const staffHistoryPanel = document.getElementById("staffHistoryPanel");
        if (staffHistoryPanel) staffHistoryPanel.style.display = "none";
        
        // Show active
        if (activeIndex === 0) {
            document.getElementById("myProfilePanel").style.display = "block";
        } else if (activeIndex === 1) {
            document.getElementById("leaveManagementPanel").style.display = "block";
            setCalendarView(calendarViewMode); 
        } else if (activeIndex === 2 && leaveBalancePanel) {
            leaveBalancePanel.style.display = "block";
        } else if (activeIndex === 3 && userManagementPanel) {
            userManagementPanel.style.display = "block";
        } else if (activeIndex === 4 && teamManagementPanel) {
            teamManagementPanel.style.display = "block";
        } else if (activeIndex === 5 && leaveFreezePanel) { 
            leaveFreezePanel.style.display = "block"; 
        } else if (activeIndex === 6 && staffHistoryPanel) { // NEW
            staffHistoryPanel.style.display = "block";
        }
        
        // Update tab buttons
        const tabs = document.querySelectorAll("#mainTabs .main-nav-button");
        tabs.forEach((tab, index) => {
            if (index === activeIndex) {
                tab.classList.add("active-tab");
            } else {
                tab.classList.remove("active-tab");
            }
        });
    }

    window.showMyProfile = () => {
        setActiveTab(0);
        renderMyProfile(); 
    }
    window.showLeaveManagement = () => {
        setActiveTab(1);
    }
    window.showLeaveBalanceReport = () => {
        setActiveTab(2);
        renderLeaveBalanceReport(); 
    }
    window.showUserManagement = () => {
        setActiveTab(3);
        renderUserManagement(); 
    }
    window.showTeamManagement = () => {
        setActiveTab(4);
        openManageTeamsModal(); 
    }
    window.showLeaveFreeze = () => {
        setActiveTab(5);
        renderLeaveFreezeList(); 
    }
    // NEW: Show Staff History
    window.showStaffHistory = () => {
        setActiveTab(6);
        renderStaffHistoryPanel();
    }
    

  </script>
</body>
</html>