<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leave Booking System (Single File)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ========== Basic Styles ========== */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f4f4f4;
      color: #333;
      font-size: 14px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; margin-top: 10px; font-size: 20px; }
    .header p { text-align: center; font-size: 12px; color: #666; margin: 4px 0; }
    
    /* ========== Leave Request Form ========== */
    #leaveForm {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 12px;
    }
    #leaveForm input, #leaveForm button {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #leaveForm button {
      background: #4CAF50;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    #leaveForm button:hover {
      background: #45a049;
    }
    
    /* ========== Team Shift Buttons ========== */
    .team-buttons {
      text-align: center;
      margin-bottom: 12px;
    }
    .team-buttons button {
      margin: 0 5px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      transition: opacity 0.2s;
    }
    .team-buttons button:hover { opacity: 0.9; }
    .team-a { background: #228B22; } /* Forest Green */
    .team-b { background: #0066cc; }
    .team-c { background: #9C27B0; }
    
    /* ========== Month Navigation ========== */
    .month-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .month-nav button {
      padding: 4px 12px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #666;
      color: #fff;
    }
    .month-nav button:hover { opacity: 0.9; }
    #monthLabel { font-weight: bold; font-size: 14px; }
    
    /* ========== Calendar ========== */
    .calendar-header {
      text-align: center;
      margin: 10px 0;
      font-weight: bold;
      font-size: 16px;
    }
    #calendarGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      max-width: 700px;
      margin: 0 auto 10px auto;
    }
    .day-cell {
      background: #fff;
      border: 1px solid #ccc;
      min-height: 70px;
      padding: 4px;
      border-radius: 4px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .shift-box {
      font-weight: bold;
      color: #fff;
      padding: 2px 4px;
      border-radius: 3px;
      text-align: center;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .shift-morning { background-color: #228B22; }
    .shift-night   { background-color: #90EE90; color: #000; }
    .shift-off     { background-color: #ddd; color: #000; }
    .leave-entry {
      background: #fff9c4;
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 11px;
      width: 100%;
      box-sizing: border-box;
    }
    .leave-entry.approved {
      background: #c8e6c9;
      font-weight: bold;
    }
    .leave-entry.rejected {
      background: #f8d7da;
      color: #721c24;
      text-decoration: line-through;
    }
    .red-dot {
      width: 8px;
      height: 8px;
      background: red;
      border-radius: 50%;
      position: absolute;
      top: 4px;
      right: 4px;
    }
    
    /* ========== Admin Summary ========== */
    #adminSummary {
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
    }
    .admin-card {
      background: #f1f1f1;
      border: 1px solid #ddd;
      margin: 4px 0;
      padding: 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    .admin-card select {
      margin-left: 6px;
    }
    .admin-card button {
      margin-left: 6px;
      padding: 2px 6px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      background: #d9534f;
      color: #fff;
      cursor: pointer;
    }
    .admin-card button:hover { opacity: 0.9; }
    .whatsapp-btn {
      background: #25D366;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 6px;
    }
    .whatsapp-btn:hover { opacity: 0.9; }
    
    /* ========== Footer ========== */
    .footer {
      text-align: center;
      color: #999;
      font-size: 11px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Leave Booking System (Single File)</h1>
      <p style="font-size:12px; color:#666; margin:0;">v2.4 - Shift box at top only, WhatsApp per request</p>
    </div>
    
    <!-- LEAVE REQUEST FORM -->
    <form id="leaveForm">
      <input type="text" id="staffName" placeholder="Staff Name" required>
      <input type="text" id="staffID" placeholder="Staff ID" required>
      <input type="date" id="startDate" required>
      <input type="date" id="endDate" required>
      <button type="submit">Submit</button>
    </form>
    
    <!-- TEAM SHIFT BUTTONS -->
    <div class="team-buttons">
      <button class="team-a" onclick="selectTeam(1)">Team A</button>
      <button class="team-b" onclick="selectTeam(2)">Team B</button>
      <button class="team-c" onclick="selectTeam(3)">Team C</button>
    </div>
    
    <!-- MONTH NAVIGATION -->
    <div class="month-nav">
      <button onclick="prevMonth()">←</button>
      <span id="monthLabel">Loading...</span>
      <button onclick="nextMonth()">→</button>
    </div>
    
    <!-- CALENDAR -->
    <div class="calendar-header">Shift Calendar</div>
    <div id="calendarGrid"></div>
    
    <!-- ADMIN SUMMARY -->
    <div id="adminSummary">
      <h3>Admin Summary</h3>
      <div id="adminList"></div>
    </div>
    
    <div class="footer">&copy; 2025. Single-file. v2.4</div>
  </div>
  
  <script>
    /* ==== SHIFT PATTERNS ==== */
    const TeamPatterns = {
      1: ["morning","morning","night","night","off","off"],
      2: ["off","off","morning","morning","night","night"],
      3: ["night","night","off","off","morning","morning"]
    };
    let selectedTeam = 1;
    const referenceDate = new Date(2025, 2, 1);
    
    /* ==== UTILS ==== */
    function daysBetween(a, b) {
      const A = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
      const B = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.floor((B - A) / (1000 * 60 * 60 * 24));
    }
    function formatDate(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    function getShift(dateObj) {
      const diff = daysBetween(referenceDate, dateObj);
      const index = ((diff % 6) + 6) % 6;
      return TeamPatterns[selectedTeam][index];
    }
    
    /* ==== LOCAL STORAGE ==== */
    function loadRequests() {
      return JSON.parse(localStorage.getItem("leaveRequests") || "[]");
    }
    function saveRequests(arr) {
      localStorage.setItem("leaveRequests", JSON.stringify(arr));
    }
    
    /* ==== GLOBAL MONTH STATE ==== */
    let currentYear = 2025, currentMonth = 2; // March
    
    /* ==== RENDER CALENDAR ==== */
    function renderCalendar() {
      const monthNames = ["January","February","March","April","May","June",
                          "July","August","September","October","November","December"];
      document.getElementById("monthLabel").textContent = monthNames[currentMonth] + " " + currentYear;
      const grid = document.getElementById("calendarGrid");
      grid.innerHTML = "";
      
      const requests = loadRequests();
      const firstDay = new Date(currentYear, currentMonth, 1);
      const offset = (firstDay.getDay() + 6) % 7;
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      // Fill blank cells
      for (let i = 0; i < offset; i++) {
        const blank = document.createElement("div");
        blank.className = "day-cell";
        grid.appendChild(blank);
      }
      
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(currentYear, currentMonth, d);
        const dateStr = formatDate(dateObj);
        const cell = document.createElement("div");
        cell.className = "day-cell";
        
        // SHIFT BOX at top (only small colored box)
        const shift = getShift(dateObj);
        const shiftBox = document.createElement("div");
        shiftBox.className = "shift-box";
        if (shift === "morning") shiftBox.classList.add("shift-morning");
        if (shift === "night") shiftBox.classList.add("shift-night");
        if (shift === "off") shiftBox.classList.add("shift-off");
        shiftBox.textContent = d; // day number in the box
        cell.appendChild(shiftBox);
        
        // Filter requests for this day
        const dailyReqs = requests.filter(r => dateStr >= r.startDate && dateStr <= r.endDate);
        const nonRejectedCount = dailyReqs.filter(r => r.status !== "Rejected").length;
        if (nonRejectedCount > 2) {
          const dot = document.createElement("div");
          dot.className = "red-dot";
          cell.appendChild(dot);
        }
        
        dailyReqs.forEach(r => {
          const entry = document.createElement("div");
          entry.className = "leave-entry";
          if (r.status === "Approved") entry.classList.add("approved");
          if (r.status === "Rejected") entry.classList.add("rejected");
          entry.textContent = `${r.staffName} (${r.staffID})`;
          cell.appendChild(entry);
        });
        
        grid.appendChild(cell);
      }
      renderAdmin();
    }
    
    /* ==== RENDER ADMIN SUMMARY ==== */
    function renderAdmin() {
      const adminList = document.getElementById("adminList");
      adminList.innerHTML = "";
      const arr = loadRequests();
      arr.forEach((r, idx) => {
        const card = document.createElement("div");
        card.className = "admin-card";
        card.innerHTML = `
          <strong>${r.staffName}</strong> (${r.staffID})<br>
          ${r.startDate} → ${r.endDate}<br>
          Status:
          <select data-idx="${idx}">
            <option value="Pending" ${r.status === "Pending" ? "selected" : ""}>Pending</option>
            <option value="Approved" ${r.status === "Approved" ? "selected" : ""}>Approved</option>
            <option value="Partially Approved" ${r.status === "Partially Approved" ? "selected" : ""}>Partially Approved</option>
            <option value="Rejected" ${r.status === "Rejected" ? "selected" : ""}>Rejected</option>
          </select>
          <button data-del="${idx}" style="margin-left:6px;">Delete</button>
          <button class="whatsapp-btn" data-ws="${idx}">WhatsApp</button>
        `;
        adminList.appendChild(card);
      });
      
      // Handle status change
      adminList.querySelectorAll("select").forEach(sel => {
        sel.onchange = () => {
          const i = sel.dataset.idx;
          let all = loadRequests();
          // If admin sets to Approved, mark entire range as approved.
          if (sel.value === "Approved") {
            all[i].status = "Approved";
          } else if (sel.value === "Rejected") {
            all[i].status = "Rejected";
          } else if (sel.value === "Partially Approved") {
            all[i].status = "Partially Approved";
          } else {
            all[i].status = "Pending";
          }
          saveRequests(all);
          renderCalendar();
        };
      });
      
      // Handle delete
      adminList.querySelectorAll("button[data-del]").forEach(btn => {
        btn.onclick = () => {
          const i = btn.dataset.del;
          let all = loadRequests();
          all.splice(i, 1);
          saveRequests(all);
          renderCalendar();
        };
      });
      
      // Handle individual WhatsApp button for each request
      adminList.querySelectorAll("button.whatsapp-btn").forEach(btn => {
        btn.onclick = () => {
          const i = btn.dataset.ws;
          let all = loadRequests();
          const req = all[i];
          const msg = `Hello ${req.staffName} (${req.staffID}), your leave from ${req.startDate} to ${req.endDate} is currently "${req.status}".`;
          const link = "https://wa.me/?text=" + encodeURIComponent(msg);
          window.open(link, "_blank");
        };
      });
    }
    
    /* ==== FORM SUBMISSION ==== */
    document.getElementById("leaveForm").addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("staffName").value.trim();
      const id = document.getElementById("staffID").value.trim();
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      if (!name || !id || !start || !end) {
        alert("All fields required");
        return;
      }
      if (end < start) {
        alert("End date must not be before start date.");
        return;
      }
      
      let arr = loadRequests();
      arr.push({ staffName: name, staffID: id, startDate: start, endDate: end, status: "Pending" });
      saveRequests(arr);
      e.target.reset();
      renderCalendar();
      alert("Leave request submitted!");
    });
    
    /* ==== TEAM SELECTION ==== */
    function selectTeam(teamNum) {
      selectedTeam = teamNum;
      renderCalendar();
    }
    
    /* ==== MONTH NAVIGATION ==== */
    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
    }
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
    }
    
    /* ==== INITIAL RENDER ==== */
    renderCalendar();
  </script>
</body>
</html>