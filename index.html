<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leave & Roster Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Optional: Include jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Base Styles */
    body {
      font-family: Arial, sans-serif; 
      font-size: 13px; 
    }
    
    /* Custom styles for leave entries (from original) */
    .leave-entry.pending   { background: #fff3cd; }
    .leave-entry.approved  { background: #d4edda; font-weight: 600; }
    .leave-entry.rejected  { background: #f8d7da; color: #721c24; text-decoration: line-through; }
    .leave-entry.write-in  { background: #ffeeba; }
    
    /* Custom styles for accordion summary */
    .status-dot.pending   { background: #e67e22; }
    .status-dot.approved  { background: #27ae60; }
    .status-dot.rejected  { background: #e74c3c; }
    .status-dot.write-in  { background: #f1c40f; }

    /* Custom styles for summary table */
    .range-block.approved  .status-dot { background: #27ae60; }
    .range-block.pending   .status-dot { background: #e67e22; }
    .range-block.rejected  .status-dot { background: #e74c3c; }
    .range-block.write-in  .status-dot { background: #f1c40f; }

    /* Hide spinners on number inputs */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    /* Team Management Modal Styles */
    .team-li:hover .edit-team-btn { opacity: 1; }
    .modal-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <!-- LOADING SPINNER -->
  <div id="loading" class="absolute inset-0 bg-gray-100 flex flex-col items-center justify-center z-50" style="display: flex;">
    <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-4 text-lg font-semibold text-gray-700">Loading Planner...</p>
  </div>

  <!-- LOGIN SECTION -->
  <div id="loginSection" class="max-w-md w-full bg-white p-6 rounded-lg shadow-md" style="display: none;">
    <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Leave Planner Login</h2>
    
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="password" id="loginPassword" placeholder="Password" class="w-full px-4 py-2 mb-4 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <button id="loginButton" type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">Login</button>
      <button onclick="showRegisterForm()" type="button" class="w-full mt-2 text-blue-600 hover:underline">Don't have an account? Register</button>
    </form>
    
    <form id="userRegisterForm" style="display: none;">
      <input type="text" id="regUsername" placeholder="Full Name (e.g., John Doe)" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="text" id="regStaffID" placeholder="Staff ID (e.g., S999)" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="tel" id="regMobile" placeholder="Mobile Number (e.g. +6512345678)" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="email" id="regEmail" placeholder="Email" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <input type="password" id="regPassword" placeholder="Password" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      <select id="regTeam" class="w-full px-4 py-2 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        <option value="">Select a team...</option>
      </select>
      <input type="password" id="regAdminSecret" placeholder="Admin Secret Code (if any)" class="w-full px-4 py-2 mb-4 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button id="registerButton" type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition-colors">Register</button>
      <button onclick="showLoginForm()" type="button" class="w-full mt-2 text-blue-600 hover:underline">Already have an account? Login</button>
    </form>

    <!-- Custom Alert Box -->
    <div id="customAlert" class="fixed top-5 right-5 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg" style="display: none; z-index: 1000;">
      <span id="customAlertMessage"></span>
    </div>

  </div>
  
  <!-- Main Container (hidden until login) -->
  <div class="container max-w-7xl w-full mx-auto bg-white p-4 rounded-lg shadow-lg" style="display: none;">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800">Leave & Roster System <sup class="text-xs text-gray-500">v11.0</sup></h1>
      <button id="logoutButton" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors text-sm">Logout</button>
    </div>
    <div class="text-sm text-gray-600 mb-2">Logged in as: <span id="currentUserDisplay" class="font-semibold"></span></div>
    
    <!-- Admin Tabs (Visible only for Admin) -->
    <div id="adminTabs" class="mb-4 border-b border-gray-200" style="display: none;">
      <nav class="flex space-x-4">
        <button onclick="showLeaveManagement()" class="tab-button active-tab py-2 px-4 text-blue-600 border-b-2 border-blue-600 font-medium">Leave Management</button>
        <button onclick="showUserManagement()" class="tab-button py-2 px-4 text-gray-500 hover:text-gray-700">User Management</button>
        <button onclick="showTeamManagement()" class="tab-button py-2 px-4 text-gray-500 hover:text-gray-700">Team Management</button>
      </nav>
      <style>.tab-button.active-tab { color: #2563eb; border-bottom: 2px solid #2563eb; } .tab-button { border-bottom: 2px solid transparent; }</style>
    </div>
    
    <!-- Leave Management Panel -->
    <div id="leaveManagementPanel">
      <!-- Leave Form -->
      <form id="leaveForm" class="flex flex-wrap items-center gap-3 p-4 bg-gray-50 rounded-lg mb-4">
        <label class="font-semibold text-gray-700">Name:</label>
        <input type="text" id="staffName" placeholder="Enter full name" class="px-3 py-1.5 border rounded-md" required readonly>
        <label class="font-semibold text-gray-700">ID:</label>
        <input type="text" id="staffID" placeholder="e.g., S123" class="px-3 py-1.5 border rounded-md" required readonly>
        <label class="font-semibold text-gray-700">From:</label>
        <input type="date" id="startDate" class="px-3 py-1.5 border rounded-md" required>
        <label class="font-semibold text-gray-700">To:</label>
        <input type="date" id="endDate" class="px-3 py-1.5 border rounded-md" required>
        <button type="submit" class="bg-blue-600 text-white px-4 py-1.5 rounded-md hover:bg-blue-700 transition-colors">Request Leave</button>
      </form>
      
      <!-- *** TEAM BUTTONS: Now color-coded *** -->
      <div id="team-buttons" class="team-buttons text-center my-3 space-x-2">
        <!-- Buttons populated by JS -->
      </div>
      
      <!-- Month Navigation -->
      <div class="month-nav flex justify-center items-center gap-4 my-3">
        <button onclick="prevMonth()" class="bg-gray-600 text-white px-3 py-1 rounded-md hover:bg-gray-700">←</button>
        <span id="monthLabel" class="font-bold text-lg text-gray-800">Loading...</span>
        <button onclick="nextMonth()" class="bg-gray-600 text-white px-3 py-1 rounded-md hover:bg-gray-700">→</button>
      </div>
      
      <!-- Calendar Container -->
      <div id="calendarGrid" class="grid grid-cols-7 gap-1 max-w-6xl mx-auto mb-4"></div>
      
      <!-- Leave Requests Accordion View -->
      <div id="adminSummary" class="p-4 rounded-lg bg-white border max-h-96 overflow-y-auto">
        <h3 class="text-lg font-semibold mb-3 text-gray-800">Leave Requests</h3>
        <div id="adminList" class="space-y-2"></div>
      </div>
      
      <!-- Monthly Summary (Admin Only) -->
      <div id="monthlySummary" class="p-4 rounded-lg bg-white border mt-6" style="display: none;">
        <h3 class="text-lg font-semibold mb-3 text-gray-800 flex justify-between items-center">
          Monthly Leave Summary
          <button class="download-btn bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 text-sm" onclick="downloadSummaryPDF()">Download PDF</button>
        </h3>
        <table class="summary-table w-full border-collapse text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2 text-left font-semibold text-gray-700 border-b" style="width: 30%;">Staff</th>
              <th class="p-2 text-left font-semibold text-gray-700 border-b" style="width: 50%;">Leave Dates</th>
              <th class="p-2 text-left font-semibold text-gray-700 border-b" style="width: 20%;">Total Days</th>
            </tr>
          </thead>
          <tbody id="summaryTableBody"></tbody>
        </table>
      </div>
    </div>
    
    <!-- User Management Panel (Admin Only) -->
    <div id="userManagementPanel" class="p-4" style="display: none;">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">User Management</h2>
      <p class="text-center text-gray-600 mb-4">Users who register will appear here. You can then grant them admin status.</p>
      <div class="overflow-x-auto">
        <table id="usersTable" class="min-w-full bg-white border rounded-lg">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-3 text-left font-semibold text-gray-700">Username</th>
              <th class="p-3 text-left font-semibold text-gray-700">Staff ID</th>
              <th class="p-3 text-left font-semibold text-gray-700">Mobile</th>
              <th class="p-3 text-left font-semibold text-gray-700">Email</th>
              <th class="p-3 text-left font-semibold text-gray-700">Team</th>
              <th class="p-3 text-left font-semibold text-gray-700">Admin</th>
              <th class="p-3 text-left font-semibold text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamically inserted rows -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Team Management Panel (Admin Only) -->
    <div id="teamManagementPanel" class="p-4" style="display: none;">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Team Management</h2>
      
      <div class="mb-6 max-w-md mx-auto">
        <h4 class="text-lg font-medium text-gray-800 mb-2">Add New Team</h4>
        <form id="add-team-form" class="flex space-x-2">
            <input type="text" id="new-team-name" class="flex-1 block w-full rounded-lg border-gray-300 shadow-sm" placeholder="New team name" required>
            <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">Add</button>
        </form>
        <div id="add-team-error" class="text-red-600 text-sm mt-1 h-4"></div>
      </div>
      
      <div class="max-w-md mx-auto">
        <h4 class="text-lg font-medium text-gray-800 mb-2">Current Teams</h4>
        <div id="delete-team-error" class="text-red-600 text-sm mb-2 h-4"></div>
        <ul id="team-list-ul" class="divide-y divide-gray-200 h-64 overflow-y-auto border rounded-lg p-2 bg-gray-50">
            <!-- Team list populated by JS -->
        </ul>
      </div>
    </div>
    
    <div class="footer text-center text-xs text-gray-500 mt-6">
      @ 2025; t’va (Leave/Roster)
    </div>
  </div>
  
  <!-- PDF Viewer Modal (hidden by default) -->
  <div id="pdfViewerContainer" class="fixed inset-0 bg-black/80 z-50 p-10" style="display: none;">
    <div class="relative w-full h-full bg-white rounded-lg overflow-hidden">
      <iframe id="pdfViewerFrame" style="width: 100%; height: 100%; border: none;"></iframe>
      <button id="exitPDFViewer" class="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Exit</button>
    </div>
  </div>
  
  <!-- Team Management Modals -->
  
  <!-- Edit Team (Visual Pattern Builder) Modal -->
  <div id="edit-team-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start z-50 hidden p-4 overflow-y-auto">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl modal-fade-in">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Edit Team & Pattern</h3>
            <button id="close-edit-team-modal" class="text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <form id="edit-team-form">
            <input type="hidden" id="edit-team-id">
            <div class="space-y-4">
                <div>
                    <label for="edit-team-name" class="block text-sm font-medium text-gray-700">Team Name</label>
                    <input type="text" id="edit-team-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-team-pattern-length" class="block text-sm font-medium text-gray-700">Pattern Length</label>
                        <input type="number" id="edit-team-pattern-length" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" min="1" max="31" value="6">
                    </div>
                    <div>
                        <label for="edit-team-anchor-date" class="block text-sm font-medium text-gray-700">Pattern Anchor Date</label>
                        <input type="date" id="edit-team-anchor-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" required>
                        <p class="mt-1 text-xs text-gray-500">The "Day 1" of the rotation.</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Visual Pattern</label>
                    <p class="mt-1 text-xs text-gray-500">Click the cells below to set the repeating pattern.</p>
                    <div id="visual-pattern-cells" class="mt-2 flex flex-wrap gap-2 p-3 bg-gray-50 rounded-lg border">
                    </div>
                </div>
                <div id="edit-team-error" class="text-red-600 text-sm h-4"></div>
                <div class="text-right">
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
  </div>

  <!-- Shift Selector Modal (for Pattern Builder) -->
  <div id="pattern-shift-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-start z-[60] hidden p-4 overflow-y-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md modal-fade-in">
          <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold">Set Pattern Shift</h3>
              <button id="close-pattern-modal" class="text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
          </div>
          <p class="mb-4 text-gray-600">Select shift for <strong id="pattern-modal-day">Day X</strong> of the pattern.</p>
          <div id="pattern-shift-options" class="grid grid-cols-4 gap-3"></div>
      </div>
  </div>
  
  <!-- Delete Team Confirmation Modal -->
  <div id="delete-team-confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] hidden">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
          <h3 class="text-xl font-semibold text-red-700">Confirm Team Deletion</h3>
          <p class="my-4 text-gray-600">Are you sure you want to delete <strong id="delete-team-modal-name"></strong>?</p>
          <div id="delete-team-warning" class="my-4 text-red-600 text-sm font-medium"></div>
          <div class="flex justify-end space-x-3">
              <button id="cancel-delete-team-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
              <button id="confirm-delete-team-btn" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm Delete</button>
          </div>
      </div>
  </div>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      sendPasswordResetEmail,
      signInAnonymously,
      signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      setDoc, 
      addDoc, 
      updateDoc, 
      deleteDoc, 
      onSnapshot, 
      collection, 
      query, 
      where,
      writeBatch,
      setLogLevel,
      deleteField
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- !! IMPORTANT !! ---
    const ADMIN_SECRET_KEY = "ADMIN2025";
    const defaultPattern = ['1', '1', '2', '2', 'OFF', 'OFF'];
    const patternAnchorDate = '2025-01-01'; // Default anchor date
    
    // *** NEW: Color list for teams ***
    const teamColorPalette = [
        { dot: 'bg-blue-500', btn: 'bg-blue-100 text-blue-700', selected: 'bg-blue-500 text-white' },
        { dot: 'bg-green-500', btn: 'bg-green-100 text-green-700', selected: 'bg-green-500 text-white' },
        { dot: 'bg-indigo-500', btn: 'bg-indigo-100 text-indigo-700', selected: 'bg-indigo-500 text-white' },
        { dot: 'bg-pink-500', btn: 'bg-pink-100 text-pink-700', selected: 'bg-pink-500 text-white' },
        { dot: 'bg-yellow-500', btn: 'bg-yellow-100 text-yellow-700', selected: 'bg-yellow-500 text-white' },
        { dot: 'bg-purple-500', btn: 'bg-purple-100 text-purple-700', selected: 'bg-purple-500 text-white' },
        { dot: 'bg-red-500', btn: 'bg-red-100 text-red-700', selected: 'bg-red-500 text-white' },
        { dot: 'bg-cyan-500', btn: 'bg-cyan-100 text-cyan-700', selected: 'bg-cyan-500 text-white' },
        { dot: 'bg-gray-500', btn: 'bg-gray-100 text-gray-700', selected: 'bg-gray-500 text-white' },
        { dot: 'bg-orange-500', btn: 'bg-orange-100 text-orange-700', selected: 'bg-orange-500 text-white' }
    ];


    // --- Firebase Configuration ---
    let firebaseConfig;
    if (typeof __firebase_config !== 'undefined') {
      firebaseConfig = JSON.parse(__firebase_config);
      console.log("Using provided __firebase_config.");
    } else {
      // Fallback config ('apo-leave-planner')
      firebaseConfig = {
        apiKey: "AIzaSyBtMiev72-UUyL8NEFk0bSIDAGJskU4Dj4",
        authDomain: "apo-leave-planner.firebaseapp.com",
        projectId: "apo-leave-planner",
        storageBucket: "apo-leave-planner.firebasestorage.app",
        messagingSenderId: "240953713168",
        appId: "1:240953713168:web:61ff4cd347c2a3ce4aa095",
        measurementId: "G-NX0TJPK0Q3"
      };
      console.warn("Using fallback Firebase config (apo-leave-planner). __firebase_config not found.");
    }

    // --- App & Auth Initialization ---
    let app, auth, db;
    let userType = null; // "admin" or "user"
    let currentUserProfile = null; // Store user's firestore doc
    let leaveRequestsCollectionPath;
    let usersCollectionPath;
    let teamsCollectionPath; 

    // --- Global State Variables ---
    let selectedTeamId = null; 
    let now = new Date();
    var currentYear = now.getFullYear();
    var currentMonth = now.getMonth();
    var referenceDate = new Date(currentYear, currentMonth, 1);
    var requests = []; 
    var allUsers = []; 
    var teamsMap = new Map(); 
    var tempPatternArray = []; 
    var teamIdToDelete = null; 
    var openAccordions = new Set();
    let leaveRequestsUnsubscriber = null;
    let usersUnsubscriber = null;
    let teamsUnsubscriber = null; 

    // Shift colors from original planner
    const shiftCodesMap = {
        '1':    { text: '1',    color: 'bg-green-600', textColor: 'text-white' },         // Morning (dark green)
        '2':    { text: '2',    color: 'bg-green-400', textColor: 'text-gray-800' },      // Night (light green)
        '1A':   { text: '1A',   color: 'bg-green-600', textColor: 'text-white' },         // Morning
        '2N':   { text: '2N',   color: 'bg-green-400', textColor: 'text-gray-800' },      // Night
        'OFF':  { text: 'OFF',  color: 'bg-gray-300', textColor: 'text-gray-800' },       // Off (gray)
        'AL':   { text: 'AL',   color: 'bg-blue-200', textColor: 'text-blue-800' },       // Leave
        'AD':   { text: 'AD',   color: 'bg-cyan-200', textColor: 'text-cyan-800' },
        'PPT':  { text: 'PPT',  color: 'bg-lime-200', textColor: 'text-lime-800' },
        'PCT':  { text: 'PCT',  color: 'bg-orange-200', textColor: 'text-orange-800' },
        'BCLS': { text: 'BCLS', color: 'bg-red-200', textColor: 'text-red-800' },
        '_EMPTY': { text: '',   color: 'bg-gray-50', textColor: 'text-gray-400' }
    };

    // --- DOM Elements ---
    const loadingEl = document.getElementById("loading");
    const loginSection = document.getElementById("loginSection");
    const mainContainer = document.querySelector(".container");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("userRegisterForm");
    const logoutButton = document.getElementById("logoutButton");
    const regTeamSelect = document.getElementById("regTeam");
    const teamManagementPanel = document.getElementById("teamManagementPanel");
    const addTeamForm = document.getElementById("add-team-form");
    const newTeamNameInput = document.getElementById("new-team-name");
    const addTeamError = document.getElementById("add-team-error");
    const deleteTeamError = document.getElementById("delete-team-error");
    const teamListUl = document.getElementById("team-list-ul");
    const editTeamModal = document.getElementById('edit-team-modal');
    const closeEditTeamModalBtn = document.getElementById('close-edit-team-modal');
    const editTeamForm = document.getElementById('edit-team-form');
    const editTeamId = document.getElementById('edit-team-id');
    const editTeamName = document.getElementById('edit-team-name');
    const editTeamPatternLength = document.getElementById('edit-team-pattern-length');
    const editTeamAnchorDate = document.getElementById('edit-team-anchor-date');
    const visualPatternCells = document.getElementById('visual-pattern-cells');
    const editTeamError = document.getElementById('edit-team-error');
    const patternShiftModal = document.getElementById('pattern-shift-modal');
    const closePatternModalBtn = document.getElementById('close-pattern-modal');
    const patternShiftOptionsContainer = document.getElementById('pattern-shift-options');
    const patternModalDay = document.getElementById('pattern-modal-day');
    const deleteTeamConfirmModal = document.getElementById('delete-team-confirm-modal');
    const cancelDeleteTeamBtn = document.getElementById('cancel-delete-team-btn');
    const confirmDeleteTeamBtn = document.getElementById('confirm-delete-team-btn');
    const deleteTeamModalName = document.getElementById('delete-team-modal-name');
    const deleteTeamWarning = document.getElementById('delete-team-warning');
    

    // --- Utility Functions ---
    function showAlert(message, isError = true) {
      const alertBox = document.getElementById("customAlert");
      const alertMessage = document.getElementById("customAlertMessage");
      alertMessage.textContent = message;
      alertBox.classList.remove(isError ? "bg-green-500" : "bg-red-500");
      alertBox.classList.add(isError ? "bg-red-500" : "bg-green-500");
      alertBox.style.display = "block";
      setTimeout(() => { alertBox.style.display = "none"; }, 4000);
    }
    
    function getDaysBetween(dateStr1, dateStr2) {
        try {
            const [y1, m1, d1] = dateStr1.split('-').map(Number);
            const [y2, m2, d2] = dateStr2.split('-').map(Number);
            const utcDate1 = Date.UTC(y1, m1 - 1, d1);
            const utcDate2 = Date.UTC(y2, m2 - 1, d2);
            if (isNaN(utcDate1) || isNaN(utcDate2)) { return 0; }
            return Math.round((utcDate1 - utcDate2) / 86400000);
        } catch (e) { console.error("Error in getDaysBetween", e); return 0; }
    }


    // --- Firebase Initialization ---
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      setLogLevel('debug');
      console.log("Firebase initialized successfully with projectId:", firebaseConfig.projectId);

      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      
      usersCollectionPath = `/artifacts/${appId}/public/data/users`;
      leaveRequestsCollectionPath = `/artifacts/${appId}/public/data/leaveRequests`;
      teamsCollectionPath = `/artifacts/${appId}/public/data/teams`; 

      console.log("Using Users Collection:", usersCollectionPath);
      console.log("Using Leave Requests Collection:", leaveRequestsCollectionPath);
      console.log("Using Teams Collection:", teamsCollectionPath); 

      initializeAuth();

    } catch (error) {
      console.error("Firebase initialization error:", error);
      showAlert("Error initializing application. Check console.");
      loadingEl.style.display = "none";
      loginSection.style.display = "block";
    }

    /**
     * Handles the authentication state changes.
     */
    async function initializeAuth() {
      // Load teams for registration dropdown
      const teamsQuery = collection(db, teamsCollectionPath);
      teamsUnsubscriber = onSnapshot(teamsQuery, (snapshot) => {
          console.log("Teams data updated (all users):", snapshot.size, "teams");
          teamsMap.clear();
          const sortedTeams = [];
          snapshot.forEach(doc => {
              const teamData = { docId: doc.id, ...doc.data() };
              teamsMap.set(doc.id, teamData);
              sortedTeams.push(teamData);
          });
          
          sortedTeams.sort((a, b) => a.name.localeCompare(b.name));
          
          // *** NEW: Assign colors to teams ***
          let colorIndex = 0;
          sortedTeams.forEach(team => {
              const teamData = teamsMap.get(team.docId);
              // *** UPDATED: Assign the whole color set object ***
              teamData.colorSet = teamColorPalette[colorIndex % teamColorPalette.length];
              colorIndex++;
          });
          
          regTeamSelect.innerHTML = '<option value="">Select a team...</option>';
          sortedTeams.forEach(team => {
              regTeamSelect.innerHTML += `<option value="${team.docId}">${team.name}</option>`;
          });
          
          if (currentUserProfile) {
              populateTeamButtons();
          }
          
      }, (error) => {
          console.error("Error listening to teams collection:", error);
          showAlert("Error loading teams. Registration may fail.");
      });


      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          console.log("Signing in with custom token...");
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          console.log("Signing in anonymously...");
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth initialization error:", error);
        showAlert("Authentication failed. Please refresh.");
        loadingEl.style.display = "none";
        loginSection.style.display = "block";
      }

      onAuthStateChanged(auth, async (user) => {
        if (user && !user.isAnonymous) {
          console.log("User is logged in:", user.uid);
          try { 
            const userDocRef = doc(db, usersCollectionPath, user.uid);
            const userDoc = await getDoc(userDocRef); 

            if (userDoc.exists()) {
              currentUserProfile = { id: user.uid, ...userDoc.data() };
              userType = currentUserProfile.isAdmin ? "admin" : "user";
              
              console.log("User profile found. User type:", userType);
              
              document.getElementById("currentUserDisplay").textContent = `${currentUserProfile.username} (${currentUserProfile.email})`;
              document.getElementById("staffName").value = currentUserProfile.username;
              document.getElementById("staffID").value = currentUserProfile.staffID;
              
              loginSection.style.display = "none";
              mainContainer.style.display = "block";
              
              await renderUI();
            } else {
              console.error("User document not found in Firestore!");
              showAlert("Error: User profile missing. Logging out.");
              await signOut(auth);
            }
          } catch (error) { 
            console.error("Error fetching user profile:", error);
            if (error.code === 'permission-denied' || error.code === 7) {
              showAlert("Login successful, but failed to get profile. Check Firestore permissions.");
            } else {
              showAlert("Error loading user profile: " + error.message);
            }
            await signOut(auth);
          } finally { 
            loadingEl.style.display = "none";
          }
        } else {
          console.log("User is logged out or anonymous.");
          userType = null;
          currentUserProfile = null;
          
          if (leaveRequestsUnsubscriber) leaveRequestsUnsubscriber();
          if (usersUnsubscriber) usersUnsubscriber();
          
          loginSection.style.display = "block";
          mainContainer.style.display = "none";
          loadingEl.style.display = "none";
          showLoginForm();
        }
      });
    }

    // --- Authentication Functions ---

    window.showRegisterForm = () => {
      loginForm.style.display = "none";
      registerForm.style.display = "block";
    }

    window.showLoginForm = () => {
      loginForm.style.display = "block";
      registerForm.style.display = "none";
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault(); 
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) {
        return showAlert("Please enter both email and password.");
      }
      
      loadingEl.style.display = "flex"; 
      try {
        await signInWithEmailAndPassword(auth, email, password);
        console.log("Login successful.");
      } catch (err) {
        console.error("Login error:", err);
        showAlert(err.message);
        loadingEl.style.display = "none"; 
      }
    });

    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault(); 
      
      const username = document.getElementById("regUsername").value.trim();
      const staffID = document.getElementById("regStaffID").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;
      const adminSecret = document.getElementById("regAdminSecret").value.trim();
      const teamId = document.getElementById("regTeam").value; 
      const mobile = document.getElementById("regMobile").value.trim(); 

      if (!username || !staffID || !email || !password || !teamId || !mobile) { 
        return showAlert("Please fill in all fields, including mobile and team.");
      }

      loadingEl.style.display = "flex";
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        const isAdmin = (adminSecret === ADMIN_SECRET_KEY);
        if (isAdmin) {
          showAlert("Admin secret correct! Admin user will be created.", false);
        }

        const userDocRef = doc(db, usersCollectionPath, user.uid);
        await setDoc(userDocRef, {
          username: username,
          staffID: staffID,
          email: email,
          isAdmin: isAdmin,
          team_id: teamId,
          mobile: mobile 
        });
        
        console.log("Registration successful, user doc created.");
        showAlert("Registration successful! Please log in.", false);
        
        await signOut(auth);

        showLoginForm();
        registerForm.reset(); 

      } catch (err) {
        console.error("Registration error:", err);
        if (err.code === 'permission-denied' || err.code === 7) {
           showAlert("Registration failed. Check Firestore permissions.");
        } else {
           showAlert(err.message);
        }
      } finally {
        loadingEl.style.display = "none";
      }
    });

    logoutButton.addEventListener("click", async () => {
      loadingEl.style.display = "flex";
      await signOut(auth);
      console.log("User logged out.");
    });

    /* Render UI based on user type */
    async function renderUI() {
      if (userType === "admin") {
        document.getElementById("adminTabs").style.display = "block";
        document.getElementById("monthlySummary").style.display = "block";
        document.getElementById("staffName").readOnly = false; 
        document.getElementById("staffID").readOnly = false;  
        showLeaveManagement();
        attachDataListeners(); 
      } else if (userType === "user") {
        document.getElementById("adminTabs").style.display = "none";
        document.getElementById("monthlySummary").style.display = "none";
        document.getElementById("staffName").readOnly = true;
        document.getElementById("staffID").readOnly = true;
        showLeaveManagement();
        attachDataListeners(); 
      }
      populateTeamButtons(); 
      await renderCalendar(); 
    }
    
    // --- Firestore Data Listeners ---
    
    function attachDataListeners() {
      if (leaveRequestsUnsubscriber) leaveRequestsUnsubscriber();
      if (usersUnsubscriber) usersUnsubscriber();
      
      let q = collection(db, leaveRequestsCollectionPath);
      
      if (userType === "user") {
        q = query(q, where("userId", "==", auth.currentUser.uid));
      }
      
      leaveRequestsUnsubscriber = onSnapshot(q, (snapshot) => {
        console.log("Leave requests snapshot received:", snapshot.size, "docs");
        requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderCalendar(); 
      }, (error) => {
        console.error("Error listening to leave requests:", error);
        showAlert("Error loading leave requests.");
      });
      
      if (userType === "admin") {
        const usersQuery = collection(db, usersCollectionPath);
        usersUnsubscriber = onSnapshot(usersQuery, (snapshot) => {
          console.log("Users snapshot received:", snapshot.size, "docs");
          allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          if (document.getElementById("userManagementPanel").style.display === "block") {
            renderUserManagement(); 
          }
        }, (error) => {
          console.error("Error listening to users:", error);
          showAlert("Error loading users.");
        });
      }
    }

    // --- Date & shift helpers ---
    
    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + dd;
    }
    
    function displayFormatDate(yyyyMmDd) {
        if (!yyyyMmDd) return '';
        const parts = yyyyMmDd.split('-');
        if (parts.length === 3) {
            return `${parts[2]}-${parts[1]}-${parts[0]}`; // dd-mm-yyyy
        }
        return yyyyMmDd; // fallback
    }
    
    function getShift(d) {
      if (!selectedTeamId) {
        return { shift: '', shiftInfo: shiftCodesMap['_EMPTY'] };
      }
      const team = teamsMap.get(selectedTeamId);
      if (!team || !team.shiftPattern || team.shiftPattern.length === 0) {
        return { shift: '', shiftInfo: shiftCodesMap['_EMPTY'] };
      }
      const pattern = team.shiftPattern;
      const anchorDate = team.patternStartDate || patternAnchorDate;
      const daysSinceAnchor = getDaysBetween(formatDate(d), anchorDate);
      const patternIndex = (daysSinceAnchor % pattern.length + pattern.length) % pattern.length;
      const shift = pattern[patternIndex];
      const shiftInfo = shiftCodesMap[shift] || { ...shiftCodesMap['_EMPTY'], text: shift }; 
      return { shift, shiftInfo };
    }
    
    function populateTeamButtons() {
        const teamButtonsContainer = document.getElementById("team-buttons");
        teamButtonsContainer.innerHTML = ""; 
        const sortedTeams = [...teamsMap.values()].sort((a, b) => a.name.localeCompare(b.name));
        
        let defaultTeamId = null;
        if (userType === 'user' && teamsMap.has(currentUserProfile.team_id)) {
            defaultTeamId = currentUserProfile.team_id;
        } else if (sortedTeams.length > 0) {
            defaultTeamId = sortedTeams[0].docId;
        }
        
        if (defaultTeamId && (!selectedTeamId || !teamsMap.has(selectedTeamId))) {
             selectedTeamId = defaultTeamId;
        }

        sortedTeams.forEach((team) => {
            const button = document.createElement("button");
            const colorSet = team.colorSet || teamColorPalette[0]; // Fallback color
            
            // *** UPDATED: Set class based on selection ***
            const isSelected = team.docId === selectedTeamId;
            const buttonClasses = isSelected ? colorSet.selected : colorSet.btn;
            
            button.className = `team-button px-3 py-1.5 rounded-md text-sm transition-colors ${buttonClasses}`;
            button.textContent = team.name;
            button.dataset.teamId = team.docId; // Store teamId for selectTeam function
            button.onclick = () => selectTeam(team.docId);
            teamButtonsContainer.appendChild(button);
        });
        
        // Re-apply selection in case teamsMap updated
        if (selectedTeamId) {
            selectTeam(selectedTeamId);
        }
    }
    
    
    /* Render Calendar */
    async function renderCalendar() {
      if (!isFinite(currentYear) || !isFinite(currentMonth)) {
          console.error("Invalid date state:", currentYear, currentMonth);
          currentYear = new Date().getFullYear();
          currentMonth = new Date().getMonth();
      }
        
      const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
      document.getElementById("monthLabel").textContent = monthNames[currentMonth] + " " + currentYear;
      const grid = document.getElementById("calendarGrid");
      grid.innerHTML = "";
      
      const fragment = document.createDocumentFragment();
      
      const weekdays = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
      weekdays.forEach(day => {
          const dayCell = document.createElement("div");
          dayCell.className = "text-center font-semibold text-xs text-gray-500 py-2";
          dayCell.textContent = day;
          fragment.appendChild(dayCell);
      });
      
      const firstDay = new Date(currentYear, currentMonth, 1);
      const offset = (firstDay.getDay() + 6) % 7; // 0 = Monday
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      for (let i = 0; i < offset; i++) {
        fragment.appendChild(document.createElement("div")).className = "day-cell bg-gray-50 rounded";
      }
      
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(currentYear, currentMonth, d);
        const dateStr = formatDate(dateObj); // Use yyyy-mm-dd for logic
        const cell = document.createElement("div");
        cell.className = "day-cell bg-white border border-gray-200 rounded-md min-h-[70px] p-1 text-xs relative";
        
        const { shift, shiftInfo } = getShift(dateObj);
        const shiftBox = document.createElement("div");
        
        shiftBox.textContent = d;
        shiftBox.className = `shift-box font-bold p-1 rounded text-center mb-1`;
        
        if (shiftInfo && shiftInfo.color) {
            shiftBox.classList.add(shiftInfo.color, shiftInfo.textColor);
        } else {
            shiftBox.classList.add('bg-gray-200', 'text-gray-700'); // Fallback for unknown
        }

        cell.appendChild(shiftBox);
        
        const dayEntries = [];
        requests.forEach(req => {
          const dayData = req.days.find(day => day.date === dateStr);
          if (dayData) {
            dayEntries.push({ 
              staffName: req.staffName, 
              staffID: req.staffID, 
              status: dayData.status 
            });
          }
        });
        
        if (dayEntries.filter(e => e.status !== "Rejected").length > 2) {
          cell.appendChild(document.createElement("div")).className = "w-2 h-2 bg-red-500 rounded-full absolute top-1 right-1";
        }
        
        dayEntries.forEach(e => {
          const entry = document.createElement("div");
          entry.className = `leave-entry ${e.status.toLowerCase()} p-1 rounded mt-0.5 truncate`;
          
          // *** UPDATED: Add team color dot ***
          let teamColorClass = 'bg-gray-400'; // Default
          let userForLeave = null;
          
          if (userType === 'admin') {
              userForLeave = allUsers.find(u => u.staffID === e.staffID);
          } else if (currentUserProfile.staffID === e.staffID) {
              userForLeave = currentUserProfile;
          }
          
          if(userForLeave) {
              const team = teamsMap.get(userForLeave.team_id);
              if (team && team.colorSet) {
                  teamColorClass = team.colorSet.dot;
              }
          }
          entry.innerHTML = `<div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full ${teamColorClass} flex-shrink-0"></div><span>${e.staffID}</span></div>`;
          
          cell.appendChild(entry);
        });
        
        fragment.appendChild(cell);
      }
      
      grid.appendChild(fragment);
      
      renderAdmin();
      if (userType === "admin") {
        renderMonthlySummary();
      }
    }
    
    function groupRequestsByStaffID(requests) {
      const grouped = {};
      requests.forEach(req => {
        const staffID = req.staffID;
        if (!grouped[staffID]) {
          grouped[staffID] = { staffName: req.staffName, staffID: req.staffID, requests: [] };
        }
        grouped[staffID].requests.push(req);
      });
      return Object.values(grouped);
    }
    
    function renderAdmin() {
      const adminList = document.getElementById("adminList");
      adminList.innerHTML = "";
      let filteredRequests = requests;
      
      if (userType === "admin") {
        const currentDate = new Date();
        const currentYearMonth = currentDate.getFullYear() * 12 + currentDate.getMonth();
        filteredRequests = requests.filter(req => {
          return req.days.some(day => {
            const [year, month] = day.date.split("-").map(Number);
            const requestYearMonth = year * 12 + (month - 1);
            return requestYearMonth >= currentYearMonth;
          });
        });
      }
      
      if (filteredRequests.length === 0) {
        adminList.innerHTML = `<div class="text-gray-500 text-center p-4">No leave requests found.</div>`;
        return;
      }

      const groupedRequests = groupRequestsByStaffID(filteredRequests);
      groupedRequests.forEach((group) => {
        const groupID = group.staffID; 
        const item = document.createElement("div");
        item.className = "accordion-item border border-gray-200 rounded-md";
        
        const totalDays = group.requests.reduce((sum, r) => sum + r.days.length, 0);
        const pendingCount = group.requests.reduce((sum, r) =>
          sum + r.days.filter(d => d.status === "Pending").length, 0
        );
        
        // *** UPDATED: Add team color dot to accordion header ***
        let teamColorClass = 'bg-gray-400'; // Default
        let userForGroup = null;
        
        if (userType === 'admin') {
            userForGroup = allUsers.find(u => u.staffID === group.staffID);
        } else if (currentUserProfile.staffID === group.staffID) {
            userForGroup = currentUserProfile;
        }

        if(userForGroup) {
            const team = teamsMap.get(userForGroup.team_id);
            if (team && team.colorSet) {
                teamColorClass = team.colorSet.dot;
            }
        }
        
        item.innerHTML = `
          <div class="accordion-header flex justify-between items-start p-3 bg-gray-50 cursor-pointer hover:bg-gray-100" data-group-id="${groupID}">
            <span class="font-semibold text-gray-700 flex items-center gap-2">
              <div class="w-3 h-3 rounded-full ${teamColorClass} flex-shrink-0"></div>
              ${group.staffName} (${group.staffID})
            </span>
            <span class="badge text-xs px-2 py-0.5 rounded-full ${pendingCount > 0 ? "bg-yellow-500 text-white" : "bg-blue-500 text-white"} whitespace-nowrap">
              ${totalDays} days (${pendingCount} pending)
            </span>
          </div>
          <div class="accordion-content p-3 bg-white" data-group-id="${groupID}" style="display: none;">
            ${group.requests.map((req) => `
              <div class="mb-3 border-b pb-3">
                <div class="timeline flex flex-wrap gap-2">
                  ${req.days.map((day, dayIndex) => `
                    <div class="day-block flex items-center gap-2 p-2 bg-gray-100 rounded">
                      <span>${displayFormatDate(day.date)}</span>
                      <div class="status-dot w-2 h-2 rounded-full ${day.status.toLowerCase()}"></div>
                      <select data-request-id="${req.id}" data-day-index="${dayIndex}" 
                              class="text-xs p-1 border rounded"
                              ${userType === "user" ? "disabled" : ""}>
                        <option value="Pending"  ${day.status === "Pending" ? "selected" : ""}>Pending</option>
                        <option value="Approved" ${day.status === "Approved" ? "selected" : ""}>Approved</option>
                        <option value="Rejected" ${day.status === "Rejected" ? "selected" : ""}>Rejected</option>
                        <option value="Write-in" ${day.status === "Write-in" ? "selected" : ""}>Write-in</option>
                      </select>
                    </div>
                  `).join("")}
                </div>
                <div class="action-buttons text-right mt-2 space-x-2">
                  ${userType === "admin" ? `<button class="delete-request-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" data-request-id="${req.id}">Delete Req</button>` : ""}
                  <button class="whatsapp-btn bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600" data-request-id="${req.id}">WhatsApp</button>
                </div>
              </div>
            `).join("")}
          </div>
        `;
        adminList.appendChild(item);
      });
      
      adminList.querySelectorAll(".accordion-header").forEach(header => {
        const groupID = header.getAttribute("data-group-id");
        const content = header.nextElementSibling;
        content.style.display = openAccordions.has(groupID) ? "block" : "none";
        
        header.onclick = function() {
          if (content.style.display === "block") {
            content.style.display = "none";
            openAccordions.delete(groupID);
          } else {
            content.style.display = "block";
            openAccordions.add(groupID);
          }
        };
      });
      
      adminList.querySelectorAll("select").forEach(sel => {
        sel.onchange = async function() {
          if (userType !== "admin") return;
          const requestId = sel.getAttribute("data-request-id");
          const dayIndex = parseInt(sel.getAttribute("data-day-index"), 10);
          const newStatus = sel.value;
          const reqDocRef = doc(db, leaveRequestsCollectionPath, requestId);
          try {
            const reqDoc = await getDoc(reqDocRef);
            if (!reqDoc.exists()) throw new Error("Request document not found.");
            const reqData = reqDoc.data();
            const updatedDays = [...reqData.days]; 
            if (updatedDays[dayIndex]) {
              updatedDays[dayIndex].status = newStatus;
            }
            await updateDoc(reqDocRef, { days: updatedDays });
            console.log("Day status updated.");
          } catch (err) {
            console.error("Day status update error:", err);
            showAlert("Error updating day status: " + err.message);
          }
        };
      });
      
      adminList.querySelectorAll(".delete-request-btn").forEach(btn => {
        btn.onclick = async function() {
          const requestId = btn.getAttribute("data-request-id");
          if (!confirm("Are you sure you want to delete this entire leave request?")) return;
          try {
            await deleteDoc(doc(db, leaveRequestsCollectionPath, requestId));
            console.log("Request deleted.");
            showAlert("Request deleted. Please refresh if it's still visible.", false);
          } catch (err) {
            console.error("Delete request error:", err);
            showAlert("Error deleting request: " + err.message);
          }
        };
      });
      
      adminList.querySelectorAll(".whatsapp-btn").forEach(btn => {
        btn.onclick = function() {
          const requestId = btn.getAttribute("data-request-id");
          const req = requests.find(r => r.id === requestId);
          if (!req) return;

          let mobileNumber = '';
          
          if (userType === 'admin') {
            const user = allUsers.find(u => u.staffID === req.staffID);
            mobileNumber = user ? user.mobile : '';
          } else {
            if (currentUserProfile && currentUserProfile.staffID === req.staffID) {
                mobileNumber = currentUserProfile.mobile || '';
            }
          }

          const msg = `Hello ${req.staffName} (${req.staffID}), your leave status for request (${displayFormatDate(req.fromDate)} to ${displayFormatDate(req.toDate)}):\n` +
            req.days.map(d => `${displayFormatDate(d.date)}: ${d.status}`).join('\n');
            
          if (mobileNumber) {
            let formattedNumber = mobileNumber.replace(/[\s+()-]/g, '');
            if (formattedNumber.startsWith('00')) {
              formattedNumber = formattedNumber.substring(2);
            }
            
            if (/^\d{8,}$/.test(formattedNumber)) {
              window.open(`https://wa.me/${formattedNumber}?text=${encodeURIComponent(msg)}`, "_blank");
            } else {
              showAlert(`Invalid mobile number for ${req.staffName}: ${mobileNumber}. Please update in User Management.`);
              window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
            }
          } else {
            showAlert(`No mobile number found for ${req.staffName}. Opening general WhatsApp.`);
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
          }
        };
      });
    }
    
    // --- Leave Form Submission ---
    
    document.getElementById("leaveForm").onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById("staffName").value.trim();
      const id   = document.getElementById("staffID").value.trim();
      const start = document.getElementById("startDate").value;
      const end   = document.getElementById("endDate").value;
      if (!name || !id || !start || !end) {
        return showAlert("Please fill all fields.");
      }
      if (end < start) {
        return showAlert("End date cannot be before start date.");
      }
      loadingEl.style.display = "flex";
      const startDate = new Date(start + "T12:00:00"); 
      const endDate = new Date(end + "T12:00:00");
      const daysArray = [];
      for (let d = new Date(startDate.getTime()); d <= endDate; d.setDate(d.getDate() + 1)) {
          daysArray.push({ date: formatDate(d), status: "Pending" }); // Use yyyy-mm-dd
      }
      
      if (daysArray.length === 0) {
        loadingEl.style.display = "none";
        return showAlert("No valid days in range.");
      }
      try {
        await addDoc(collection(db, leaveRequestsCollectionPath), {
          staffName: name,
          staffID: id,
          userId: (userType === 'admin' && currentUserProfile.staffID !== id) ? `admin_entry_${id}` : auth.currentUser.uid, 
          fromDate: start, // yyyy-mm-dd
          toDate: end,     // yyyy-mm-dd
          days: daysArray
        });
        showAlert("Leave request submitted successfully.", false);
        e.target.reset();
        if(userType === 'user') {
            document.getElementById("staffName").value = currentUserProfile.username;
            document.getElementById("staffID").value = currentUserProfile.staffID;
        }
      } catch (error) {
        console.error("Error submitting leave request:", error);
        showAlert("An error occurred: " + error.message);
      } finally {
        loadingEl.style.display = "none";
      }
    };
    
    // --- Monthly Summary & PDF (Admin) ---
    
    function renderMonthlySummary() {
      if (userType !== "admin") return;
      const summaryTableBody = document.getElementById("summaryTableBody");
      summaryTableBody.innerHTML = "";
      const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}`;
      const allDaysByStaff = {};
      requests.forEach(req => {
        const staffID = req.staffID;
        const staffName = req.staffName;
        if (!allDaysByStaff[staffID]) {
          allDaysByStaff[staffID] = { staffName, staffID, days: {} };
        }
        req.days.forEach(day => {
          if (day.date.startsWith(monthStr) && 
             (day.status === "Approved" || day.status === "Write-in")) {
            if (!allDaysByStaff[staffID].days[day.date] || day.status === "Approved") {
              allDaysByStaff[staffID].days[day.date] = day.status;
            }
          }
        });
      });
      const groupedRequests = Object.values(allDaysByStaff).filter(
        g => Object.keys(g.days).length > 0
      );
      groupedRequests.forEach(group => {
        const dayEntries = Object.entries(group.days).map(([date, status]) => ({ date, status }));
        dayEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
        const ranges = [];
        if (dayEntries.length > 0) {
          let currentRange = [dayEntries[0]];
          for (let i = 1; i < dayEntries.length; i++) {
            const prevDateStr = currentRange[currentRange.length - 1].date;
            const currDateStr = dayEntries[i].date;
            const dateDiff = getDaysBetween(currDateStr, prevDateStr);

            if (dateDiff === 1 && currentRange[0].status === dayEntries[i].status) {
              currentRange.push(dayEntries[i]);
            } else {
              ranges.push(currentRange);
              currentRange = [dayEntries[i]];
            }
          }
          ranges.push(currentRange);
        }
        const totalDays = dayEntries.length;
        const row = document.createElement("tr");
        row.className = "border-b hover:bg-gray-50";
        row.innerHTML = `
          <td class="p-2 staff-name font-medium text-gray-800">${group.staffName} (${group.staffID})</td>
          <td class="p-2 leave-range">
            <div class="flex flex-col gap-1">
            ${ranges.map(range => {
              const startDate = range[0].date; 
              const endDate = range[range.length - 1].date; 
              const startDisplay = displayFormatDate(startDate); 
              const endDisplay = displayFormatDate(endDate); 
              const displayText = (startDate === endDate) ? startDisplay.split('-')[0] : `${startDisplay.split('-')[0]}-${endDisplay.split('-')[0]}`; 
              const monthYear = `${startDisplay.split('-')[1]}-${startDisplay.split('-')[2]}`;
              const statusLabel = range[0].status;
              return `
                <div class="range-block ${statusLabel.toLowerCase()} inline-flex items-center gap-1.5 text-xs">
                  <span class="status-dot w-1.5 h-1.5 rounded-full"></span>
                  ${displayText} (${monthYear}) - ${statusLabel}
                </div>
              `;
            }).join("")}
            </div>
          </td>
          <td class="p-2 total-days font-medium text-gray-800 text-right">${totalDays}</td>
        `;
        summaryTableBody.appendChild(row);
      });
      if (summaryTableBody.children.length === 0) {
        summaryTableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">No approved or write-in leave requests for this month.</td></tr>`;
      }
    }
    
    window.downloadSummaryPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const bodyData = [];
      const rows = document.querySelectorAll("#summaryTableBody tr");
      rows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        if (cells.length === 3) {
          bodyData.push([
            cells[0].innerText.trim(),
            cells[1].innerText.trim().replace(/\s+/g, ' '),
            cells[2].innerText.trim()
          ]);
        }
      });
      doc.text(`Monthly Leave Summary - ${document.getElementById("monthLabel").textContent}`, 14, 15);
      doc.autoTable({
        head: [["Staff", "Dates", "Days"]],
        body: bodyData,
        startY: 20,
        theme: "grid",
        styles: { fontSize: 10 },
        columnStyles: {
          0: { cellWidth: 50 },
          1: { cellWidth: 'auto' },
          2: { cellWidth: 20 }
        }
      });
      showPDFPreview(doc);
    }
    
    function showPDFPreview(doc) {
      const pdfBlob = doc.output("blob");
      const pdfURL = URL.createObjectURL(pdfBlob);
      const container = document.getElementById("pdfViewerContainer");
      document.getElementById("pdfViewerFrame").src = pdfURL;
      container.style.display = "block";
      
      document.getElementById("exitPDFViewer").onclick = function() {
        container.style.display = "none";
        document.getElementById("pdfViewerFrame").src = "about:blank";
        URL.revokeObjectURL(pdfURL);
      };
    }
    
    // --- User Management (Admin) ---

    function renderUserManagement() {
      if (userType !== 'admin') return;
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      
      if (allUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No users have registered yet.</td></tr>`;
        return;
      }
      
      allUsers.forEach(user => {
        const isSelf = (user.id === auth.currentUser.uid);
        const team = teamsMap.get(user.team_id);
        const teamName = team ? team.name : 'N/A';
        const teamColorClass = team ? (team.colorSet.dot || 'bg-gray-400') : 'bg-gray-400';
        
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3">${user.username}</td>
          <td class="p-3">${user.staffID}</td>
          <td class="p-3">${user.mobile || 'N/A'}</td>
          <td class="p-3">${user.email}</td>
          <td class="p-3">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-full ${teamColorClass} flex-shrink-0"></div>
              <span>${teamName}</span>
            </div>
          </td>
          <td class="p-3">
            <span class="px-2 py-1 text-xs rounded-full ${user.isAdmin ? "bg-green-200 text-green-800" : "bg-gray-200 text-gray-800"}">
              ${user.isAdmin ? "Yes" : "No"}
            </span>
          </td>
          <td class="p-3 space-x-2 whitespace-nowrap">
            <button class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs hover:bg-blue-200 ${isSelf ? 'opacity-50 cursor-not-allowed' : ''}" 
                    onclick="window.toggleAdminStatus('${user.id}', ${user.isAdmin})" ${isSelf ? 'disabled' : ''}>
              ${user.isAdmin ? "Revoke Admin" : "Make Admin"}
            </button>
            <button class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-xs hover:bg-yellow-200" 
                    onclick="window.resetUserPassword('${user.email}')">
              Reset Password
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.toggleAdminStatus = async (userId, isCurrentlyAdmin) => {
      if (userId === auth.currentUser.uid) {
        return showAlert("You cannot change your own admin status.");
      }
      if (!confirm(`Are you sure you want to ${isCurrentlyAdmin ? 'revoke' : 'grant'} admin status for this user?`)) return;
      loadingEl.style.display = "flex";
      try {
        const userDocRef = doc(db, usersCollectionPath, userId);
        await updateDoc(userDocRef, { isAdmin: !isCurrentlyAdmin });
        showAlert("Admin status updated successfully.", false);
      } catch (err) {
        console.error("Toggle admin error:", err);
        showAlert("Error updating admin status: " + err.message);
      } finally {
        loadingEl.style.display = "none";
      }
    }
    
    window.resetUserPassword = async (email) => {
      if (!confirm(`Are you sure you want to send a password reset email to ${email}?`)) return;
      loadingEl.style.display = "flex";
      try {
        await sendPasswordResetEmail(auth, email);
        showAlert(`Password reset email sent to ${email}.`, false);
      } catch (err) {
        console.error("Password reset error:", err);
        showAlert("Error sending password reset: " + err.message);
      } finally {
        loadingEl.style.display = "none";
      }
    }
    
    
    // --- Team Management Functions (from Roster) ---
    
    window.openManageTeamsModal = () => {
        deleteTeamError.textContent = '';
        addTeamError.textContent = '';
        populateManageTeamsModal();
    }
    
    function populateManageTeamsModal() {
        if (!teamListUl) return; 
        teamListUl.innerHTML = '';
        const sortedTeams = [...teamsMap.values()].sort((a, b) => a.name.localeCompare(b.name));
        
        if (sortedTeams.length === 0) {
            teamListUl.innerHTML = '<li class="p-3 text-gray-500 italic">No teams found.</li>'; return;
        }
        
        sortedTeams.forEach((team) => {
            const li = document.createElement('li');
            li.className = 'team-li flex justify-between items-center p-3';
            li.innerHTML = `
                <span class="flex items-center gap-2">
                  <div class="w-3 h-3 rounded-full ${team.colorSet.dot || 'bg-gray-400'}"></div>
                  ${team.name}
                </span>
                <div class="flex items-center">
                    <button class="edit-team-btn text-sm text-indigo-600 hover:text-indigo-800 font-medium mr-3 opacity-100 transition-opacity" data-team-id="${team.docId}">Edit</button>
                    <button class="delete-team-btn text-red-400 hover:text-red-700 font-bold text-xl p-0 rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-100" title="Delete ${team.name}" data-team-id="${team.docId}" data-team-name="${team.name}">&#215;</button>
                </div>
            `;
            teamListUl.appendChild(li);
        });
        
        teamListUl.querySelectorAll('.edit-team-btn').forEach(btn => {
            btn.onclick = () => openEditTeamModal(btn.dataset.teamId);
        });
        teamListUl.querySelectorAll('.delete-team-btn').forEach(btn => {
            btn.onclick = () => checkAndDeleteTeam(btn.dataset.teamId, btn.dataset.teamName);
        });
    }

    addTeamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        addTeamError.textContent = '';
        const newTeamName = newTeamNameInput.value.trim();
        if (!newTeamName) { addTeamError.textContent = 'Please enter a name.'; return; }
        
        const newTeamDocId = newTeamName.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_{2,}/g, '_') + '_' + Date.now();
        
        if ([...teamsMap.values()].some(team => team.name.toLowerCase() === newTeamName.toLowerCase())) {
            addTeamError.textContent = 'A team with this name already exists.'; return;
        }
        
        try {
            const newTeam = { 
                id: newTeamDocId, docId: newTeamDocId, name: newTeamName,
                shiftPattern: defaultPattern, patternStartDate: patternAnchorDate
            };
            await setDoc(doc(db, teamsCollectionPath, newTeamDocId), newTeam);
            newTeamNameInput.value = '';
        } catch (error) {
            console.error("Error adding team: ", error);
            addTeamError.textContent = 'Error saving team.';
        }
    });

    window.openEditTeamModal = (teamId) => {
        const team = teamsMap.get(teamId);
        if (!team) { console.error("Could not find team with ID:", teamId); return; }
        editTeamId.value = teamId;
        editTeamName.value = team.name;
        editTeamAnchorDate.value = team.patternStartDate || patternAnchorDate;
        tempPatternArray = [...(team.shiftPattern || defaultPattern)];
        editTeamPatternLength.value = tempPatternArray.length;
        renderVisualPatternCells();
        editTeamError.textContent = '';
        editTeamModal.classList.remove('hidden');
    }
    
    function renderVisualPatternCells() {
        const emptyShiftInfo = shiftCodesMap['_EMPTY'];
        const len = parseInt(editTeamPatternLength.value) || 0;
        
        while (tempPatternArray.length < len) tempPatternArray.push('_EMPTY');
        if (tempPatternArray.length > len) tempPatternArray = tempPatternArray.slice(0, len);
        
        visualPatternCells.innerHTML = '';
        for (let i = 0; i < len; i++) {
            const shiftCode = tempPatternArray[i] || '_EMPTY';
            const shiftInfo = shiftCodesMap[shiftCode] || { ...emptyShiftInfo, text: '???' };
            const cell = document.createElement('div');
            cell.className = `w-16 h-16 flex flex-col items-center justify-center rounded-lg border-2 cursor-pointer ${shiftInfo.color} ${shiftInfo.textColor} hover:shadow-md`;
            cell.dataset.index = i;
            cell.innerHTML = `
                <span class="text-xs font-medium text-gray-500">Day ${i + 1}</span>
                <span class="text-lg font-bold">${shiftInfo.text || '...'}</span>
            `;
            cell.addEventListener('click', () => openPatternShiftModal(i));
            visualPatternCells.appendChild(cell);
        }
    }
    
    window.openPatternShiftModal = (index) => {
        patternModalDay.textContent = `Day ${index + 1}`;
        patternShiftOptionsContainer.innerHTML = '';
        
        Object.keys(shiftCodesMap).sort().forEach(code => {
            const shiftInfo = shiftCodesMap[code];
            const button = document.createElement('button');
            button.textContent = shiftInfo.text || 'Empty';
            button.className = `p-3 rounded-lg border font-medium transition duration-150 ${shiftInfo.color} ${shiftInfo.textColor} hover:shadow-md hover:ring-2 hover:ring-indigo-400`;
            button.addEventListener('click', () => {
                tempPatternArray[index] = code;
                renderVisualPatternCells();
                closePatternShiftModal();
            });
            patternShiftOptionsContainer.appendChild(button);
        });
        patternShiftModal.classList.remove('hidden');
    }
    
    function closePatternShiftModal() { patternShiftModal.classList.add('hidden'); }
    function closeEditTeamModal() { editTeamModal.classList.add('hidden'); editTeamForm.reset(); }

    editTeamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        editTeamError.textContent = '';
        const teamId = editTeamId.value;
        if (tempPatternArray.some(code => code === undefined || code === null)) {
            editTeamError.textContent = 'All pattern days must have a shift selected.'; return;
        }
        const updatedData = {
            name: editTeamName.value.trim(),
            shiftPattern: tempPatternArray,
            patternStartDate: editTeamAnchorDate.value
        };
        try {
            await updateDoc(doc(db, teamsCollectionPath, teamId), updatedData);
            closeEditTeamModal();
        } catch (error) {
            console.error("Error updating team: ", error);
            editTeamError.textContent = 'Error saving changes.';
        }
    });

    window.checkAndDeleteTeam = (teamId, teamName) => {
        deleteTeamError.textContent = '';
        deleteTeamWarning.textContent = '';
        
        const employeesOnTeam = allUsers.filter(user => user.team_id === teamId);
        
        if (employeesOnTeam.length > 0) {
            deleteTeamWarning.textContent = `Cannot delete "${teamName}". ${employeesOnTeam.length} user(s) are still assigned to it.`;
            confirmDeleteTeamBtn.disabled = true;
            confirmDeleteTeamBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
             deleteTeamWarning.textContent = '';
             confirmDeleteTeamBtn.disabled = false;
             confirmDeleteTeamBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        teamIdToDelete = teamId;
        deleteTeamModalName.textContent = teamName;
        deleteTeamConfirmModal.classList.remove('hidden');
    }

    async function performDeleteTeam() {
        if (!teamIdToDelete || confirmDeleteTeamBtn.disabled) return;
        try {
            await deleteDoc(doc(db, teamsCollectionPath, teamIdToDelete));
        } catch (error) {
            console.error("Error deleting team: ", error);
            deleteTeamError.textContent = 'Error deleting team.';
        }
        closeDeleteTeamModal();
    }
    
    function closeDeleteTeamModal() {
        teamIdToDelete = null;
        deleteTeamConfirmModal.classList.add('hidden');
    }

    // Add listeners for new modals
    closeEditTeamModalBtn.addEventListener('click', closeEditTeamModal);
    editTeamModal.addEventListener('click', (e) => { if (e.target === editTeamModal) closeEditTeamModal(); });
    editTeamPatternLength.addEventListener('change', renderVisualPatternCells);
    
    closePatternModalBtn.addEventListener('click', closePatternShiftModal);
    patternShiftModal.addEventListener('click', (e) => { if (e.target === patternShiftModal) closePatternShiftModal(); });
    
    cancelDeleteTeamBtn.addEventListener('click', closeDeleteTeamModal); 
    confirmDeleteTeamBtn.addEventListener('click', performDeleteTeam);
    deleteTeamConfirmModal.addEventListener('click', (e) => { if (e.target === deleteTeamConfirmModal) closeDeleteTeamModal(); });

    
    // --- Tab & Navigation Functions ---
    
    window.selectTeam = (teamId) => {
      selectedTeamId = teamId;
      
      const teamButtonsContainer = document.getElementById("team-buttons");
      // *** UPDATED: This logic now correctly styles all buttons ***
      teamButtonsContainer.querySelectorAll('button.team-button').forEach(btn => {
          const btnTeamId = btn.dataset.teamId;
          const team = teamsMap.get(btnTeamId);
          if (!team || !team.colorSet) return; // Safety check

          if (btnTeamId === teamId) {
              // This is the selected one
              btn.className = `team-button px-3 py-1.5 rounded-md text-sm transition-colors ${team.colorSet.selected}`;
          } else {
              // This is an unselected one
              btn.className = `team-button px-3 py-1.5 rounded-md text-sm transition-colors ${team.colorSet.btn}`;
          }
      });
      
      renderCalendar();
    }
    
    window.prevMonth = async () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      referenceDate = new Date(currentYear, currentMonth, 1);
      await renderCalendar();
    }
    window.nextMonth = async () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      referenceDate = new Date(currentYear, currentMonth, 1);
      await renderCalendar();
    }
    
    function setActiveTab(activeIndex) {
        document.getElementById("leaveManagementPanel").style.display = activeIndex === 0 ? "block" : "none";
        document.getElementById("userManagementPanel").style.display = activeIndex === 1 ? "block" : "none";
        document.getElementById("teamManagementPanel").style.display = activeIndex === 2 ? "block" : "none";
        
        const tabs = document.querySelectorAll(".tab-button");
        tabs.forEach((tab, index) => {
            if (index === activeIndex) {
                tab.classList.add("active-tab");
            } else {
                tab.classList.remove("active-tab");
            }
        });
    }

    window.showLeaveManagement = () => {
        setActiveTab(0);
    }
    window.showUserManagement = () => {
        setActiveTab(1);
        renderUserManagement(); 
    }
    window.showTeamManagement = () => {
        setActiveTab(2);
        openManageTeamsModal(); 
    }
    

  </script>
</body>
</html>


