<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Partial Approvals (No localStorage)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <style>
    body {
      font-family: Arial, sans-serif; background: #f4f4f4; color: #333;
      margin: 0; padding: 15px; font-size: 14px;
    }
    .container {
      max-width: 800px; margin: 0 auto; background: #fff;
      padding: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; margin: 10px 0; font-size: 20px; }
    p.version { text-align: center; font-size: 12px; color: #666; margin: 0; }

    /* Form */
    #leaveForm {
      display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
      margin: 10px 0;
    }
    #leaveForm input, #leaveForm button {
      padding: 6px; font-size: 14px; border-radius: 4px;
    }
    #leaveForm input {
      border: 1px solid #ccc; 
      min-width: 120px;
    }
    #leaveForm button {
      background: #4CAF50; color: #fff; border: none; cursor: pointer;
    }
    #leaveForm button:hover { background: #45a049; }

    /* Team Buttons */
    .team-buttons { text-align: center; margin: 10px 0; }
    .team-buttons button {
      margin: 0 5px; padding: 6px 12px; border: none; border-radius: 4px;
      cursor: pointer; color: #fff; transition: opacity 0.2s;
    }
    .team-buttons button:hover { opacity: 0.9; }
    .team-a { background: #228B22; }
    .team-b { background: #0066cc; }
    .team-c { background: #9C27B0; }

    /* Month Nav */
    .month-nav {
      display: flex; justify-content: center; align-items: center;
      gap: 10px; margin-bottom: 10px;
    }
    .month-nav button {
      padding: 4px 12px; font-size: 14px; border: none; border-radius: 4px;
      background: #666; color: #fff; cursor: pointer;
    }
    .month-nav button:hover { opacity: 0.9; }
    #monthLabel { font-weight: bold; font-size: 14px; }

    /* Calendar */
    #calendarGrid {
      display: grid; grid-template-columns: repeat(7,1fr);
      gap: 2px; max-width: 700px; margin: 0 auto 10px auto;
    }
    .day-cell {
      background: #fff; border: 1px solid #ccc; min-height: 70px;
      padding: 4px; border-radius: 4px; position: relative;
      display: flex; flex-direction: column;
    }
    .shift-box {
      font-weight: bold; color: #fff; padding: 2px 4px;
      border-radius: 3px; text-align: center; margin-bottom: 4px;
      font-size: 12px;
    }
    .shift-morning { background-color: #228B22; }
    .shift-night   { background-color: #90EE90; color: #000; }
    .shift-off     { background-color: #ddd; color: #000; }
    .leave-entry {
      background: #fff9c4; margin: 2px 0; padding: 2px 4px;
      border-radius: 3px; font-size: 11px; text-align: left;
    }
    .leave-entry.approved { background: #c8e6c9; font-weight: bold; }
    .leave-entry.rejected { background: #f8d7da; color: #721c24; text-decoration: line-through; }
    .leave-entry.management { background: #ffeeba; }
    .red-dot {
      width: 8px; height: 8px; background: red; border-radius: 50%;
      position: absolute; top: 4px; right: 4px;
    }

    /* Admin Summary */
    #adminSummary {
      background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 8px;
      max-width: 700px; margin: 0 auto;
    }
    .admin-card {
      background: #f1f1f1; border: 1px solid #ddd; margin: 4px 0;
      padding: 6px; border-radius: 4px; font-size: 12px;
    }
    .admin-card h4 { margin: 4px 0; font-size: 13px; }
    .day-row {
      display: flex; gap: 5px; margin: 4px 0; align-items: center;
    }
    .day-row select {
      font-size: 12px; padding: 2px; border-radius: 4px; margin-left: 4px;
    }
    .admin-card button {
      margin-left: 6px; padding: 2px 6px; font-size: 12px; border: none;
      border-radius: 4px; background: #d9534f; color: #fff; cursor: pointer;
    }
    .admin-card button:hover { opacity: 0.9; }
    .whatsapp-btn {
      background: #25D366; color: #fff; border: none; border-radius: 4px;
      padding: 4px 8px; font-size: 12px; cursor: pointer; margin-left: 6px;
    }
    .whatsapp-btn:hover { opacity: 0.9; }

    .footer { text-align: center; color: #999; font-size: 11px; margin-top: 10px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Partial Approvals (No localStorage)</h1>
  <p class="version">v2.7 — Day-level statuses, in-memory only, tested with console logs</p>

  <!-- LEAVE FORM -->
  <form id="leaveForm">
    <input type="text" id="staffName" placeholder="Staff Name" required>
    <input type="text" id="staffID" placeholder="Staff ID" required>
    <input type="date" id="startDate" required>
    <input type="date" id="endDate" required>
    <button type="submit">Submit</button>
  </form>

  <!-- TEAM BUTTONS -->
  <div class="team-buttons">
    <button class="team-a" onclick="selectTeam(1)">Team A</button>
    <button class="team-b" onclick="selectTeam(2)">Team B</button>
    <button class="team-c" onclick="selectTeam(3)">Team C</button>
  </div>

  <!-- MONTH NAV -->
  <div class="month-nav">
    <button onclick="prevMonth()">←</button>
    <span id="monthLabel">Loading...</span>
    <button onclick="nextMonth()">→</button>
  </div>

  <div id="calendarGrid"></div>

  <div id="adminSummary">
    <h3>Admin Summary</h3>
    <div id="adminList"></div>
  </div>

  <div class="footer">&copy; 2025. In-memory partial approvals. No localStorage.</div>
</div>

<script>
console.log("Script loaded. Let's define our data model.");

/* SHIFT PATTERNS */
var TeamPatterns = {
  1: ["morning","morning","night","night","off","off"],
  2: ["off","off","morning","morning","night","night"],
  3: ["night","night","off","off","morning","morning"]
};
var selectedTeam = 1;
var referenceDate = new Date(2025,2,1);

function daysBetween(a,b){
  var A=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate());
  var B=Date.UTC(b.getFullYear(),b.getMonth(),b.getDate());
  return Math.floor((B - A)/(1000*60*60*24));
}
function formatDate(d){
  var y=d.getFullYear();
  var m=String(d.getMonth()+1).padStart(2,"0");
  var dd=String(d.getDate()).padStart(2,"0");
  return y+"-"+m+"-"+dd;
}
function getShift(d){
  var diff=daysBetween(referenceDate,d);
  var idx=((diff%6)+6)%6;
  return TeamPatterns[selectedTeam][idx];
}

// In-memory requests array (no localStorage)
var requests = []; // each request has .days: [{date:'...',status:'Pending'},...]

var currentYear=2025, currentMonth=2; // 2=March

function renderCalendar(){
  console.log("renderCalendar() called, year=", currentYear, "month=", currentMonth);
  var monthNames=["January","February","March","April","May","June",
                  "July","August","September","October","November","December"];
  document.getElementById("monthLabel").textContent= monthNames[currentMonth]+" "+currentYear;

  var grid= document.getElementById("calendarGrid");
  grid.innerHTML="";
  var firstDay= new Date(currentYear, currentMonth, 1);
  var offset= (firstDay.getDay()+6)%7;
  var daysInMonth= new Date(currentYear, currentMonth+1, 0).getDate();

  // fill blank
  for(var i=0;i<offset;i++){
    var blank= document.createElement("div");
    blank.className="day-cell";
    grid.appendChild(blank);
  }

  for(var d=1; d<=daysInMonth; d++){
    var dateObj= new Date(currentYear, currentMonth, d);
    var dateStr= formatDate(dateObj);
    var cell= document.createElement("div");
    cell.className="day-cell";

    // SHIFT BOX
    var shift= getShift(dateObj);
    var shiftBox= document.createElement("div");
    shiftBox.className="shift-box";
    if(shift==="morning") shiftBox.classList.add("shift-morning");
    if(shift==="night")   shiftBox.classList.add("shift-night");
    if(shift==="off")     shiftBox.classList.add("shift-off");
    shiftBox.textContent= d;
    cell.appendChild(shiftBox);

    // gather day-level statuses
    var dayEntries=[];
    for(var r=0; r<requests.length; r++){
      var req= requests[r];
      for(var dd=0; dd<req.days.length; dd++){
        if(req.days[dd].date===dateStr){
          dayEntries.push({
            staffName: req.staffName,
            staffID: req.staffID,
            status: req.days[dd].status
          });
        }
      }
    }

    // red dot if >2 non-rejected
    var nonRejected= dayEntries.filter(function(e){return e.status!=="Rejected";}).length;
    if(nonRejected>2){
      var dot= document.createElement("div");
      dot.className="red-dot";
      cell.appendChild(dot);
    }

    // add each day entry
    dayEntries.forEach(function(e){
      var entryDiv= document.createElement("div");
      entryDiv.className="leave-entry";
      if(e.status==="Approved") entryDiv.classList.add("approved");
      if(e.status==="Rejected") entryDiv.classList.add("rejected");
      if(e.status==="Management") entryDiv.classList.add("management");
      entryDiv.textContent= e.staffName+" ("+ e.staffID +")";
      cell.appendChild(entryDiv);
    });

    grid.appendChild(cell);
  }
  renderAdmin();
  console.log("renderCalendar() completed");
}

function renderAdmin(){
  console.log("renderAdmin() called...");
  var adminList= document.getElementById("adminList");
  adminList.innerHTML="";
  for(var i=0; i<requests.length; i++){
    var req= requests[i];
    var card= document.createElement("div");
    card.className="admin-card";
    var html= "<strong>"+req.staffName+"</strong> ("+req.staffID+")<br>"
             + req.fromDate+" → "+req.toDate+"<br>"
             + "<h4>Day-by-Day Status</h4>";
    for(var d=0; d<req.days.length; d++){
      var dayObj= req.days[d];
      html+= '<div class="day-row">'
           +   '<span>'+dayObj.date+'</span>'
           +   '<select data-req="'+i+'" data-day="'+d+'">'
           +     '<option value="Pending"'+(dayObj.status==="Pending"?" selected":"")+'>Pending</option>'
           +     '<option value="Approved"'+(dayObj.status==="Approved"?" selected":"")+'>Approved</option>'
           +     '<option value="Rejected"'+(dayObj.status==="Rejected"?" selected":"")+'>Rejected</option>'
           +     '<option value="Management"'+(dayObj.status==="Management"?" selected":"")+'>Management</option>'
           +   '</select>'
           + '</div>';
    }
    html+= '<button data-del="'+i+'">Delete Request</button>'
         + '<button class="whatsapp-btn" data-ws="'+i+'">WhatsApp</button>';
    card.innerHTML= html;
    adminList.appendChild(card);
  }

  // day-level changes
  adminList.querySelectorAll("select").forEach(function(sel){
    sel.onchange= function(){
      var reqIndex= sel.getAttribute("data-req");
      var dayIndex= sel.getAttribute("data-day");
      requests[reqIndex].days[dayIndex].status= sel.value;
      renderCalendar();
    };
  });

  // handle delete
  adminList.querySelectorAll("button[data-del]").forEach(function(btn){
    btn.onclick= function(){
      var i= btn.getAttribute("data-del");
      requests.splice(i,1);
      renderCalendar();
    };
  });

  // handle WhatsApp
  adminList.querySelectorAll("button.whatsapp-btn").forEach(function(b){
    b.onclick= function(){
      var i= b.getAttribute("data-ws");
      var req= requests[i];
      var msg= "Hello "+req.staffName+" ("+req.staffID+"), your day-by-day leave status:\\n";
      for(var dd=0; dd<req.days.length; dd++){
        var dayObj= req.days[dd];
        msg+= "• "+dayObj.date+": "+dayObj.status+"\\n";
      }
      var link= "https://wa.me/?text="+ encodeURIComponent(msg);
      window.open(link, "_blank");
    };
  });
  console.log("renderAdmin() completed");
}

// SHIFT TEAM
function selectTeam(num){
  selectedTeam= num;
  console.log("Team changed to", num);
  renderCalendar();
}

// FORM SUBMIT
document.getElementById("leaveForm").onsubmit= function(e){
  e.preventDefault();
  console.log("Form submitted...");
  var name= document.getElementById("staffName").value.trim();
  var id= document.getElementById("staffID").value.trim();
  var start= document.getElementById("startDate").value;
  var end= document.getElementById("endDate").value;
  if(!name||!id||!start||!end){ alert("All fields required."); return; }
  if(end<start){ alert("End date must not be before start date."); return; }

  var d= new Date(start);
  var endDate= new Date(end);
  var dayArr= [];
  while(d<= endDate){
    dayArr.push({ date: formatDate(d), status:"Pending" });
    d.setDate(d.getDate()+1);
  }
  var newReq= {
    staffName: name,
    staffID: id,
    fromDate: start,
    toDate: end,
    days: dayArr
  };
  requests.push(newReq);
  e.target.reset();
  renderCalendar();
  alert("Leave request submitted (all days pending).");
};

var currentYear=2025, currentMonth=2; // 2=March

function prevMonth(){
  currentMonth--;
  if(currentMonth<0){ currentMonth=11; currentYear--; }
  renderCalendar();
}
function nextMonth(){
  currentMonth++;
  if(currentMonth>11){ currentMonth=0; currentYear++; }
  renderCalendar();
}

// ON LOAD
document.addEventListener("DOMContentLoaded", function(){
  console.log("DOMContentLoaded - let's render the calendar");
  renderCalendar();
});
</script>
</body>
</html>