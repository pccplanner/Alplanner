<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Leave Management System</title>
</head>
<body>
  <h2>Employee Leave Management System</h2>

  <!-- Navigation for Month Selection -->
  <div class="navigation">
    <button onclick="previousMonth()">Previous Month</button>
    <span id="currentMonthYear"></span>
    <button onclick="nextMonth()">Next Month</button>
  </div>

  <!-- Calendar View -->
  <div>
    <h3>Leave Calendar</h3>
    <div id="calendar"></div>
  </div>

  <!-- Time-Off Request Submission Section -->
  <div>
    <h3>Submit Time-Off Request</h3>
    <label for="requestStaffName">Staff Name:</label>
    <input type="text" id="requestStaffName" placeholder="e.g., James">
    <label for="requestStaffID">Staff ID:</label>
    <input type="text" id="requestStaffID" placeholder="e.g., 8283">
    <label for="fromDate">From Date:</label>
    <input type="date" id="fromDate">
    <label for="toDate">To Date:</label>
    <input type="date" id="toDate">
    <button onclick="submitRequest()">Submit Request</button>
  </div>

  <!-- Pending Requests Section -->
  <div id="requestList">
    <h3>Pending Leave Requests</h3>
    <ul id="requestListBody"></ul>
  </div>

  <!-- Enhanced Monthly Report Section -->
  <div>
    <h3 id="summaryTitle"></h3>
    <div>
      <h4>Detailed Leave Summary</h4>
      <table>
        <thead>
          <tr>
            <th>Staff</th>
            <th>Leave Dates</th>
            <th>Approved Days</th>
            <th>Write-in Days</th>
            <th>Total Days</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>
    <div>
      <h4>Leave Patterns</h4>
      <p id="mostCommonLeaveDay"></p>
    </div>
  </div>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2, h3, h4 {
      color: #2c3e50;
    }
    div {
      margin-bottom: 20px;
    }
    .navigation {
      text-align: center;
      margin-bottom: 20px;
    }
    .navigation button {
      margin: 0 10px;
      padding: 5px 10px;
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }
    .navigation button:hover {
      background-color: #2980b9;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #ddd;
      padding: 1px;
    }
    .calendar-day {
      background-color: white;
      padding: 10px;
      text-align: center;
      border: 1px solid #ddd;
      min-height: 50px;
    }
    .calendar-day.header {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .calendar-day.empty {
      background-color: #f9f9f9;
    }
    .calendar-day.leave {
      background-color: #ffeb3b;
    }
    .calendar-day.leave.approved {
      background-color: #27ae60;
      color: white;
    }
    .calendar-day.leave.writein {
      background-color: #e67e22;
      color: white;
    }
    label {
      margin-right: 5px;
    }
    input, select, button {
      margin: 5px;
      padding: 5px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .range-block {
      margin: 5px 0;
      display: flex;
      align-items: center;
    }
    .range-block.approved .status-dot {
      background-color: #27ae60;
    }
    .range-block.writein .status-dot {
      background-color: #e67e22;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      padding: 5px 0;
    }
    p {
      margin: 5px 0;
    }
  </style>

  <script>
    // Global variables
    let requests = [];
    let currentYear = 2025;
    let currentMonth = 3; // 0-based (3 = April)

    // Utility function to calculate days between two dates
    function daysBetween(date1, date2) {
      const oneDay = 24 * 60 * 60 * 1000;
      return Math.round(Math.abs((date1 - date2) / oneDay));
    }

    // Function to group requests by staff ID
    function groupRequestsByStaffID(requests) {
      const grouped = {};
      requests.forEach(req => {
        if (!grouped[req.staffID]) {
          grouped[req.staffID] = {
            staffID: req.staffID,
            staffName: req.staffName,
            requests: []
          };
        }
        grouped[req.staffID].requests.push(req);
      });
      return Object.values(grouped);
    }

    // Fetch requests from the backend
    async function fetchRequests() {
      try {
        const response = await fetch('https://api.pccplanner.com/api/get_leaves', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error('Error fetching requests:', error);
        return [];
      }
    }

    // Fetch leave patterns from the backend
    async function fetchLeavePatterns() {
      try {
        const response = await fetch(`https://api.pccplanner.com/api/leave-patterns?year=${currentYear}&month=${String(currentMonth + 1).padStart(2, "0")}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error('Error fetching leave patterns:', error);
        return { mostCommonDay: null, count: 0 };
      }
    }

    // Submit a time-off request via the backend
    async function submitRequest() {
      const staffName = document.getElementById("requestStaffName").value;
      const staffID = document.getElementById("requestStaffID").value;
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;

      if (staffName && staffID && fromDate && toDate) {
        try {
          const response = await fetch('https://api.pccplanner.com/api/submit_leave', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ staffName, staffID, fromDate, toDate })
          });
          const result = await response.json();
          if (!response.ok) throw new Error(result.message || `HTTP error! status: ${response.status}`);
          alert('Time-off request submitted successfully.');
          // Refresh data
          requests.length = 0;
          const updatedRequests = await fetchRequests();
          updatedRequests.forEach(req => requests.push(req));
          renderCalendar();
          renderRequestList();
          renderMonthlySummary();
        } catch (error) {
          console.error('Error submitting request:', error);
          alert('Failed to submit request: ' + error.message);
        }
      } else {
        alert("Please fill in all fields.");
      }
    }

    // Render the pending requests list
    async function renderRequestList() {
      const requestListBody = document.getElementById("requestListBody");
      requestListBody.innerHTML = "";
      const allRequests = await fetchRequests();
      const pendingRequests = allRequests.filter(req => req.days.some(day => day.status === 'Pending'));
      pendingRequests.forEach(req => {
        const pendingDays = req.days.filter(day => day.status === 'Pending');
        pendingDays.forEach(day => {
          const li = document.createElement("li");
          li.innerHTML = `${req.staffName} (${req.staffID}): ${day.date} 
            <button onclick="approveDay(${day.id}, 'Approved')">Approve</button>
            <button onclick="approveDay(${day.id}, 'Write-in')">Write-in</button>
            <button onclick="approveDay(${day.id}, 'Rejected')">Reject</button>`;
          requestListBody.appendChild(li);
        });
      });
    }

    // Approve or reject a day via the backend
    async function approveDay(dayId, status) {
      try {
        const response = await fetch('https://api.pccplanner.com/api/update_day_status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ day_id: dayId, status })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message || `HTTP error! status: ${response.status}`);
        alert(`Day status updated to ${status}.`);
        // Refresh data
        requests.length = 0;
        const updatedRequests = await fetchRequests();
        updatedRequests.forEach(req => requests.push(req));
        renderCalendar();
        renderRequestList();
        renderMonthlySummary();
      } catch (error) {
        console.error('Error updating day status:', error);
        alert('Failed to update day status: ' + error.message);
      }
    }

    // Render the calendar
    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";

      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDay = firstDay.getDay();

      // Render day headers
      const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      daysOfWeek.forEach(day => {
        const dayHeader = document.createElement("div");
        dayHeader.className = "calendar-day header";
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
      });

      // Render empty days before the first day of the month
      for (let i = 0; i < startingDay; i++) {
        const emptyDay = document.createElement("div");
        emptyDay.className = "calendar-day empty";
        calendar.appendChild(emptyDay);
      }

      // Render days of the month
      const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}`;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${monthStr}-${String(day).padStart(2, "0")}`;
        const dayDiv = document.createElement("div");
        dayDiv.className = "calendar-day";
        dayDiv.textContent = day;

        // Check for leave requests on this day
        let leaveStatus = null;
        requests.forEach(req => {
          const matchingDay = req.days.find(d => d.date === dateStr);
          if (matchingDay && (matchingDay.status === "Approved" || matchingDay.status === "Write-in")) {
            leaveStatus = matchingDay.status.toLowerCase();
            dayDiv.textContent += `\n${req.staffName} (${req.staffID})`;
          }
        });

        if (leaveStatus) {
          dayDiv.className += ` leave ${leaveStatus}`;
        }

        calendar.appendChild(dayDiv);
      }
    }

    // Enhanced renderMonthlySummary function
    async function renderMonthlySummary() {
      const summaryTableBody = document.getElementById("summaryTableBody");
      const mostCommonLeaveDay = document.getElementById("mostCommonLeaveDay");
      summaryTableBody.innerHTML = "";

      const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}`;
      const groupedRequests = groupRequestsByStaffID(requests);

      // Fetch leave patterns from backend
      const leavePatterns = await fetchLeavePatterns();

      // Process each staff member
      groupedRequests.forEach(group => {
        // Filter days that fall within the current month and have "Approved" or "Write-in" status
        const monthlyLeaves = [];
        group.requests.forEach(req => {
          const daysInMonth = req.days.filter(day => 
            day.date.startsWith(monthStr) && 
            (day.status === "Approved" || day.status === "Write-in")
          );
          if (daysInMonth.length > 0) {
            monthlyLeaves.push({ days: daysInMonth });
          }
        });

        if (monthlyLeaves.length === 0) return; // Skip if no approved or write-in leaves in this month

        // Group days by status (Approved or Write-in)
        const leavesByStatus = { Approved: [], WriteIn: [] };
        monthlyLeaves.forEach(leave => {
          leave.days.forEach(day => {
            const statusKey = day.status === "Approved" ? "Approved" : "WriteIn";
            leavesByStatus[statusKey].push(day);
          });
        });

        // For each status, group consecutive days into ranges
        const rangesByStatus = { Approved: [], WriteIn: [] };
        for (const status of ["Approved", "WriteIn"]) {
          const days = leavesByStatus[status];
          if (days.length === 0) continue;

          days.sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort by date
          let currentRange = [days[0]];
          for (let i = 1; i < days.length; i++) {
            const prevDate = new Date(currentRange[currentRange.length - 1].date);
            const currDate = new Date(days[i].date);
            if (daysBetween(prevDate, currDate) === 1) {
              currentRange.push(days[i]);
            } else {
              rangesByStatus[status].push(currentRange);
              currentRange = [days[i]];
            }
          }
          if (currentRange.length > 0) rangesByStatus[status].push(currentRange);
        }

        // Calculate total days for each status
        const approvedDays = leavesByStatus.Approved.length;
        const writeInDays = leavesByStatus.WriteIn.length;
        const totalDays = approvedDays + writeInDays;

        // Format the leave ranges for display
        const leaveRangeHTML = [];
        for (const status of ["Approved", "WriteIn"]) {
          const ranges = rangesByStatus[status];
          if (ranges.length === 0) continue;

          const statusLabel = status === "Approved" ? "Approved" : "Write-in";
          const statusClass = status.toLowerCase();
          const rangeText = ranges.map(range => {
            const startDate = range[0].date.split('-')[2]; // Get day (e.g., "07")
            const endDate = range[range.length - 1].date.split('-')[2]; // Get day (e.g., "10")
            return startDate === endDate ? startDate : `${startDate}-${endDate}`;
          }).join(', ');

          leaveRangeHTML.push(`
            <div class="range-block ${statusClass}">
              <span class="status-dot"></span>
              <strong>${statusLabel}:</strong> ${rangeText}
            </div>
          `);
        }

        // Create table row
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="staff-name">${group.staffName} (${group.staffID})</td>
          <td class="leave-range">${leaveRangeHTML.join('')}</td>
          <td class="approved-days">${approvedDays}</td>
          <td class="writein-days">${writeInDays}</td>
          <td class="total-days">${totalDays}</td>
        `;
        summaryTableBody.appendChild(row);
      });

      // Render Leave Patterns
      mostCommonLeaveDay.textContent = leavePatterns.mostCommonDay 
        ? `Most common leave day: ${leavePatterns.mostCommonDay} (taken by ${leavePatterns.count} staff)`
        : "No leave data available.";

      // If no leaves, display a message
      if (summaryTableBody.children.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="5" style="text-align: center; color: #7f8c8d; font-size: 11px;">No approved or write-in leave requests for this month.</td>`;
        summaryTableBody.appendChild(row);
      }
    }

    // Navigation functions
    function previousMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      updateMonthYear();
      renderCalendar();
      renderRequestList();
      renderMonthlySummary();
    }

    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      updateMonthYear();
      renderCalendar();
      renderRequestList();
      renderMonthlySummary();
    }

    function updateMonthYear() {
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      document.getElementById("currentMonthYear").textContent = `${monthNames[currentMonth]} ${currentYear}`;
      document.getElementById("summaryTitle").textContent = `Enhanced Monthly Leave Summary Report for ${monthNames[currentMonth]} ${currentYear}`;
    }

    // Initialize the page
    async function init() {
      // Fetch initial data
      requests.length = 0;
      const fetchedRequests = await fetchRequests();
      fetchedRequests.forEach(req => requests.push(req));

      updateMonthYear();
      renderCalendar();
      renderRequestList();
      renderMonthlySummary();
    }

    // Run the script when the page loads
    window.onload = init;
  </script>
</body>
</html>