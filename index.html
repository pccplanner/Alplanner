<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leave Booking System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 10px; font-size: 13px; color: #333; display: flex;
    }
    .container { display: flex; max-width: 1200px; margin: 0 auto; gap: 10px; }

    /* Sidebar */
    .sidebar { width: 250px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .sidebar h2 { font-size: 16px; margin: 0 0 10px; color: #2c3e50; }
    .staff-list { max-height: 200px; overflow-y: auto; }
    .staff-item { padding: 5px; background: #ecf0f1; margin: 2px 0; border-radius: 4px; cursor: move; display: flex; align-items: center; gap: 5px; }
    .staff-item span { font-weight: 600; }
    .staff-initials { width: 20px; height: 20px; background: #3498db; color: #fff; border-radius: 50%; text-align: center; line-height: 20px; font-size: 11px; }
    .admin-panel { margin-top: 10px; }
    .admin-panel h3 { font-size: 14px; margin: 0 0 5px; }
    .request-item { padding: 5px; border: 1px solid #e0e0e0; margin: 5px 0; border-radius: 4px; }
    .request-item span { font-weight: 600; }
    .timeline { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
    .day-block { padding: 3px 6px; background: #f1f1f1; border-radius: 3px; display: flex; align-items: center; gap: 3px; }
    .day-block select { font-size: 10px; padding: 1px; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; }
    .status-dot.pending { background: #e67e22; }
    .status-dot.approved { background: #27ae60; }
    .status-dot.rejected { background: #e74c3c; }
    .status-dot.management { background: #f1c40f; }

    /* Main Content */
    .main-content { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    h1 { text-align: center; font-size: 18px; margin: 5px 0; color: #2c3e50; }
    p.version { text-align: center; font-size: 11px; color: #7f8c8d; margin: 0 0 10px; }
    .month-nav { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 8px 0; }
    .month-nav button { padding: 4px 10px; background: #7f8c8d; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .month-nav button:hover { background: #6c7a89; }
    #monthLabel { font-weight: 600; color: #2c3e50; }

    /* Calendar */
    #calendarGrid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
    .day-cell { background: #fff; border: 1px solid #e0e0e0; min-height: 80px; padding: 3px; border-radius: 4px; position: relative; }
    .day-cell.drop-target { border: 2px dashed #3498db; }
    .shift-box { font-weight: 600; padding: 2px 4px; border-radius: 3px; text-align: center; margin-bottom: 3px; }
    .shift-morning { background: #27ae60; color: #fff; }
    .shift-night { background: #a9dfbf; color: #2c3e50; }
    .shift-off { background: #dcdcdc; color: #7f8c8d; }
    .staff-avatars { display: flex; flex-wrap: wrap; gap: 2px; }
    .avatar { width: 18px; height: 18px; background: #3498db; color: #fff; border-radius: 50%; text-align: center; line-height: 18px; font-size: 10px; }
    .request-count { position: absolute; top: 3px; right: 3px; background: #e74c3c; color: #fff; border-radius: 50%; width: 16px; height: 16px; line-height: 16px; text-align: center; font-size: 10px; }
    .popover { display: none; position: absolute; background: #fff; border: 1px solid #e0e0e0; padding: 5px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; font-size: 11px; max-width: 200px; }
    .popover div { margin: 2px 0; }
    .popover .approved { color: #27ae60; font-weight: 600; }
    .popover .rejected { color: #e74c3c; text-decoration: line-through; }
    .popover .management { color: #f1c40f; }
  </style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2>Staff</h2>
    <div class="staff-list" id="staffList"></div>
    <div class="admin-panel">
      <h3>Pending Requests</h3>
      <div id="adminList"></div>
    </div>
  </div>
  <div class="main-content">
    <h1>Staff Leave Calendar</h1>
    <p class="version">v4.0 — Drag-and-Drop with Avatar Display</p>
    <div class="month-nav">
      <button onclick="prevMonth()">←</button>
      <span id="monthLabel">Loading...</span>
      <button onclick="nextMonth()">→</button>
    </div>
    <div id="calendarGrid"></div>
  </div>
</div>

<script>
// Shift Patterns
var TeamPatterns = {
  1: ["morning", "morning", "night", "night", "off", "off"],
  2: ["off", "off", "morning", "morning", "night", "night"],
  3: ["night", "night", "off", "off", "morning", "morning"]
};
var selectedTeam = 1;
var referenceDate = new Date(2025, 2, 1);
var requests = [];
var currentYear = 2025, currentMonth = 2;
var staffList = ["John Doe (JD01)", "Jane Smith (JS02)", "Mike Tan (MT03)"]; // Example staff, expand as needed

function daysBetween(a, b) {
  var A = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
  var B = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.floor((B - A) / (1000 * 60 * 60 * 24));
}

function formatDate(d) {
  var y = d.getFullYear();
  var m = String(d.getMonth() + 1).padStart(2, "0");
  var dd = String(d.getDate()).padStart(2, "0");
  return y + "-" + m + "-" + dd;
}

function getShift(d) {
  var diff = daysBetween(referenceDate, d);
  var idx = ((diff % 6) + 6) % 6;
  return TeamPatterns[selectedTeam][idx];
}

function renderStaffList() {
  var staffListDiv = document.getElementById("staffList");
  staffListDiv.innerHTML = "";
  staffList.forEach(staff => {
    var [name, id] = staff.match(/(.+) \((.+)\)/).slice(1);
    var item = document.createElement("div");
    item.className = "staff-item";
    item.draggable = true;
    item.innerHTML = `<div class="staff-initials">${name.split(" ").map(n => n[0]).join("")}</div><span>${name} (${id})</span>`;
    item.ondragstart = (e) => e.dataTransfer.setData("staff", staff);
    staffListDiv.appendChild(item);
  });
}

function renderCalendar() {
  var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  document.getElementById("monthLabel").textContent = monthNames[currentMonth] + " " + currentYear;

  var grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";
  var firstDay = new Date(currentYear, currentMonth, 1);
  var offset = (firstDay.getDay() + 6) % 7;
  var daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  for (var i = 0; i < offset; i++) {
    grid.appendChild(document.createElement("div")).className = "day-cell";
  }

  for (var d = 1; d <= daysInMonth; d++) {
    var dateObj = new Date(currentYear, currentMonth, d);
    var dateStr = formatDate(dateObj);
    var cell = document.createElement("div");
    cell.className = "day-cell";
    cell.dataset.date = dateStr;

    var shift = getShift(dateObj);
    var shiftBox = document.createElement("div");
    shiftBox.className = "shift-box " + (shift === "morning" ? "shift-morning" : shift === "night" ? "shift-night" : "shift-off");
    shiftBox.textContent = d;
    cell.appendChild(shiftBox);

    var avatars = document.createElement("div");
    avatars.className = "staff-avatars";
    var dayEntries = [];
    requests.forEach(req => {
      req.days.forEach(day => {
        if (day.date === dateStr) {
          dayEntries.push({ staffName: req.staffName, staffID: req.staffID, status: day.status });
        }
      });
    });

    var nonRejected = dayEntries.filter(e => e.status !== "Rejected");
    if (nonRejected.length > 2) {
      var count = document.createElement("div");
      count.className = "request-count";
      count.textContent = nonRejected.length;
      cell.appendChild(count);
    }

    nonRejected.forEach(e => {
      var avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = e.staffName.split(" ").map(n => n[0]).join("");
      avatars.appendChild(avatar);
    });
    cell.appendChild(avatars);

    var popover = document.createElement("div");
    popover.className = "popover";
    popover.innerHTML = dayEntries.map(e => `<div class="${e.status.toLowerCase()}">${e.staffName} (${e.staffID}): ${e.status}</div>`).join("");
    cell.appendChild(popover);

    cell.onmouseover = () => dayEntries.length > 0 && (popover.style.display = "block");
    cell.onmouseout = () => popover.style.display = "none";
    cell.ondragover = (e) => { e.preventDefault(); cell.classList.add("drop-target"); };
    cell.ondragleave = () => cell.classList.remove("drop-target");
    cell.ondrop = (e) => {
      e.preventDefault();
      cell.classList.remove("drop-target");
      var staff = e.dataTransfer.getData("staff");
      var [name, id] = staff.match(/(.+) \((.+)\)/).slice(1);
      var endDate = prompt(`Leave for ${name} (${id}) starting ${dateStr}. Enter end date (YYYY-MM-DD):`, dateStr);
      if (endDate && endDate >= dateStr) {
        var d = new Date(dateStr);
        var end = new Date(endDate);
        var dayArr = [];
        while (d <= end) {
          dayArr.push({ date: formatDate(d), status: "Pending" });
          d.setDate(d.getDate() + 1);
        }
        requests.push({ staffName: name, staffID: id, fromDate: dateStr, toDate: endDate, days: dayArr });
        renderCalendar();
      }
    };

    grid.appendChild(cell);
  }
  renderAdmin();
}

function renderAdmin() {
  var adminList = document.getElementById("adminList");
  adminList.innerHTML = "";
  requests.forEach((req, reqIndex) => {
    var item = document.createElement("div");
    item.className = "request-item";
    item.innerHTML = `
      <span>${req.staffName} (${req.staffID})</span>
      <div class="timeline">
        ${req.days.map((day, dayIndex) => `
          <div class="day-block">
            <span>${day.date}</span>
            <div class="status-dot ${day.status.toLowerCase()}"></div>
            <select data-req="${reqIndex}" data-day="${dayIndex}">
              <option value="Pending" ${day.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="Approved" ${day.status === "Approved" ? "selected" : ""}>Approved</option>
              <option value="Rejected" ${day.status === "Rejected" ? "selected" : ""}>Rejected</option>
              <option value="Management" ${day.status === "Management" ? "selected" : ""}>Management</option>
            </select>
          </div>
        `).join('')}
      </div>
    `;
    adminList.appendChild(item);
  });

  adminList.querySelectorAll("select").forEach(sel => {
    sel.onchange = function() {
      var reqIndex = sel.getAttribute("data-req");
      var dayIndex = sel.getAttribute("data-day");
      requests[reqIndex].days[dayIndex].status = sel.value;
      renderCalendar();
    };
  });
}

function prevMonth() {
  currentMonth--;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  renderCalendar();
}

function nextMonth() {
  currentMonth++;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  renderCalendar();
}

document.addEventListener("DOMContentLoaded", () => {
  renderStaffList();
  renderCalendar();
});
</script>
</body>
</html>