<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leave Booking System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: Arial, sans-serif; 
      background: #f5f7fa; 
      margin: 0; 
      padding: 10px; 
      font-size: 13px; 
      color: #333;
    }
    .container {
      max-width: 900px; 
      margin: 0 auto; 
      background: #fff; 
      padding: 15px; 
      border-radius: 8px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    h1 {
      text-align: center; 
      font-size: 18px; 
      margin: 5px 0; 
      color: #2c3e50;
    }
    p.version {
      text-align: center; 
      font-size: 11px; 
      color: #7f8c8d; 
      margin: 0 0 10px;
    }

    /* Leave Form */
    #leaveForm {
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      padding: 10px; 
      background: #ecf0f1; 
      border-radius: 6px; 
      margin-bottom: 10px;
    }
    #leaveForm label {
      font-weight: 600; 
      margin-right: 4px; 
      color: #34495e;
    }
    #leaveForm input {
      padding: 5px 8px; 
      border: 1px solid #bdc3c7; 
      border-radius: 4px; 
      font-size: 13px; 
      width: 120px;
    }
    #leaveForm input::placeholder {
      color: #95a5a6;
    }
    #leaveForm button {
      padding: 6px 12px; 
      background: #3498db; 
      color: #fff; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      transition: background 0.2s;
    }
    #leaveForm button:hover {
      background: #2980b9;
    }

    /* Team Buttons */
    .team-buttons {
      text-align: center; 
      margin: 8px 0;
    }
    .team-buttons button {
      padding: 5px 10px; 
      margin: 0 4px; 
      border: none; 
      border-radius: 4px; 
      color: #fff; 
      cursor: pointer; 
      font-size: 12px;
    }
    .team-a { background: #27ae60; } 
    .team-b { background: #2980b9; } 
    .team-c { background: #8e44ad; }
    .team-buttons button:hover {
      opacity: 0.85;
    }

    /* Month Navigation */
    .month-nav {
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 8px; 
      margin: 8px 0;
    }
    .month-nav button {
      padding: 4px 10px; 
      background: #7f8c8d; 
      color: #fff; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
    }
    .month-nav button:hover {
      background: #6c7a89;
    }
    #monthLabel {
      font-weight: 600; 
      color: #2c3e50;
    }

    /* Calendar */
    #calendarGrid {
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: 3px; 
      max-width: 850px; 
      margin: 0 auto 10px;
    }
    .day-cell {
      background: #fff; 
      border: 1px solid #e0e0e0; 
      min-height: 60px; 
      padding: 3px; 
      border-radius: 4px; 
      font-size: 11px; 
      position: relative;
    }
    .shift-box {
      font-weight: 600; 
      color: #fff; 
      padding: 2px 4px; 
      border-radius: 3px; 
      text-align: center; 
      margin-bottom: 3px;
    }
    .shift-morning { background: #27ae60; }
    .shift-night   { background: #a9dfbf; color: #2c3e50; }
    .shift-off     { background: #dcdcdc; color: #7f8c8d; }

    .leave-entry {
      background: #fff3cd; 
      padding: 2px 4px; 
      border-radius: 3px; 
      margin: 1px 0;
    }
    .leave-entry.approved  { background: #d4edda; font-weight: 600; }
    .leave-entry.rejected  { background: #f8d7da; color: #721c24; text-decoration: line-through; }
    .leave-entry.management { background: #ffeeba; }
    .leave-entry.write-in   { background: #ffeeba; }

    .red-dot {
      width: 6px; 
      height: 6px; 
      background: #e74c3c; 
      border-radius: 50%; 
      position: absolute; 
      top: 3px; 
      right: 3px;
    }

    /* Admin Summary */
    #adminSummary {
      padding: 10px; 
      border-radius: 6px; 
      background: #fff; 
      max-height: 400px; 
      overflow-y: auto;
    }
    #adminSummary h3 {
      font-size: 15px; 
      margin: 0 0 8px; 
      color: #2c3e50;
    }

    .staff-container {
      margin-bottom: 10px; 
      border: 1px solid #e0e0e0; 
      border-radius: 4px; 
      padding: 8px;
    }
    .staff-header {
      font-weight: 600; 
      margin: 4px 0; 
      font-size: 14px; 
      color: #34495e;
    }

    .request-item {
      border: 1px solid #e0e0e0; 
      margin: 5px 0; 
      border-radius: 4px; 
      padding: 8px;
    }
    .request-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      cursor: pointer;
      background: #f7f9fb;
      padding: 4px;
      border-radius: 4px;
    }
    .request-header:hover {
      background: #eef2f5;
    }
    .request-days {
      padding: 4px; 
      display: none;
    }
    .timeline {
      display: flex; 
      flex-wrap: wrap; 
      gap: 6px;
      margin-top: 4px;
    }
    .day-block {
      padding: 4px 8px; 
      border-radius: 4px; 
      background: #f1f1f1; 
      display: flex; 
      align-items: center; 
      gap: 4px; 
      transition: transform 0.2s;
    }
    .day-block:hover {
      transform: scale(1.02);
    }
    .day-block select {
      font-size: 11px; 
      padding: 2px; 
      border-radius: 3px; 
      border: 1px solid #bdc3c7;
    }
    .status-dot {
      width: 8px; 
      height: 8px; 
      border-radius: 50%;
    }
    .status-dot.pending     { background: #e67e22; }
    .status-dot.approved    { background: #27ae60; }
    .status-dot.rejected    { background: #e74c3c; }
    .status-dot.management  { background: #f1c40f; }
    .status-dot.write-in    { background: #f1c40f; }

    .action-buttons {
      text-align: right; 
      margin-top: 6px;
    }
    .delete-btn, .whatsapp-btn {
      padding: 3px 8px; 
      font-size: 11px; 
      border: none; 
      border-radius: 3px; 
      cursor: pointer; 
      margin-left: 4px;
    }
    .delete-btn {
      background: #e74c3c; 
      color: #fff;
    }
    .delete-btn:hover {
      background: #c0392b;
    }
    .whatsapp-btn {
      background: #25D366; 
      color: #fff;
    }
    .whatsapp-btn:hover {
      background: #20b958;
    }

    .footer {
      text-align: center; 
      font-size: 10px; 
      color: #95a5a6; 
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Staff Leave Booking</h1>
  <p class="version">v3.3 — Grouped Bookings & “Write-in” Status</p>

  <!-- Leave Form -->
  <form id="leaveForm">
    <label for="staffName">Name</label>
    <input type="text" id="staffName" placeholder="Enter full name" required>
    <label for="staffID">ID</label>
    <input type="text" id="staffID" placeholder="e.g., S123" required>
    <label for="startDate">From</label>
    <input type="date" id="startDate" required>
    <label for="endDate">To</label>
    <input type="date" id="endDate" required>
    <button type="submit">Request Leave</button>
  </form>

  <!-- Team Buttons -->
  <div class="team-buttons">
    <button class="team-a" onclick="selectTeam(1)">Team A</button>
    <button class="team-b" onclick="selectTeam(2)">Team B</button>
    <button class="team-c" onclick="selectTeam(3)">Team C</button>
  </div>

  <!-- Month Navigation -->
  <div class="month-nav">
    <button onclick="prevMonth()">←</button>
    <span id="monthLabel">Loading...</span>
    <button onclick="nextMonth()">→</button>
  </div>

  <div id="calendarGrid"></div>

  <!-- Admin Summary -->
  <div id="adminSummary">
    <h3>Leave Requests</h3>
    <div id="adminList"></div>
  </div>

  <div class="footer">
    © 2025. Persistent accordion with day-by-day approvals.
  </div>
</div>

<script>
// Domain pointing to your VPS
const API_BASE_URL = "https://leave-management.th3va.com";

// SHIFT PATTERNS
var TeamPatterns = {
  1: ["morning", "morning", "night", "night", "off", "off"],
  2: ["off", "off", "morning", "morning", "night", "night"],
  3: ["night", "night", "off", "off", "morning", "morning"]
};
var selectedTeam = 1;
var referenceDate = new Date(2025, 2, 1);
var requests = [];
var currentYear = 2025, currentMonth = 2;
var openAccordions = new Set();

// UTILITY FUNCTIONS
function daysBetween(a, b) {
  const A = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
  const B = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.floor((B - A) / (1000 * 60 * 60 * 24));
}
function formatDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return y + "-" + m + "-" + dd;
}
function getShift(d) {
  const diff = daysBetween(referenceDate, d);
  const idx = ((diff % 6) + 6) % 6;
  return TeamPatterns[selectedTeam][idx];
}

// RENDER CALENDAR
function renderCalendar() {
  const monthNames = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];
  document.getElementById("monthLabel").textContent =
    monthNames[currentMonth] + " " + currentYear;

  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";
  const firstDay = new Date(currentYear, currentMonth, 1);
  const offset = (firstDay.getDay() + 6) % 7;
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  for (let i = 0; i < offset; i++) {
    grid.appendChild(document.createElement("div")).className = "day-cell";
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dateObj = new Date(currentYear, currentMonth, d);
    const dateStr = formatDate(dateObj);
    const cell = document.createElement("div");
    cell.className = "day-cell";

    const shift = getShift(dateObj);
    const shiftBox = document.createElement("div");
    shiftBox.className = "shift-box " + (
      shift === "morning" ? "shift-morning" :
      shift === "night"   ? "shift-night"   : "shift-off"
    );
    shiftBox.textContent = d;
    cell.appendChild(shiftBox);

    // For each request/day that matches dateStr
    const dayEntries = [];
    requests.forEach(req => {
      req.days.forEach(day => {
        if (day.date === dateStr) {
          dayEntries.push({
            staffName: req.staffName,
            staffID: req.staffID,
            status: day.status
          });
        }
      });
    });

    // Red dot if >2 non-rejected entries
    const nonRejected = dayEntries.filter(e => e.status !== "Rejected").length;
    if (nonRejected > 2) {
      cell.appendChild(document.createElement("div")).className = "red-dot";
    }

    dayEntries.forEach(e => {
      const entry = document.createElement("div");
      // If status is "Write-in", let's treat it similarly to management
      entry.className = "leave-entry " + e.status.toLowerCase();
      entry.textContent = e.staffName + " (" + e.staffID + ")";
      cell.appendChild(entry);
    });

    grid.appendChild(cell);
  }
  renderAdmin();
}

// GROUP REQUESTS BY STAFF, THEN RENDER
function renderAdmin() {
  const adminList = document.getElementById("adminList");
  adminList.innerHTML = "";

  // 1) Build a staff map: staffID -> { staffName, staffID, requests: [...] }
  const staffMap = {};
  requests.forEach((req, reqIndex) => {
    const staffKey = req.staffID;
    if (!staffMap[staffKey]) {
      staffMap[staffKey] = {
        staffName: req.staffName,
        staffID: req.staffID,
        bookings: []
      };
    }
    // store this request
    staffMap[staffKey].bookings.push({ ...req, requestIndex: reqIndex });
  });

  // 2) For each staff, create a container. Inside, list each booking as an accordion
  Object.values(staffMap).forEach(staffObj => {
    // staffObj = { staffName, staffID, bookings: [ { ...req, requestIndex } ] }
    const staffContainer = document.createElement("div");
    staffContainer.className = "staff-container";

    // Staff heading
    const staffHeader = document.createElement("div");
    staffHeader.className = "staff-header";
    staffHeader.textContent = `${staffObj.staffName} (${staffObj.staffID})`;
    staffContainer.appendChild(staffHeader);

    // For each booking of this staff
    staffObj.bookings.forEach(booking => {
      const requestItem = document.createElement("div");
      requestItem.className = "request-item";

      // Calculate pending days
      const pendingCount = booking.days.filter(d => d.status === "Pending").length;
      // Build request heading
      const requestHeader = document.createElement("div");
      requestHeader.className = "request-header";
      requestHeader.innerHTML = `
        <span>${booking.from_date} to ${booking.to_date} - ${booking.days.length} days (${pendingCount} pending)</span>
      `;
      requestItem.appendChild(requestHeader);

      // Build day-block container
      const requestDays = document.createElement("div");
      requestDays.className = "request-days";

      // timeline
      const timeline = document.createElement("div");
      timeline.className = "timeline";

      booking.days.forEach((day, dayIndex) => {
        const dayBlock = document.createElement("div");
        dayBlock.className = "day-block";

        // Dot
        const dot = document.createElement("div");
        dot.className = "status-dot " + day.status.toLowerCase();
        // Dropdown
        const selectEl = document.createElement("select");
        selectEl.setAttribute("data-req", booking.requestIndex);
        selectEl.setAttribute("data-day", dayIndex);

        // Build options
        const statuses = ["Pending", "Approved", "Rejected", "Write-in"];
        statuses.forEach(st => {
          const opt = document.createElement("option");
          opt.value = st;
          opt.textContent = st;
          if (day.status === st) opt.selected = true;
          selectEl.appendChild(opt);
        });

        // Date label
        const dateSpan = document.createElement("span");
        dateSpan.textContent = day.date;

        dayBlock.appendChild(dateSpan);
        dayBlock.appendChild(dot);
        dayBlock.appendChild(selectEl);
        timeline.appendChild(dayBlock);
      });

      requestDays.appendChild(timeline);

      // Action buttons
      const actionDiv = document.createElement("div");
      actionDiv.className = "action-buttons";
      actionDiv.innerHTML = `
        <button class="delete-btn" data-del="${booking.requestIndex}">Delete</button>
        <button class="whatsapp-btn" data-ws="${booking.requestIndex}">WhatsApp</button>
      `;
      requestDays.appendChild(actionDiv);

      requestItem.appendChild(requestDays);

      // Toggle requestDays on click
      requestHeader.onclick = () => {
        requestDays.style.display = (requestDays.style.display === "block") ? "none" : "block";
      };

      staffContainer.appendChild(requestItem);
    });

    adminList.appendChild(staffContainer);
  });

  // Hook up day status changes
  adminList.querySelectorAll("select").forEach(sel => {
    sel.onchange = function() {
      const reqIndex = sel.getAttribute("data-req");
      const dayIndex = sel.getAttribute("data-day");
      const newStatus = sel.value;  // "Pending", "Approved", "Rejected", "Write-in"

      const day_id = requests[reqIndex].days[dayIndex].id; // must exist
      fetch(`${API_BASE_URL}/api/update_day_status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ day_id: day_id, status: newStatus })
      })
      .then(r => r.json())
      .then(data => {
        if (data.status === "success") {
          requests[reqIndex].days[dayIndex].status = newStatus;
          renderCalendar(); // re-render to refresh calendar
        } else {
          alert("Error updating day: " + data.message);
        }
      })
      .catch(err => {
        console.error("Error updating day:", err);
        alert("An error occurred updating the day status.");
      });
    };
  });

  // Hook up Delete
  adminList.querySelectorAll(".delete-btn").forEach(btn => {
    btn.onclick = function() {
      const i = btn.getAttribute("data-del");
      const reqId = requests[i].id; // from the DB

      fetch(`${API_BASE_URL}/api/delete_request`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ request_id: reqId })
      })
      .then(r => r.json())
      .then(data => {
        if (data.status === "success") {
          // Remove from requests array
          requests.splice(i, 1);
          renderCalendar();
        } else {
          alert("Error deleting request: " + data.message);
        }
      })
      .catch(err => {
        console.error("Delete error:", err);
        alert("An error occurred while deleting. Please try again.");
      });
    };
  });

  // Hook up WhatsApp
  adminList.querySelectorAll(".whatsapp-btn").forEach(btn => {
    btn.onclick = function() {
      const i = btn.getAttribute("data-ws");
      const req = requests[i];
      let msg = `Hello ${req.staffName} (${req.staffID}), your leave status:\n` +
        req.days.map(d => `${d.date}: ${d.status}`).join('\n');
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
    };
  });
}

// SELECT TEAM
function selectTeam(num) {
  selectedTeam = num;
  renderCalendar();
}

// LOAD LEAVES FROM BACKEND
function loadLeaves() {
  fetch(`${API_BASE_URL}/api/get_leaves`)
    .then(response => response.json())
    .then(data => {
      requests = data;
      renderCalendar();
    })
    .catch(error => console.error("Error fetching leaves:", error));
}

// SUBMIT LEAVE
document.getElementById("leaveForm").onsubmit = function(e) {
  e.preventDefault();
  const name  = document.getElementById("staffName").value.trim();
  const id    = document.getElementById("staffID").value.trim();
  const start = document.getElementById("startDate").value;
  const end   = document.getElementById("endDate").value;

  if (!name || !id || !start || !end) {
    alert("Please fill all fields.");
    return;
  }
  if (end < start) {
    alert("End date cannot be before start date.");
    return;
  }

  fetch(`${API_BASE_URL}/api/submit_leave`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      staffName: name,
      staffID: id,
      fromDate: start,
      toDate: end
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === "success") {
      alert("Leave request submitted successfully.");
      loadLeaves(); 
    } else {
      alert("Error: " + data.message);
    }
  })
  .catch(error => {
    console.error("Error submitting leave request:", error);
    alert("An error occurred. Please try again later.");
  });

  e.target.reset();
};

// MONTH NAV
function prevMonth() {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  renderCalendar();
}
function nextMonth() {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
}

// INIT
document.addEventListener("DOMContentLoaded", loadLeaves);
</script>
</body>
</html>