<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leave Management System v5.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Include jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* (styles unchanged) */
    /* ... */
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="loginSection">
    <h2>Login</h2>
    <button onclick="showAdminLogin()">Login as Admin</button>
    <button onclick="showUserLogin()">Login as User</button>
    <div id="adminLoginForm" style="display: none;">
      <input type="text" id="adminUsername" placeholder="Staff ID (e.g., ADMIN001)">
      <input type="password" id="adminPassword" placeholder="Password">
      <button onclick="loginAdmin()">Login</button>
    </div>
    <div id="userLoginForm" style="display: none;">
      <input type="text" id="userStaffID" placeholder="Staff ID (e.g., S123)">
      <input type="password" id="userPassword" placeholder="Password">
      <button onclick="loginUser()">Login</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container" style="display: none;">
    <h1>Leave Management System <sup>v5.0</sup></h1>
    <!-- Admin Tabs (Visible only for Admin users) -->
    <div id="adminTabs" style="display: none;">
      <button onclick="showLeaveManagement()">Leave Management</button>
      <button onclick="showUserManagement()">User Management</button>
    </div>

    <!-- Leave Management Panel -->
    <div id="leaveManagementPanel">
      <!-- Leave Form -->
      <form id="leaveForm">
        <label>Name</label>
        <input type="text" id="staffName" placeholder="Enter full name" required>
        <label>ID</label>
        <input type="text" id="staffID" placeholder="e.g., S123" required>
        <label>From</label>
        <input type="date" id="startDate" required>
        <label>To</label>
        <input type="date" id="endDate" required>
        <button type="submit">Request Leave</button>
      </form>

      <!-- Team Buttons -->
      <div class="team-buttons">
        <button class="team-a" onclick="selectTeam(1)">Team A</button>
        <button class="team-b" onclick="selectTeam(2)">Team B</button>
        <button class="team-c" onclick="selectTeam(3)">Team C</button>
      </div>

      <!-- Month Navigation -->
      <div class="month-nav">
        <button onclick="prevMonth()">←</button>
        <span id="monthLabel">Loading...</span>
        <button onclick="nextMonth()">→</button>
      </div>

      <div id="calendarGrid"></div>

      <!-- Admin Summary -->
      <div id="adminSummary">
        <h3>Leave Requests</h3>
        <div id="adminList"></div>
      </div>

      <!-- Monthly Summary -->
      <div id="monthlySummary">
        <h3>
          Monthly Leave Summary
          <button class="download-btn" onclick="downloadSummaryPDF()">Download PDF</button>
        </h3>
        <table class="summary-table">
          <thead>
            <tr>
              <th style="width: 30%;">Staff</th>
              <th style="width: 50%;">Leave Dates</th>
              <th style="width: 20%;">Total Days</th>
            </tr>
          </thead>
          <tbody id="summaryTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- User Management Panel (Admin Only) -->
    <div id="userManagementPanel" style="display: none;">
      <h2>User Management</h2>
      <form id="addUserForm" style="margin-bottom: 15px;">
        <input type="text" id="newUsername" placeholder="Username" required>
        <input type="text" id="newStaffID" placeholder="Staff ID" required>
        <input type="password" id="newPassword" placeholder="Password" required>
        <label>
          <input type="checkbox" id="newIsAdmin"> Admin?
        </label>
        <button type="submit">Add User</button>
      </form>
      <table id="usersTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Staff ID</th>
            <th>Admin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamically inserted rows -->
        </tbody>
      </table>
    </div>

    <div class="footer">
      @ 2025; t’va
    </div>
  </div>

  <script>
    const API_BASE_URL = "https://leave-management.th3va.com";
    let userType = null; // 'admin' or 'user'
    let currentStaffID = null;
    var TeamPatterns = {
      1: ["morning", "morning", "night", "night", "off", "off"],
      2: ["off", "off", "morning", "morning", "night", "night"],
      3: ["night", "night", "off", "off", "morning", "morning"]
    };
    var selectedTeam = 1;
    var referenceDate = new Date(2025, 2, 1);
    var requests = [];
    var currentYear = 2025, currentMonth = 2;
    var openAccordions = new Set();

    /* ====== Show/hide login forms ====== */
    function showAdminLogin() {
      document.getElementById("adminLoginForm").style.display = "block";
      document.getElementById("userLoginForm").style.display = "none";
    }
    function showUserLogin() {
      document.getElementById("userLoginForm").style.display = "block";
      document.getElementById("adminLoginForm").style.display = "none";
    }

    /* ====== Admin login using JWT ====== */
    async function loginAdmin() {
      const staff_id = document.getElementById("adminUsername").value.trim();
      const password = document.getElementById("adminPassword").value;
      if (!staff_id || !password) {
        alert("Please fill in both Staff ID and Password.");
        return;
      }
      try {
        const response = await fetch(`${API_BASE_URL}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ staff_id, password })
        });
        const data = await response.json();
        if (response.ok && data.status === 'success') {
          localStorage.setItem('token', data.token);
          userType = "admin";
          currentStaffID = null;
          document.getElementById("loginSection").style.display = "none";
          document.querySelector(".container").style.display = "block";
          await renderUI();
        } else {
          alert("Invalid admin credentials.");
        }
      } catch (err) {
        alert("Login error: " + err.message);
      }
    }

    /* ====== User login using JWT ====== */
    async function loginUser() {
      const staffID = document.getElementById("userStaffID").value.trim();
      const password = document.getElementById("userPassword").value;
      if (!staffID || !password) {
        alert("Please enter your Staff ID and Password.");
        return;
      }
      try {
        const response = await fetch(`${API_BASE_URL}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ staff_id: staffID, password })
        });
        const data = await response.json();
        if (response.ok && data.status === 'success') {
          localStorage.setItem('token', data.token);
          userType = "user";
          currentStaffID = staffID;
          document.getElementById("loginSection").style.display = "none";
          document.querySelector(".container").style.display = "block";
          await renderUI();
        } else {
          alert("Invalid user credentials.");
        }
      } catch (err) {
        alert("Login error: " + err.message);
      }
    }

    async function renderUI() {
      if (userType === "admin") {
        document.getElementById("adminTabs").style.display = "block";
        // Show leave management by default
        showLeaveManagement();
        document.getElementById("staffID").readOnly = false;
        document.getElementById("staffID").value = "";
        await renderCalendar();
        renderAdmin();
        await renderMonthlySummary();
      } else if (userType === "user") {
        document.getElementById("adminTabs").style.display = "none";
        document.querySelector(".team-buttons").style.display = "none";
        document.querySelector(".month-nav").style.display = "none";
        document.getElementById("calendarGrid").style.display = "none";
        document.getElementById("monthlySummary").style.display = "none";
        document.getElementById("staffID").value = currentStaffID;
        document.getElementById("staffID").readOnly = true;
        await loadLeaves();
        renderAdmin();
      }
    }

    function daysBetween(a, b) {
      const A = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
      const B = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.floor((B - A) / (1000 * 60 * 60 * 24));
    }
    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + dd;
    }
    function getShift(d) {
      const diff = daysBetween(referenceDate, d);
      const idx = ((diff % 6) + 6) % 6;
      return TeamPatterns[selectedTeam][idx];
    }

    /* ====== RENDER CALENDAR ====== */
    async function renderCalendar() {
      if (userType !== "admin") return;
      await loadLeaves();
      const monthNames = ["January","February","March","April","May","June",
                          "July","August","September","October","November","December"];
      document.getElementById("monthLabel").textContent = monthNames[currentMonth] + " " + currentYear;

      const grid = document.getElementById("calendarGrid");
      grid.innerHTML = "";
      const firstDay = new Date(currentYear, currentMonth, 1);
      const offset = (firstDay.getDay() + 6) % 7;
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      for (let i = 0; i < offset; i++) {
        grid.appendChild(document.createElement("div")).className = "day-cell";
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(currentYear, currentMonth, d);
        const dateStr = formatDate(dateObj);
        const cell = document.createElement("div");
        cell.className = "day-cell";

        const shift = getShift(dateObj);
        const shiftBox = document.createElement("div");
        shiftBox.className = "shift-box " + (
          shift === "morning" ? "shift-morning" :
          shift === "night"   ? "shift-night"   : "shift-off"
        );
        shiftBox.textContent = d;
        cell.appendChild(shiftBox);

        const dayEntries = [];
        requests.forEach(req => {
          req.days.forEach(day => {
            if (day.date === dateStr) {
              dayEntries.push({ staffName: req.staffName, staffID: req.staffID, status: day.status });
            }
          });
        });

        const nonRejected = dayEntries.filter(e => e.status !== "Rejected").length;
        if (nonRejected > 2) {
          cell.appendChild(document.createElement("div")).className = "red-dot";
        }

        dayEntries.forEach(e => {
          const entry = document.createElement("div");
          entry.className = "leave-entry " + e.status.toLowerCase();
          entry.textContent = e.staffName + " (" + e.staffID + ")";
          cell.appendChild(entry);
        });

        grid.appendChild(cell);
      }
      renderAdmin();
      await renderMonthlySummary();
    }

    function groupRequestsByStaffID(requests) {
      const grouped = {};
      requests.forEach((req, reqIndex) => {
        const staffID = req.staffID;
        if (!grouped[staffID]) {
          grouped[staffID] = {
            staffName: req.staffName,
            staffID: staffID,
            requests: [],
          };
        }
        grouped[staffID].requests.push({ ...req, originalIndex: reqIndex });
      });
      return Object.values(grouped);
    }

    /* ====== RENDER ADMIN LEAVE REQUESTS ====== */
    function renderAdmin() {
      // (unchanged)
      // ...
    }

    /* ====== MONTHLY SUMMARY ====== */
    async function renderMonthlySummary() {
      // (unchanged)
      // ...
    }

    async function downloadSummaryPDF() {
      // (unchanged)
    }

    async function selectTeam(num) {
      if (userType !== "admin") return;
      selectedTeam = num;
      await renderCalendar();
    }

    async function loadLeaves() {
      try {
        let url = `${API_BASE_URL}/api/get_leaves`;
        if (userType === "user") {
          url += `?staffID=${currentStaffID}`;
        }
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Failed to fetch leaves');
        }
        requests = await response.json();
      } catch (error) {
        console.error("Error fetching leaves:", error);
        requests = [];
      }
    }

    document.getElementById("leaveForm").onsubmit = async function(e) {
      // (unchanged)
      // ...
    };

    async function prevMonth() {
      // (unchanged)
    }

    async function nextMonth() {
      // (unchanged)
    }

    document.getElementById("startDate").addEventListener("change", function() {
      // (unchanged)
    });

    /* ====== USER MANAGEMENT (No Email) ====== */
    function showLeaveManagement() {
      document.getElementById("leaveManagementPanel").style.display = "block";
      document.getElementById("userManagementPanel").style.display = "none";
    }
    function showUserManagement() {
      document.getElementById("leaveManagementPanel").style.display = "none";
      document.getElementById("userManagementPanel").style.display = "block";
      loadUsers();
    }

    const USERS_API_URL = API_BASE_URL + "/api/users";

    async function loadUsers() {
      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        if (!response.ok) throw new Error("Failed to fetch users");
        const users = await response.json();
        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";
        users.forEach(user => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${user.username}</td>
            <td>${user.staffID}</td>
            <td>${user.isAdmin ? "Yes" : "No"}</td>
            <td>
              <button onclick="editUserPrompt('${user.id}', '${user.username}', '${user.staffID}')">Edit</button>
              <button onclick="deleteUser('${user.id}')">Delete</button>
              <button onclick="toggleAdminStatus('${user.id}', ${user.isAdmin})">
                ${user.isAdmin ? "Revoke Admin" : "Make Admin"}
              </button>
              <button onclick="resetUserPasswordPrompt('${user.id}')">Reset Password</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert("Error loading users: " + err.message);
      }
    }

    // Add new user
    document.getElementById("addUserForm").onsubmit = async function(e) {
      e.preventDefault();
      const newUsername = document.getElementById("newUsername").value.trim();
      const newStaffID  = document.getElementById("newStaffID").value.trim();
      const newPassword = document.getElementById("newPassword").value;
      const newIsAdmin  = document.getElementById("newIsAdmin").checked;

      if (!newUsername || !newStaffID || !newPassword) {
        alert("Please fill in all fields.");
        return;
      }
      // Hash the password securely using the Web Crypto API (SHA-256)
      const hashedPassword = await hashPassword(newPassword);

      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            username: newUsername,
            staffID: newStaffID,
            password: hashedPassword,
            isAdmin: newIsAdmin
          })
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("User added successfully.");
          document.getElementById("addUserForm").reset();
          loadUsers();
        } else {
          alert("Error adding user: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error adding user: " + err.message);
      }
    };

    // Prompt to edit user details
    function editUserPrompt(id, currentUsername, currentStaffID) {
      const newUsername = prompt("Edit Username:", currentUsername);
      if (newUsername === null) return;
      const newStaffID = prompt("Edit Staff ID:", currentStaffID);
      if (newStaffID === null) return;
      editUser(id, newUsername.trim(), newStaffID.trim());
    }

    async function editUser(id, username, staffID) {
      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL + "/" + id, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ username, staffID })
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("User updated successfully.");
          loadUsers();
        } else {
          alert("Error updating user: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error updating user: " + err.message);
      }
    }

    async function deleteUser(id) {
      if (!confirm("Are you sure you want to delete this user?")) return;
      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL + "/" + id, {
          method: "DELETE",
          headers: {
            "Authorization": "Bearer " + token
          }
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("User deleted successfully.");
          loadUsers();
        } else {
          alert("Error deleting user: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error deleting user: " + err.message);
      }
    }

    async function toggleAdminStatus(id, isCurrentlyAdmin) {
      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL + "/" + id + "/toggle_admin", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token
          }
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("Admin status updated successfully.");
          loadUsers();
        } else {
          alert("Error toggling admin status: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error toggling admin status: " + err.message);
      }
    }

    function resetUserPasswordPrompt(id) {
      const newPassword = prompt("Enter new password:");
      if (newPassword) {
        resetUserPassword(id, newPassword);
      }
    }

    async function resetUserPassword(id, password) {
      try {
        const hashedPassword = await hashPassword(password);
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL + "/" + id + "/reset_password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ newPassword: hashedPassword })
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("Password reset successfully.");
        } else {
          alert("Error resetting password: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error resetting password: " + err.message);
      }
    }

    // Hash password using SHA-256 via the Web Crypto API
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
      return hashHex;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginSection").style.display = "block";
      document.querySelector(".container").style.display = "none";
    });
  </script>
</body>
</html>