<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leave Booking System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    /* (unchanged CSS omitted for brevity) */
  </style>
</head>
<body>
<div class="container">
  <h1>Staff Leave Booking</h1>
  <p class="version">v3.2 — Persistent Accordion & Red Dot Restored</p>

  <!-- Leave Form -->
  <form id="leaveForm">
    <label for="staffName">Name</label>
    <input type="text" id="staffName" placeholder="Enter full name" required>
    <label for="staffID">ID</label>
    <input type="text" id="staffID" placeholder="e.g., S123" required>
    <label for="startDate">From</label>
    <input type="date" id="startDate" required>
    <label for="endDate">To</label>
    <input type="date" id="endDate" required>
    <button type="submit">Request Leave</button>
  </form>

  <!-- Team Buttons -->
  <div class="team-buttons">
    <button class="team-a" onclick="selectTeam(1)">Team A</button>
    <button class="team-b" onclick="selectTeam(2)">Team B</button>
    <button class="team-c" onclick="selectTeam(3)">Team C</button>
  </div>

  <!-- Month Navigation -->
  <div class="month-nav">
    <button onclick="prevMonth()">←</button>
    <span id="monthLabel">Loading...</span>
    <button onclick="nextMonth()">→</button>
  </div>

  <div id="calendarGrid"></div>

  <!-- Admin Summary -->
  <div id="adminSummary">
    <h3>Leave Requests</h3>
    <div id="adminList"></div>
  </div>

  <div class="footer">
    © 2025. Persistent accordion with day-by-day approvals.
  </div>
</div>

<script>
// -----------------------------
//    ADJUST THIS FOR YOUR VPS
// -----------------------------
// If your VPS domain is "leave-management.th3va.com", use:
const API_BASE_URL = "https://leave-management.th3va.com"; 
// If you're using HTTP only, do: "http://leave-management.th3va.com"

// Shift Patterns
var TeamPatterns = {
  1: ["morning", "morning", "night", "night", "off", "off"],
  2: ["off", "off", "morning", "morning", "night", "night"],
  3: ["night", "night", "off", "off", "morning", "morning"]
};
var selectedTeam = 1;
var referenceDate = new Date(2025, 2, 1);
var requests = [];  // This array will be populated by the backend
var currentYear = 2025, currentMonth = 2;
var openAccordions = new Set(); // Track open accordion states

function daysBetween(a, b) {
  var A = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
  var B = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.floor((B - A) / (1000 * 60 * 60 * 24));
}

function formatDate(d) {
  var y = d.getFullYear();
  var m = String(d.getMonth() + 1).padStart(2, "0");
  var dd = String(d.getDate()).padStart(2, "0");
  return y + "-" + m + "-" + dd;
}

function getShift(d) {
  var diff = daysBetween(referenceDate, d);
  var idx = ((diff % 6) + 6) % 6;
  return TeamPatterns[selectedTeam][idx];
}

function renderCalendar() {
  var monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
  document.getElementById("monthLabel").textContent = monthNames[currentMonth] + " " + currentYear;

  var grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";
  var firstDay = new Date(currentYear, currentMonth, 1);
  var offset = (firstDay.getDay() + 6) % 7;
  var daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  for (var i = 0; i < offset; i++) {
    grid.appendChild(document.createElement("div")).className = "day-cell";
  }

  for (var d = 1; d <= daysInMonth; d++) {
    var dateObj = new Date(currentYear, currentMonth, d);
    var dateStr = formatDate(dateObj);
    var cell = document.createElement("div");
    cell.className = "day-cell";

    var shift = getShift(dateObj);
    var shiftBox = document.createElement("div");
    shiftBox.className = "shift-box " + 
      (shift === "morning" ? "shift-morning" :
       shift === "night" ? "shift-night" : "shift-off");
    shiftBox.textContent = d;
    cell.appendChild(shiftBox);

    var dayEntries = [];
    requests.forEach(req => {
      req.days.forEach(day => {
        if (day.date === dateStr) {
          dayEntries.push({
            staffName: req.staffName,
            staffID: req.staffID,
            status: day.status
          });
        }
      });
    });

    // Red dot if >2 non-rejected entries
    var nonRejected = dayEntries.filter(e => e.status !== "Rejected").length;
    if (nonRejected > 2) {
      cell.appendChild(document.createElement("div")).className = "red-dot";
    }

    dayEntries.forEach(e => {
      var entry = document.createElement("div");
      entry.className = "leave-entry " +
        (e.status === "Approved" ? "approved" :
         e.status === "Rejected" ? "rejected" :
         e.status === "Management" ? "management" : "");
      entry.textContent = e.staffName + " (" + e.staffID + ")";
      cell.appendChild(entry);
    });

    grid.appendChild(cell);
  }

  renderAdmin();
}

function renderAdmin() {
  var adminList = document.getElementById("adminList");
  adminList.innerHTML = "";

  requests.forEach((req, reqIndex) => {
    var item = document.createElement("div");
    item.className = "accordion-item";
    var pendingCount = req.days.filter(d => d.status === "Pending").length;
    item.innerHTML = `
      <div class="accordion-header" data-index="${reqIndex}">
        <span>${req.staffName} (${req.staffID})</span>
        <span class="badge ${pendingCount > 0 ? 'pending' : ''}">
          ${req.days.length} days (${pendingCount} pending)
        </span>
      </div>
      <div class="accordion-content" data-index="${reqIndex}">
        <div class="timeline">
          ${req.days.map((day, dayIndex) => `
            <div class="day-block">
              <span>${day.date}</span>
              <div class="status-dot ${day.status.toLowerCase()}"></div>
              <select data-req="${reqIndex}" data-day="${dayIndex}">
                <option value="Pending" ${day.status === "Pending" ? "selected" : ""}>Pending</option>
                <option value="Approved" ${day.status === "Approved" ? "selected" : ""}>Approved</option>
                <option value="Rejected" ${day.status === "Rejected" ? "selected" : ""}>Rejected</option>
                <option value="Management" ${day.status === "Management" ? "selected" : ""}>Management</option>
              </select>
            </div>
          `).join('')}
        </div>
        <div class="action-buttons">
          <button class="delete-btn" data-del="${reqIndex}">Delete</button>
          <button class="whatsapp-btn" data-ws="${reqIndex}">WhatsApp</button>
        </div>
      </div>
    `;
    adminList.appendChild(item);
  });

  // Restore accordion states
  adminList.querySelectorAll(".accordion-header").forEach(header => {
    var index = header.getAttribute("data-index");
    var content = header.nextElementSibling;
    if (openAccordions.has(index)) {
      content.style.display = "block";
    } else {
      content.style.display = "none";
    }
    header.onclick = function() {
      if (content.style.display === "block") {
        content.style.display = "none";
        openAccordions.delete(index);
      } else {
        content.style.display = "block";
        openAccordions.add(index);
      }
    };
  });

  // Status updates
  adminList.querySelectorAll("select").forEach(sel => {
    sel.onchange = function() {
      var reqIndex = sel.getAttribute("data-req");
      var dayIndex = sel.getAttribute("data-day");
      requests[reqIndex].days[dayIndex].status = sel.value;
      renderCalendar(); // Re-render
    };
  });

  // Delete
  adminList.querySelectorAll(".delete-btn").forEach(btn => {
    btn.onclick = function() {
      var i = btn.getAttribute("data-del");
      openAccordions.delete(i);
      requests.splice(i, 1);
      renderCalendar();
    };
  });

  // WhatsApp
  adminList.querySelectorAll(".whatsapp-btn").forEach(btn => {
    btn.onclick = function() {
      var i = btn.getAttribute("data-ws");
      var req = requests[i];
      var msg = `Hello ${req.staffName} (${req.staffID}), your leave status:\n` +
                req.days.map(d => `${d.date}: ${d.status}`).join('\n');
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
    };
  });
}

function selectTeam(num) {
  selectedTeam = num;
  renderCalendar();
}

// Fetch existing leave requests from the BACKEND
function loadLeaves() {
  fetch(`${API_BASE_URL}/api/get_leaves`)  // <--- using full URL
    .then(response => response.json())
    .then(data => {
      requests = data;
      renderCalendar();
    })
    .catch(error => console.error("Error fetching leaves:", error));
}

// Submit a new leave request
document.getElementById("leaveForm").onsubmit = function(e) {
  e.preventDefault();
  var name = document.getElementById("staffName").value.trim();
  var id = document.getElementById("staffID").value.trim();
  var start = document.getElementById("startDate").value;
  var end = document.getElementById("endDate").value;

  if (!name || !id || !start || !end) {
    alert("Please fill all fields.");
    return;
  }
  if (end < start) {
    alert("End date cannot be before start date.");
    return;
  }

  fetch(`${API_BASE_URL}/api/submit_leave`, {  // <--- using full URL
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      staffName: name,
      staffID: id,
      fromDate: start,
      toDate: end
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === "success") {
      alert("Leave request submitted successfully.");
      loadLeaves(); // Reload data from backend
    } else {
      alert("Error: " + data.message);
    }
  })
  .catch(error => {
    console.error("Error submitting leave request:", error);
    alert("An error occurred. Please try again later.");
  });

  e.target.reset();
};

function prevMonth() {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  renderCalendar();
}

function nextMonth() {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
}

// On page load, fetch data
document.addEventListener("DOMContentLoaded", loadLeaves);
</script>
</body>
</html>