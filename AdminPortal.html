<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Request Admin Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 for nice popups -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .status-badge { @apply px-2 py-1 rounded-full text-xs font-semibold uppercase tracking-wide; }
        .status-pending_colleague { @apply bg-yellow-100 text-yellow-800 border border-yellow-200; }
        .status-pending_tl_oc { @apply bg-blue-100 text-blue-800 border border-blue-200; }
        .status-approved { @apply bg-green-100 text-green-800 border border-green-200; }
        .status-rejected_colleague, .status-rejected_tl_oc { @apply bg-red-100 text-red-800 border border-red-200; }
        
        /* Custom Scrollbar for table */
        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Admin Portal</h1>
                        <p class="text-xs text-gray-500">Shift Request Management</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="fetchRequests()" class="p-2 text-gray-400 hover:text-indigo-600 transition-colors" title="Refresh Data">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <div id="auth-status" class="text-sm font-medium text-gray-500">Checking Auth...</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- Stats & Filters -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Stat Cards -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <span class="text-gray-500 text-xs font-medium uppercase">Total Requests</span>
                <span class="text-2xl font-bold text-gray-900 mt-1" id="stat-total">-</span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <span class="text-gray-500 text-xs font-medium uppercase">Pending TL/OC</span>
                <span class="text-2xl font-bold text-blue-600 mt-1" id="stat-pending">-</span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <span class="text-gray-500 text-xs font-medium uppercase">Approved</span>
                <span class="text-2xl font-bold text-green-600 mt-1" id="stat-approved">-</span>
            </div>
            
            <!-- Filter Dropdown -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center">
                <label class="text-gray-500 text-xs font-medium uppercase mb-1">Filter View</label>
                <select id="status-filter" class="w-full border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500 p-1.5 border" onchange="applyFilters()">
                    <option value="all">Show All</option>
                    <option value="pending_tl_oc">Pending TL/OC</option>
                    <option value="pending_colleague">Pending Colleague</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected (All)</option>
                </select>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden">
            <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-800">Request List</h2>
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search name or ID..." 
                           class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 w-64"
                           onkeyup="applyFilters()">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            
            <div class="overflow-x-auto table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requester</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Colleague</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requests-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be injected here -->
                        <tr>
                            <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                                <div class="flex justify-center items-center">
                                    <svg class="animate-spin h-5 w-5 mr-3 text-indigo-500" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Loading requests...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 sm:px-6">
                <p class="text-xs text-gray-500" id="showing-count">Showing 0 requests</p>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
            collection, query, getDocs, orderBy, serverTimestamp, where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (Reuse logic) ---
        let firebaseConfig;
        const standaloneConfig = {
            apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
            authDomain: "roster-4a997.firebaseapp.com",
            projectId: "roster-4a997",
            storageBucket: "roster-4a997.firebasestorage.app",
            messagingSenderId: "901381868881",
            appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = standaloneConfig;
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let shiftRequestsCollection;
        let rosterCollection;
        let allRequests = []; // Store local copy for filtering

        // --- UI REFERENCES ---
        const tableBody = document.getElementById('requests-table-body');
        const authStatus = document.getElementById('auth-status');
        const statTotal = document.getElementById('stat-total');
        const statPending = document.getElementById('stat-pending');
        const statApproved = document.getElementById('stat-approved');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const showingCount = document.getElementById('showing-count');

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authStatus.textContent = `Admin: ${user.uid.substring(0,6)}...`;
                authStatus.className = "text-sm font-medium text-green-600 bg-green-50 px-2 py-1 rounded";
                
                shiftRequestsCollection = collection(db, `artifacts/${appId}/public/data/shiftRequests`);
                rosterCollection = collection(db, "roster");
                
                fetchRequests();
            } else {
                authStatus.textContent = "Not Signed In";
                authStatus.className = "text-sm font-medium text-red-600";
            }
        });

        async function initAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed", error);
                Swal.fire('Error', 'Authentication failed. Check console.', 'error');
            }
        }
        initAuth();

        // --- CORE FUNCTIONS ---

        // 1. Fetch All Requests
        window.fetchRequests = async function() {
            tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Loading data...</td></tr>`;
            
            try {
                // Fetch all requests
                const q = query(shiftRequestsCollection, orderBy("shiftDate", "desc"));
                const snapshot = await getDocs(q);
                
                allRequests = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updateStats();
                applyFilters(); // Renders the table
                
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true
                });
                Toast.fire({ icon: 'success', title: 'Data refreshed' });

            } catch (error) {
                console.error("Fetch error:", error);
                tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading data: ${error.message}</td></tr>`;
            }
        };

        // 2. Render Table
        function renderTable(requests) {
            if (requests.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">No requests found matching your filters.</td></tr>`;
                showingCount.textContent = "Showing 0 requests";
                return;
            }

            tableBody.innerHTML = requests.map(req => {
                const statusClass = `status-${req.status}`;
                const statusLabel = req.status.replace(/_/g, " ").replace("tl oc", "TL/OC").toUpperCase();
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                            ${req.shiftDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${req.requesterName}</div>
                            <div class="text-xs text-gray-500">
                                <span class="text-red-500">${req.requesterOriginalShift}</span> &rarr; <span class="text-green-600 font-bold">${req.requesterNewShift}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${req.colleagueName}</div>
                            <div class="text-xs text-gray-500">
                                <span class="text-red-500">${req.colleagueOriginalShift}</span> &rarr; <span class="text-green-600 font-bold">${req.colleagueNewShift}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="${statusClass} status-badge">
                                ${statusLabel}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openEditModal('${req.id}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded-md transition-colors mr-2">
                                Update
                            </button>
                            <button onclick="deleteRequest('${req.id}')" class="text-red-600 hover:text-red-900 hover:bg-red-50 px-2 py-1 rounded-md transition-colors" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            showingCount.textContent = `Showing ${requests.length} requests`;
        }

        // 3. Filter Logic
        window.applyFilters = function() {
            const term = searchInput.value.toLowerCase();
            const status = statusFilter.value;

            const filtered = allRequests.filter(req => {
                // Text Search
                const matchesText = 
                    req.requesterName.toLowerCase().includes(term) ||
                    req.colleagueName.toLowerCase().includes(term) ||
                    (req.requesterRankId && req.requesterRankId.toLowerCase().includes(term)) ||
                    req.shiftDate.includes(term);

                // Status Filter
                let matchesStatus = true;
                if (status === 'pending_tl_oc') matchesStatus = req.status === 'pending_tl_oc';
                else if (status === 'pending_colleague') matchesStatus = req.status === 'pending_colleague';
                else if (status === 'approved') matchesStatus = req.status === 'approved';
                else if (status === 'rejected') matchesStatus = req.status.includes('rejected');
                
                return matchesText && matchesStatus;
            });

            renderTable(filtered);
        };

        function updateStats() {
            statTotal.textContent = allRequests.length;
            statPending.textContent = allRequests.filter(r => r.status === 'pending_tl_oc').length;
            statApproved.textContent = allRequests.filter(r => r.status === 'approved').length;
        }

        // 4. Update Logic (The "Portal" Action)
        window.openEditModal = async function(reqId) {
            const req = allRequests.find(r => r.id === reqId);
            if (!req) return;

            const { value: formValues } = await Swal.fire({
                title: 'Update Request Status',
                html: `
                    <div class="text-left mb-4 text-sm text-gray-600">
                        <p><strong>Requester:</strong> ${req.requesterName} (${req.requesterOriginalShift} &rarr; ${req.requesterNewShift})</p>
                        <p><strong>Colleague:</strong> ${req.colleagueName} (${req.colleagueOriginalShift} &rarr; ${req.colleagueNewShift})</p>
                        <p><strong>Date:</strong> ${req.shiftDate}</p>
                    </div>
                    <label class="block text-left text-sm font-medium text-gray-700 mb-1">New Status</label>
                    <select id="swal-status" class="w-full border border-gray-300 rounded p-2 mb-3">
                        <option value="pending_colleague" ${req.status === 'pending_colleague' ? 'selected' : ''}>Pending Colleague</option>
                        <option value="pending_tl_oc" ${req.status === 'pending_tl_oc' ? 'selected' : ''}>Pending TL/OC</option>
                        <option value="approved" ${req.status === 'approved' ? 'selected' : ''}>APPROVED</option>
                        <option value="rejected_tl_oc" ${req.status === 'rejected_tl_oc' ? 'selected' : ''}>Rejected (by TL/OC)</option>
                        <option value="rejected_colleague" ${req.status === 'rejected_colleague' ? 'selected' : ''}>Rejected (by Colleague)</option>
                    </select>
                    
                    <div id="roster-check-container" class="flex items-center p-3 bg-blue-50 rounded border border-blue-100 hidden">
                        <input type="checkbox" id="swal-update-roster" checked class="h-4 w-4 text-blue-600 rounded">
                        <label for="swal-update-roster" class="ml-2 block text-sm text-blue-900">
                            <strong>Sync Roster?</strong> (Recommended for 'Approved')
                        </label>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                didOpen: () => {
                    const statusSelect = document.getElementById('swal-status');
                    const rosterContainer = document.getElementById('roster-check-container');
                    
                    // Show checkbox only if selecting 'approved' and it wasn't already approved
                    function toggleRosterCheck() {
                        if (statusSelect.value === 'approved' && req.status !== 'approved') {
                            rosterContainer.classList.remove('hidden');
                        } else {
                            rosterContainer.classList.add('hidden');
                        }
                    }
                    statusSelect.addEventListener('change', toggleRosterCheck);
                    toggleRosterCheck();
                },
                preConfirm: () => {
                    return {
                        status: document.getElementById('swal-status').value,
                        updateRoster: document.getElementById('swal-update-roster').checked
                    }
                }
            });

            if (formValues) {
                await processUpdate(req, formValues.status, formValues.updateRoster);
            }
        };

        async function processUpdate(req, newStatus, shouldUpdateRoster) {
            Swal.fire({ title: 'Updating...', didOpen: () => Swal.showLoading() });

            try {
                const docRef = doc(shiftRequestsCollection, req.id);
                const updates = { 
                    status: newStatus,
                    lastAdminUpdate: serverTimestamp() // Audit trail
                };

                // 1. Update Roster Logic (If checked)
                if (newStatus === 'approved' && shouldUpdateRoster) {
                    const requesterRosterRef = doc(rosterCollection, req.requesterId);
                    const colleagueRosterRef = doc(rosterCollection, req.colleagueId);
                    
                    const requesterShiftWithMark = `[${req.requesterNewShift}]`;
                    const colleagueShiftWithMark = `[${req.colleagueNewShift}]`;
                    
                    await setDoc(requesterRosterRef, { [req.shiftDate]: requesterShiftWithMark }, { merge: true });
                    await setDoc(colleagueRosterRef, { [req.shiftDate]: colleagueShiftWithMark }, { merge: true });
                    
                    updates.tlOcSignatureTimestamp = serverTimestamp(); // Mark as signed if force approving
                    updates.tlOcComments = "Approved via Admin Portal";
                }

                // 2. Update Document
                await updateDoc(docRef, updates);

                Swal.fire('Success', 'Request updated successfully.', 'success');
                fetchRequests(); // Refresh table

            } catch (error) {
                console.error("Update failed", error);
                Swal.fire('Error', 'Failed to update request: ' + error.message, 'error');
            }
        }

        window.deleteRequest = async function(reqId) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                try {
                    await deleteDoc(doc(shiftRequestsCollection, reqId));
                    Swal.fire('Deleted!', 'The request has been deleted.', 'success');
                    fetchRequests();
                } catch (error) {
                    Swal.fire('Error', 'Could not delete: ' + error.message, 'error');
                }
            }
        }

    </script>
</body>
</html>

