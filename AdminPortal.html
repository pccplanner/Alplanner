<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Admin Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Smooth fade for tabs */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Badge Styles */
        .badge { @apply px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide; }
        .badge-pending { @apply bg-blue-50 text-blue-700 border border-blue-100; }
        
        /* Timeline Styles */
        .timeline-item { @apply relative pl-6 pb-4 border-l-2 border-gray-200 last:border-0 last:pb-0; }
        .timeline-dot { @apply absolute -left-[5px] top-1 h-2.5 w-2.5 rounded-full bg-gray-300; }
        .timeline-dot.active { @apply bg-green-500 ring-2 ring-green-100; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo & Title -->
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-lg shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900 leading-tight">Admin Portal</h1>
                        <div class="flex items-center gap-2">
                            <span id="auth-status" class="text-xs text-gray-400">Connecting...</span>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="flex items-center space-x-1">
                    <button onclick="switchTab('dashboard')" id="tab-btn-dashboard" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-indigo-50 text-indigo-700">
                        ‚ö° Live Dashboard
                    </button>
                    <button onclick="switchTab('archive')" id="tab-btn-archive" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-all duration-200">
                        üìÇ Full Archive
                    </button>
                    <button onclick="fetchRequests()" class="p-2 ml-2 text-gray-400 hover:text-indigo-600 transition-colors" title="Refresh Data">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full">

        <!-- ================= TAB 1: DASHBOARD ================= -->
        <div id="tab-dashboard" class="tab-content active space-y-6">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- LEFT COLUMN: PENDING APPROVALS (Priority) -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                            Action Required: Pending TL/OC
                        </h2>
                        <span id="count-pending" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">0</span>
                    </div>

                    <!-- UPDATED: Grid Layout for Pending Cards -->
                    <div id="pending-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Pending Cards Injected Here -->
                    </div>
                </div>

                <!-- RIGHT COLUMN: RECENTLY APPROVED (History) -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            History (Last 7 Days)
                        </h2>
                        <span id="count-approved-recent" class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full">0</span>
                    </div>

                    <!-- Detailed History Cards -->
                    <div id="approved-list" class="space-y-3">
                        <!-- Approved Cards Injected Here -->
                    </div>
                </div>

            </div>
        </div>

        <!-- ================= TAB 2: ARCHIVE ================= -->
        <div id="tab-archive" class="tab-content">
            <div class="bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-200 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-lg font-semibold text-gray-800">Full Request History</h2>
                    
                    <div class="flex gap-2 w-full sm:w-auto">
                        <select id="archive-filter" class="border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border bg-white" onchange="renderArchive()">
                            <option value="all">Show All Status</option>
                            <option value="pending_tl_oc">Pending (TL/OC)</option>
                            <option value="pending_colleague">Pending (Colleague)</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <input type="text" id="archive-search" placeholder="Search name, date, or status..." 
                               class="pl-4 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-64"
                               onkeyup="renderArchive()">
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requester</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Colleague</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archive-table-body" class="bg-white divide-y divide-gray-200 text-sm">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
            collection, query, getDocs, orderBy, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SETUP ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
            authDomain: "roster-4a997.firebaseapp.com",
            projectId: "roster-4a997",
            storageBucket: "roster-4a997.firebasestorage.app",
            messagingSenderId: "901381868881",
            appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let shiftRequestsCollection, rosterCollection;
        let allRequests = [];

        // --- ICONS ---
        const iconSun = `<svg class="w-3.5 h-3.5 text-orange-400 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
        const iconMoon = `<svg class="w-3.5 h-3.5 text-indigo-500 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
        const iconEdit = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>`;

        // --- DOM ELEMENTS ---
        const pendingContainer = document.getElementById('pending-container');
        const approvedList = document.getElementById('approved-list');
        const archiveTableBody = document.getElementById('archive-table-body');
        const countPending = document.getElementById('count-pending');
        const countApprovedRecent = document.getElementById('count-approved-recent');

        // --- INITIALIZATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-status').textContent = "Connected";
                document.getElementById('auth-status').className = "text-xs text-green-600 font-medium";
                
                shiftRequestsCollection = collection(db, `artifacts/${appId}/public/data/shiftRequests`);
                rosterCollection = collection(db, "roster");
                fetchRequests();
            }
        });

        const initAuth = async () => {
            try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch (e) { console.error("Auth failed", e); }
        };
        initAuth();

        // --- HELPERS ---
        function formatShift(shift) {
            if (!shift) return "?";
            const s = shift.toString().toUpperCase();
            if (s.includes('1') || s === 'M') return `${iconSun} Morning`;
            if (s.includes('2') || s === 'N') return `${iconMoon} Night`;
            return shift;
        }

        function formatShiftShort(shift) {
            if (!shift) return "?";
             const s = shift.toString().toUpperCase();
            if (s.includes('1') || s === 'M') return `${iconSun} AM`;
            if (s.includes('2') || s === 'N') return `${iconMoon} PM`;
            return shift;
        }

        function formatStatus(status) {
            if (!status) return 'Unknown';
            const map = {
                'pending_colleague': 'Pending (Colleague)',
                'pending_tl_oc': 'Pending (TL/OC)',
                'approved': 'Approved',
                'rejected_colleague': 'Rejected (Colleague)',
                'rejected_tl_oc': 'Rejected (TL/OC)'
            };
            return map[status] || status.replace(/_/g, ' ').toUpperCase();
        }

        function getStatusColor(status) {
            if (!status) return "bg-gray-100 text-gray-800";
            if (status === 'approved') return "bg-green-100 text-green-800 border-green-200";
            if (status === 'pending_tl_oc') return "bg-blue-100 text-blue-800 border-blue-200";
            if (status === 'pending_colleague') return "bg-yellow-100 text-yellow-800 border-yellow-200";
            if (status.includes('rejected')) return "bg-red-100 text-red-800 border-red-200";
            return "bg-gray-100 text-gray-800";
        }

        function formatTime(timestamp) {
            if (!timestamp) return '<span class="text-gray-400 italic">Pending...</span>';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('en-SG', { 
                month: 'short', day: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            const btnDash = document.getElementById('tab-btn-dashboard');
            const btnArch = document.getElementById('tab-btn-archive');
            
            if(tabName === 'dashboard') {
                btnDash.className = "px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-indigo-50 text-indigo-700 shadow-sm ring-1 ring-indigo-200";
                btnArch.className = "px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-all duration-200";
            } else {
                btnDash.className = "px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-all duration-200";
                btnArch.className = "px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-indigo-50 text-indigo-700 shadow-sm ring-1 ring-indigo-200";
            }
        };

        window.fetchRequests = async function() {
            Swal.showLoading();
            try {
                // Fetch all requests
                const q = query(shiftRequestsCollection, orderBy("shiftDate", "desc"));
                const snapshot = await getDocs(q);
                allRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderDashboard();
                renderArchive();
                Swal.close();
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'Failed to load data', 'error');
            }
        };

        function renderDashboard() {
            // 1. PENDING TL/OC
            const pending = allRequests.filter(r => r.status === 'pending_tl_oc');
            countPending.textContent = pending.length;
            
            if (pending.length === 0) {
                pendingContainer.innerHTML = `
                    <div class="col-span-full p-8 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                        <svg class="w-12 h-12 mx-auto mb-3 text-green-100" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <p class="font-medium text-gray-500">All caught up!</p>
                        <p class="text-xs">No pending approvals required.</p>
                    </div>`;
            } else {
                // UPDATED: Compact Grid Cards
                pendingContainer.innerHTML = pending.map(req => `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 flex flex-col justify-between h-full hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-2 pb-2 border-b border-gray-100">
                            <div class="font-bold text-gray-800 flex items-center gap-1.5 text-sm">
                                <svg class="w-4 h-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                ${req.shiftDate}
                            </div>
                            <span class="badge badge-pending">Pending TL/OC</span>
                        </div>

                        <div class="text-sm space-y-2 mb-3">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-700 truncate mr-2" title="${req.requesterName}">${req.requesterName}</span>
                                <span class="text-[10px] bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100 whitespace-nowrap">${formatShiftShort(req.requesterOriginalShift)} &rarr; ${formatShiftShort(req.requesterNewShift)}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-700 truncate mr-2" title="${req.colleagueName}">${req.colleagueName}</span>
                                <span class="text-[10px] bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100 whitespace-nowrap">${formatShiftShort(req.colleagueOriginalShift)} &rarr; ${formatShiftShort(req.colleagueNewShift)}</span>
                            </div>
                        </div>

                        <div class="flex gap-2 mt-auto">
                            <button onclick="quickAction('${req.id}', 'approve')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-1.5 rounded text-xs transition shadow-sm flex items-center justify-center gap-1">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                Approve
                            </button>
                            <button onclick="quickAction('${req.id}', 'reject')" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 font-semibold py-1.5 rounded text-xs transition flex items-center justify-center gap-1">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                Reject
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // 2. RECENTLY APPROVED (7 DAYS)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const recent = allRequests.filter(r => {
                if (r.status !== 'approved') return false;
                const shiftDate = new Date(r.shiftDate);
                return shiftDate >= sevenDaysAgo;
            }).slice(0, 10);

            countApprovedRecent.textContent = recent.length;

            if (recent.length === 0) {
                approvedList.innerHTML = `<div class="p-6 text-center text-sm text-gray-400 italic bg-white rounded-xl border border-gray-200">No approved requests in the last 7 days.</div>`;
            } else {
                approvedList.innerHTML = recent.map(req => `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 transition hover:shadow-md relative group">
                        <button onclick="openEditModal('${req.id}')" class="absolute top-3 right-3 text-gray-300 hover:text-indigo-600 p-1 transition">
                            ${iconEdit}
                        </button>

                        <div class="flex items-center gap-2 text-gray-500 text-xs font-semibold uppercase tracking-wider mb-3">
                            <svg class="w-4 h-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            ${req.shiftDate}
                        </div>

                        <div class="space-y-3">
                            <div class="flex justify-between items-center text-sm">
                                <div>
                                    <div class="font-bold text-gray-800">${req.requesterName}</div>
                                    <div class="text-[10px] text-gray-400">${req.requesterTeam || 'N/A'}</div>
                                </div>
                                <div class="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded text-xs text-gray-600 border border-gray-100">
                                    ${formatShift(req.requesterOriginalShift)} <span class="text-gray-300">&rarr;</span> <strong class="text-green-700">${formatShift(req.requesterNewShift)}</strong>
                                </div>
                            </div>

                            <div class="flex justify-between items-center text-sm border-t border-gray-50 pt-2">
                                <div>
                                    <div class="font-bold text-gray-800">${req.colleagueName}</div>
                                    <div class="text-[10px] text-gray-400">${req.colleagueTeam || 'N/A'}</div>
                                </div>
                                <div class="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded text-xs text-gray-600 border border-gray-100">
                                    ${formatShift(req.colleagueOriginalShift)} <span class="text-gray-300">&rarr;</span> <strong class="text-green-700">${formatShift(req.colleagueNewShift)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // --- NEW: Custom Sort for Archive ---
        function renderArchive() {
            const term = document.getElementById('archive-search').value.toLowerCase();
            const statusFilter = document.getElementById('archive-filter').value;

            // 1. FILTER
            let filtered = allRequests.filter(req => {
                const statusText = formatStatus(req.status).toLowerCase();
                const matchesText = 
                    req.requesterName.toLowerCase().includes(term) ||
                    req.colleagueName.toLowerCase().includes(term) ||
                    req.shiftDate.includes(term) ||
                    statusText.includes(term);
                
                let matchesStatus = true;
                if (statusFilter !== 'all') {
                    if (statusFilter === 'rejected') matchesStatus = req.status.includes('rejected');
                    else matchesStatus = req.status === statusFilter;
                }
                return matchesText && matchesStatus;
            });

            // 2. SORT (Pending > Approved > Rejected > Date)
            filtered.sort((a, b) => {
                const getPriority = (status) => {
                    // Priority Level 1: Pending
                    if (status.includes('pending')) return 1;
                    // Priority Level 2: Approved
                    if (status.includes('approved')) return 2;
                    // Priority Level 3: Rejected
                    if (status.includes('rejected')) return 3;
                    return 4;
                };

                const pA = getPriority(a.status);
                const pB = getPriority(b.status);

                if (pA !== pB) {
                    return pA - pB; // Lower number = Higher priority
                }

                // If same priority, sort by date descending (Newest first)
                return b.shiftDate.localeCompare(a.shiftDate);
            });

            if (filtered.length === 0) {
                archiveTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No requests found.</td></tr>`;
                return;
            }

            // 3. RENDER
            archiveTableBody.innerHTML = filtered.map(req => {
                const statusColor = getStatusColor(req.status);
                const displayStatus = formatStatus(req.status);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-gray-900 font-medium">${req.shiftDate}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${req.requesterName}</div>
                            <div class="text-xs text-gray-500">${formatShift(req.requesterOriginalShift)} ‚ûù ${formatShift(req.requesterNewShift)}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${req.colleagueName}</div>
                            <div class="text-xs text-gray-500">${formatShift(req.colleagueOriginalShift)} ‚ûù ${formatShift(req.colleagueNewShift)}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold border ${statusColor}">
                                ${displayStatus}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                             <button onclick="openEditModal('${req.id}')" class="text-indigo-600 hover:text-indigo-900 font-medium text-xs bg-indigo-50 px-3 py-1.5 rounded-md">Edit / Audit</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // --- ACTIONS ---

        window.quickAction = async function(reqId, action) {
            const req = allRequests.find(r => r.id === reqId);
            if (!req) return;

            if (action === 'approve') {
                const result = await Swal.fire({
                    title: 'Approve Request?',
                    text: `Confirm shift swap between ${req.requesterName} and ${req.colleagueName} on ${req.shiftDate}?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#16a34a',
                    confirmButtonText: 'Yes, Approve & Sync Roster'
                });

                if (result.isConfirmed) {
                    await processUpdate(req, 'approved', true);
                }
            } else {
                 const result = await Swal.fire({
                    title: 'Reject Request?',
                    input: 'text',
                    inputLabel: 'Reason (Optional)',
                    inputPlaceholder: 'Type reason here...',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    confirmButtonText: 'Reject'
                });

                if (result.isConfirmed) {
                    await processUpdate(req, 'rejected_tl_oc', false);
                }
            }
        };

        window.openEditModal = async function(reqId) {
            const req = allRequests.find(r => r.id === reqId);
            if (!req) return;

            // Generate Timeline HTML
            const t1 = req.requesterSignatureTimestamp;
            const t2 = req.colleagueSignatureTimestamp;
            const t3 = req.tlOcSignatureTimestamp;
            
            const timelineHtml = `
                <div class="mt-4 mb-6 text-left">
                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Audit Trail</h4>
                    <div class="space-y-0">
                        <div class="timeline-item">
                            <div class="timeline-dot ${t1 ? 'active' : ''}"></div>
                            <p class="text-sm font-semibold text-gray-800">Request Created</p>
                            <p class="text-xs text-gray-500">${formatTime(t1)}</p>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-dot ${t2 ? 'active' : ''}"></div>
                            <p class="text-sm font-semibold text-gray-800">Colleague Agreed</p>
                            <p class="text-xs text-gray-500">${formatTime(t2)}</p>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-dot ${t3 ? 'active' : ''}"></div>
                            <p class="text-sm font-semibold text-gray-800">TL/OC Decision</p>
                            <p class="text-xs text-gray-500">${formatTime(t3)}</p>
                        </div>
                    </div>
                </div>
            `;

            const { value: formValues } = await Swal.fire({
                title: 'Request Details',
                html: `
                    <div class="text-left bg-gray-50 p-3 rounded-lg border border-gray-100 mb-4">
                        <p class="text-sm"><strong>Date:</strong> ${req.shiftDate}</p>
                        <p class="text-sm"><strong>Requester:</strong> ${req.requesterName}</p>
                        <p class="text-sm"><strong>Colleague:</strong> ${req.colleagueName}</p>
                    </div>

                    <label class="block text-left text-xs font-bold text-gray-500 uppercase mb-1">Status Override</label>
                    <select id="swal-status" class="w-full border border-gray-300 rounded p-2 mb-2 text-sm bg-white">
                        <option value="pending_tl_oc" ${req.status === 'pending_tl_oc' ? 'selected' : ''}>Pending TL/OC</option>
                        <option value="approved" ${req.status === 'approved' ? 'selected' : ''}>APPROVED</option>
                        <option value="rejected_tl_oc" ${req.status === 'rejected_tl_oc' ? 'selected' : ''}>Rejected (TL/OC)</option>
                        <option value="pending_colleague" ${req.status === 'pending_colleague' ? 'selected' : ''}>Pending Colleague</option>
                    </select>
                    
                    <div class="flex items-center gap-2 mt-2 text-sm text-left p-2 rounded hover:bg-gray-100 cursor-pointer">
                         <input type="checkbox" id="swal-roster" ${req.status !== 'approved' ? 'checked' : ''} class="w-4 h-4 text-indigo-600 rounded">
                         <label for="swal-roster" class="cursor-pointer">Sync Roster (if approving)</label>
                    </div>

                    ${timelineHtml}
                `,
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: 'Update Status',
                denyButtonText: 'Delete Request',
                denyButtonColor: '#dc2626',
                confirmButtonColor: '#4f46e5',
                focusConfirm: false,
                preConfirm: () => ({
                    action: 'update',
                    status: document.getElementById('swal-status').value,
                    roster: document.getElementById('swal-roster').checked
                }),
                preDeny: () => ({ action: 'delete' })
            });

            if (formValues) {
                if (formValues.action === 'update') {
                    await processUpdate(req, formValues.status, formValues.roster);
                } else if (formValues.action === 'delete') {
                    const confirmDelete = await Swal.fire({
                        title: 'Are you sure?',
                        text: "This action cannot be undone.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#dc2626',
                        confirmButtonText: 'Yes, Delete it'
                    });
                    
                    if (confirmDelete.isConfirmed) {
                        await deleteRequest(req.id);
                    }
                }
            }
        };

        async function processUpdate(req, newStatus, updateRoster) {
            Swal.fire({ title: 'Processing...', didOpen: () => Swal.showLoading() });
            
            try {
                const docRef = doc(shiftRequestsCollection, req.id);
                const updates = { 
                    status: newStatus, 
                    lastAdminUpdate: serverTimestamp()
                };

                if ((newStatus === 'approved' || newStatus.includes('rejected')) && !req.tlOcSignatureTimestamp) {
                    updates.tlOcSignatureTimestamp = serverTimestamp();
                }

                if (newStatus === 'approved' && updateRoster) {
                    const requesterRef = doc(rosterCollection, req.requesterId);
                    const colleagueRef = doc(rosterCollection, req.colleagueId);
                    await setDoc(requesterRef, { [req.shiftDate]: `[${req.requesterNewShift}]` }, { merge: true });
                    await setDoc(colleagueRef, { [req.shiftDate]: `[${req.colleagueNewShift}]` }, { merge: true });
                    updates.tlOcComments = "Approved by Admin Portal";
                }

                await updateDoc(docRef, updates);
                await fetchRequests(); 
                
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                Toast.fire({ icon: 'success', title: 'Updated' });

            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        async function deleteRequest(reqId) {
             Swal.fire({ title: 'Deleting...', didOpen: () => Swal.showLoading() });
             try {
                 await deleteDoc(doc(shiftRequestsCollection, reqId));
                 await fetchRequests();
                 Swal.fire('Deleted', 'Request has been removed.', 'success');
             } catch (error) {
                 Swal.fire('Error', error.message, 'error');
             }
        }
    </script>
</body>
</html>


