<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unified Admin Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            overflow-x: hidden; 
        }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CALENDAR STYLES --- */
        .calendar-wrapper {
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
            min-width: 800px; /* Force minimum width to prevent squishing */
        }
        .day-cell { 
            background-color: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            min-height: 100px; 
            padding: 6px; 
            position: relative; 
            display: flex;
            flex-direction: column;
            transition: border-color 0.2s;
        }
        .day-cell:hover { border-color: #94a3b8; }
        .day-cell.empty { background: transparent; border: none; }
        
        /* Shift Box */
        .shift-box {
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 6px;
            font-size: 0.8rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: inline-block;
            align-self: flex-start;
        }

        /* Leave Entries */
        .leave-entry { 
            font-size: 0.7rem; 
            font-weight: 600;
            padding: 3px 6px; 
            border-radius: 4px; 
            margin-top: 2px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            cursor: pointer;
            border-left-width: 3px;
            transition: all 0.1s;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .leave-entry:hover { transform: scale(1.02); z-index: 10; shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Status Colors */
        .leave-entry.pending   { background: #fff3cd; color: #856404; border-left-color: #ffeeba; }
        .leave-entry.approved  { background: #d4edda; color: #155724; border-left-color: #c3e6cb; }
        .leave-entry.rejected  { background: #f8d7da; color: #721c24; border-left-color: #f5c6cb; text-decoration: line-through; opacity: 0.7; }
        
        /* FREEZE / WRITE-IN (Yellowish) */
        .leave-entry.freeze, 
        .leave-entry.write-in { background: #ffeeba; color: #856404; border-left-color: #f1c40f; }

        /* Badge Styles */
        .badge { @apply px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide; }
        .badge-pending { @apply bg-blue-50 text-blue-700 border border-blue-100; }
        .badge-shift-pending { @apply bg-blue-50 text-blue-700 border border-blue-100; }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }

        /* --- FREEZE DATE STYLES (Stripes + Animation) --- */
        @keyframes stripes {
            from { background-position: 0 0; }
            to { background-position: 40px 0; }
        }
        .bg-stripes {
            background-image: repeating-linear-gradient(-45deg, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.05) 10px, transparent 10px, transparent 20px);
            animation: stripes 1s linear infinite;
        }
        
        /* Navigation Styles */
        .nav-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: #9ca3af;
            margin-bottom: 2px;
            padding-left: 2px;
        }
        
        /* Custom Scrollbar for Modal */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50 w-full">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col xl:flex-row justify-between h-auto py-2 xl:py-3 gap-3 items-center">
                <!-- Branding -->
                <div class="flex items-center gap-3 w-full xl:w-auto justify-between xl:justify-start">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-600 p-2 rounded-lg shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m8-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2m4-2a2 2 0 002-2v-2m-2-4h.01M17 16l-3-3m0 0l-3 3m3-3v9" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-900 leading-tight">Admin Portal</h1>
                            <div class="flex items-center gap-2">
                                <span id="auth-status" class="text-xs text-gray-400">Connecting...</span>
                            </div>
                        </div>
                    </div>
                    <!-- Mobile Refresh -->
                    <button onclick="refreshAll()" class="xl:hidden p-2 text-gray-400 hover:text-indigo-600 bg-gray-50 rounded-lg">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    </button>
                </div>

                <!-- Smart Navigation Groups -->
                <div class="flex flex-col sm:flex-row items-end sm:items-center gap-4 w-full xl:w-auto overflow-x-auto pb-1 sm:pb-0">
                    
                    <!-- Group 1: Roster Management -->
                    <div class="flex flex-col items-center sm:items-start">
                        <span class="nav-label">Roster Management</span>
                        <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                            <button onclick="switchTab('dashboard')" id="tab-btn-dashboard" class="px-3 py-1.5 rounded-md text-sm font-medium bg-white text-indigo-700 shadow-sm transition-all whitespace-nowrap">
                                Shift Swaps
                            </button>
                            <button onclick="switchTab('archive')" id="tab-btn-archive" class="px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-white transition-all whitespace-nowrap">
                                Archive
                            </button>
                        </div>
                    </div>

                    <!-- Group 2: Leave Management -->
                    <div class="flex flex-col items-center sm:items-start">
                        <span class="nav-label">Leave Management</span>
                        <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                            <button onclick="switchTab('leave')" id="tab-btn-leave" class="px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-white transition-all whitespace-nowrap">
                                Leave Calendar
                            </button>
                        </div>
                    </div>

                    <!-- Group 3: Main Application Access -->
                    <!-- This provides admins with a direct link to the primary leave planning application -->
                    <div class="flex flex-col items-center sm:items-start">
                        <span class="nav-label">Main App</span>
                        <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                            <a href="https://pccplanner.github.io/Alplanner/" target="_blank" class="px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-white transition-all whitespace-nowrap">
                                Leave Planner
                            </a>
                        </div>
                    </div>

                    <!-- Desktop Refresh -->
                    <div class="hidden xl:flex items-end h-full pb-1">
                        <button onclick="refreshAll()" class="p-2 ml-2 text-gray-400 hover:text-indigo-600 transition-colors bg-gray-50 rounded-lg hover:bg-gray-100" title="Refresh Data">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full overflow-hidden">
        
        <!-- ERROR BANNER (This handles the 'red message' gracefully) -->
        <div id="permission-error-banner" class="hidden mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm transition-all duration-500 ease-in-out">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <svg class="h-6 w-6 text-red-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    <div>
                        <p class="text-sm text-red-700 font-bold">Leave Database Disconnected</p>
                        <p class="text-xs text-red-600">Permission denied. Please log in to the <strong>Leave Planner</strong> database to view this data.</p>
                    </div>
                </div>
                <button onclick="toggleLoginModal()" class="bg-red-600 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-red-700 transition shadow">Connect Leave DB</button>
            </div>
        </div>

        <!-- TAB 1: SHIFT DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- LEFT COLUMN: PENDING APPROVALS -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span> Shift Swap Requests
                        </h2>
                        <span id="count-pending" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">0</span>
                    </div>
                    <!-- PENDING CONTAINER -->
                    <div id="pending-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                         <div class="col-span-full p-8 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">Loading requests...</div>
                    </div>
                </div>
                
                <!-- RIGHT COLUMN: HISTORY -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between"><h2 class="text-lg font-bold text-gray-800">Recent Activity</h2></div>
                    <div id="approved-list" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- TAB 2: LEAVE CALENDAR (FULL WIDTH) -->
        <div id="tab-leave" class="tab-content">
            
            <!-- LOGIN SCREEN (Shown when not connected to Leave DB) -->
            <div id="leave-login-container" class="max-w-md mx-auto mt-10 bg-white p-8 rounded-xl shadow-lg border border-gray-100 text-center">
                <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Admin Login Required</h3>
                <p class="text-sm text-gray-500 mb-6">Please log in to the Leave Planner database to view and manage leave requests.</p>
                
                <form id="leave-login-form" onsubmit="handleLeaveLogin(event)" class="space-y-4 text-left">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="leave-email" class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Password</label>
                        <input type="password" id="leave-password" class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                        Access Leave Calendar
                    </button>
                </form>
            </div>

            <!-- DASHBOARD CONTENT (Hidden until logged in) -->
            <div id="leave-dashboard-container" class="space-y-6 hidden">
                <!-- Top Stats -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between">
                        <div><p class="text-xs font-medium text-gray-500 uppercase">Pending Review</p><h3 id="stat-leave-pending" class="text-2xl font-bold text-gray-900">-</h3></div>
                        <div class="p-2 bg-amber-50 rounded-lg"><svg class="w-6 h-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between">
                        <div><p class="text-xs font-medium text-gray-500 uppercase">On Leave Today</p><h3 id="stat-leave-today" class="text-2xl font-bold text-gray-900">-</h3></div>
                        <div class="p-2 bg-blue-50 rounded-lg"><svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between">
                        <div><p class="text-xs font-medium text-gray-500 uppercase">Approved (Month)</p><h3 id="stat-leave-approved" class="text-2xl font-bold text-gray-900">-</h3></div>
                        <div class="p-2 bg-green-50 rounded-lg"><svg class="w-6 h-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between">
                        <div><p class="text-xs font-medium text-gray-500 uppercase">Upcoming (7 Days)</p><h3 id="stat-leave-upcoming" class="text-2xl font-bold text-gray-900">-</h3></div>
                        <div class="p-2 bg-indigo-50 rounded-lg"><svg class="w-6 h-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>
                    </div>

                    <!-- Calendar & Availability Stack -->
                        <!-- Make the calendar section span the full width of the grid on larger screens -->
                        <div class="flex flex-col gap-6 w-full sm:col-span-2 lg:col-span-4">
                        
                        <!-- 1. Full Width Calendar -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 w-full">
                            <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4 border-b border-gray-100 pb-4">
                                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <svg class="w-6 h-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    Leave Calendar
                                </h2>
                                
                                <div class="flex flex-wrap items-center gap-4 justify-center sm:justify-end">
                                    <div class="flex items-center gap-2 text-[10px] text-gray-500 mr-4">
                                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Approved</span>
                                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-stripes border border-red-300"></span> Freeze ðŸ”’</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label class="text-xs font-semibold text-gray-500">View Team:</label>
                                        <select id="calendar-team-select" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-1.5" onchange="handleTeamChange()">
                                            <option value="">Loading Teams...</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center bg-gray-50 rounded-lg p-1 border border-gray-200">
                                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-white hover:shadow-sm rounded transition"><svg class="w-5 h-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg></button>
                                        <span id="calendar-month-label" class="text-sm font-bold w-36 text-center text-gray-800">Loading...</span>
                                        <button onclick="changeMonth(1)" class="p-1 hover:bg-white hover:shadow-sm rounded transition"><svg class="w-5 h-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg></button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CALENDAR WRAPPER: Ensures horizontal scroll on mobile to prevent gray overflow -->
                            <div class="calendar-wrapper">
                                <div class="calendar-grid bg-gray-50 p-2 rounded-lg border border-gray-100" id="calendar-grid">
                                    <!-- Days Header (injected via JS) -->
                                </div>
                            </div>
                        </div>

                        <!-- 2. Who is off (Below Calendar) -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 w-full">
                             <h3 class="text-sm font-bold text-gray-700 mb-3 border-b border-gray-100 pb-2">Who is off today? (<span id="today-date-display"></span>)</h3>
                             <div id="who-is-off-list" class="flex flex-wrap gap-2"><span class="text-sm text-gray-400 italic">Checking...</span></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: ARCHIVE -->
        <div id="tab-archive" class="tab-content">
            <div class="bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-200 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-lg font-semibold text-gray-800">History</h2>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <input type="text" id="archive-search" placeholder="Search..." class="pl-4 pr-4 py-2 border border-gray-300 rounded-lg text-sm w-full sm:w-64" onkeyup="renderArchive()">
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Requester</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Colleague</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th></tr></thead><tbody id="archive-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody></table></div>
            </div>
        </div>
    </main>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="hidden fixed inset-0 z-[100] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all">
            <div class="text-center mb-6">
                <div class="bg-indigo-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Connect to Leave Database</h3>
                <p class="text-sm text-gray-500">Connecting to: <strong>apo-leave-planner</strong></p>
            </div>
            <form id="login-form" onsubmit="handleLeaveLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition">Log In to Leave DB</button>
            </form>
            <button onclick="toggleLoginModal()" class="mt-4 text-xs text-gray-400 hover:text-gray-600 w-full text-center">Cancel</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
            collection, query, getDocs, orderBy, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG 1: SHIFT / ROSTER DB
        const shiftConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
            authDomain: "roster-4a997.firebaseapp.com",
            projectId: "roster-4a997",
            storageBucket: "roster-4a997.firebasestorage.app",
            messagingSenderId: "901381868881",
            appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // CONFIG 2: LEAVE PLANNER DB
        const leaveConfig = {
            apiKey: "AIzaSyBtMiev72-UUyL8NEFk0bSIDAGJskU4Dj4",
            authDomain: "apo-leave-planner.firebaseapp.com",
            projectId: "apo-leave-planner",
            storageBucket: "apo-leave-planner.firebasestorage.app",
            messagingSenderId: "240953713168",
            appId: "1:240953713168:web:61ff4cd347c2a3ce4aa095"
        };

        // --- INIT DOUBLE DB ---
        const appShift = initializeApp(shiftConfig, "shiftApp");
        const authShift = getAuth(appShift);
        const dbShift = getFirestore(appShift);

        const appLeave = initializeApp(leaveConfig, "leaveApp");
        const authLeave = getAuth(appLeave);
        const dbLeave = getFirestore(appLeave);

        // --- COLLECTIONS ---
        const shiftRequestsCollection = collection(dbShift, 'artifacts', appId, 'public', 'data', 'shiftRequests');
        const rosterCollection = collection(dbShift, "roster");
        
        const leaveRequestsCollection = collection(dbLeave, 'artifacts', appId, 'public', 'data', 'leaveRequests');
        const teamsCollection = collection(dbLeave, 'artifacts', appId, 'public', 'data', 'teams');
        const leaveFreezeCollectionPath = collection(dbLeave, 'artifacts', appId, 'public', 'data', 'leaveFreezeDates');
        
        // NEW: Users collection for balance info
        const usersCollection = collection(dbLeave, 'artifacts', appId, 'public', 'data', 'users');

        // STATE
        let allShiftRequests = [];
        let allLeaveRequests = [];
        let allTeams = [];
        let allUsers = []; // New state for users
        let leaveFreezeDates = new Set(); 
        let selectedTeamId = null;
        let teamsMap = new Map();

        let currentCalendarDate = new Date();

        // --- ICONS & HELPERS ---
        const iconSun = `<svg class="w-3.5 h-3.5 text-orange-400 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
        const iconMoon = `<svg class="w-3.5 h-3.5 text-indigo-500 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;

        // Shift pattern logic
        const shiftCodesMap = {
            '1':    { text: '1',    color: 'bg-green-600', textColor: 'text-white' },
            '2':    { text: '2',    color: 'bg-green-400', textColor: 'text-gray-800' },
            '1A':   { text: '1A',   color: 'bg-green-600', textColor: 'text-white' },
            '2N':   { text: '2N',   color: 'bg-green-400', textColor: 'text-gray-800' },
            'OFF':  { text: 'OFF',  color: 'bg-gray-300', textColor: 'text-gray-800' },
            'AL':   { text: 'AL',   color: 'bg-blue-200', textColor: 'text-blue-800' },
            '_EMPTY': { text: '',   color: 'bg-gray-50', textColor: 'text-gray-400' }
        };

        const patternAnchorDate = '2025-01-01';

        // --- ERROR HANDLING HELPER (NEW) ---
        function showErrorBanner(show) {
            const banner = document.getElementById('permission-error-banner');
            if (show) {
                banner.classList.remove('hidden');
                // Auto hide logic handled by auth state change mainly, but we can animate it
            } else {
                banner.classList.add('hidden');
            }
        }
        
        window.toggleLoginModal = () => {
            const modal = document.getElementById('login-modal');
            modal.classList.toggle('hidden');
        };

        // --- AUTH & LOGIN ---
        window.handleLeaveLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('leave-email').value;
            const pass = document.getElementById('leave-password').value;
            // Also grab from modal if that's where it was triggered
            const modalEmail = document.getElementById('login-email').value;
            const modalPass = document.getElementById('login-password').value;
            
            const finalEmail = email || modalEmail;
            const finalPass = pass || modalPass;

            try {
                await signInWithEmailAndPassword(authLeave, finalEmail, finalPass);
                document.getElementById('login-modal').classList.add('hidden');
                // Toggle view handled by observer
            } catch (err) {
                Swal.fire('Login Failed', err.message, 'error');
            }
        };

        window.handleTeamChange = () => {
            selectedTeamId = document.getElementById('calendar-team-select').value;
            renderCalendar();
        };

        // --- OBSERVERS ---
        onAuthStateChanged(authShift, (user) => {
            if (user) {
                document.getElementById('auth-status').textContent = "Connected";
                fetchShiftRequests();
            } else {
                if (initialAuthToken) signInWithCustomToken(authShift, initialAuthToken);
                else signInAnonymously(authShift);
            }
        });

        onAuthStateChanged(authLeave, (user) => {
            const loginContainer = document.getElementById('leave-login-container');
            const dashboardContainer = document.getElementById('leave-dashboard-container');
            
            if (user) {
                showErrorBanner(false); // Hide error if user logs in
                loginContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                refreshLeaveData();
            } else {
                // Don't necessarily show error here, just the login container
                loginContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                allLeaveRequests = [];
            }
        });

        // --- DATA FETCHING ---
        window.refreshAll = async function() {
            await fetchShiftRequests();
            if(authLeave.currentUser) await refreshLeaveData();
        };

        async function refreshLeaveData() {
            // Trigger fetches only if user is logged in to avoid spamming errors
            if (!authLeave.currentUser) return;
            
            await fetchTeams();
            await fetchUsers(); // Added User Fetching
            await fetchFreezeDates();
            await fetchLeaveRequests();
        }

        async function fetchShiftRequests() {
            try {
                // Fallback sort
                const snap = await getDocs(shiftRequestsCollection);
                allShiftRequests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                allShiftRequests.sort((a,b) => b.shiftDate.localeCompare(a.shiftDate));
                renderShiftDashboard();
                renderArchive();
            } catch (e) {
                console.error("Shift Fetch Error", e);
            }
        }

        async function fetchTeams() {
            try {
                const snap = await getDocs(teamsCollection);
                allTeams = snap.docs.map(d => ({id: d.id, ...d.data()}));
                allTeams.sort((a,b) => a.name.localeCompare(b.name));
                
                teamsMap.clear();
                const select = document.getElementById('calendar-team-select');
                select.innerHTML = '<option value="">-- Select Team --</option>';
                
                allTeams.forEach(t => {
                    teamsMap.set(t.id, t);
                    select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
                
                if (!selectedTeamId && allTeams.length > 0) {
                    selectedTeamId = allTeams[0].id;
                    select.value = selectedTeamId;
                }
            } catch (e) { 
                console.error("Teams Fetch Error", e);
                // IF permission denied, show banner instead of alert
                if (e.code === 'permission-denied' || e.message.includes('permission')) {
                    showErrorBanner(true);
                }
            }
        }

        // NEW: Fetch Users for Balance Info
        async function fetchUsers() {
            try {
                const snap = await getDocs(usersCollection);
                allUsers = snap.docs.map(d => ({id: d.id, ...d.data()}));
            } catch(e) { console.error("Users Fetch Error", e); }
        }

        async function fetchFreezeDates() {
            try {
                const snap = await getDocs(leaveFreezeCollectionPath);
                leaveFreezeDates.clear();
                snap.forEach(doc => {
                    if (doc.data().frozen) {
                        leaveFreezeDates.add(doc.id); 
                    }
                });
                renderCalendar();
            } catch (e) {
                console.error("Freeze Fetch Error", e);
            }
        }

        async function fetchLeaveRequests() {
            try {
                const snap = await getDocs(leaveRequestsCollection);
                allLeaveRequests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                allLeaveRequests.sort((a, b) => {
                    const dA = a.fromDate || '0000'; const dB = b.fromDate || '0000';
                    return dB.localeCompare(dA);
                });
                renderLeaveDashboard();
            } catch (e) {
                console.warn("Leave Fetch Failed:", e);
                
                // FIXED: Use Banner for permission errors, Swal for others
                if (e.code === 'permission-denied' || e.message.includes('permission')) {
                    showErrorBanner(true);
                } else {
                    Swal.fire('Data Error', `Leave Data: ${e.message}`, 'error');
                }
            }
        }

        // --- HELPER: SHIFT CALCULATION ---
        function getDaysBetween(dateStr1, dateStr2) {
            try {
                const [y1, m1, d1] = dateStr1.split('-').map(Number);
                const [y2, m2, d2] = dateStr2.split('-').map(Number);
                const utcDate1 = Date.UTC(y1, m1 - 1, d1);
                const utcDate2 = Date.UTC(y2, m2 - 1, d2);
                if (isNaN(utcDate1) || isNaN(utcDate2)) return 0;
                return Math.round((utcDate1 - utcDate2) / 86400000);
            } catch (e) { return 0; }
        }

        function getShift(dateObj) {
            if (!selectedTeamId) return { shift: '', shiftInfo: shiftCodesMap['_EMPTY'] };
            
            const team = teamsMap.get(selectedTeamId);
            if (!team || !team.shiftPattern || team.shiftPattern.length === 0) {
                return { shift: '', shiftInfo: shiftCodesMap['_EMPTY'] };
            }
            
            const pattern = team.shiftPattern;
            const anchorDate = team.patternStartDate || patternAnchorDate;
            const dateStr = formatDate(dateObj);
            const daysSinceAnchor = getDaysBetween(dateStr, anchorDate);
            
            const patternIndex = (daysSinceAnchor % pattern.length + pattern.length) % pattern.length;
            const shift = pattern[patternIndex];
            const shiftInfo = shiftCodesMap[shift] || { ...shiftCodesMap['_EMPTY'], text: shift }; 
            return { shift, shiftInfo };
        }
        
        function formatDate(d) {
             const y = d.getFullYear();
             const m = String(d.getMonth() + 1).padStart(2, "0");
             const dd = String(d.getDate()).padStart(2, "0");
             return y + "-" + m + "-" + dd;
        }

        function formatShiftShort(shift) {
            if (!shift) return "?";
             const s = shift.toString().toUpperCase();
            if (s.includes('1') || s === 'M') return `${iconSun} AM`;
            if (s.includes('2') || s === 'N') return `${iconMoon} PM`;
            return shift;
        }

        // --- DASHBOARD RENDERERS ---
        function renderShiftDashboard() {
            const pendingContainer = document.getElementById('pending-container');
            const approvedList = document.getElementById('approved-list');
            const countPending = document.getElementById('count-pending');
            const pending = allShiftRequests.filter(r => r.status === 'pending_tl_oc');
            countPending.textContent = pending.length;
            
            if (pending.length === 0) {
                pendingContainer.innerHTML = `<div class="col-span-full p-6 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">No pending shift approvals.</div>`;
            } else {
                pendingContainer.innerHTML = pending.map(req => `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 flex flex-col justify-between h-full hover:shadow-md transition">
                        <div class="flex justify-between items-start border-b border-gray-100 pb-2 mb-2">
                            <span class="font-bold text-gray-800 text-sm">${req.shiftDate}</span>
                            <span class="badge badge-shift-pending">Shift Swap</span>
                        </div>
                        <div class="text-sm space-y-1 mb-3">
                            <div class="flex justify-between"><span>${req.requesterName}</span><span class="text-xs bg-gray-100 px-1 rounded">${req.requesterOriginalShift} -> ${req.requesterNewShift}</span></div>
                            <div class="flex justify-between"><span>${req.colleagueName}</span><span class="text-xs bg-gray-100 px-1 rounded">${req.colleagueOriginalShift} -> ${req.colleagueNewShift}</span></div>
                        </div>
                        <div class="flex gap-2"><button onclick="quickActionShift('${req.id}', 'approve')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-1.5 rounded text-xs transition shadow-sm flex items-center justify-center gap-1">Approve</button><button onclick="quickActionShift('${req.id}', 'reject')" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 font-semibold py-1.5 rounded text-xs transition flex items-center justify-center gap-1">Reject</button></div>
                    </div>`).join('');
            }
            
            const recent = allShiftRequests.filter(r => r.status === 'approved').slice(0, 5);
            approvedList.innerHTML = recent.length ? recent.map(r => `<div class="bg-white p-3 rounded-lg border text-sm"><strong>${r.shiftDate}:</strong> ${r.requesterName} <-> ${r.colleagueName}</div>`).join('') : '<div class="text-gray-400 text-sm text-center">No recent activity.</div>';
        }

        function renderLeaveDashboard() {
            let pendingCount = 0, approvedMonth = 0, todayCount = 0, upcoming = 0;
            const today = new Date(); const todayStr = today.toISOString().split('T')[0];
            const onLeaveToday = [];
            const sevenDaysFromNow = new Date();
            sevenDaysFromNow.setDate(today.getDate() + 7);

            allLeaveRequests.forEach(req => {
                if(!req.days) return;
                const pDays = req.days.filter(d => d.status === 'Pending');
                if(pDays.length > 0) pendingCount++;
                
                req.days.forEach(d => {
                    if(d.status === 'Approved') {
                        if(d.date.startsWith(todayStr.substring(0,7))) approvedMonth++;
                        if(d.date === todayStr) { todayCount++; onLeaveToday.push(req.staffName); }
                        const dDate = new Date(d.date);
                        if (dDate > today && dDate <= sevenDaysFromNow) upcoming++;
                    }
                });
            });

            document.getElementById('stat-leave-pending').textContent = pendingCount;
            document.getElementById('stat-leave-approved').textContent = approvedMonth;
            document.getElementById('stat-leave-today').textContent = todayCount;
            document.getElementById('stat-leave-upcoming').textContent = upcoming;
            document.getElementById('who-is-off-list').innerHTML = onLeaveToday.length ? onLeaveToday.map(n => `<span class="bg-red-100 text-red-800 px-2 py-0.5 rounded-full text-xs">${n}</span>`).join('') : '<span class="text-gray-400 text-sm italic">No one is on leave today.</span>';
            
            renderCalendar();
        }

        // --- CALENDAR ---
        window.changeMonth = (d) => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + d); renderCalendar(); };
        function renderCalendar() {
            const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
            const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            document.getElementById('calendar-month-label').textContent = `${months[m]} ${y}`;
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const fragment = document.createDocumentFragment();

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const h = document.createElement('div');
                h.className = "text-center text-xs font-bold text-gray-400 uppercase pb-2";
                h.textContent = day;
                fragment.appendChild(h);
            });

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const div = document.createElement('div');
                // Use both 'calendar-day' and 'day-cell' so the cell gets the same styling defined in CSS (e.g. position relative)
                div.className = 'calendar-day day-cell';
                div.innerHTML = `<span class="text-gray-400 font-bold block mb-1">${d}</span>`;
                
                if (leaveFreezeDates.has(dateStr)) {
                    div.classList.add("bg-stripes"); 
                    const lockIcon = document.createElement("div");
                    // Raise the z-index so the lock sits above other elements (leave/shift entries)
                    lockIcon.className = "absolute bottom-1 right-1 text-red-700 font-bold text-sm z-20";
                    lockIcon.innerHTML = `ðŸ”’`;
                    div.appendChild(lockIcon);
                }

                const { shift, shiftInfo } = getShift(new Date(y, m, d));
                const shiftBox = document.createElement('div');
                shiftBox.textContent = d;
                shiftBox.className = `shift-box ${shiftInfo.color} ${shiftInfo.textColor} z-10 relative`;
                shiftBox.title = shiftInfo.text;
                div.appendChild(shiftBox);
                
                allLeaveRequests.forEach(req => {
                    if(!req.days) return;
                    const dayData = req.days.find(x => x.date === dateStr);
                    if(dayData && dayData.status !== 'Rejected') {
                        const statusClass = dayData.status.toLowerCase();
                        const finalClass = (statusClass.includes('freeze') || statusClass.includes('write')) ? 'write-in' : statusClass;

                        const pill = document.createElement('div');
                        pill.className = `leave-entry ${finalClass} z-10 relative`;
                        
                        let inner = `<span>${req.staffID || '???'}</span>`;
                        if (statusClass.includes('freeze') || statusClass.includes('write')) {
                             inner += `<span>ðŸ”’</span>`;
                        }
                        pill.innerHTML = inner;
                        
                        pill.title = `${req.staffName} (${dayData.status})`;
                        pill.onclick = (e) => {
                            e.stopPropagation();
                            window.openLeaveActionModal(req.id);
                        };
                        div.appendChild(pill);
                    }
                });
                grid.appendChild(div);
            }
        }

        window.openLeaveActionModal = async (id) => {
            const req = allLeaveRequests.find(r => r.id === id);
            if(!req) return;

            // 1. Fetch User Details & Balances
            const user = allUsers.find(u => u.staffID === req.staffID);
            
            // Calculate Used Leaves (AL & PH) from Approved/Write-in requests
            const usedAL = allLeaveRequests.reduce((acc, r) => {
                if(r.staffID === req.staffID && r.leaveType === 'Annual Leave') {
                    return acc + r.days.filter(d => d.status === 'Approved' || d.status === 'Write-in').length;
                }
                return acc;
            }, 0);
            
            const usedPH = allLeaveRequests.reduce((acc, r) => {
                if(r.staffID === req.staffID && r.leaveType === 'Public Holiday') {
                    return acc + r.days.filter(d => d.status === 'Approved' || d.status === 'Write-in').length;
                }
                return acc;
            }, 0);

            const allocAL = user ? (user.annualLeaveAllocated || 0) : 0;
            const allocPH = user ? (user.publicHolidayAllocated || 0) : 0;
            const balAL = allocAL - usedAL;
            const balPH = allocPH - usedPH;
            const teamName = user ? (teamsMap.get(user.team_id)?.name || 'Unknown Team') : 'Unknown Team';
            const mobile = user ? (user.mobile || 'N/A') : 'N/A';

            // Construct Profile HTML
            const profileHtml = `
                <div class="grid grid-cols-2 gap-3 mb-4 bg-white p-3 rounded-lg border border-gray-100 shadow-sm text-xs">
                    <div>
                        <p class="text-gray-400 uppercase tracking-wider font-bold mb-1">Contact</p>
                        <p class="text-gray-800"><span class="font-semibold">Team:</span> ${teamName}</p>
                        <p class="text-gray-800"><span class="font-semibold">Mobile:</span> ${mobile}</p>
                        <p class="text-gray-800"><span class="font-semibold">Email:</span> ${user?.email || 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-gray-400 uppercase tracking-wider font-bold mb-1">Balances</p>
                        <div class="flex justify-between mb-1">
                            <span>Annual Leave:</span>
                            <span class="font-bold ${balAL < 0 ? 'text-red-600' : 'text-green-600'}">${balAL} / ${allocAL}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Public Holiday:</span>
                            <span class="font-bold ${balPH < 0 ? 'text-red-600' : 'text-green-600'}">${balPH} / ${allocPH}</span>
                        </div>
                    </div>
                </div>
            `;

            // 2. History Logic
            const history = allLeaveRequests
                .filter(r => r.staffID === req.staffID && r.id !== id) // Get other requests by same staff
                .sort((a,b) => b.fromDate.localeCompare(a.fromDate)); // Sort newest first

            const historyHtml = history.length ? `
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Past Leave History</h4>
                    <div class="max-h-40 overflow-y-auto border rounded bg-white shadow-inner custom-scrollbar">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-50 text-gray-500 font-semibold sticky top-0 z-10">
                                <tr>
                                    <th class="px-2 py-1.5 border-b">Date Range</th>
                                    <th class="px-2 py-1.5 border-b">Type</th>
                                    <th class="px-2 py-1.5 border-b">Days</th>
                                    <th class="px-2 py-1.5 border-b">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${history.map(h => {
                                    const approvedCount = h.days.filter(d => d.status === 'Approved').length;
                                    const totalDays = h.days.length;
                                    let statusColor = 'text-gray-500';
                                    let statusText = h.days[0].status;
                                    if(h.days.every(d => d.status === 'Approved')) {
                                        statusColor = 'text-green-600 font-bold';
                                    } else if(h.days.some(d => d.status === 'Approved')) {
                                        statusColor = 'text-orange-500'; statusText = 'Mixed';
                                    } else if(h.days.every(d => d.status === 'Rejected')) {
                                        statusColor = 'text-red-500 line-through';
                                    }
                                    if(h.days.some(d => d.status === 'Write-in' || d.status === 'Freeze')) {
                                        statusColor = 'text-purple-600 font-bold'; statusText = 'Write-in';
                                    }
                                    return `<tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-2 py-1.5 whitespace-nowrap">${h.fromDate} <span class="text-gray-300">-></span> ${h.toDate}</td>
                                        <td class="px-2 py-1.5">${h.leaveType || 'AL'}</td>
                                        <td class="px-2 py-1.5 text-center">${approvedCount}/${totalDays}</td>
                                        <td class="px-2 py-1.5 ${statusColor}">${statusText}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>` : '<div class="mt-4 pt-2 border-t text-xs text-gray-400 italic">No previous history found.</div>';

            const daysHtml = req.days.map((d,i) => `
                <div class="flex justify-between items-center mb-1 text-sm border-b border-gray-100 pb-1 last:border-0">
                    <span class="font-medium text-gray-700">${d.date}</span>
                    <select id="ls-${i}" class="text-xs border-gray-300 border rounded py-1 px-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm">
                        <option ${d.status==='Pending'?'selected':''}>Pending</option>
                        <option ${d.status==='Approved'?'selected':''} class="text-green-600 font-bold">Approved</option>
                        <option ${d.status==='Rejected'?'selected':''} class="text-red-600">Rejected</option>
                        <option value="Freeze" ${d.status==='Freeze' || d.status==='Write-in'?'selected':''} class="text-orange-600">Freeze / Write-in</option>
                    </select>
                </div>`).join('');
            
            const res = await Swal.fire({
                title: `<span class="text-lg font-bold text-gray-800">Manage Leave</span>`,
                html: `
                    <div class="text-left">
                        <div class="bg-indigo-50 p-3 mb-2 rounded-t-lg border-b border-indigo-100 flex justify-between items-center">
                            <div>
                                <p class="text-sm text-indigo-900 font-bold">${req.staffName}</p>
                                <p class="text-xs text-indigo-500">${req.staffID}</p>
                            </div>
                            <span class="px-2 py-1 rounded bg-indigo-100 text-indigo-700 text-xs font-bold">${req.leaveType || 'AL'}</span>
                        </div>
                        
                        ${profileHtml}

                        <div class="mb-2 font-semibold text-xs text-gray-500 uppercase tracking-wide">Edit Request Status</div>
                        <div class="max-h-32 overflow-y-auto pr-1 mb-2 custom-scrollbar border-b border-gray-100 pb-2">
                            ${daysHtml}
                        </div>
                        ${historyHtml}
                    </div>`,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                confirmButtonColor: '#4f46e5',
                cancelButtonColor: '#9ca3af',
                width: '600px', 
                customClass: { popup: 'rounded-xl shadow-xl' }
            });
            
            if(res.isConfirmed) {
                const newDays = req.days.map((d,i) => ({ ...d, status: document.getElementById(`ls-${i}`).value }));
                try {
                    await updateDoc(doc(leaveRequestsCollection, id), { days: newDays });
                    refreshLeaveData();
                    Swal.fire('Updated', '', 'success');
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            }
        };

        window.quickActionShift = async (id, action) => {
            const req = allShiftRequests.find(r => r.id === id);
            if(!req) return;
            if(action === 'reject') {
                const reason = await Swal.fire({title:'Reject Reason', input:'text', showCancelButton:true});
                if(!reason.isConfirmed) return;
            }
            try {
                const status = action === 'approve' ? 'approved' : 'rejected_tl_oc';
                const updates = { status, lastAdminUpdate: serverTimestamp() };
                if(action === 'approve') {
                     await setDoc(doc(rosterCollection, req.requesterId), { [req.shiftDate]: `[${req.requesterNewShift}]` }, { merge: true });
                     await setDoc(doc(rosterCollection, req.colleagueId), { [req.shiftDate]: `[${req.colleagueNewShift}]` }, { merge: true });
                }
                await updateDoc(doc(shiftRequestsCollection, id), updates); 
                fetchShiftRequests();
                Swal.fire('Success', '', 'success');
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.switchTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            
            document.querySelectorAll('button[id^="tab-btn-"]').forEach(btn => {
                btn.className = "px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-white transition-all whitespace-nowrap";
            });
            const activeBtn = document.getElementById(`tab-btn-${t}`);
            if(activeBtn) {
                activeBtn.className = "px-3 py-1.5 rounded-md text-sm font-medium bg-white text-indigo-700 shadow-sm transition-all whitespace-nowrap";
            }
        };
        
        window.renderArchive = () => {
            const term = document.getElementById('archive-search').value.toLowerCase();
            const filtered = allShiftRequests.filter(r => r.requesterName.toLowerCase().includes(term) || r.shiftDate.includes(term));
            document.getElementById('archive-table-body').innerHTML = filtered.length ? filtered.map(r => `
                <tr class="hover:bg-gray-50"><td class="px-6 py-4">${r.shiftDate}</td><td class="px-6 py-4">${r.requesterName}</td><td class="px-6 py-4">${r.colleagueName}</td><td class="px-6 py-4">${r.status}</td></tr>
            `).join('') : '<tr><td colspan="4" class="p-4 text-center text-gray-400">No requests found</td></tr>';
        };

        document.getElementById('today-date-display').textContent = new Date().toLocaleDateString('en-SG', { day: 'numeric', month: 'short' });

    </script>
</body>
</html>


