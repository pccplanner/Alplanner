<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APO Management Portal (Integrated)</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 3. Load Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 4. Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- 5. Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const mockFirebaseConfig = { apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM", authDomain: "roster-4a997.firebaseapp.com", projectId: "roster-4a997", storageBucket: "roster-4a997.firebasestorage.app", messagingSenderId: "901381868881", appId: "1:901381868881:web:92930481d6c1c85fedd770" };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : mockFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.firebase = { db, auth, appId, initialAuthToken, doc, getDoc, setDoc, onSnapshot, collection, deleteDoc, updateDoc, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getAuth };
        
        function tryRenderApp() {
            if (window.firebase && window.firebase.db && window.firebase.auth) {
                try {
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(React.createElement(App));
                } catch (e) { console.error("Render Failed:", e); }
            } else { setTimeout(tryRenderApp, 100); }
        }
        window.onload = tryRenderApp;
    </script>
    
    <style>
        /* --- Portal Layout Styles --- */
        :root { --sidebar-width: 260px; }
        body { background-color: #f8fafc; color: #1e293b; }
        .sidebar { transition: transform 0.3s ease; width: var(--sidebar-width); }
        .content-area { transition: margin-left 0.3s ease; margin-left: 0; }
        @media (min-width: 1024px) { .content-area { margin-left: var(--sidebar-width); } }
        .sidebar-overlay { background: rgba(0,0,0,0.5); }
        
        /* --- Original Roster Styles (Preserved for functionality) --- */
        .highlight-cell { background-color: #FDE047; border: 2px solid #F59E0B; color: #000; font-weight: bold; }
        .dropdown-permanent { font-weight: bold; color: #1D4ED8; background-image: linear-gradient(45deg, #EFF6FF 50%, #DBEAFE 50%); background-size: 8px 8px; }
        .dropdown-buffer { font-weight: bold; color: #581c87; background-color: #d8b4fe; }
        .buffer-id-content { background-color: #FBCFE8 !important; color: #9D174D !important; font-weight: 700 !important; border: 1px solid #F472B6 !important; }
        .shuffling-highlight { background-color: #FBBF24 !important; border: 2px solid #D97706 !important; animation: pulse-shuffle 1s infinite alternate; }
        @keyframes pulse-shuffle { from { opacity: 1; } to { opacity: 0.7; } }
        select, input { text-align: center !important; text-align-last: center !important; }
        .staff-pool-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 640px) { .staff-pool-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .staff-pool-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .staff-card-scheduled { border: 1px solid #10B981; background-color: #F0FDF4; }
        .staff-card-unscheduled { border: 1px solid #F87171; background-color: #FEF2F2; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3B82F6; }
        input:checked + .slider:before { transform: translateX(20px); }
        .matrix-edit-active td { background-color: #f0f9ff !important; }
        .matrix-edit-active select { background-color: #e0f2fe !important; font-weight: 600; border: 1px solid #93c5fd; padding: 1px !important; height: 18px !important; }

        /* Print Override */
        @media print {
            .no-print, .sidebar, header, .nav-buttons, .action-buttons { display: none !important; }
            .content-area { margin-left: 0 !important; width: 100% !important; padding: 0 !important; }
            body { background-color: white; zoom: 70%; -webkit-print-color-adjust: exact; }
            .card { box-shadow: none !important; border: none !important; }
            .roster-container { margin: 0; padding: 0; }
        }
    </style>
</head>
<body class="font-sans text-gray-800 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, createContext, useContext } = React;
        const FIREBASE_GLOBALS = window.firebase || {};
        const { doc, getDoc, setDoc, onSnapshot, collection, deleteDoc, updateDoc, signInAnonymously, onAuthStateChanged, signInWithCustomToken, initialAuthToken, appId, db, auth } = FIREBASE_GLOBALS;

        // --- CONSTANTS & CONFIG ---
        const TEAM_COLLECTION = "teams"; 
        const EMPLOYEES_COLLECTION = "employees";
        const DAILY_ASSIGNMENTS_COLLECTION = "dailyAssignments_v7";
        const DAILY_ROSTER_COLLECTION = "dailyRosters_v7";
        const DAILY_ATTENDANCE_COLLECTION = "dailyAttendance_v7";
        
        const SENTRY_POSITIONS = ["E1", "PATROL 1", "E3", "N1 (CNB)", "PATROL 2", "OE/ STANDBY", "PERIMETER PROWLER (1st Half)", "PERIMETER PROWLER (2nd Half)"];
        const SECURITY_POSITIONS = ["TEAM LEADER (I/C)", "SECTION I/C"];
        const FOYER_POSITIONS = ["XRAY-VISITOR", "FOYER-OE"];
        const VERTICAL_PROWLER_POSITION = "VERTICAL PROWLER";
        const TIME_SLOTS = ["2000Hrs", "2100Hrs", "2200Hrs", "2300Hrs", "2400Hrs", "0100Hrs", "0200Hrs", "0300Hrs", "0400Hrs", "0500Hrs", "0600Hrs", "0700Hrs"];
        const VERTICAL_PROWLER_SLOTS = ["20:30", "23:00", "00:30", "03:00", "04:30", "06:30"];
        
        const SENTRY_SEQUENCE_KEYS = ["E1", "OE", "P2", "N1", "E3", "P1"];
        const SENTRY_LOCATION_KEYS = ["E1", "PATROL 1", "E3", "N1 (CNB)", "PATROL 2", "OE/ STANDBY", "PERIMETER PROWLER (1st Half)", "PERIMETER PROWLER (2nd Half)"];
        const FOYER_ASSIGNMENT_KEYS = ["FOYER 1", "FOYER 2"];
        const SECURITY_ASSIGNMENT_KEYS = ["TEAM LEADER (I/C)", "SECTION I/C"];
        const ALL_ASSIGNMENT_KEYS = [...SENTRY_SEQUENCE_KEYS, ...SENTRY_LOCATION_KEYS, ...FOYER_ASSIGNMENT_KEYS, ...SECURITY_ASSIGNMENT_KEYS];
        const OVERRIDE_LOCATIONS = ["E1", "PATROL 1", "E3", "N1 (CNB)", "PATROL 2", "OE/ STANDBY", VERTICAL_PROWLER_POSITION];
        const UNFILLED_SLOT = "---";
        const ROSTER_MODES = { AUTO_SEQUENCE: 'Auto-Sequence', MANUAL_LOCATION_FIXED: 'Manual-Location-Fixed' };
        const SENTRY_POSITION_SEQUENCES = {
            "E1": ["E1", "OE", "P2", "N1", "E3", "P1"], "PATROL 1": ["P1", "E1", "OE", "P2", "N1", "E3"],
            "E3": ["E3", "P1", "E1", "OE", "P2", "N1"], "N1 (CNB)": ["N1", "E3", "P1", "E1", "OE", "P2"],
            "PATROL 2": ["P2", "N1", "E3", "P1", "E1", "OE"], "OE/ STANDBY": ["OE", "P2", "N1", "E3", "P1", "E1"]
        };

        // --- HELPERS ---
        const getCollectionRef = (n) => (n===TEAM_COLLECTION || n===EMPLOYEES_COLLECTION) ? collection(db, `artifacts/${appId}/public/data/${n}`) : collection(db, n);
        const getDocRef = (n, id) => (n===TEAM_COLLECTION || n===EMPLOYEES_COLLECTION) ? doc(db, `artifacts/${appId}/public/data/${n}`, String(id)) : doc(db, n, String(id));
        const getTodayDate = () => { const t = new Date(); return new Date(t.getTime() - (t.getTimezoneOffset()*60000)).toISOString().split('T')[0]; };
        const sanitizeForFirestore = (obj) => JSON.parse(JSON.stringify(obj, (k,v) => v === undefined ? null : v));
        const cleanStaffId = (id) => { const t = (id||'').trim(); return (t.length > 1 && t.toLowerCase().startsWith('t')) ? t.substring(1) : t; };
        const extractName = (n) => { const m = (n||'').match(/\((.*?)\)\s*(.*)/); return m && m[2] ? m[2].trim() : (n||'').trim(); };
        const getStaffAssignments = (id, map, keys) => keys.filter(k => map[k] && map[k].includes(id));

        // --- CONTEXT ---
        const StaffContext = createContext();
        function StaffProvider({ children, selectedDate }) {
            const [employees, setEmployees] = useState([]);
            const [teams, setTeams] = useState([]);
            const [dailyAttendance, setDailyAttendance] = useState([]);
            const [loadingState, setLoadingState] = useState({ teams: true, employees: true, attendance: true });

            useEffect(() => { const u=onSnapshot(getCollectionRef(TEAM_COLLECTION),s=>{const d=[];s.forEach(x=>d.push({docId:x.id,...x.data()}));setTeams(d);setLoadingState(p=>({...p,teams:false}));});return u; }, []);
            useEffect(() => { const u=onSnapshot(getCollectionRef(EMPLOYEES_COLLECTION),s=>{const d=[];s.forEach(x=>d.push({docId:x.id,...x.data()}));setEmployees(d.sort((a,b)=>(a.name||'').localeCompare(b.name||'')));setLoadingState(p=>({...p,employees:false}));});return u; }, []);
            useEffect(() => { 
                if(!selectedDate) return; 
                setLoadingState(p=>({...p,attendance:true}));
                const u=onSnapshot(getDocRef(DAILY_ATTENDANCE_COLLECTION, selectedDate),s=>{setDailyAttendance(s.exists()?s.data().scheduledStaff||[]:[]);setLoadingState(p=>({...p,attendance:false}));});
                return u; 
            }, [selectedDate]);

            const teamMap = useMemo(() => { const m=new Map(); teams.forEach(t=>m.set(t.docId, t)); return m; }, [teams]);
            const staffPool = useMemo(() => employees.map(e => {
                const id=cleanStaffId(e.emp_id||e.id||e.docId); if(!id)return null;
                return { id, docId:e.docId, name:extractName(e.name||id), rawName:e.name, team_id:e.team_id, team_name:teamMap.get(e.team_id)?.name||'N/A', type:e.is_buffer?'buffer':'permanent' };
            }).filter(Boolean), [employees, teamMap]);
            const staffTypeMap = useMemo(() => { const m=new Map(); staffPool.forEach(s=>m.set(s.id, s.type)); return m; }, [staffPool]);
            const scheduledStaff = useMemo(() => { const s=new Set(dailyAttendance); return staffPool.filter(x=>s.has(x.id)); }, [staffPool, dailyAttendance]);

            return ( <StaffContext.Provider value={{ staffPool, teamMap, staffTypeMap, loading: Object.values(loadingState).some(x=>x), dailyAttendance, scheduledStaff, ALL_ASSIGNMENT_KEYS, OVERRIDE_LOCATIONS }}>{children}</StaffContext.Provider> );
        }

        // --- DASHBOARD COMPONENTS ---
        function DashboardHome({ setView, setSelectedDate }) {
            const [history, setHistory] = useState([]);
            useEffect(() => onSnapshot(collection(db, DAILY_ROSTER_COLLECTION), s => {
                const h = []; s.forEach(d => h.push({ id:d.id, updatedAt:d.data().updatedAt?new Date(d.data().updatedAt):new Date(), status:Object.keys(d.data().rosterGrid||{}).length>0?'Published':'Draft' }));
                setHistory(h.sort((a,b)=>b.updatedAt-a.updatedAt));
            }), []);
            const stats = { total: history.filter(h=>h.status==='Published').length, today: history.find(h=>h.id===getTodayDate())?.status||'Not Started' };

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center gap-4">
                            <div className="p-3 bg-blue-100 text-blue-600 rounded-lg"><i className="ph ph-calendar-check text-2xl"></i></div>
                            <div><p className="text-slate-500 text-sm font-medium">Total Rosters</p><h3 className="text-2xl font-bold text-slate-800">{stats.total}</h3></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center gap-4">
                            <div className={`p-3 rounded-lg ${stats.today==='Published'?'bg-emerald-100 text-emerald-600':'bg-amber-100 text-amber-600'}`}><i className="ph ph-clock text-2xl"></i></div>
                            <div><p className="text-slate-500 text-sm font-medium">Today's Status</p><h3 className="text-2xl font-bold text-slate-800">{stats.today}</h3></div>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i className="ph ph-clock-counter-clockwise text-blue-500"></i> Recent Activity</h3>
                        <div className="space-y-2 max-h-64 overflow-y-auto pr-2">
                            {history.slice(0,10).map(r=>(<div key={r.id} onClick={()=>{setSelectedDate(r.id);setView('roster');}} className="flex justify-between p-3 hover:bg-slate-50 rounded-lg cursor-pointer border-b border-slate-50 last:border-0"><div className="flex gap-3"><span className="text-slate-500 bg-slate-100 px-2 rounded font-mono">{r.id}</span><span className={`text-xs px-2 py-1 rounded-full font-medium ${r.status==='Published'?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-600'}`}>{r.status}</span></div><span className="text-xs text-slate-400">{r.updatedAt.toLocaleDateString()}</span></div>))}
                            {history.length===0 && <p className="text-center text-slate-400 py-4">No history found.</p>}
                        </div>
                    </div>
                </div>
            );
        }

        function ManagementReports() {
            const [month, setMonth] = useState(getTodayDate().substring(0, 7));
            const [data, setData] = useState(null);
            const { staffPool } = useContext(StaffContext);
            
            useEffect(() => {
                onSnapshot(collection(db, DAILY_ROSTER_COLLECTION), s => {
                    const docs = []; s.forEach(d => { if(d.id.startsWith(month)) docs.push({date:d.id, ...d.data()}); });
                    const counts = {}, headcount = {}, types = {sentry:0, patrol:0, admin:0, standby:0};
                    docs.forEach(day => {
                        const daySet = new Set();
                        Object.entries(day.rosterGrid||{}).forEach(([pos, cells]) => {
                            cells.forEach(c => {
                                if(c.value && c.value!==UNFILLED_SLOT) {
                                    counts[c.value] = (counts[c.value]||0)+1; daySet.add(c.value);
                                    if(pos.includes("PATROL")||pos.includes("PROWLER")) types.patrol++;
                                    else if(pos.includes("OE/ STANDBY")) types.standby++;
                                    else if(SECURITY_POSITIONS.includes(pos)) types.admin++;
                                    else types.sentry++;
                                }
                            });
                        });
                        headcount[day.date] = daySet.size;
                    });
                    setData({ counts, headcount, types, total: Object.values(counts).reduce((a,b)=>a+b,0) });
                });
            }, [month]);

            const stats = useMemo(() => {
                if(!data) return [];
                return Object.entries(data.counts).sort(([,a],[,b])=>b-a).map(([id,c]) => { const s=staffPool.find(x=>x.id===id); return { id, name:s?s.name:'Unknown', count:c }; });
            }, [data, staffPool]);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-slate-200">
                        <h2 className="text-xl font-bold text-slate-800 flex gap-2"><i className="ph ph-chart-bar text-purple-600"></i> Monthly Reports</h2>
                        <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="bg-slate-50 border-none rounded p-2" />
                    </div>
                    {data ? (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="bg-blue-600 text-white p-5 rounded-xl shadow-md">
                                    <p className="text-blue-100 text-sm">Total Shifts</p><h3 className="text-3xl font-bold">{data.total}</h3>
                                </div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border col-span-3">
                                    <p className="text-slate-500 text-sm mb-2">Duty Distribution</p>
                                    <div className="flex h-6 rounded-lg overflow-hidden w-full">
                                        {['sentry','patrol','admin','standby'].map((t,i) => <div key={t} style={{width:`${(data.types[t]/data.total)*100}%`}} className={['bg-blue-500','bg-emerald-500','bg-purple-500','bg-slate-400'][i]} title={t}></div>)}
                                    </div>
                                    <div className="flex gap-4 mt-2 text-xs text-slate-500 font-bold">
                                        {['Sentry','Patrol','Admin','Standby'].map((t,i)=><span key={t} className="flex items-center gap-1"><div className={['w-2 h-2 bg-blue-500','w-2 h-2 bg-emerald-500','w-2 h-2 bg-purple-500','w-2 h-2 bg-slate-400'][i]}></div> {t}</span>)}
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b font-bold text-slate-700">Top Staff Utilization</div>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full text-sm">
                                        <thead className="bg-slate-100 text-slate-500"><tr><th className="p-3 text-left">ID</th><th className="p-3 text-left">Name</th><th className="p-3 text-right">Hours</th><th className="p-3 w-1/3">Load</th></tr></thead>
                                        <tbody className="divide-y">{stats.slice(0,50).map(s=>(<tr key={s.id}><td className="p-3 font-mono">{s.id}</td><td className="p-3">{s.name}</td><td className="p-3 text-right">{s.count}</td><td className="p-3"><div className="w-full bg-slate-100 rounded-full h-2"><div className="bg-blue-600 h-2 rounded-full" style={{width:`${Math.min(100,(s.count/200)*100)}%`}}></div></div></td></tr>))}</tbody>
                                    </table>
                                </div>
                            </div>
                        </>
                    ) : <div className="text-center py-10">Loading Data...</div>}
                </div>
            );
        }

        // --- ORIGINAL ROSTER LOGIC (Integrated) ---
        function StaffAssignmentCard({ staff, isScheduled, scheduledSet, handleAttendanceToggle, handleRemoveStaff, staffTypeMap, sequenceMap, locationBufferMap, rosterMode, handleSequenceChange, handleUnassign, handleLocationBufferChange, availableAssignmentKeys }) {
            const { ALL_ASSIGNMENT_KEYS, OVERRIDE_LOCATIONS } = useContext(StaffContext);
            const [isExpanded, setIsExpanded] = useState(false);
            const assignedKeys = getStaffAssignments(staff.id, sequenceMap, ALL_ASSIGNMENT_KEYS);
            const assignedKey = assignedKeys[0] || "";
            const isAuto = rosterMode === ROSTER_MODES.AUTO_SEQUENCE;

            return (
                <div className={`p-3 rounded-lg shadow-sm border transition-all ${isScheduled ? 'staff-card-scheduled' : 'staff-card-unscheduled'}`}>
                    <div className="flex justify-between items-center mb-1">
                        <span className="font-bold text-lg text-slate-900">{staff.id}</span>
                        <button onClick={()=>setIsExpanded(!isExpanded)} className="text-slate-400 hover:text-blue-600"><i className={`ph ph-caret-${isExpanded?'up':'down'}`}></i></button>
                    </div>
                    {isExpanded && (
                        <div className="border-t border-slate-300 py-2 mt-1 mb-2 text-sm">
                            <p className="font-medium">{staff.name}</p>
                            <div className="flex justify-between mt-1"><span className="text-xs bg-blue-100 text-blue-800 px-2 rounded">{staff.type} - {staff.team_name}</span><button onClick={()=>handleRemoveStaff(staff)} className="text-xs text-red-600 hover:underline">Remove</button></div>
                        </div>
                    )}
                    <div className="flex justify-between items-center mt-1">
                        <span className={`text-xs font-bold ${isScheduled?'text-emerald-700':'text-red-700'}`}>{isScheduled?'SCHEDULED':'OFF'}</span>
                        <label className="toggle-switch"><input type="checkbox" checked={isScheduled} onChange={()=>handleAttendanceToggle(staff.id)}/><span className="slider"></span></label>
                    </div>
                    {isScheduled && (
                        <div className="mt-2 space-y-2">
                            <select value={assignedKey} onChange={e=>e.target.value===""?handleUnassign(staff.id):handleSequenceChange(e.target.value, staff.id)} className={`w-full p-1 border rounded text-xs font-bold ${assignedKey?'bg-blue-100 border-blue-300':'bg-slate-50'}`}>
                                <option value="">{assignedKey || (isAuto?"Rotation Key":"Location")}</option>
                                {availableAssignmentKeys.map(k=><option key={k} value={k}>{k}</option>)}
                            </select>
                            {staff.type==='buffer' && (
                                <select value={locationBufferMap[staff.id]||""} onChange={e=>handleLocationBufferChange(staff.id, e.target.value)} className="w-full p-1 border rounded text-xs bg-purple-50 text-purple-700 border-purple-200">
                                    <option value="">Override: {locationBufferMap[staff.id]||"None"}</option>
                                    {OVERRIDE_LOCATIONS.map(l=><option key={l} value={l}>{l}</option>)}
                                </select>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function ConsolidatedStaffManagement({ selectedDate, setSelectedDate }) {
            const { staffPool, dailyAttendance, staffTypeMap, loading, scheduledStaff, ALL_ASSIGNMENT_KEYS } = useContext(StaffContext);
            const [localAtt, setLocalAtt] = useState([]);
            const [status, setStatus] = useState("idle");
            const [rosterMode, setRosterMode] = useState(ROSTER_MODES.AUTO_SEQUENCE);
            const [sequenceMap, setSeqMap] = useState({});
            const [locBuffMap, setLocBuffMap] = useState({});
            const [newId, setNewId] = useState(""); const [newName, setNewName] = useState(""); const [newTeam, setNewTeam] = useState(""); const [newType, setNewType] = useState("permanent");
            const scheduledSet = useMemo(()=>new Set(localAtt), [localAtt]);

            useEffect(() => { setLocalAtt(dailyAttendance); setStatus("idle"); }, [dailyAttendance, selectedDate]);
            useEffect(() => {
                if(!selectedDate) return;
                const unsub = onSnapshot(getDocRef(DAILY_ASSIGNMENTS_COLLECTION, selectedDate), snap => {
                    if(snap.exists()) { const d=snap.data(); setRosterMode(d.rosterMode||ROSTER_MODES.AUTO_SEQUENCE); setSeqMap(d.sequenceMap||{}); setLocBuffMap(d.locationBufferMap||{}); }
                    else { setRosterMode(ROSTER_MODES.AUTO_SEQUENCE); setSeqMap({}); setLocBuffMap({}); }
                });
                return unsub;
            }, [selectedDate]);

            const handleAttToggle = (id) => { setStatus("unsaved"); setLocalAtt(p => p.includes(id) ? p.filter(x=>x!==id) : [...p, id].sort()); if(localAtt.includes(id)) handleUnassign(id); };
            const handleUnassign = (id) => { const m={...sequenceMap}; ALL_ASSIGNMENT_KEYS.forEach(k=>{if(m[k]) m[k]=m[k].filter(x=>x!==id);}); setSeqMap(m); setStatus("unsaved"); };
            const handleSeqChange = (key, id) => { const m={...sequenceMap}; ALL_ASSIGNMENT_KEYS.forEach(k=>{if(m[k] && staffTypeMap.get(id)!=='buffer') m[k]=m[k].filter(x=>x!==id);}); if(!m[key]) m[key]=[]; if(!m[key].includes(id)) m[key].push(id); setSeqMap(m); setStatus("unsaved"); };
            const handleLocBuffChange = (id, loc) => { const m={...locBuffMap}; if(loc) m[id]=loc; else delete m[id]; setLocBuffMap(m); setStatus("unsaved"); };

            const saveAll = async () => {
                setStatus("saving");
                await setDoc(getDocRef(DAILY_ATTENDANCE_COLLECTION, selectedDate), { scheduledStaff: localAtt, updatedAt: new Date().toISOString() });
                await setDoc(getDocRef(DAILY_ASSIGNMENTS_COLLECTION, selectedDate), { rosterMode, sequenceMap, locationBufferMap: locBuffMap, updatedAt: new Date().toISOString() });
                setStatus("saved"); setTimeout(()=>setStatus("idle"), 2000);
            };

            const addStaff = async () => { if(newId && newName && newTeam) { await setDoc(getDocRef(EMPLOYEES_COLLECTION, newId), { emp_id:newId, name:newName, team_id:newTeam, is_buffer:newType==='buffer', docId:newId }); setNewId(""); setNewName(""); } };

            const availKeys = rosterMode===ROSTER_MODES.AUTO_SEQUENCE ? SENTRY_SEQUENCE_KEYS : SENTRY_LOCATION_KEYS;
            const fullKeys = [...availKeys, ...FOYER_ASSIGNMENT_KEYS, ...SECURITY_ASSIGNMENT_KEYS];
            const filteredStaff = staffPool.filter(s=>scheduledSet.has(s.id)); // Simple view for now

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div className="flex flex-col md:flex-row justify-between mb-6 gap-4">
                        <h3 className="text-xl font-bold text-slate-800">Staff & Daily Setup</h3>
                        <div className="flex gap-2">
                            <button onClick={saveAll} disabled={status==='saving'} className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 shadow-md transition-colors">{status==='saving'?'Saving...':status==='saved'?'Saved!':'Save All Changes'}</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-1 space-y-4">
                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <h4 className="font-bold mb-2">1. Roster Mode</h4>
                                <div className="flex gap-2">
                                    <button onClick={()=>setRosterMode(ROSTER_MODES.AUTO_SEQUENCE)} className={`flex-1 py-2 text-sm rounded border ${rosterMode===ROSTER_MODES.AUTO_SEQUENCE?'bg-blue-100 border-blue-400 text-blue-800 font-bold':'bg-white'}`}>Auto-Sequence</button>
                                    <button onClick={()=>setRosterMode(ROSTER_MODES.MANUAL_LOCATION_FIXED)} className={`flex-1 py-2 text-sm rounded border ${rosterMode===ROSTER_MODES.MANUAL_LOCATION_FIXED?'bg-blue-100 border-blue-400 text-blue-800 font-bold':'bg-white'}`}>Fixed Loc</button>
                                </div>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <h4 className="font-bold mb-2">2. Add New Staff</h4>
                                <div className="space-y-2">
                                    <input placeholder="ID (e.g. 12345)" value={newId} onChange={e=>setNewId(e.target.value)} className="w-full p-2 border rounded"/>
                                    <input placeholder="Name" value={newName} onChange={e=>setNewName(e.target.value)} className="w-full p-2 border rounded"/>
                                    <input placeholder="Team ID" value={newTeam} onChange={e=>setNewTeam(e.target.value)} className="w-full p-2 border rounded"/>
                                    <select value={newType} onChange={e=>setNewType(e.target.value)} className="w-full p-2 border rounded"><option value="permanent">Permanent</option><option value="buffer">Buffer</option></select>
                                    <button onClick={addStaff} className="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Add to Pool</button>
                                </div>
                            </div>
                        </div>
                        <div className="lg:col-span-2">
                             <div className="flex justify-between items-center mb-2"><h4 className="font-bold">3. Staff Pool ({staffPool.length})</h4><span className="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">Scheduled: {localAtt.length}</span></div>
                             <div className="staff-pool-grid grid gap-3 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                                {staffPool.map(s => <StaffAssignmentCard key={s.id} staff={s} isScheduled={scheduledSet.has(s.id)} scheduledSet={scheduledSet} handleAttendanceToggle={handleAttToggle} handleRemoveStaff={()=>{}} staffTypeMap={staffTypeMap} sequenceMap={sequenceMap} locationBufferMap={locBuffMap} rosterMode={rosterMode} handleSequenceChange={handleSeqChange} handleUnassign={handleUnassign} handleLocationBufferChange={handleLocBuffChange} availableAssignmentKeys={fullKeys} />)}
                             </div>
                        </div>
                    </div>
                </div>
            );
        }

        function RosterView({ selectedDate }) {
            const { staffTypeMap, scheduledStaff } = useContext(StaffContext);
            const [data, setData] = useState(null);
            const [assignments, setAssignments] = useState(null);
            const [matrixMode, setMatrixMode] = useState(false);
            const [dirty, setDirty] = useState(false);

            useEffect(() => {
                if(!selectedDate) return;
                const u1=onSnapshot(getDocRef(DAILY_ASSIGNMENTS_COLLECTION, selectedDate), s=>setAssignments(s.exists()?s.data():null));
                const u2=onSnapshot(getDocRef(DAILY_ROSTER_COLLECTION, selectedDate), s=>setData(s.exists()?s.data().rosterGrid:null));
                return ()=>{u1();u2();};
            }, [selectedDate]);

            const generate = async () => {
                if(!assignments) return alert("Please save assignments first.");
                const grid = {};
                const { sequenceMap, locationBufferMap, rosterMode } = assignments;
                
                // Logic derived from original: Sentry Gen
                SENTRY_POSITIONS.forEach(pos => {
                    if(pos.includes("PROWLER")) return; // Skip prowler
                    const row = [];
                    const seq = (rosterMode===ROSTER_MODES.AUTO_SEQUENCE) ? SENTRY_POSITION_SEQUENCES[pos] : Array(12).fill(pos);
                    
                    if(seq) {
                        for(let i=0; i<12; i++) {
                            const key = seq[i%6] || seq[i]; // Handle manual vs auto array length
                            const ids = assignments.sequenceMap[key] || [];
                            const perm = ids.find(id=>staffTypeMap.get(id)!=='buffer') || UNFILLED_SLOT;
                            const buff = ids.find(id=>staffTypeMap.get(id)==='buffer');
                            row.push({ value: perm!==UNFILLED_SLOT?perm:(buff||UNFILLED_SLOT), permanent: perm, buffer: buff, isPair: !!(perm!==UNFILLED_SLOT && buff) });
                        }
                        grid[pos] = row;
                    }
                });

                // Simplified Logic for Demo: Apply overrides & Prowlers would go here in full implementation. 
                // We assume basic generation works for the portal proof.
                
                await setDoc(getDocRef(DAILY_ROSTER_COLLECTION, selectedDate), { rosterGrid: grid, updatedAt: new Date().toISOString() });
                setDirty(false);
            };

            const save = async () => { await setDoc(getDocRef(DAILY_ROSTER_COLLECTION, selectedDate), { rosterGrid: data, updatedAt: new Date().toISOString() }); setDirty(false); };
            const updateCell = (pos, i, val) => { const d={...data}; d[pos][i].value=val; setData(d); setDirty(true); };

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div className="flex justify-between items-center mb-4 no-print">
                        <h3 className="text-xl font-bold">Daily Roster Grid</h3>
                        <div className="flex gap-2">
                            <button onClick={()=>setMatrixMode(!matrixMode)} className={`px-4 py-2 rounded text-white ${matrixMode?'bg-red-500':'bg-blue-500'}`}>{matrixMode?'Exit Edit':'Edit Grid'}</button>
                            <button onClick={generate} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Generate/Reset</button>
                            {dirty && <button onClick={save} className="bg-purple-600 text-white px-4 py-2 rounded animate-pulse">Save Changes</button>}
                            <button onClick={()=>window.print()} className="bg-slate-600 text-white px-4 py-2 rounded">Print</button>
                        </div>
                    </div>
                    {data ? (
                        <div className="overflow-x-auto shadow rounded border">
                            <table className="min-w-full divide-y divide-slate-200">
                                <thead className="bg-slate-100">
                                    <tr><th className="p-2 text-left sticky left-0 bg-slate-100 z-10">Location</th>{TIME_SLOTS.map(t=><th key={t} className="p-2 text-center text-xs">{t}</th>)}</tr>
                                </thead>
                                <tbody className={`bg-white divide-y ${matrixMode?'matrix-edit-active':''}`}>
                                    {Object.keys(data).sort().map(pos => (
                                        <tr key={pos}>
                                            <td className="p-2 text-sm font-bold bg-slate-50 sticky left-0 z-10 border-r">{pos}</td>
                                            {data[pos].map((c,i)=>(
                                                <td key={i} className="p-0 border-r min-w-[60px]">
                                                    {matrixMode ? (
                                                        <select value={c.value} onChange={e=>updateCell(pos,i,e.target.value)} className="w-full text-xs p-1 h-full"><option value="">-</option>{scheduledStaff.map(s=><option key={s.id} value={s.id}>{s.id}</option>)}</select>
                                                    ) : (
                                                        <div className={`text-xs py-2 text-center ${c.isPair?'dropdown-permanent':''} ${c.value===UNFILLED_SLOT?'bg-yellow-100':''}`}>{c.value}</div>
                                                    )}
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : <div className="text-center py-10 bg-slate-50 text-slate-400">No roster generated yet. Click Generate.</div>}
                </div>
            );
        }

        // --- APP LAYOUT ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [selectedDate, setSelectedDate] = useState(getTodayDate());
            const [user, setUser] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            useEffect(() => onAuthStateChanged(auth, u => { if(u) setUser(u); else signInAnonymously(auth); }), []);

            if(!user) return <div className="h-screen flex items-center justify-center bg-slate-100 text-slate-400">Connecting to APO Portal...</div>;

            const NavItem = ({id, label, icon}) => (
                <button onClick={()=>{setView(id);setSidebarOpen(false);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all mb-1 ${view===id?'bg-blue-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                    <i className={`ph ${icon} text-xl`}></i><span className="font-medium">{label}</span>
                </button>
            );

            return (
                <StaffProvider selectedDate={selectedDate}>
                    <div className="flex min-h-screen relative bg-slate-100">
                        <aside className={`sidebar fixed inset-y-0 left-0 bg-[#0f172a] text-white z-40 transform ${sidebarOpen?'translate-x-0':'-translate-x-full'} lg:translate-x-0 flex flex-col`}>
                            <div className="p-6 border-b border-slate-800"><h1 className="text-xl font-bold flex gap-2"><i className="ph ph-shield-check text-blue-500"></i> APO Portal</h1></div>
                            <nav className="p-4 flex-1 overflow-y-auto">
                                <p className="text-xs font-bold text-slate-500 uppercase px-4 mb-2 mt-2">Overview</p>
                                <NavItem id="dashboard" label="Dashboard" icon="ph-squares-four"/>
                                <NavItem id="reports" label="Reports" icon="ph-chart-bar"/>
                                <p className="text-xs font-bold text-slate-500 uppercase px-4 mb-2 mt-6">Operations</p>
                                <NavItem id="roster" label="Daily Roster" icon="ph-table"/>
                                <NavItem id="settings" label="Staff & Setup" icon="ph-users-three"/>
                            </nav>
                            <div className="p-4 border-t border-slate-800 bg-[#0b1120] text-xs text-slate-500 flex justify-between"><span>User: {user.uid.slice(0,4)}</span><span>v2.0</span></div>
                        </aside>
                        {sidebarOpen && <div className="fixed inset-0 sidebar-overlay z-30 lg:hidden" onClick={()=>setSidebarOpen(false)}></div>}
                        <main className="content-area flex-1 flex flex-col min-h-screen">
                            <header className="bg-white/80 backdrop-blur border-b h-16 flex items-center justify-between px-6 sticky top-0 z-20 no-print">
                                <div className="flex items-center gap-4"><button onClick={()=>setSidebarOpen(true)} className="lg:hidden text-2xl"><i className="ph ph-list"></i></button><h2 className="text-lg font-bold capitalize text-slate-700">{view.replace('-',' ')}</h2></div>
                                {(view==='roster'||view==='settings') && <div className="flex items-center border rounded px-3 py-1 bg-white"><i className="ph ph-calendar text-slate-400 mr-2"></i><input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="outline-none text-sm"/></div>}
                            </header>
                            <div className="p-6 flex-1 overflow-x-hidden">
                                {view==='dashboard' && <DashboardHome setView={setView} setSelectedDate={setSelectedDate}/>}
                                {view==='reports' && <ManagementReports/>}
                                {view==='roster' && <RosterView selectedDate={selectedDate}/>}
                                {view==='settings' && <ConsolidatedStaffManagement selectedDate={selectedDate} setSelectedDate={setSelectedDate}/>}
                            </div>
                        </main>
                    </div>
                </StaffProvider>
            );
        }
    </script>
</body>
</html>

