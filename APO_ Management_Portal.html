<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APO Management Portal v3.4</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 4. Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- 5. Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, where, getDocs, orderBy, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const mockFirebaseConfig = {
          apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
          authDomain: "roster-4a997.firebaseapp.com",
          projectId: "roster-4a997",
          storageBucket: "roster-4a997.firebasestorage.app",
          messagingSenderId: "901381868881",
          appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : mockFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.firebase = { db, auth, appId, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, signInAnonymously, onAuthStateChanged, signInWithCustomToken };
        
        function tryRenderApp() {
            if (window.firebase && window.firebase.db && window.firebase.auth && window.React && window.ReactDOM) {
                try {
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(React.createElement(App));
                } catch (e) {
                    console.error("React Mount Error:", e);
                    document.body.innerHTML = `<div style="color:red; padding:20px;">Error mounting app: ${e.message}</div>`;
                }
            } else { 
                setTimeout(tryRenderApp, 100); 
            }
        }
        window.onload = tryRenderApp;
    </script>

    <style>
        body { background-color: #f8fafc; color: #334155; }
        .sidebar { transition: transform 0.3s ease-in-out; width: 260px; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Roster Grid Styles */
        .roster-grid-table th:first-child, .roster-grid-table td:first-child { position: sticky; left: 0; z-index: 20; width: 180px; min-width: 180px; max-width: 180px; background-color: #f8fafc; border-right: 2px solid #e2e8f0; font-size: 0.75rem; font-weight: 600; text-align: left; padding-left: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .roster-grid-table th:first-child { background-color: #f1f5f9; z-index: 30; }
        .roster-grid-table th { background-color: #f1f5f9; position: sticky; top: 0; z-index: 10; font-size: 0.7rem; text-transform: uppercase; color: #64748b; padding: 0.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; }
        .roster-grid-table td { border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; padding: 0; height: 36px; width: 60px; text-align: center; vertical-align: middle; }
        .cell-content { font-size: 0.75rem; font-weight: 500; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; }
        .cell-permanent { background-color: #ffffff; color: #334155; }
        .cell-pair { background-image: linear-gradient(45deg, #eff6ff 50%, #dbeafe 50%); color: #1e40af; font-weight: 700; background-size: 10px 10px; }
        .cell-buffer { background-color: #fce7f3; color: #9d174d; font-weight: 700; border: 1px solid #fbcfe8; }
        .cell-empty { background-color: #fefce8; color: #ca8a04; }
        .cell-missing { background-color: #fee2e2; color: #b91c1c; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); border-radius: 0.75rem; }

        @media print {
            .sidebar, .sidebar-overlay, .no-print, header { display: none !important; }
            .content-area { margin-left: 0 !important; padding: 0 !important; }
            body { background: white; }
            .roster-grid-table th:first-child, .roster-grid-table td:first-child { border-right: 1px solid #999; width: 150px; min-width: 150px; max-width: 150px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useContext, createContext } = React;
        const { db, auth, appId, collection, onSnapshot, signInAnonymously, onAuthStateChanged, doc, getDoc, query, where, getDocs, orderBy } = window.firebase;

        // --- CONSTANTS ---
        const COLLECTIONS = {
            TEAMS: `teams`, 
            EMPLOYEES: `employees`, 
            ROSTERS: `dailyRosters_v7`,
            ATTENDANCE: `dailyAttendance_v7`
        };

        const POSITIONS = {
            SECURITY: ["TEAM LEADER (I/C)", "SECTION I/C"],
            FOYER: ["XRAY-VISITOR", "FOYER-OE"],
            PROWLER: ["VERTICAL PROWLER"],
            SENTRY: ["E1", "PATROL 1", "E3", "N1 (CNB)", "PATROL 2", "OE/ STANDBY", "PERIMETER PROWLER (1st Half)", "PERIMETER PROWLER (2nd Half)"]
        };
        
        const TIME_SLOTS = ["2000Hrs", "2100Hrs", "2200Hrs", "2300Hrs", "2400Hrs", "0100Hrs", "0200Hrs", "0300Hrs", "0400Hrs", "0500Hrs", "0600Hrs", "0700Hrs"];
        const VP_SLOTS = ["20:30", "23:00", "00:30", "03:00", "04:30", "06:30"];

        // --- HELPERS ---
        const getCollectionRef = (name) => {
            if (name === COLLECTIONS.TEAMS || name === COLLECTIONS.EMPLOYEES) {
                if (appId === 'default-app-id' || typeof appId === 'undefined') {
                    return collection(db, name); 
                }
                return collection(db, `artifacts/${appId}/public/data/${name}`);
            }
            return collection(db, name);
        };

        const cleanStaffId = (id) => {
            if (!id || typeof id !== 'string') return '';
            const trimmedId = id.trim();
            if (trimmedId.length > 1 && (trimmedId.startsWith('T') || trimmedId.startsWith('t'))) {
                return trimmedId.substring(1);
            }
            return trimmedId;
        };

        const extractName = (fullName) => {
            if (!fullName || typeof fullName !== 'string') return '';
            const match = fullName.match(/\((.*?)\)\s*(.*)/);
            if (match && match[2]) return match[2].trim();
            return fullName.trim();
        };

        const getToday = () => {
            const now = new Date();
            const offset = now.getTimezoneOffset();
            return new Date(now.getTime() - (offset*60*1000)).toISOString().split('T')[0];
        };
        const getMonthStr = (date = new Date()) => {
            const offset = date.getTimezoneOffset();
            return new Date(date.getTime() - (offset*60*1000)).toISOString().slice(0, 7);
        };

        // --- DATA CONTEXT ---
        const DataContext = createContext();

        function DataProvider({ children }) {
            const [staff, setStaff] = useState([]);
            const [teams, setTeams] = useState([]);
            const [staffTypeMap, setStaffTypeMap] = useState(new Map());
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubEmp = onSnapshot(getCollectionRef(COLLECTIONS.EMPLOYEES), snap => {
                    const data = snap.docs.map(d => {
                        const raw = d.data();
                        const rawId = raw.emp_id || raw.id || d.id;
                        return {
                            docId: d.id,
                            ...raw,
                            emp_id: cleanStaffId(String(rawId)), 
                            name: extractName(raw.name || String(rawId))
                        };
                    });
                    setStaff(data.sort((a,b) => a.name.localeCompare(b.name)));
                    const map = new Map();
                    data.forEach(s => { map.set(s.emp_id, s.is_buffer ? 'buffer' : 'permanent'); });
                    setStaffTypeMap(map);
                });
                const unsubTeam = onSnapshot(getCollectionRef(COLLECTIONS.TEAMS), snap => {
                    setTeams(snap.docs.map(d => ({ docId: d.id, ...d.data() })));
                });
                setTimeout(() => setLoading(false), 800);
                return () => { unsubEmp(); unsubTeam(); };
            }, []);

            return (
                <DataContext.Provider value={{ staff, teams, staffTypeMap, loading }}>
                    {children}
                </DataContext.Provider>
            );
        }

        // --- COMPONENTS ---

        function Sidebar({ view, setView, isOpen, setIsOpen }) {
            const NavItem = ({ id, icon, label }) => (
                <button 
                    onClick={() => { setView(id); setIsOpen(false); }}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all mb-1 font-medium text-sm ${view === id ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
                >
                    <i className={`ph ${icon} text-lg`}></i>{label}
                </button>
            );
            return (
                <>
                    {isOpen && <div className="fixed inset-0 bg-black/50 z-20 lg:hidden sidebar-overlay" onClick={() => setIsOpen(false)}></div>}
                    <div className={`sidebar fixed inset-y-0 left-0 bg-slate-900 text-white p-4 flex flex-col z-30 shadow-xl border-r border-slate-800 transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 lg:static`}>
                        <div className="mb-8 flex items-center gap-3 px-2 mt-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-600/30"><i className="ph ph-shield-check text-lg text-white"></i></div>
                            <div><h1 className="font-bold text-base leading-none tracking-tight">Management</h1><p className="text-[10px] text-slate-500 font-mono mt-1">PORTAL v3.4</p></div>
                            <button onClick={()=>setIsOpen(false)} className="lg:hidden ml-auto text-slate-400"><i className="ph ph-x text-xl"></i></button>
                        </div>
                        <nav className="flex-1 space-y-6 overflow-y-auto">
                            <div><p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 px-3">Overview</p><NavItem id="dashboard" icon="ph-squares-four" label="Dashboard" /><NavItem id="history" icon="ph-calendar-blank" label="Roster History" /></div>
                            <div><p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 px-3">Analytics</p><NavItem id="fairness" icon="ph-scales" label="Workload Balance" /><NavItem id="location" icon="ph-map-pin" label="Location Scorecard" /><NavItem id="profiler" icon="ph-users-three" label="Staff Profiler" /></div>
                        </nav>
                        <div className="mt-auto pt-6 border-t border-slate-800"><div className="flex items-center gap-2 opacity-60 px-2"><i className="ph ph-lock-key text-xs"></i><span className="text-[10px] font-mono">SECURE ADMIN</span></div></div>
                    </div>
                </>
            );
        }

        function RosterGridRenderer({ data, staffTypeMap }) {
            if (!data) return <div className="p-10 flex flex-col items-center justify-center text-slate-400 h-full"><i className="ph ph-calendar-x text-4xl mb-4 opacity-50"></i><p>No roster data available for this date.</p></div>;
            const manualStandbyRows = Object.keys(data).filter(key => key.startsWith("OE/ STANDBY-")).sort((a,b) => parseInt(a.split('-')[1]||0) - parseInt(b.split('-')[1]||0));
            const renderCell = (cell) => {
                if (!cell) return <td className="cell-missing">?</td>;
                const val = cell.value;
                const type = staffTypeMap.get(val);
                let className = "cell-content ";
                if (!val || val === "---") className += "cell-empty";
                else if (type === 'buffer') className += "cell-buffer";
                else if (cell.isPair) className += "cell-pair";
                else className += "cell-permanent";
                return <td><div className={className} title={val !== "---" ? `Staff: ${val}` : "Empty"}>{val}</div></td>;
            };
            const RenderTableSection = ({ title, rows, slots }) => (
                <div className="mb-6 border border-slate-200 rounded-lg overflow-hidden shadow-sm bg-white break-inside-avoid">
                    <div className="bg-slate-50 px-4 py-2 border-b border-slate-200 font-bold text-xs text-slate-600 uppercase tracking-wider">{title}</div>
                    <div className="overflow-x-auto"><table className="roster-grid-table w-full border-collapse"><thead><tr><th>Location</th>{slots.map(t => <th key={t}>{t}</th>)}</tr></thead><tbody>{rows.map(pos => (<tr key={pos}><td>{pos.replace("OE/ STANDBY", "OE").replace("PERIMETER PROWLER", "PROWLER")}</td>{slots.map((t, i) => { const cell = (data[pos] && data[pos][i]) ? data[pos][i] : { value: "---" }; return renderCell(cell); })}</tr>))}</tbody></table></div>
                </div>
            );
            return <div className="space-y-6 animate-fade-in-up"><RenderTableSection title="Security Control" rows={POSITIONS.SECURITY} slots={TIME_SLOTS} /><RenderTableSection title="Foyer Deployment" rows={POSITIONS.FOYER} slots={TIME_SLOTS} /><RenderTableSection title="Vertical Prowler" rows={POSITIONS.PROWLER} slots={VP_SLOTS} /><RenderTableSection title="Sentry & Patrol" rows={[...POSITIONS.SENTRY, ...manualStandbyRows]} slots={TIME_SLOTS} /></div>;
        }

        function FullCalendar({ markedDates, onSelectDate }) {
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const year = currentMonth.getFullYear(); const month = currentMonth.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfWeek = new Date(year, month, 1).getDay();
            const prevMonth = () => setCurrentMonth(new Date(year, month - 1, 1));
            const nextMonth = () => setCurrentMonth(new Date(year, month + 1, 1));
            const jumpToday = () => setCurrentMonth(new Date());
            const todayStr = getToday();
            const days = [];
            for (let i = 0; i < firstDayOfWeek; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) { days.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`); }
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            return (
                <div className="flex flex-col h-full bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50"><div className="flex items-center gap-4"><h2 className="text-xl font-bold text-slate-800">{monthNames[month]} {year}</h2><div className="flex gap-1"><button onClick={prevMonth} className="p-1.5 hover:bg-slate-200 rounded-lg text-slate-600 transition-colors"><i className="ph ph-caret-left text-lg"></i></button><button onClick={nextMonth} className="p-1.5 hover:bg-slate-200 rounded-lg text-slate-600 transition-colors"><i className="ph ph-caret-right text-lg"></i></button></div></div><button onClick={jumpToday} className="text-sm font-medium text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-200 transition-colors">Today</button></div>
                    <div className="grid grid-cols-7 border-b border-slate-100 bg-slate-50/50">{['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (<div key={d} className="py-2 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">{d}</div>))}</div>
                    <div className="grid grid-cols-7 grid-rows-5 flex-1 auto-rows-fr bg-slate-100 gap-px border-b border-slate-200">
                        {days.map((dateStr, idx) => {
                            if (!dateStr) return <div key={`empty-${idx}`} className="bg-white min-h-[80px]"></div>;
                            const isToday = dateStr === todayStr; const hasRoster = markedDates.has(dateStr);
                            return (
                                <div key={dateStr} onClick={() => onSelectDate(dateStr)} className={`bg-white min-h-[80px] p-2 relative cursor-pointer hover:bg-blue-50 transition-colors group flex flex-col items-start`}><span className={`text-sm font-medium w-7 h-7 flex items-center justify-center rounded-full mb-1 ${isToday ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 group-hover:text-blue-600'}`}>{parseInt(dateStr.split('-')[2])}</span>{hasRoster && (<div className="mt-1 w-full flex justify-center"><span className="inline-flex items-center justify-center gap-1.5 px-2 py-1 rounded-md bg-emerald-100 text-emerald-700 text-[10px] font-bold w-auto border border-emerald-200 shadow-sm whitespace-nowrap overflow-hidden"><span className="w-1.5 h-1.5 rounded-full bg-emerald-500 shrink-0"></span><span className="hidden sm:inline">Published</span><span className="sm:hidden">Pub</span></span></div>)}{!hasRoster && isToday && (<div className="mt-1 w-full opacity-0 group-hover:opacity-100 transition-opacity"><span className="inline-flex items-center justify-center px-2 py-1 rounded-md border border-dashed border-slate-300 text-slate-400 text-[10px] w-full">+</span></div>)}</div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function RosterHistoryView() {
            const { staffTypeMap } = useContext(DataContext);
            const [history, setHistory] = useState(new Set());
            const [rosterDataMap, setRosterDataMap] = useState({});
            const [viewMode, setViewMode] = useState('calendar');
            const [selectedDate, setSelectedDate] = useState(null);
            const [loadingList, setLoadingList] = useState(true);
            useEffect(() => {
                const q = query(collection(db, COLLECTIONS.ROSTERS)); 
                const unsub = onSnapshot(q, snap => {
                    const dates = new Set(); const map = {};
                    snap.forEach(d => { if (d.data().rosterGrid && Object.keys(d.data().rosterGrid).length > 0) { dates.add(d.id); map[d.id] = d.data().rosterGrid; } });
                    setHistory(dates); setRosterDataMap(map); setLoadingList(false);
                });
                return unsub;
            }, []);
            const handleDateSelect = (dateStr) => { setSelectedDate(dateStr); setViewMode('detail'); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const handleBackToCalendar = () => { setViewMode('calendar'); setSelectedDate(null); };
            if (loadingList) return <div className="p-20 text-center text-slate-400 animate-pulse">Loading Roster Calendar...</div>;
            return (
                <div className="h-full flex flex-col">
                    {viewMode === 'calendar' ? (
                        <div className="h-full flex flex-col animate-fade-in-up"><div className="mb-4 flex items-center justify-between"><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><i className="ph ph-calendar text-blue-600"></i> Roster Calendar</h2><div className="text-sm text-slate-500 flex gap-4"><span className="flex items-center gap-1.5"><span className="w-2 h-2 rounded-full bg-emerald-500"></span> Published</span><span className="flex items-center gap-1.5"><span className="w-2 h-2 rounded-full bg-white border border-slate-300"></span> Empty</span></div></div><div className="flex-1 min-h-[600px]"><FullCalendar markedDates={history} onSelectDate={handleDateSelect} /></div></div>
                    ) : (
                        <div className="h-full flex flex-col animate-fade-in-up"><div className="mb-4 flex items-center gap-4 sticky top-0 z-20 bg-slate-50/95 backdrop-blur py-2 border-b border-slate-200 no-print"><button onClick={handleBackToCalendar} className="flex items-center gap-2 text-slate-600 hover:text-blue-600 font-medium px-3 py-2 rounded-lg hover:bg-white transition-colors"><i className="ph ph-arrow-left text-lg"></i> Back to Calendar</button><div className="h-6 w-px bg-slate-300"></div><h2 className="text-xl font-bold text-slate-800">Roster: <span className="font-mono text-blue-600">{selectedDate}</span></h2><div className="ml-auto"><button onClick={() => window.print()} className="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-4 py-2 rounded-lg font-medium shadow-sm flex items-center gap-2"><i className="ph ph-printer"></i> Print</button></div></div><div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex-1 overflow-auto"><RosterGridRenderer data={rosterDataMap[selectedDate]} staffTypeMap={staffTypeMap} /></div></div>
                    )}
                </div>
            );
        }

        // 5. Staff Profile (Updated Layout)
        function StaffProfileView() {
            const { staff } = useContext(DataContext);
            const [month, setMonth] = useState(getMonthStr());
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedStaffIds, setSelectedStaffIds] = useState(new Set());
            const [profileData, setProfileData] = useState({});
            const [processing, setProcessing] = useState(false);

            const filteredStaffList = useMemo(() => {
                const term = searchTerm.toLowerCase();
                return staff.filter(s => (s.name?.toLowerCase().includes(term) || s.emp_id?.toLowerCase().includes(term) || s.docId?.toLowerCase().includes(term)));
            }, [staff, searchTerm]);

            const toggleStaff = (id) => { const newSet = new Set(selectedStaffIds); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedStaffIds(newSet); };

            useEffect(() => {
                if (selectedStaffIds.size === 0) { setProfileData({}); return; }
                setProcessing(true);
                const q = query(collection(db, COLLECTIONS.ROSTERS));
                onSnapshot(q, snap => {
                    const allStats = {};
                    selectedStaffIds.forEach(id => { allStats[id] = { locationCounts: {}, totalShifts: 0, uniqueLocations: new Set(), dutyTypeCounts: { sentry: 0, patrol: 0, admin: 0, foyer: 0 }, badges: [], sortedLocs: [] }; });
                    snap.forEach(d => {
                        if (d.id.startsWith(month) && d.data().rosterGrid) {
                            const grid = d.data().rosterGrid; const workedToday = new Set();
                            Object.entries(grid).forEach(([pos, slots]) => {
                                slots.forEach(slot => {
                                    if (selectedStaffIds.has(slot.value)) {
                                        const stats = allStats[slot.value]; const locName = pos.replace("OE/ STANDBY", "OE").replace("PERIMETER PROWLER", "PROWLER");
                                        stats.locationCounts[locName] = (stats.locationCounts[locName] || 0) + 1; stats.uniqueLocations.add(locName); workedToday.add(slot.value);
                                        if (pos.includes("PATROL") || pos.includes("PROWLER")) stats.dutyTypeCounts.patrol++; else if (pos.includes("FOYER") || pos.includes("XRAY")) stats.dutyTypeCounts.foyer++; else if (POSITIONS.SECURITY.includes(pos)) stats.dutyTypeCounts.admin++; else stats.dutyTypeCounts.sentry++;
                                    }
                                });
                            });
                            workedToday.forEach(id => allStats[id].totalShifts++);
                        }
                    });
                    Object.keys(allStats).forEach(id => {
                        const s = allStats[id]; s.totalSlots = Object.values(s.dutyTypeCounts).reduce((a,b) => a+b, 0);
                        s.sortedLocs = Object.entries(s.locationCounts).sort(([,a], [,b]) => b - a).map(([name, count]) => ({ name, count, pct: s.totalSlots > 0 ? Math.round((count / s.totalSlots) * 100) : 0 }));
                        if (s.totalSlots > 0) {
                            if (s.dutyTypeCounts.patrol / s.totalSlots > 0.4) s.badges.push({ l: "Patrol Specialist", c: "bg-orange-100 text-orange-800" });
                            if (s.dutyTypeCounts.foyer / s.totalSlots > 0.4) s.badges.push({ l: "Foyer Expert", c: "bg-green-100 text-green-800" });
                            if (s.uniqueLocations.size > 4) s.badges.push({ l: "All-Rounder", c: "bg-purple-100 text-purple-800" });
                            if (s.totalShifts > 20) s.badges.push({ l: "High Availability", c: "bg-blue-100 text-blue-800" });
                        }
                    });
                    setProfileData(allStats); setProcessing(false);
                });
            }, [selectedStaffIds, month]);

            return (
                <div className="flex flex-col lg:flex-row h-full gap-6 animate-fade-in-up">
                    <div className="w-full lg:w-96 flex flex-col glass-panel overflow-hidden shrink-0 h-[400px] lg:h-auto">
                        <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3"><h3 className="font-bold text-slate-700 flex justify-between items-center"><span>Staff Directory</span><span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">{selectedStaffIds.size} Selected</span></h3><div className="relative"><i className="ph ph-magnifying-glass absolute left-2.5 top-2.5 text-slate-400"></i><input type="text" placeholder="Search ID or Name" className="w-full pl-9 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="w-full border p-2 rounded text-sm bg-white"/></div>
                        
                        {/* Improved Grid Layout for Staff List */}
                        <div className="flex-1 overflow-y-auto p-2">
                            {filteredStaffList.length === 0 ? (
                                <div className="text-center p-4 text-xs text-slate-400">No staff found.</div>
                            ) : (
                                <div className="grid grid-cols-2 gap-2">
                                    {filteredStaffList.map(s => {
                                        const isSelected = selectedStaffIds.has(s.emp_id || s.docId);
                                        return (
                                            <button
                                                key={s.docId}
                                                onClick={() => toggleStaff(s.emp_id || s.docId)}
                                                className={`text-left p-2 rounded-lg border transition-all flex flex-col ${
                                                    isSelected 
                                                    ? 'bg-blue-50 border-blue-400 shadow-sm ring-1 ring-blue-300' 
                                                    : 'bg-white border-slate-200 hover:border-slate-300 hover:bg-slate-50'
                                                }`}
                                            >
                                                <div className="flex justify-between items-start w-full">
                                                    <span className={`text-xs font-bold ${isSelected ? 'text-blue-700' : 'text-slate-700'}`}>
                                                        {s.emp_id}
                                                    </span>
                                                    {isSelected && <i className="ph ph-check-circle text-blue-600 text-sm"></i>}
                                                </div>
                                                <span className="text-[10px] text-slate-500 truncate w-full mt-1">
                                                    {s.name}
                                                </span>
                                            </button>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto min-h-[500px]">
                        {selectedStaffIds.size === 0 ? <div className="h-full flex flex-col items-center justify-center bg-white rounded-xl border border-dashed border-slate-300 text-slate-400 p-10"><i className="ph ph-users-three text-5xl mb-4 opacity-50"></i><p className="text-lg font-medium">Select staff from the list to analyze workload.</p><p className="text-sm">Select multiple to compare.</p></div> : selectedStaffIds.size === 1 ? (() => { const id = Array.from(selectedStaffIds)[0]; const sStats = profileData[id]; const sInfo = staff.find(st => st.emp_id === id || st.docId === id); if (!sStats) return <div className="text-center p-10">Loading...</div>; return (<div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in-up"><div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><div className="text-center mb-6"><div className="w-16 h-16 bg-slate-100 rounded-full mx-auto flex items-center justify-center text-xl font-bold text-slate-600 mb-2 border-2 border-white shadow">{id.slice(0, 2)}</div><h3 className="font-bold text-xl text-slate-800">{sInfo?.name || id}</h3><p className="text-slate-500 font-mono text-sm">{id}</p><div className="flex flex-wrap justify-center gap-2 mt-3">{sStats.badges.map((b, i) => <span key={i} className={`px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${b.c}`}>{b.l}</span>)}</div></div><div className="grid grid-cols-2 gap-4 mb-6"><div className="bg-blue-50 p-4 rounded-xl text-center"><div className="text-2xl font-bold text-blue-700">{sStats.totalShifts}</div><div className="text-[10px] text-blue-600 uppercase font-bold tracking-wider">Total Shifts</div></div><div className="bg-purple-50 p-4 rounded-xl text-center"><div className="text-2xl font-bold text-purple-700">{sStats.uniqueLocations.size}</div><div className="text-[10px] text-purple-600 uppercase font-bold tracking-wider">Unique Posts</div></div></div><div className="space-y-3"><h4 className="font-bold text-xs text-slate-400 uppercase tracking-wide">Role Split</h4>{[{ l: 'Sentry', v: sStats.dutyTypeCounts.sentry, c: 'bg-blue-500' }, { l: 'Patrol', v: sStats.dutyTypeCounts.patrol, c: 'bg-orange-500' }, { l: 'Foyer', v: sStats.dutyTypeCounts.foyer, c: 'bg-green-500' }, { l: 'Admin', v: sStats.dutyTypeCounts.admin, c: 'bg-purple-500' }].map(d => { const pct = sStats.totalSlots ? (d.v / sStats.totalSlots) * 100 : 0; return (<div key={d.l}><div className="flex justify-between text-xs mb-1"><span>{d.l}</span><span className="font-bold">{Math.round(pct)}%</span></div><div className="w-full bg-slate-100 rounded-full h-1.5"><div className={`h-1.5 rounded-full ${d.c}`} style={{width: `${pct}%`}}></div></div></div>) })}</div></div><div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col"><div className="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700">Location Frequency</div><div className="p-4 overflow-y-auto flex-1">{sStats.sortedLocs.length === 0 ? <div className="text-center p-10 text-slate-400">No data.</div> : (<div className="space-y-4">{sStats.sortedLocs.map((loc, i) => (<div key={loc.name} className="flex items-center gap-3"><div className="w-6 text-right text-slate-400 font-mono text-xs">#{i+1}</div><div className="flex-1"><div className="flex justify-between mb-1"><span className="font-bold text-slate-700 text-xs">{loc.name}</span><span className="text-[10px] text-slate-500">{loc.count} Slots</span></div><div className="w-full bg-slate-100 rounded-r-full h-6 relative overflow-hidden"><div className={`h-full flex items-center pl-2 text-[10px] font-bold text-white ${loc.name.includes('PATROL')?'bg-orange-400':'bg-blue-500'}`} style={{width: `${Math.max(loc.pct, 5)}%`}}>{loc.pct}%</div></div></div></div>))}</div>)}</div></div></div>); })() : (<div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in-up"><div className="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h3 className="font-bold text-slate-700 text-lg">Comparison Matrix ({selectedStaffIds.size})</h3><button onClick={()=>setSelectedStaffIds(new Set())} className="text-xs text-red-600 hover:text-red-800 font-medium">Clear All</button></div><div className="overflow-x-auto"><table className="min-w-full text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-4 text-left">Staff Member</th><th className="p-4 text-center">Total Shifts</th><th className="p-4 w-1/3">Role Distribution</th><th className="p-4 text-left">Top Location</th></tr></thead><tbody className="divide-y divide-slate-100">{Array.from(selectedStaffIds).map(id => { const sStats = profileData[id]; const sInfo = staff.find(st => st.emp_id === id || st.docId === id); if (!sStats) return null; const patrolPct = sStats.totalSlots ? (sStats.dutyTypeCounts.patrol / sStats.totalSlots) * 100 : 0; const sentryPct = sStats.totalSlots ? (sStats.dutyTypeCounts.sentry / sStats.totalSlots) * 100 : 0; return (<tr key={id} className="hover:bg-slate-50"><td className="p-4"><div className="font-bold text-slate-800">{sInfo?.name || id}</div><div className="text-xs text-slate-400 font-mono">{id}</div></td><td className="p-4 text-center"><span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold">{sStats.totalShifts}</span></td><td className="p-4"><div className="flex items-center gap-1 text-[10px] font-bold text-white text-center h-4 rounded-full overflow-hidden"><div className="bg-orange-400 h-full" style={{width: `${patrolPct}%`}} title={`Patrol: ${Math.round(patrolPct)}%`}></div><div className="bg-blue-500 h-full" style={{width: `${sentryPct}%`}} title={`Sentry: ${Math.round(sentryPct)}%`}></div><div className="bg-green-500 h-full flex-1" title="Other"></div></div><div className="flex justify-between text-[10px] text-slate-400 mt-1"><span>Patrol {Math.round(patrolPct)}%</span><span>Static {Math.round(sentryPct)}%</span></div></td><td className="p-4 text-xs font-medium text-slate-600">{sStats.sortedLocs[0] ? (<span className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-emerald-500"></span>{sStats.sortedLocs[0].name} ({sStats.sortedLocs[0].pct}%)</span>) : <span className="text-slate-300">--</span>}</td></tr>); })}</tbody></table></div></div>)}
                    </div>
                </div>
            );
        }

        // 6. Location Scorecard
        function LocationScorecardView() {
            const { staffTypeMap } = useContext(DataContext);
            const [month, setMonth] = useState(getMonthStr());
            const [locationStats, setLocationStats] = useState([]);
            const [processing, setProcessing] = useState(false);
            useEffect(() => {
                setProcessing(true);
                const q = query(collection(db, COLLECTIONS.ROSTERS));
                onSnapshot(q, snap => {
                    const stats = {};
                    snap.forEach(d => {
                        if (d.id.startsWith(month) && d.data().rosterGrid) {
                            const grid = d.data().rosterGrid;
                            Object.entries(grid).forEach(([pos, slots]) => {
                                if (!stats[pos]) { stats[pos] = { name: pos.replace("OE/ STANDBY", "OE").replace("PERIMETER PROWLER", "PROWLER"), totalSlots: 0, filledSlots: 0, uniqueStaff: new Set() }; }
                                slots.forEach(slot => { stats[pos].totalSlots++; const id = slot.value; if (id && id !== "---" && id !== "") { stats[pos].filledSlots++; stats[pos].uniqueStaff.add(id); } });
                            });
                        }
                    });
                    const EXCLUDED_LOCATIONS = ["PERIMETER PROWLER (1st Half)", "PERIMETER PROWLER (2nd Half)", "SECTION I/C", "TEAM LEADER (I/C)", "OE/ STANDBY-2"];
                    const result = Object.entries(stats).filter(([pos]) => !EXCLUDED_LOCATIONS.includes(pos)).map(([pos, s]) => ({ ...s, uniqueStaffCount: s.uniqueStaff.size, coverage: s.totalSlots > 0 ? (s.filledSlots / s.totalSlots) * 100 : 0, })).sort((a,b) => b.coverage - a.coverage);
                    setLocationStats(result); setProcessing(false);
                });
            }, [month, staffTypeMap]);
            const getStatusBadge = (stat) => {
                if (stat.coverage < 80) return <span className="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-bold">Critical</span>;
                if (stat.uniqueStaffCount < 3) return <span className="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded font-bold">Stagnant</span>;
                return <span className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">Stable</span>;
            };
            return (
                <div className="space-y-6 animate-fade-in-up">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200"><div><h2 className="text-xl font-bold text-slate-800">Location Scorecard</h2><p className="text-sm text-slate-500">Analyze coverage efficiency per post.</p></div><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded text-sm"/></div>
                    {processing ? <div className="p-20 text-center text-slate-400">Analyzing location data...</div> : (
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><table className="min-w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500 font-semibold border-b"><tr><th className="p-4">Location Name</th><th className="p-4 w-1/3">Coverage Efficiency</th><th className="p-4 text-center">Unique Staff</th><th className="p-4 text-center">Status</th></tr></thead><tbody className="divide-y divide-slate-100">{locationStats.map(stat => (<tr key={stat.name} className="hover:bg-slate-50"><td className="p-4 font-bold text-slate-700">{stat.name}</td><td className="p-4"><div className="flex items-center gap-2"><div className="flex-1 bg-slate-100 rounded-full h-2 overflow-hidden"><div className={`h-full ${stat.coverage < 90 ? 'bg-orange-400' : 'bg-green-500'}`} style={{width: `${stat.coverage}%`}}></div></div><span className="text-xs font-bold text-slate-600">{Math.round(stat.coverage)}%</span></div></td><td className="p-4 text-center"><span className="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">{stat.uniqueStaffCount}</span></td><td className="p-4 text-center">{getStatusBadge(stat)}</td></tr>))}{locationStats.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">No data found for this month.</td></tr>}</tbody></table></div>
                    )}
                </div>
            );
        }

        // 7. Workload
        function WorkloadBalanceView() {
            const { staff } = useContext(DataContext); const [month, setMonth] = useState(getMonthStr()); const [stats, setStats] = useState([]); const [processing, setProcessing] = useState(false);
            useEffect(() => { setProcessing(true); const q = query(collection(db, COLLECTIONS.ROSTERS)); onSnapshot(q, snap => { const counts = {}; snap.forEach(d => { if (d.id.startsWith(month) && d.data().rosterGrid) { const grid = d.data().rosterGrid; const seen = new Set(); Object.values(grid).forEach(row => row.forEach(c => { if (c.value && c.value !== "---" && c.value !== "" && !seen.has(c.value)) { counts[c.value] = (counts[c.value] || 0) + 1; seen.add(c.value); } })); } }); const res = Object.entries(counts).map(([id, n]) => ({ id, n, name: staff.find(s=>s.emp_id===id||s.id===id||s.docId===id)?.name || id, type: staff.find(s=>s.emp_id===id||s.id===id||s.docId===id)?.is_buffer ? 'Buffer' : 'Perm' })); setStats(res.sort((a,b) => b.n - a.n)); setProcessing(false); }); }, [month, staff]);
            return ( <div className="space-y-6"><div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border"><h2 className="text-xl font-bold text-slate-800">Workload Balance</h2><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border p-2 rounded text-sm"/></div>{processing ? <div className="p-8 text-center text-slate-400">Calculating...</div> : <div className="bg-white rounded-xl shadow-sm border overflow-hidden"><table className="min-w-full text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-4 text-left">Staff</th><th className="p-4 text-center">Shifts ({month})</th><th className="p-4">Load</th></tr></thead><tbody className="divide-y">{stats.map(s => (<tr key={s.id}><td className="p-4"><div className="font-bold text-slate-700">{s.name}</div><div className="text-xs text-slate-400 font-mono">{s.id} â€¢ {s.type}</div></td><td className="p-4 text-center font-bold">{s.n}</td><td className="p-4"><div className="w-full bg-slate-100 rounded-full h-2"><div className={`h-2 rounded-full ${s.n > 20 ? 'bg-orange-400' : 'bg-blue-600'}`} style={{width: `${(s.n/25)*100}%`}}></div></div></td></tr>))}</tbody></table></div>}</div> );
        }

        // 8. Dashboard
        function DashboardView() {
            const { staff } = useContext(DataContext); const [todayRoster, setTodayRoster] = useState(null);
            useEffect(() => { getDoc(doc(db, COLLECTIONS.ROSTERS, getToday())).then(s => setTodayRoster(s.exists() ? s.data() : null)); }, []);
            const isPublished = todayRoster && Object.keys(todayRoster.rosterGrid || {}).length > 0;
            return ( <div className="space-y-6 animate-fade-in-up"><header className="mb-8"><h2 className="text-2xl font-bold text-slate-800">Operational Overview</h2><p className="text-slate-500">Real-time insight into resource allocation and readiness.</p></header><div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="flex justify-between items-start mb-4"><div><p className="text-xs font-bold text-slate-400 uppercase">Today's Roster</p><h3 className={`text-2xl font-bold mt-1 ${isPublished ? 'text-emerald-600' : 'text-amber-500'}`}>{isPublished ? 'Active' : 'Pending'}</h3></div><div className={`p-3 rounded-xl ${isPublished ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}`}><i className={`ph ${isPublished ? 'ph-check-circle' : 'ph-warning-circle'} text-2xl`}></i></div></div><p className="text-xs text-slate-400">{isPublished ? "Operations normal." : "Roster generation required."}</p></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="flex justify-between items-start mb-4"><div><p className="text-xs font-bold text-slate-400 uppercase">Staff Pool</p><h3 className="text-2xl font-bold mt-1 text-slate-800">{staff.length}</h3></div><div className="p-3 rounded-xl bg-blue-100 text-blue-600"><i className="ph ph-users text-2xl"></i></div></div><p className="text-xs text-slate-400">Total active profiles.</p></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="flex justify-between items-start mb-4"><div><p className="text-xs font-bold text-slate-400 uppercase">System Health</p><h3 className="text-2xl font-bold mt-1 text-purple-600">Online</h3></div><div className="p-3 rounded-xl bg-purple-100 text-purple-600"><i className="ph ph-lightning text-2xl"></i></div></div><p className="text-xs text-slate-400">Database connection stable.</p></div></div></div> );
        }

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [user, setUser] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            useEffect(() => { const unsub = onAuthStateChanged(auth, u => { if (u) setUser(u); else signInAnonymously(auth).catch(e => console.error("Auth Error", e)); }); return unsub; }, []);
            if (!user) return <div className="h-screen flex items-center justify-center bg-slate-50 text-slate-400 font-mono text-sm">Connecting Secure Portal...</div>;
            return ( <DataProvider><div className="flex min-h-screen bg-slate-50 relative"><Sidebar view={view} setView={setView} isOpen={sidebarOpen} setIsOpen={setSidebarOpen} /><div className="flex-1 flex flex-col min-h-screen transition-all duration-300 content-area"><header className="bg-white border-b border-slate-200 p-4 flex items-center justify-between lg:hidden sticky top-0 z-10 no-print"><h1 className="font-bold text-slate-700">APO Portal</h1><button onClick={() => setSidebarOpen(true)} className="p-2 text-slate-600 rounded-lg hover:bg-slate-100"><i className="ph ph-list text-2xl"></i></button></header><main className="flex-1 p-4 lg:p-8 h-full">{view === 'dashboard' && <DashboardView />}{view === 'history' && <RosterHistoryView />}{view === 'fairness' && <WorkloadBalanceView />}{view === 'location' && <LocationScorecardView />}{view === 'profiler' && <StaffProfileView />}{view === 'trends' && <div className="text-center p-20 text-slate-400">Trend Analysis Module (Coming Soon)</div>}</main></div></div></DataProvider> );
        }
    </script>
</body>
</html>

