<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone Staff Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.2rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }

        /* Hide buttons until hover to reduce clutter, optional */
        tr:hover .row-controls { opacity: 1; }
        .row-controls { opacity: 0.3; transition: opacity 0.2s; }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
          apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
          authDomain: "roster-4a997.firebaseapp.com",
          projectId: "roster-4a997",
          storageBucket: "roster-4a997.firebasestorage.app",
          messagingSenderId: "901381868881",
          appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'custom-roster-app';
        
        // Saving to 'rosters' collection, specific draft doc
        const SAVE_COLLECTION = 'rosters'; 
        const SAVE_DOC_ID = 'standalone_draft';

        // Default Config
        const DEFAULT_LOCATIONS = [
            { name: "Pass Counter", slots: 2 },
            { name: "KIOSK", slots: 1 },
            { name: "Lobby", slots: 1 },
            { name: "HHMD", slots: 1 },
            { name: "Guard House", slots: 1 },
            { name: "Report Room", slots: 1 },
            { name: "Vertical Patrol", slots: 1 },
            { name: "Tango Papa", slots: 1 }
        ];

        const TIMES = ["20:00", "21:00", "22:00", "23:00", "00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00"];

        let staffList = [];
        let tableData = {};
        // State to track current order of locations
        let currentLocations = [...DEFAULT_LOCATIONS]; 
        let currentUser = null;

        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('status-text').textContent = "Auth Error: " + error.message;
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Connected as", user.uid);
                document.getElementById('status-dot').classList.remove('bg-red-500');
                document.getElementById('status-dot').classList.add('bg-green-500', 'animate-pulse');
                document.getElementById('status-text').textContent = "Online & Connected";
                
                fetchStaffAndRender();
                loadSavedTableData();
            } else {
                currentUser = null;
                document.getElementById('status-dot').classList.add('bg-red-500');
                document.getElementById('status-dot').classList.remove('bg-green-500', 'animate-pulse');
            }
        });

        function fetchStaffAndRender() {
            const staffPath = collection(db, 'artifacts', appId, 'public', 'data', 'employees');
            
            onSnapshot(query(staffPath), (snapshot) => {
                staffList = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                staffList.sort((a, b) => (a.staffId || "").localeCompare(b.staffId || ""));
                renderTable();
            });
        }

        // --- Row Reordering Logic ---
        window.moveRow = function(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentLocations.length) return;

            // Swap
            const temp = currentLocations[index];
            currentLocations[index] = currentLocations[newIndex];
            currentLocations[newIndex] = temp;

            renderTable();
            updateSaveStatus("Unsaved changes (Order changed)");
        };

        function renderTable() {
            const theadRow = document.getElementById('table-head-row');
            const tbody = document.getElementById('table-body');

            // Render Header (only if empty, except corner cell)
            if (theadRow.children.length === 1) { 
                TIMES.forEach(time => {
                    const th = document.createElement('th');
                    th.className = "px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-50 border-b border-slate-200 min-w-[120px]";
                    th.textContent = time;
                    theadRow.appendChild(th);
                });
            }

            // Render Body
            tbody.innerHTML = ''; 
            
            currentLocations.forEach((locConfig, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors group";

                // Location Cell (Sticky Left) with Controls
                const tdLoc = document.createElement('td');
                tdLoc.className = "px-4 py-2 text-sm text-slate-700 bg-white border-r border-slate-200 sticky left-0 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] align-middle";
                
                // Content Wrapper
                const contentDiv = document.createElement('div');
                contentDiv.className = "flex items-center justify-between gap-2";

                // Text
                const textDiv = document.createElement('div');
                textDiv.innerHTML = `
                    <div class="font-bold leading-tight">${locConfig.name}</div>
                    ${locConfig.slots > 1 ? '<span class="text-[9px] text-slate-400 font-normal">(2 Staff)</span>' : ''}
                `;

                // Controls
                const controlsDiv = document.createElement('div');
                controlsDiv.className = "row-controls flex flex-col gap-0.5";
                
                // Up Button
                const upBtn = document.createElement('button');
                upBtn.innerHTML = `<i data-lucide="chevron-up" class="w-3 h-3"></i>`;
                upBtn.className = `p-0.5 rounded hover:bg-slate-100 ${index === 0 ? 'text-slate-200 cursor-default' : 'text-slate-400 hover:text-indigo-600'}`;
                if (index > 0) upBtn.onclick = () => window.moveRow(index, -1);
                
                // Down Button
                const downBtn = document.createElement('button');
                downBtn.innerHTML = `<i data-lucide="chevron-down" class="w-3 h-3"></i>`;
                downBtn.className = `p-0.5 rounded hover:bg-slate-100 ${index === currentLocations.length - 1 ? 'text-slate-200 cursor-default' : 'text-slate-400 hover:text-indigo-600'}`;
                if (index < currentLocations.length - 1) downBtn.onclick = () => window.moveRow(index, 1);

                controlsDiv.appendChild(upBtn);
                controlsDiv.appendChild(downBtn);
                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(controlsDiv);
                
                tdLoc.appendChild(contentDiv);
                tr.appendChild(tdLoc);

                // Time Cells
                TIMES.forEach(time => {
                    const td = document.createElement('td');
                    td.className = "p-1 border-b border-r border-slate-100 min-w-[120px] align-top";
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = "flex flex-col gap-1";

                    for (let i = 0; i < locConfig.slots; i++) {
                        const select = document.createElement('select');
                        select.className = "w-full text-xs p-1.5 border border-slate-200 rounded focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none bg-white text-slate-700 font-medium cursor-pointer font-mono";
                        
                        const defaultOpt = document.createElement('option');
                        defaultOpt.value = "";
                        defaultOpt.text = "-";
                        select.appendChild(defaultOpt);

                        staffList.forEach(staff => {
                            const opt = document.createElement('option');
                            opt.value = staff.staffId; 
                            // Display ONLY staff ID (names intentionally omitted)
                            opt.text = String(staff.staffId || '').trim();
                            select.appendChild(opt);
                        });

                        const key = `${locConfig.name}_${time}_${i}`;
                        if (tableData[key]) {
                            select.value = tableData[key];
                        }

                        select.addEventListener('change', (e) => {
                            handleSelectionChange(locConfig.name, time, i, e.target.value);
                        });

                        wrapper.appendChild(select);
                    }

                    td.appendChild(wrapper);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
            
            // Refresh icons after render
            if (window.lucide) lucide.createIcons();
        }

        function handleSelectionChange(locName, time, index, value) {
            const key = `${locName}_${time}_${index}`;
            if (value === "") {
                delete tableData[key];
            } else {
                tableData[key] = value;
            }
            updateSaveStatus("Unsaved changes");
        }

        function updateSaveStatus(msg, type = 'neutral') {
            const el = document.getElementById('save-status');
            el.textContent = msg;
            if (type === 'success') el.className = "text-xs font-bold text-green-600";
            else if (type === 'neutral') el.className = "text-xs font-bold text-amber-600";
            else el.className = "text-xs font-bold text-slate-400";
        }

        async function saveTable() {
            if (!currentUser) {
                alert("Please wait for the database status to turn green/Online.");
                return;
            }

            const btn = document.getElementById('save-btn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Saving...`;
            lucide.createIcons();

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', SAVE_COLLECTION, SAVE_DOC_ID);
                
                // Save rowOrder as array of names
                const rowOrder = currentLocations.map(l => l.name);

                await setDoc(docRef, { 
                    gridData: tableData,
                    rowOrder: rowOrder, // Saving the order
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                updateSaveStatus("All changes saved", "success");
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Saved`;
                    lucide.createIcons();
                    setTimeout(() => {
                         btn.innerHTML = originalContent;
                         lucide.createIcons();
                    }, 2000);
                }, 500);

            } catch (e) {
                console.error("Save failed", e);
                alert(`Failed to save. \nError: ${e.message}`);
                btn.disabled = false;
                btn.innerHTML = originalContent;
                lucide.createIcons();
            }
        }

        function loadSavedTableData() {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', SAVE_COLLECTION, SAVE_DOC_ID);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. Load Data
                    if(data.gridData) {
                        tableData = data.gridData;
                    }

                    // 2. Load Order
                    if (data.rowOrder && Array.isArray(data.rowOrder)) {
                        // Reconstruct config based on saved names
                        const loadedOrder = [];
                        
                        // Add saved locations in order
                        data.rowOrder.forEach(name => {
                            const config = DEFAULT_LOCATIONS.find(l => l.name === name);
                            if (config) loadedOrder.push(config);
                        });

                        // Append any new locations that might have been added to code since last save
                        DEFAULT_LOCATIONS.forEach(def => {
                            if (!loadedOrder.find(l => l.name === def.name)) {
                                loadedOrder.push(def);
                            }
                        });

                        currentLocations = loadedOrder;
                    }

                    renderTable();
                    updateSaveStatus("Data loaded", "success");
                }
            }, (error) => {
                console.warn("Could not load previous save:", error.message);
            });
        }

        

        // === Blueprint JSON Export (Roster_22_01_4E compatible + backward compatible) ===
        // New roster system uses:
        // - times matching rosterSystem.ROSTER_TIMES
        // - locations matching rosterSystem.LOCATIONS names
        // - slot count is effectively `needed` (Pass Counter = 2, others = 1)
        // This export keeps BOTH `needed` and legacy `slots` so older importers still work.
        function buildBlueprintJSON() {
            const roster = {};
            currentLocations.forEach(loc => {
                const needed = Number(loc.needed ?? loc.slots ?? 1) || 1;

                roster[loc.name] = {};
                TIMES.forEach(t => {
                    const arr = [];
                    for (let i = 0; i < needed; i++) {
                        const key = loc.name + '_' + t + '_' + i;
                        arr.push(tableData[key] || "");
                    }
                    roster[loc.name][t] = arr;
                });
            });

            // Provide a strict row order (what you see in the table)
            const rowOrder = currentLocations.map(l => l.name);

            return {
                // Tags (the roster app shows schema/version for info)
                schema: "pcc_roster_blueprint_v2",
                version: "universal_schedule_blueprint_v1",

                appId,
                createdAt: new Date().toISOString(),

                // Must match rosterSystem.ROSTER_TIMES exactly
                times: [...TIMES],

                // Roster_22_01_4E uses LOCATIONS with `needed`; keep both fields
                locations: currentLocations.map(l => ({
                    name: l.name,
                    needed: Number(l.needed ?? l.slots ?? 1) || 1,
                    slots: Number(l.slots ?? l.needed ?? 1) || 1
                })),

                rowOrder,

                // Primary structured form used by the roster generator
                roster,

                // Lossless flat keys for round-trip / debugging
                gridData: { ...tableData }
            };
        }

function downloadJSON(obj, filename) {
            const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 250);
        }

        window.exportJSON = function() {
            const data = buildBlueprintJSON();
            const filename = 'blueprint_' + new Date().toISOString().slice(0,10) + '.json';
            downloadJSON(data, filename);
            updateSaveStatus("JSON exported", "success");
        };

        window.saveTable = saveTable;
        initAuth();
        lucide.createIcons();
    </script>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col font-sans text-slate-800">

    <!-- Header -->
    <div class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm shrink-0">
        <div class="flex items-center gap-4">
            <div class="p-2 bg-indigo-600 rounded-lg text-white">
                <i data-lucide="table-2" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800">Independent Roster Table</h1>
                <div class="flex items-center gap-2">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="status-text" class="text-xs text-slate-500 font-medium">Connecting...</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
             <span id="save-status" class="text-xs font-bold text-slate-400"></span>
            
            <button id="export-btn" onclick="exportJSON()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-md font-semibold text-sm transition-all shadow-sm active:transform active:scale-95">
                <i data-lucide="download" class="w-4 h-4"></i>
                Export JSON
            </button>
            <button id="save-btn" onclick="saveTable()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-semibold text-sm transition-all shadow-sm active:transform active:scale-95">
                <i data-lucide="save" class="w-4 h-4"></i>
                Save Table
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-6 overflow-hidden flex flex-col">
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col h-full overflow-hidden">
            
            <!-- Instructions -->
            <div class="px-4 py-3 bg-slate-50 border-b border-slate-100 flex items-center justify-between text-xs text-slate-500">
                <div class="flex items-center gap-2">
                    <i data-lucide="info" class="w-3.5 h-3.5"></i>
                    <span>Use the arrows (Hover over row) to reorder locations. Order is saved automatically.</span>
                </div>
            </div>

            <!-- Scrollable Table Wrapper -->
            <div class="table-container flex-1 overflow-auto bg-white">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 z-20 shadow-sm">
                        <tr id="table-head-row">
                            <!-- Empty corner cell -->
                            <th class="p-3 bg-white border-b border-r border-slate-200 sticky left-0 z-30 w-48 min-w-[190px]">
                                <span class="text-xs font-bold text-slate-400 uppercase">Location \ Time</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="10" class="p-8 text-center text-slate-400 italic">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

</body>
</html>

