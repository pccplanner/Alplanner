<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change of Shift Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f9fafb; /* Slightly lighter gray */
        }
        
        /* Read-only/Disabled styles */
        input:disabled, select:disabled, textarea:disabled,
        .form-input-readonly {
            background-color: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
            opacity: 1;
        }

        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Changed to blue */
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status banners - These are simple bg/text/border colors, no @apply */
        .status-pending_colleague { @apply bg-yellow-100 text-yellow-800 border border-yellow-200; }
        .status-pending_tl_oc { @apply bg-blue-100 text-blue-800 border border-blue-200; }
        .status-approved { @apply bg-green-100 text-green-800 border border-green-200; }
        .status-rejected_colleague, .status-rejected_tl_oc { @apply bg-red-100 text-red-800 border border-red-200; }

        /* TomSelect overrides - These do not use @apply and are fine */
        .ts-control {
            @apply w-full border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-indigo-500 focus-within:border-indigo-500 !important;
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }
        .ts-control .ts-input {
            @apply shadow-none p-0 m-0 !important;
        }
        .ts-dropdown {
            @apply border-gray-300 rounded-lg shadow-lg !important;
        }
        .ts-dropdown .ts-option.active, .ts-dropdown .ts-option:hover {
            @apply bg-indigo-50 text-indigo-700 !important;
        }
        .ts-dropdown .optgroup-header {
            @apply text-xs font-semibold uppercase text-gray-500 bg-gray-50 p-2 !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Container -->
    <div class="container mx-auto max-w-2xl p-4 py-8 sm:py-12">
        
        <header class="text-center mb-8">
            <div class="flex justify-center items-center gap-3">
                <!-- Added Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600">
                    <path d="M8 7h.01"/>
                    <path d="M12 7h.01"/>
                    <path d="M16 7h.01"/>
                    <path d="M16 11h.01"/>
                    <path d="M12 11h.01"/>
                    <path d="M8 11h.01"/>
                    <path d="M16 15h.01"/>
                    <path d="M12 15h.01"/>
                    <path d="M8 15h.01"/>
                    <path d="M2 6l1.45-2.9A2 2 0 0 1 5.24 2h13.52a2 2 0 0 1 1.79 1.1L22 6"/>
                    <path d="M2 6h20"/>
                    <path d="M2 6v11a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6"/>
                    <path d="M10 19v-4h4v4"/>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">Change of Shift Application</h1>
            </div>
            <p class="text-gray-600 mt-2" id="app-subtitle">Submit a new request or view an existing one.</p>
        </header>

        <!-- Loading View -->
        <div id="loading-view" class="text-center p-10">
            <div class="loader"></div>
            <p id="loading-text" class="text-gray-600 text-lg">Loading...</p>
        </div>

        <!-- New Request View -->
        <div id="new-request-view" class="hidden space-y-6">
            <form id="new-request-form">
                <!-- Requesting APO's Detail -->
                <!-- FIXED: Inlined Tailwind classes from .form-section -->
                <div class.bind="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">1. Requesting APO's Detail</h2>
                    
                    <div>
                        <!-- FIXED: Inlined Tailwind classes from .form-label -->
                        <label for="requesterName" class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
                        <select id="requesterName" placeholder="Type to search your name..." required>
                            <option value="">-- Select Your Name --</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="requesterRankId" class="block text-sm font-medium text-gray-700 mb-1">Emp ID:</label>
                            <!-- FIXED: Inlined Tailwind classes from .form-input -->
                            <input type="text" id="requesterRankId" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" disabled>
                        </div>
                        <div>
                            <label for="requesterTeam" class="block text-sm font-medium text-gray-700 mb-1">Unit/Team:</label>
                            <input type="text" id="requesterTeam" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" disabled>
                        </div>
                    </div>
                    
                    <div>
                        <label for="shiftDate" class="block text-sm font-medium text-gray-700 mb-1">Date/Day of Change:</label>
                        <input type="date" id="shiftDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="requesterOriginalShift" class="block text-sm font-medium text-gray-700 mb-1">Original Shift:</label>
                            <input type="text" id="requesterOriginalShift" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="e.g., 2" required>
                        </div>
                        <div>
                            <label for="requesterNewShift" class="block text-sm font-medium text-gray-700 mb-1">Change Shift to:</label>
                            <input type="text" id="requesterNewShift" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 form-input-readonly" readonly>
                        </div>
                    </div>
                    
                    <div>
                        <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">Reason for change:</label>
                        <textarea id="reason" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="e.g., Family gathering" required></textarea>
                    </div>
                </div>

                <!-- Changing with APO's Detail -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">2. Changing with APO's Detail</h2>
                    
                    <div>
                        <label for="colleagueName" class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
                        <select id="colleagueName" placeholder="Select a suitable colleague..." required>
                            <option value="">-- Select Requester & Date First --</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="colleagueRankId" class="block text-sm font-medium text-gray-700 mb-1">Emp ID:</label>
                            <input type="text" id="colleagueRankId" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" disabled>
                        </div>
                        <div>
                            <label for="colleagueTeam" class="block text-sm font-medium text-gray-700 mb-1">Unit/Team:</label>
                            <input type="text" id="colleagueTeam" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" disabled>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="colleagueOriginalShift" class="block text-sm font-medium text-gray-700 mb-1">Colleague's Original Shift:</label>
                            <input type="text" id="colleagueOriginalShift" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="e.g., 1" required>
                            <p class="text-xs text-gray-500 mt-1">Note: Your 'Change Shift to' should match this.</p>
                        </div>
                        <div>
                            <label for="colleagueNewShift" class="block text-sm font-medium text-gray-700 mb-1">Colleague's New Shift:</label>
                            <input type="text" id="colleagueNewShift" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 form-input-readonly" readonly>
                             <p class="text-xs text-gray-500 mt-1">Note: This should match your 'Original Shift'.</p>
                        </div>
                    </div>
                </div>

                <!-- Agreement -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75">
                    <h3 class="font-semibold text-gray-900 mb-2 border-b pb-1">3. Agreement</h3>
                    <div class="text-xs text-gray-600 space-y-2 mt-3">
                        <p>We, hereby understand and acknowledged that:</p>
                        <ul class="list-disc list-inside pl-2 space-y-1">
                            <li>Changes are subject to approval by TL/OIC/OC.</li>
                            <li>Changes shall only be effective upon approval TL/OIC/OC.</li>
                            <li>In any event, anyone of us do not turn up as requested, we understand that we are liable to report back to duty as per original shift/roster.</li>
                            <li>It is our responsibility to remind TL or OIC on the changes.</li>
                            <li>*All shift changes shall be made at least 7 days before the actual shift for approval by TL/OIC/OC.</li>
                        </ul>
                    </div>
                    <div class="mt-4 bg-gray-50 p-3 rounded-lg">
                        <label class="flex items-center">
                            <input type="checkbox" id="agreement" class="h-4 w-4 rounded border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500" required>
                            <span class="ml-2 text-sm font-medium text-gray-700">By submitting, I (the requester) agree to the terms.</span>
                        </label>
                    </div>
                </div>

                <!-- NEW: Error Message Container -->
                <div id="error-message-container" class="hidden">
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                        <strong class="font-bold">Submission Failed!</strong>
                        <span class="block sm:inline" id="error-message-text"></span>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="mt-6">
                    <!-- FIXED: Inlined Tailwind classes from .btn-base and .btn-primary -->
                    <button type="submit" id="submit-request-btn" class="w-full px-5 py-3 rounded-lg shadow-md font-semibold text-white transition-all duration-200 flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500">
                        <span>Submit Request</span>
                        <!-- Added Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </form>
        </div>

        <!-- View Request View -->
        <div id="view-request-view" class="hidden space-y-6">
            <div id="status-banner-container"></div>
            
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">Request Details</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Date of Change:</span>
                        <!-- FIXED: Inlined Tailwind classes from .form-value -->
                        <div id="view-shiftDate" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center font-bold text-indigo-700"></div>
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Reason for Change:</span>
                        <div id="view-reason" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- Requesting APO -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                    <h3 class="text-lg font-semibold text-indigo-700 border-b pb-2">Requesting APO</h3>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Name:</span>
                        <div id="view-requesterName" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center"></div>
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Emp ID:</span>
                        <div id="view-requesterRankId" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center"></div>
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Unit/Team:</span>
                        <div id="view-requesterTeam" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="block text-sm font-medium text-gray-700 mb-1">Original Shift:</span>
                            <div id="view-requesterOriginalShift" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center font-semibold text-red-600"></div>
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-gray-700 mb-1">Change Shift to:</span>
                            <div id="view-requesterNewShift" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center font-semibold text-green-600"></div>
                        </div>
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Submitted:</span>
                        <div id="view-requesterSignature" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center text-sm"></div>
                    </div>
                </div>
                
                <!-- Changing with APO -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                    <h3 class="text-lg font-semibold text-blue-700 border-b pb-2">Changing with APO</h3>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Name:</span>
                        <div id="view-colleagueName" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center"></div>
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Emp ID:</span>
                        <div id="view-colleagueRankId" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center"></div>
                    </div>
                     <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Unit/Team:</span>
                        <div id="view-colleagueTeam" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="block text-sm font-medium text-gray-700 mb-1">Original Shift:</span>
                            <div id="view-colleagueOriginalShift" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center font-semibold text-red-600"></div>
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-gray-700 mb-1">Change Shift to:</span>
                            <div id="view-colleagueNewShift" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[4TwoLinesAdded] flex items-center font-semibold text-green-600"></div>
                        </div>
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Agreed:</span>
                        <div id="view-colleagueSignature" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center text-sm"></div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">3. Approval / Disapproval</h2>
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-1">TL/OC Comments:</span>
                    <div id="view-tl-oc-Comments" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[60px] flex items-center"></div>
                </div>
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-1">TL/OC's Signature:</span>
                    <div id="view-tl-oc-Signature" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg shadow-sm min-h-[42px] flex items-center text-sm"></div>
                </div>
            </div>

            <div id="action-container" class="space-y-4"></div>
        </div>

        <!-- Success/Message View (Redesigned) -->
        <div id="message-view" class="hidden space-y-6">
            
            <!-- Top Card: Success -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 text-center">
                <div id="message-icon-container" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100">
                    <svg class="h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2 id="message-title" class="text-2xl font-bold text-gray-900 mt-4">Success!</h2>
                <p id="message-text" class="mt-2 text-gray-700 max-w-md mx-auto">Your request has been created. Please send the link below to <strong>...</strong> for their agreement.</p>
            </div>

            <!-- CHANGED: Added View Details Button -->
            <a id="view-details-btn" href="#" 
               class="hidden w-full px-5 py-3 rounded-lg shadow-md font-semibold text-white transition-all duration-200 flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500 text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span>View Request Details</span>
            </a>

            <!-- Action Card 1: WhatsApp (Primary) -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75">
                <h3 id="whatsapp-card-title" class="text-lg font-semibold text-gray-900 mb-4 text-center">Step 2: Get Colleague's Agreement</h3>
                <p class="text-center text-gray-600 mb-5">The easiest way is to send the link via WhatsApp:</p>
                
                <!-- FIXED: Big WhatsApp Button with all classes inlined -->
                <a id="whatsapp-share-btn" href="#" target="_blank" 
                   class="w-full px-5 py-3 rounded-lg shadow-lg font-semibold text-white transition-all duration-300 flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 hover:bg-green-700 focus:ring-green-500 text-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.627-2.961 6.58-6.591 6.58zM5.59 5.59a.35.35 0 0 0-.273.512c.16.32.555 1.22 1.232 1.89C7.882 9.173 8.82 9.3 9.13 9.21c.31-.09.72-.372 1.038-.724.318-.35.555-.8.7-1.285.145-.485.08-.936-.026-1.083-.105-.146-.318-.24-.635-.426-.318-.187-.72-.187-.986-.113-.265.074-.469.165-.65.339-.181.174-.29.4-.395.572-.105.173-.21.265-.364.265-.155 0-.318-.09-.46-.21a4.9 4.9 0 0 1-1.6-1.485 5 5 0 0 1-1.04-1.745s-.105-.146.026-.28c.13-.134.288-.174.395-.21.105-.036.18-.01.264.04s.24.09.352.21c.112.12.164.195.21.318.047.123.027.265-.04.395-.07.13-.127.21-.184.288a.35.35 0 0 1-.264.112c-.09 0-.17-.036-.21-.074-.047-.036-.144-.165-.21-.28z"/>
                    </svg>
                    <span id="whatsapp-share-text" class="ml-3 text-lg">Share to Colleague</span>
                </a>
            </div>

            <!-- Action Card 2: Copy Link (Secondary) -->
            <div id="message-link-container" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 bg-gray-50">
                <p class="text-sm font-medium text-gray-800 mb-3 text-center">Or copy the link manually:</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="message-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-sm text-indigo-600 flex-grow bg-white" readonly>
                    <!-- FIXED: Inlined Tailwind classes for Copy button -->
                    <button id="copy-link-btn" class="px-4 py-2 rounded-lg shadow-md font-semibold transition-all duration-200 flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-100 text-indigo-700 font-medium hover:bg-indigo-200 focus:ring-indigo-300 w-full sm:w-auto text-sm">
                        <!-- Added Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        <span>Copy Link</span>
                    </button>
                </div>
                <span id="copy-status" class="mt-2 h-4 block text-sm text-green-600 text-center"></span>
            </div>
            
        </div>
        
    </div>

    <!-- Firebase SDK (No changes to logic) -->
    <script type="module">
        console.log("Shift Request App script started."); // DEBUG: Check if script runs

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc,
            collection, query, getDocs, addDoc, serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. FIREBASE SETUP ---
        let firebaseConfig;
        const standaloneConfig = {
            apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
            authDomain: "roster-4a997.firebaseapp.com",
            projectId: "roster-4a997",
            storageBucket: "roster-4a997.firebasestorage.app",
            messagingSenderId: "901381868881",
            appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };

        if (typeof __firebase_config !== 'undefined') {
            console.log("Using environment-provided Firebase config.");
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            console.log("Using standalone Firebase config.");
            firebaseConfig = standaloneConfig;
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('Debug');

        // --- 1. GLOBAL VARIABLES & COLLECTIONS ---
        
        // !!!!! IMPORTANT !!!!!
        // SET THIS TO THE FINAL URL OF YOUR HTML FILE
        // Example: "https://your-github-username.github.io/your-repo/your-file.html"
        const APP_URL = "https://theva73.github.io/YOUR_REPO_NAME/Form_07_11_8S.txt";
        // !!!!! IMPORTANT !!!!!

        let employeesCollection, teamsCollection, rosterCollection, shiftRequestsCollection;
        let allEmployees = [];
        let teamsMap = new Map();
        let currentRequestId = null;
        let currentRequestAction = null;
        let currentRequestData = null;
        const patternAnchorDate = '2025-01-01';

        let requesterSelect, colleagueSelect;

        // --- 2. DOM ELEMENTS (Will be assigned in DOMContentLoaded) ---
        let loadingView, loadingText, newRequestView, viewRequestView, messageView, newRequestForm,
            requesterNameSelect, requesterRankId, requesterTeam, colleagueNameSelect, colleagueRankId,
            colleagueTeam, shiftDateInput, requesterOriginalShift, requesterNewShift,
            colleagueOriginalShift, colleagueNewShift, statusBannerContainer, actionContainer,
            errorMessageContainer, errorMessageText; // <-- NEW ELEMENTS

        // --- 3. HELPER FUNCTIONS ---
        
        // FIXED: This function now uses the hardcoded APP_URL
        function getBaseUrl() {
            // Check if hardcoded URL is the default
            if (APP_URL.includes("YOUR_REPO_NAME") || APP_URL.includes("YOUR-REPO-NAME")) {
                console.warn("APP_URL not set. Falling back to window.location.href, which might fail.");
                const baseUrl = window.location.href.split('?')[0];
                if (baseUrl.includes("about:blank") || !baseUrl) {
                    console.error("Cannot generate link from 'about:blank'. Please set APP_URL in the script.");
                    return null; // This will cause the form submission to fail safely
                }
                return baseUrl;
            }
            return APP_URL.split('?')[0];
        }

        // --- NEW: Error Handling Functions ---
        function showError(message) {
            errorMessageText.textContent = message;
            errorMessageContainer.classList.remove('hidden');
        }

        function clearError() {
            errorMessageText.textContent = "";
            errorMessageContainer.classList.add('hidden');
        }

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            currentRequestId = params.get('requestId');
            currentRequestAction = params.get('action');
        }

        function showView(view) {
            loadingView.classList.add('hidden');
            newRequestView.classList.add('hidden');
            viewRequestView.classList.add('hidden');
            messageView.classList.add('hidden');
            
            if (view === 'loading') {
                loadingView.classList.remove('hidden');
            } else if (view === 'new') {
                newRequestView.classList.remove('hidden');
            } else if (view === 'view') {
                viewRequestView.classList.remove('hidden');
            } else if (view === 'message') {
                messageView.classList.remove('hidden');
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return "Pending...";
            let date;
            if (timestamp.toDate) { date = timestamp.toDate(); } 
            else { date = new Date(timestamp); }
            return date.toLocaleString('en-SG', { 
                dateStyle: 'medium', 
                timeStyle: 'short',
                timeZone: 'Asia/Singapore'
            });
        }
        
        function getDaysBetween(dateStr1, dateStr2) {
            try {
                const [y1, m1, d1] = dateStr1.split('-').map(Number);
                const [y2, m2, d2] = dateStr2.split('-').map(Number);
                const utcDate1 = Date.UTC(y1, m1 - 1, d1);
                const utcDate2 = Date.UTC(y2, m2 - 1, d2);
                if (isNaN(utcDate1) || isNaN(utcDate2)) { return 0; }
                return Math.round((utcDate1 - utcDate2) / 86400000);
            } catch (e) { console.error("Error in getDaysBetween", e); return 0; }
        }
        
        function getOppositeShift(shift) {
            const normalizedShift = shift ? shift.trim().toUpperCase() : "";
            switch (normalizedShift) {
                case '1': return '2';
                case '2': return '1';
                case '1A': return '2N';
                case '2N': return '1A';
                default: return '';
            }
        }

        async function fetchInitialData() {
            if (allEmployees.length > 0 && teamsMap.size > 0) return;

            loadingText.textContent = "Fetching employee and team list...";
            try {
                const [empSnapshot, teamSnapshot] = await Promise.all([
                    getDocs(query(employeesCollection)),
                    getDocs(query(teamsCollection))
                ]);

                allEmployees = empSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allEmployees.sort((a, b) => a.name.localeCompare(b.name));
                
                teamsMap.clear();
                teamSnapshot.docs.forEach(doc => {
                    teamsMap.set(doc.id, doc.data());
                });
                console.log(`Fetched ${allEmployees.length} employees and ${teamsMap.size} teams.`);
            } catch (error) {
                console.error("Error fetching initial data: ", error);
                loadingText.textContent = "Error fetching data. Cannot proceed.";
                throw error;
            }
        }

        async function getShiftFromRoster(employeeId, date) {
            if (!employeeId || !date) return "";
            
            try {
                const rosterDocRef = doc(rosterCollection, employeeId);
                const rosterDocSnap = await getDoc(rosterDocRef);
                
                if (rosterDocSnap.exists()) {
                    const rosterData = rosterDocSnap.data();
                    if (rosterData.hasOwnProperty(date)) {
                        return rosterData[date] || ""; 
                    }
                }

                const emp = allEmployees.find(e => e.id === employeeId);
                if (!emp) return "";
                
                const team = teamsMap.get(emp.team_id);
                if (team && team.shiftPattern && team.shiftPattern.length > 0) {
                    const pattern = team.shiftPattern;
                    const anchor = team.patternStartDate || patternAnchorDate;
                    const daysSinceAnchor = getDaysBetween(date, anchor);
                    
                    if (isNaN(daysSinceAnchor)) {
                        console.error("getDaysBetween returned NaN", {date, anchor});
                        return "";
                    }

                    const patternIndex = (daysSinceAnchor % pattern.length + pattern.length) % pattern.length;
                    return pattern[patternIndex] || "";
                }
            } catch (error) {
                console.error(`Error in getShiftFromRoster for ${employeeId} on ${date}:`, error);
                return "Error";
            }
            return "";
        }

        // --- 4. APP LOGIC - NEW REQUEST ---

        async function initNewRequestForm() {
            console.log("Initializing new request form...");
            await fetchInitialData();
            initTomSelectInputs();
            
            const today = new Date();
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            shiftDateInput.min = today.toISOString().split('T')[0];

            shiftDateInput.addEventListener('change', async () => { 
                await fetchRequesterShiftAndColleagues(); 
            });
            
            newRequestForm.addEventListener('submit', handleFormSubmit);
            
            showView('new');
            console.log("New request form initialized.");
        }

        function initTomSelectInputs() {
            const tomSelectSettings = {
                create: false,
                sortField: { field: "text", direction: "asc" },
                valueField: 'value',
                labelField: 'text',
                searchField: 'text'
            };

            const employeeOptions = allEmployees.map(emp => ({
                value: emp.id,
                text: emp.name
            }));
            
            requesterSelect = new TomSelect(requesterNameSelect, {
                ...tomSelectSettings,
                options: employeeOptions,
                onChange: async (value) => {
                    await updateEmployeeDetails(value, 'requester'); 
                }
            });

            colleagueSelect = new TomSelect(colleagueNameSelect, {
                ...tomSelectSettings,
                onChange: async (value) => {
                    await updateEmployeeDetails(value, 'colleague');
                }
            });
            
            colleagueSelect.disable();
            colleagueSelect.clearOptions();
            colleagueSelect.addOption({ value: "", text: "-- Select Requester & Date First --" });
        }
        
        async function updateEmployeeDetails(employeeId, type) {
            const emp = allEmployees.find(e => e.id === employeeId);
            let rankIdInput, teamInput;

            if (type === 'requester') {
                rankIdInput = requesterRankId;
                teamInput = requesterTeam;
            } else {
                rankIdInput = colleagueRankId;
                teamInput = colleagueTeam;
            }

            if (!emp) {
                rankIdInput.value = "";
                teamInput.value = "";
                return;
            }

            const team = teamsMap.get(emp.team_id);
            const teamName = team ? team.name : (emp.team_id || 'N/A');

            rankIdInput.value = emp.emp_id || 'N/A';
            teamInput.value = teamName;
            
            if (type === 'requester') {
                await fetchRequesterShiftAndColleagues(); 
            } else {
                await fetchColleagueShift(employeeId);
            }
        }
        
        async function fetchColleagueShift(colleagueId) {
             const date = shiftDateInput.value;
             if (!date || !colleagueId) return;
             
             try {
                colleagueOriginalShift.value = "Fetching...";
                const colOrigShift = await getShiftFromRoster(colleagueId, date);
                colleagueOriginalShift.value = colOrigShift;
                
                const colNewShift = getOppositeShift(colOrigShift);
                colleagueNewShift.value = colNewShift;
            } catch (error) {
                console.error("Error fetching colleague shift:", error);
                colleagueOriginalShift.value = "Error";
            }
        }

        async function fetchRequesterShiftAndColleagues() {
            const date = shiftDateInput.value;
            const requesterId = requesterSelect.getValue();
            
            if (!date || !requesterId) {
                await updateColleagueDropdown(requesterId, date, "");
                return;
            }

            let reqOrigShift = '';
            let reqNewShift = '';
            try {
                requesterOriginalShift.value = "Fetching...";
                reqOrigShift = await getShiftFromRoster(requesterId, date);
                requesterOriginalShift.value = reqOrigShift;
                reqNewShift = getOppositeShift(reqOrigShift);
                requesterNewShift.value = reqNewShift;
            } catch (error) {
                console.error("Error fetching requester shift:", error);
                requesterOriginalShift.value = "Error";
            } 
            
            try {
                // Pass the shift the requester *wants* to the dropdown filter
                await updateColleagueDropdown(requesterId, date, reqNewShift);
            } catch (dropdownError) {
                console.error("Error updating colleague dropdown:", dropdownError);
                colleagueSelect.disable();
                colleagueSelect.clearOptions();
                colleagueSelect.addOption({ value: "", text: "-- Error loading --" });
                colleagueSelect.enable();
            }
        }

        // --- **** MODIFIED FUNCTION **** ---
        // This function now filters the list based on the requesterWantsShift
        async function updateColleagueDropdown(requesterId, date, requesterWantsShift) {
            const normalizedRequesterWantsShift = requesterWantsShift ? requesterWantsShift.trim().toUpperCase() : "";

            if (!requesterId) {
                colleagueSelect.disable();
                colleagueSelect.clearOptions();
                colleagueSelect.addOption({ value: "", text: "-- Select Requester First --" });
                return;
            }

            colleagueSelect.disable();
            colleagueSelect.clear();
            colleagueSelect.clearOptions();
            colleagueSelect.load(onLoad => {
                onLoad([{ value: "", text: "Loading colleagues..." }]);
            });

            const requester = allEmployees.find(e => e.id === requesterId);
            if (!requester) {
                 colleagueSelect.enable();
                 return;
            }

            const requesterTeamId = requester.team_id;

            // Filter out the requester AND anyone on their own team
            const eligibleColleagues = allEmployees.filter(emp => 
                emp.id !== requesterId && emp.team_id !== requesterTeamId
            );

            let bestMatches = [];

            // We ONLY proceed if we have a date and a target shift.
            if (date && normalizedRequesterWantsShift && normalizedRequesterWantsShift.length > 0) {
                const shiftPromises = eligibleColleagues.map(colleague => 
                    getShiftFromRoster(colleague.id, date)
                );
                const shifts = await Promise.all(shiftPromises);

                shifts.forEach((shift, index) => {
                    const colleague = eligibleColleagues[index];
                    const normalizedShift = (shift || "").trim().toUpperCase(); 
                    
                    // This is the core logic: only add if the colleague's shift matches
                    if (normalizedShift && normalizedShift === normalizedRequesterWantsShift) {
                        bestMatches.push(colleague);
                    }
                    // No 'else' block. We simply ignore colleagues who don't match.
                });
            }
            // If no date/shift is selected, bestMatches remains empty.

            colleagueSelect.clearOptions();

            // New UI logic based on what we found
            if (bestMatches.length > 0) {
                // Give a more descriptive label
                const groupLabel = `Suitable Colleagues (Working Shift "${normalizedRequesterWantsShift}")`;
                colleagueSelect.addOptionGroup('matches', { label: groupLabel });
                
                // Add the placeholder *after* clearing
                colleagueSelect.addOption({ value: "", text: "-- Select a Suitable Colleague --" });
                
                bestMatches.forEach(emp => {
                    colleagueSelect.addOption({ value: emp.id, text: emp.name, optgroup: 'matches' });
                });
            } else {
                // No matches. We need to know *why*.
                if (!date || !normalizedRequesterWantsShift) {
                    colleagueSelect.addOption({ value: "", text: "-- Select Date & Your Shift First --" });
                } else {
                    colleagueSelect.addOption({ value: "", text: `No colleagues found working shift "${normalizedRequesterWantsShift}"` });
                }
            }
            
            colleagueSelect.enable();
            colleagueSelect.setValue("");
        }
        // --- **** END OF MODIFIED FUNCTION **** ---


        // --- UPDATED: Form Submit Handler ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            clearError(); // <-- NEW: Clear old errors
            
            const submitBtn = document.getElementById('submit-request-btn');
            submitBtn.disabled = true;
            submitBtn.firstElementChild.textContent = "Submitting...";
            submitBtn.classList.add('opacity-75');

            const requesterId = requesterSelect.getValue();
            const colleagueId = colleagueSelect.getValue();
            
            if (requesterId === colleagueId) {
                console.error("User selected self.");
                showError("You cannot change shifts with yourself. Please select a different colleague."); // <-- NEW
                submitBtn.disabled = false;
                submitBtn.firstElementChild.textContent = "Submit Request";
                submitBtn.classList.remove('opacity-75');
                return;
            }
            if (!requesterId || !colleagueId) {
                 console.error("Missing fields.");
                 showError("Please select both your name and your colleague's name."); // <-- NEW
                submitBtn.disabled = false;
                submitBtn.firstElementChild.textContent = "Submit Request";
                submitBtn.classList.remove('opacity-75');
                return;
            }
            
            const requester = allEmployees.find(e => e.id === requesterId);
            const colleague = allEmployees.find(e => e.id === colleagueId);

            const requesterTeamObj = teamsMap.get(requester.team_id);
            const requesterTeamName = requesterTeamObj ? requesterTeamObj.name : (requester.team_id || 'N/A');
            const colleagueTeamObj = teamsMap.get(colleague.team_id);
            const colleagueTeamName = colleagueTeamObj ? colleagueTeamObj.name : (colleague.team_id || 'N/A');

            const requestData = {
                requesterId: requesterId,
                requesterName: requester.name,
                requesterRankId: requester.emp_id || 'N/A',
                requesterTeam: requesterTeamName,
                
                colleagueId: colleagueId,
                colleagueName: colleague.name,
                colleagueRankId: colleague.emp_id || 'N/A',
                colleagueTeam: colleagueTeamName,
                
                shiftDate: shiftDateInput.value,
                requesterOriginalShift: requesterOriginalShift.value,
                requesterNewShift: requesterNewShift.value,
                colleagueOriginalShift: colleagueOriginalShift.value,
                colleagueNewShift: colleagueNewShift.value,
                
                reason: document.getElementById('reason').value,
                status: 'pending_colleague',
                
                requesterSignatureTimestamp: serverTimestamp(),
                colleagueSignatureTimestamp: null,
                tlOcSignatureTimestamp: null,
                tlOcComments: "",
            };

            if (requestData.requesterNewShift !== requestData.colleagueOriginalShift ||
                requestData.requesterOriginalShift !== requestData.colleagueNewShift) {
                
                console.error("Shift mismatch.");
                // <-- NEW: Show detailed error
                showError(`Shift Mismatch. Your 'Change Shift to' (${requestData.requesterNewShift}) must match your Colleague's 'Original Shift' (${requestData.colleagueOriginalShift}). Please check the date and colleague.`);
                submitBtn.disabled = false;
                submitBtn.firstElementChild.textContent = "Submit Request";
                submitBtn.classList.remove('opacity-75');
                return;
            }

            try {
                const docRef = await addDoc(shiftRequestsCollection, requestData);
                
                const baseUrl = getBaseUrl();
                if (!baseUrl) {
                    console.error("APP_URL not set.");
                    showError("CRITICAL ERROR: APP_URL is not set correctly. Cannot generate sharing link. Please contact administrator."); // <-- NEW
                    submitBtn.disabled = false;
                    submitBtn.firstElementChild.textContent = "Submit Request";
                    submitBtn.classList.remove('opacity-75');
                    return;
                }
                
                const whatsAppLink = `${baseUrl}?requestId=${docRef.id}&action=colleague`;
                const whatsAppMessage = `Hi ${colleague.name}, ${requester.name} has requested a shift swap with you for ${requestData.shiftDate}. Please review and agree at this link:`;

                showMessage(
                    "Request Submitted!",
                    `Your request has been created. Please send the link below to <strong>${colleague.name}</strong> for their agreement.`,
                    whatsAppLink,
                    whatsAppMessage,
                    "Share to Colleague",
                    "Step 2: Get Colleague's Agreement"
                );
            } catch (error) {
                console.error("Error adding document: ", error);
                showError(`An unexpected error occurred: ${error.message}. Please try again.`); // <-- NEW
                submitBtn.disabled = false;
                submitBtn.firstElementChild.textContent = "Submit Request";
                submitBtn.classList.remove('opacity-75');
            }
        }
        
        // CHANGED: Logic for new View Details button
        function showMessage(title, text, link, whatsAppMessage, buttonText, whatsAppTitle) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').innerHTML = text;
            
            // Show green check for success, warning icon for others
            const iconContainer = document.getElementById('message-icon-container');
            if (title.toLowerCase().includes('success') || title.toLowerCase().includes('approved') || title.toLowerCase().includes('submitted')) {
                iconContainer.innerHTML = `
                    <svg class="h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>`;
                iconContainer.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100";
            } else { // Rejected, etc.
                iconContainer.innerHTML = `
                    <svg class="h-10 w-10 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>`;
                iconContainer.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100";
            }

            const linkInput = document.getElementById('message-link');
            linkInput.value = link;
            
            const copyBtn = document.getElementById('copy-link-btn');
            const copyStatus = document.getElementById('copy-status');
            
            copyBtn.onclick = () => {
                linkInput.select();
                try {
                    // Use modern clipboard API if available (with fallback)
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(link).then(() => {
                            copyStatus.textContent = "Copied!";
                        });
                    } else {
                        document.execCommand('copy');
                        copyStatus.textContent = "Copied!";
                    }
                } catch (err) {
                     copyStatus.textContent = "Error copying.";
                }
                setTimeout(() => { copyStatus.textContent = ""; }, 2000);
            };

            const waBtn = document.getElementById('whatsapp-share-btn');
            const waBtnText = document.getElementById('whatsapp-share-text');
            const waBtnCard = waBtn.closest('.bg-white');
            const waTitleEl = document.getElementById('whatsapp-card-title');
            
            // --- NEW ---
            const viewDetailsBtn = document.getElementById('view-details-btn');
            const copyLinkCard = document.getElementById('message-link-container');
            // --- END NEW ---


            if (waTitleEl) {
                waTitleEl.textContent = whatsAppTitle || "Step 2: Get Colleague's Agreement";
            }

            if (whatsAppMessage && buttonText) {
                // This is an intermediate step (share to colleague, share to TL/OC)
                console.log("showMessage: Rendering WhatsApp button.");
                const encodedMessage = encodeURIComponent(`${whatsAppMessage}\n\n${link}`);
                const waHref = `https://wa.me/?text=${encodedMessage}`;
                waBtn.href = waHref;
                waBtnText.textContent = buttonText;
                
                waBtn.classList.remove('hidden');
                if (waBtnCard) waBtnCard.classList.remove('hidden');

                // --- NEW ---
                viewDetailsBtn.classList.add('hidden'); // Hide details button
                copyLinkCard.classList.remove('hidden'); // Show copy link card
                // --- END NEW ---

            } else {
                // This is a final step (Approved, Rejected)
                console.log("showMessage: Hiding WhatsApp button, showing details button.");
                
                waBtn.classList.add('hidden');
                if (waBtnCard) waBtnCard.classList.add('hidden');

                // --- NEW ---
                viewDetailsBtn.href = link; // Set link
                viewDetailsBtn.classList.remove('hidden'); // Show details button
                copyLinkCard.classList.remove('hidden'); // Ensure copy link card is also visible
                // --- END NEW ---
            }

            showView('message');
        }

        // --- 5. APP LOGIC - VIEW REQUEST ---

        async function initViewRequest() {
            await fetchInitialData();
            loadingText.textContent = "Loading request details...";
            
            const docRef = doc(shiftRequestsCollection, currentRequestId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                loadingText.textContent = "Error: This request does not exist.";
                return;
            }

            currentRequestData = docSnap.data();
            
            document.getElementById('view-shiftDate').textContent = currentRequestData.shiftDate;
            document.getElementById('view-reason').textContent = currentRequestData.reason;
            
            document.getElementById('view-requesterName').textContent = currentRequestData.requesterName;
            document.getElementById('view-requesterRankId').textContent = currentRequestData.requesterRankId;
            document.getElementById('view-requesterTeam').textContent = currentRequestData.requesterTeam;
            document.getElementById('view-requesterOriginalShift').textContent = currentRequestData.requesterOriginalShift;
            document.getElementById('view-requesterNewShift').textContent = currentRequestData.requesterNewShift;
            document.getElementById('view-requesterSignature').textContent = formatTimestamp(currentRequestData.requesterSignatureTimestamp);
            
            document.getElementById('view-colleagueName').textContent = currentRequestData.colleagueName;
            document.getElementById('view-colleagueRankId').textContent = currentRequestData.colleagueRankId;
            document.getElementById('view-colleagueTeam').textContent = currentRequestData.colleagueTeam;
            document.getElementById('view-colleagueOriginalShift').textContent = currentRequestData.colleagueOriginalShift;
            document.getElementById('view-colleagueNewShift').textContent = currentRequestData.colleagueNewShift;
            document.getElementById('view-colleagueSignature').textContent = formatTimestamp(currentRequestData.colleagueSignatureTimestamp);
            
            document.getElementById('view-tl-oc-Comments').textContent = currentRequestData.tlOcComments || "No comments.";
            document.getElementById('view-tl-oc-Signature').textContent = formatTimestamp(currentRequestData.tlOcSignatureTimestamp);

            const status = currentRequestData.status;
            let statusText = status.replace('_', ' ').replace('tl oc', 'TL/OC').replace(/\b\w/g, l => l.toUpperCase()); // Capitalize words
            // FIXED: Inlined Tailwind classes from .status-banner
            statusBannerContainer.innerHTML = `<div class="p-4 rounded-lg text-center font-bold text-lg mb-6 shadow-sm status-${status}">${statusText}</div>`;

            renderActionButtons();
            showView('view');
        }

        function renderActionButtons() {
            actionContainer.innerHTML = "";
            const status = currentRequestData.status;

            // FIXED: Define the full Tailwind class strings here
            const btnSuccess = "w-full px-5 py-3 rounded-lg shadow-md font-semibold text-white transition-all duration-200 flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 hover:bg-green-700 focus:ring-green-500";
            const btnDanger = "w-full px-5 py-3 rounded-lg shadow-md font-semibold text-white transition-all duration-200 flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-600 hover:bg-red-700 focus:ring-red-500";
            
            // --- SVGs for buttons ---
            const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            const xIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;

            if (status === 'pending_colleague' && currentRequestAction === 'colleague') {
                actionContainer.innerHTML = `
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 text-center">
                        <h3 class="text-xl font-semibold">Hi ${currentRequestData.colleagueName},</h3>
                        <p class="text-gray-700 mt-2">${currentRequestData.requesterName} has requested to change shifts with you. Do you agree?</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <button id="colleague-agree-btn" class="${btnSuccess}">
                            ${checkIcon}
                            <span>I Agree</span>
                        </button>
                        <button id="colleague-disagree-btn" class="${btnDanger}">
                            ${xIcon}
                            <span>I Disagree</span>
                        </button>
                    </div>
                `;
                document.getElementById('colleague-agree-btn').addEventListener('click', () => handleColleagueAction(true));
                document.getElementById('colleague-disagree-btn').addEventListener('click', () => handleColleagueAction(false));
            }
            else if (status === 'pending_tl_oc' && currentRequestAction === 'tl_oc') {
                 actionContainer.innerHTML = `
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                        <h3 class="text-xl font-semibold text-center border-b pb-2">TL/OC Approval</h3>
                        <div>
                            <label for="tl-oc-CommentsInput" class="block text-sm font-medium text-gray-700 mb-1">Comments (Optional):</label>
                            <textarea id="tl-oc-CommentsInput" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="tl-oc-approve-btn" class="${btnSuccess}">
                                ${checkIcon}
                                <span>Approve</span>
                            </button>
                            <button id="tl-oc-reject-btn" class="${btnDanger}">
                                ${xIcon}
                                <span>Reject</span>
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('tl-oc-approve-btn').addEventListener('click', () => handleTlOcAction(true));
                document.getElementById('tl-oc-reject-btn').addEventListener('click', () => handleTlOcAction(false));
            }
            else {
                if (currentRequestAction && (status.includes('approved') || status.includes('rejected'))) {
                    actionContainer.innerHTML = `<p class="text-center text-gray-600">This request has already been <strong>${status.replace('_', ' ').replace('tl oc', 'TL/OC').toUpperCase()}</strong>.</p>`;
                } else if (!currentRequestAction && status.includes('pending')) {
                     actionContainer.innerHTML = `<p class="text-center text-gray-600">This request is <strong>${status.replace('_', ' ').replace('tl oc', 'TL/OC').toUpperCase()}</strong>. Waiting for action.</p>`;
                } else {
                     actionContainer.innerHTML = `<p class="text-center text-gray-600">This request is finalized. No further actions are needed.</p>`;
                }
            }
        }

        async function handleColleagueAction(didAgree) {
            const docRef = doc(shiftRequestsCollection, currentRequestId);
            
            try {
                const baseUrl = getBaseUrl();
                if (!baseUrl) {
                    console.error("APP_URL not set.");
                    return;
                }

                if (didAgree) {
                    await updateDoc(docRef, {
                        status: 'pending_tl_oc',
                        colleagueSignatureTimestamp: serverTimestamp()
                    });
                    
                    const whatsAppLink = `${baseUrl}?requestId=${currentRequestId}&action=tl_oc`;
                    const whatsAppMessage = `Hi , this is a shift change request for ${currentRequestData.requesterName} and ${currentRequestData.colleagueName} on ${currentRequestData.shiftDate}. We have both agreed. Please approve:`;

                    showMessage(
                        "Agreement Submitted!",
                        `Thank you! Your agreement has been recorded. Please forward the link below to your TL/OC for final approval.`,
                        whatsAppLink,
                        whatsAppMessage,
                        "Share to TL/OC",
                        "Step 3: Get TL/OC Approval"
                    );
                } else {
                    await updateDoc(docRef, {
                        status: 'rejected_colleague',
                        colleagueSignatureTimestamp: serverTimestamp()
                    });

                    const link = `${baseUrl}?requestId=${currentRequestId}`;
                    showMessage(
                        "Request Rejected",
                        `You have rejected this request. The requester has been notified (implicitly).`,
                        link, null, null, "Request Status"
                    );
                }
            } catch (error) {
                console.error("Error updating request: ", error);
            }
        }
        
        async function handleTlOcAction(didApprove) {
            const docRef = doc(shiftRequestsCollection, currentRequestId);
            const tlOcComments = document.getElementById('tl-oc-CommentsInput') ? document.getElementById('tl-oc-CommentsInput').value : "";

            try {
                if (didApprove) {
                    const { requesterId, colleagueId, shiftDate, requesterNewShift, colleagueNewShift } = currentRequestData;
                    
                    const requesterRosterRef = doc(rosterCollection, requesterId);
                    const colleagueRosterRef = doc(rosterCollection, colleagueId);
                    
                    // NEW: Add an asterisk (*) as a remark
                    const requesterShiftWithMark = `${requesterNewShift}*`;
                    const colleagueShiftWithMark = `${colleagueNewShift}*`;
                    
                    await setDoc(requesterRosterRef, { [shiftDate]: requesterShiftWithMark }, { merge: true });
                    await setDoc(colleagueRosterRef, { [shiftDate]: colleagueShiftWithMark }, { merge: true });
                    
                    await updateDoc(docRef, {
                        status: 'approved',
                        tlOcComments: tlOcComments,
                        tlOcSignatureTimestamp: serverTimestamp()
                    });
                    
                } else {
                    await updateDoc(docRef, {
                        status: 'rejected_tl_oc',
                        tlOcComments: tlOcComments,
                        tlOcSignatureTimestamp: serverTimestamp()
                    });
                }

                const baseUrl = getBaseUrl();
                const link = baseUrl ? `${baseUrl}?requestId=${currentRequestId}` : "Link unavailable (APP_URL not set)";
                
                showMessage(
                    didApprove ? "Request Approved!" : "Request Rejected",
                    didApprove ? `The request has been approved and the roster has been updated automatically with a '*' remark.` : `The request has been rejected. The roster was not changed.`,
                    link, 
                    null, 
                    null,
                    "Request Finalized"
                );

            } catch (error)
                {
                console.error("Error finalizing request: ", error);
            }
        }

        // --- 6. INITIALIZATION ---
        
        let authStateProcessed = false;
        
        // --- UPDATED: Assign DOM Elements ---
        function assignDOMElements() {
            loadingView = document.getElementById('loading-view');
            loadingText = document.getElementById('loading-text');
            newRequestView = document.getElementById('new-request-view');
            viewRequestView = document.getElementById('view-request-view');
            messageView = document.getElementById('message-view');
            newRequestForm = document.getElementById('new-request-form');
            requesterNameSelect = document.getElementById('requesterName');
            requesterRankId = document.getElementById('requesterRankId');
            requesterTeam = document.getElementById('requesterTeam');
            colleagueNameSelect = document.getElementById('colleagueName');
            colleagueRankId = document.getElementById('colleagueRankId');
            colleagueTeam = document.getElementById('colleagueTeam');
            shiftDateInput = document.getElementById('shiftDate');
            requesterOriginalShift = document.getElementById('requesterOriginalShift');
            requesterNewShift = document.getElementById('requesterNewShift');
            colleagueOriginalShift = document.getElementById('colleagueOriginalShift');
            colleagueNewShift = document.getElementById('colleagueNewShift');
            statusBannerContainer = document.getElementById('status-banner-container');
            actionContainer = document.getElementById('action-container');
            
            // --- NEW ---
            errorMessageContainer = document.getElementById('error-message-container');
            errorMessageText = document.getElementById('error-message-text');

            console.log("DOM elements assigned.");
        }
        
        async function initFirebase() {
            loadingText.textContent = "Authenticating...";
            console.log("initFirebase started.");
            
            const authTimeout = setTimeout(() => {
                if (!authStateProcessed) {
                    console.error("Authentication timed out.");
                    if (loadingText) loadingText.textContent = "Authentication Timed Out. Please check your network and refresh.";
                }
            }, 10000);

            onAuthStateChanged(auth, async (user) => {
                // FIXED: This logic is now identical to your working roster app
                authStateProcessed = true;
                clearTimeout(authTimeout);

                if (user) {
                    console.log("User authenticated:", user.uid);
                    loadingText.textContent = "Authentication successful. Loading data...";
                    
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        
                        employeesCollection = collection(db, "employees");
                        teamsCollection = collection(db, "teams");
                        rosterCollection = collection(db, "roster");
                        shiftRequestsCollection = collection(db, `artifacts/${appId}/public/data/shiftRequests`);
                        console.log("Collections defined.");

                        getUrlParams();
                        if (currentRequestId) {
                            await initViewRequest();
                        } else {
                            await initNewRequestForm();
                        }
                    } catch (error) {
                        console.error("Error during app initialization:", error);
                        loadingText.textContent = `Error: ${error.message}. Please refresh.`;
                    }

                } else {
                    console.log("User not signed in.");
                    loadingText.textContent = "Authentication Failed. User is not signed in.";
                }
            });

            try {
                if (initialAuthToken) {
                    console.log("Attempting signInWithCustomToken...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Attempting signInAnonymously...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                if (!authStateProcessed) { 
                    authStateProcessed = true;
                    clearTimeout(authTimeout);
                    loadingText.textContent = "Authentication Failed. Please refresh.";
                }
            }
        }

        // Start the app only after the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Assigning elements and initializing Firebase.");
            assignDOMElements();
            initFirebase();
        });
        
    </script>
</body>
</html>
