<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change of Shift Application</title>
    
    <!-- === SMART LINK PREVIEW TAGS === -->
    <meta property="og:title" content="Shift Change Request">
    <meta property="og:description" content="Tap to view details.">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/128/3652/3652191.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <!-- CRITICAL FIX: Added type="text/tailwindcss" so @apply works -->
    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; 
            border-radius: 50%; width: 48px; height: 48px; 
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        input:disabled, select:disabled, textarea:disabled, .form-input-readonly {
            background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; opacity: 1;
        }

        /* Status banners */
        .status-pending_colleague { @apply bg-yellow-100 text-yellow-800 border border-yellow-200; }
        .status-pending_tl_oc { @apply bg-blue-100 text-blue-800 border border-blue-200; }
        .status-approved { @apply bg-green-100 text-green-800 border border-green-200; }
        .status-rejected_colleague, .status-rejected_tl_oc { @apply bg-red-100 text-red-800 border border-red-200; }

        .ts-control { @apply w-full border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-indigo-500 !important; }
        .ts-dropdown { @apply border-gray-300 rounded-lg shadow-lg !important; }
        
        .radio-card-label { @apply flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50 hover:border-indigo-300; }
        .radio-card-label:has(input:checked) { @apply bg-indigo-50 border-indigo-500 ring-1 ring-indigo-500; }
        .radio-custom { @apply h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500; }

        /* Tab States - Blue Line logic */
        .tab-active { @apply text-indigo-600 border-b-2 border-indigo-600; }
        .tab-inactive { @apply text-gray-500 hover:text-gray-800 border-b-2 border-transparent hover:border-gray-300; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <div class="container mx-auto max-w-2xl p-4 py-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-center items-center gap-3 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600">
                    <path d="M8 7h.01"/><path d="M12 7h.01"/><path d="M16 7h.01"/><path d="M16 11h.01"/><path d="M12 11h.01"/><path d="M8 11h.01"/><path d="M16 15h.01"/><path d="M12 15h.01"/><path d="M8 15h.01"/><path d="M2 6l1.45-2.9A2 2 0 0 1 5.24 2h13.52a2 2 0 0 1 1.79 1.1L22 6"/><path d="M2 6h20"/><path d="M2 6v11a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6"/><path d="M10 19v-4h4v4"/>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">Change of Shift Application</h1>
            </div>
            
            <!-- Navigation (Tabs) -->
            <div class="flex justify-center gap-4 text-sm font-medium border-b border-gray-200 pb-1">
                <button id="nav-btn-form" onclick="window.switchView('form')" class="pb-2 px-4 transition-colors tab-active">New Request</button>
                <button id="nav-btn-track" onclick="window.switchView('track')" class="pb-2 px-4 transition-colors tab-inactive">Track My Requests</button>
            </div>
        </header>

        <!-- Loading View -->
        <div id="loading-view" class="text-center py-12">
            <div class="loader"></div>
            <p id="loading-text" class="text-gray-600 text-lg mt-4">Connecting...</p>
        </div>

        <!-- NEW REQUEST VIEW -->
        <div id="new-request-view" class="hidden space-y-6">
            <form id="new-request-form">
                
                <!-- 1. Requesting APO Detail -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">1. Requesting APO's Detail</h2>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
                        <select id="requesterName" placeholder="Type to search your name..." required></select>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Emp ID:</label>
                            <input type="text" id="requesterRankId" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" disabled>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unit/Team:</label>
                            <input type="text" id="requesterTeam" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" disabled>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date/Day of Change:</label>
                        <input type="date" id="shiftDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Requester Shift Radios -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Original Shift:</label>
                            <input type="hidden" id="requesterOriginalShift" required>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <label class="radio-card-label">
                                    <input type="radio" name="reqShiftGroup" id="req-radio-1" value="1" class="radio-custom" onclick="window.setShiftUI('requester', '1')">
                                    <div class="ml-2 flex items-center gap-1.5">
                                        <span class="text-orange-500 font-bold">‚òÄÔ∏è</span>
                                        <span class="text-sm font-medium text-gray-900">Morning (1)</span>
                                    </div>
                                </label>
                                
                                <label class="radio-card-label">
                                    <input type="radio" name="reqShiftGroup" id="req-radio-2" value="2" class="radio-custom" onclick="window.setShiftUI('requester', '2')">
                                    <div class="ml-2 flex items-center gap-1.5">
                                        <span class="text-indigo-500 font-bold">üåô</span>
                                        <span class="text-sm font-medium text-gray-900">Night (2)</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Change Shift to:</label>
                            <input type="text" id="requesterNewShift" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 font-bold text-indigo-600" readonly>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason for change:</label>
                        <textarea id="reason" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Family gathering" required></textarea>
                    </div>
                </div>

                <!-- 2. Colleague Detail -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">2. Changing with APO's Detail</h2>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
                        <select id="colleagueName" placeholder="Select a colleague..." required disabled></select>
                        <p class="text-xs text-gray-500 mt-1">Select requester first to load colleagues.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Emp ID:</label>
                            <input type="text" id="colleagueRankId" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" disabled>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unit/Team:</label>
                            <input type="text" id="colleagueTeam" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" disabled>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Colleague Shift Radios (Auto-selected mostly) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Colleague's Original Shift:</label>
                            <input type="hidden" id="colleagueOriginalShift" required>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <label class="radio-card-label">
                                    <input type="radio" name="colShiftGroup" id="col-radio-1" value="1" class="radio-custom" onclick="window.setShiftUI('colleague', '1')">
                                    <div class="ml-2 flex items-center gap-1.5">
                                        <span class="text-orange-500 font-bold">‚òÄÔ∏è</span>
                                        <span class="text-sm font-medium text-gray-900">Morning (1)</span>
                                    </div>
                                </label>
                                
                                <label class="radio-card-label">
                                    <input type="radio" name="colShiftGroup" id="col-radio-2" value="2" class="radio-custom" onclick="window.setShiftUI('colleague', '2')">
                                    <div class="ml-2 flex items-center gap-1.5">
                                        <span class="text-indigo-500 font-bold">üåô</span>
                                        <span class="text-sm font-medium text-gray-900">Night (2)</span>
                                    </div>
                                </label>
                            </div>
                             <p class="text-xs text-gray-500 mt-1 italic">Automatically updated based on your selection.</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Colleague's New Shift:</label>
                            <input type="text" id="colleagueNewShift" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 font-bold text-orange-600" readonly>
                        </div>
                    </div>
                </div>

                <!-- 3. Agreement -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/75">
                    <h3 class="font-semibold text-gray-900 mb-2 border-b pb-1">3. Agreement</h3>
                    <div class="text-xs text-gray-600 space-y-2 mt-3 pl-2 border-l-2 border-gray-300">
                        <p>We, hereby understand and acknowledged that:</p>
                        <ul class="list-disc list-inside">
                            <li>Changes subject to TL/OIC/OC approval.</li>
                            <li>Liable to report back if colleague doesn't show.</li>
                            <li>Requests should be made 7 days in advance.</li>
                        </ul>
                    </div>
                    <div class="mt-4 bg-gray-50 p-3 rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="agreement" class="h-4 w-4 text-indigo-600 rounded" required>
                            <span class="ml-2 text-sm font-medium text-gray-700">By submitting, I (the requester) agree to the terms.</span>
                        </label>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="error-message-container" class="hidden">
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mt-4" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline" id="error-message-text"></span>
                    </div>
                </div>

                <!-- Submit -->
                <div class="mt-6">
                    <button type="submit" id="submit-request-btn" class="w-full px-5 py-3 rounded-lg shadow-md font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                        <span>Submit Request</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </form>
        </div>

        <!-- TRACKER VIEW -->
        <div id="tracker-view" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/75">
                <h2 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Track Your Requests</h2>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search by Employee ID or Name</label>
                <div class="flex gap-2">
                    <input id="track-id" type="text" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="e.g. 12345 or John">
                    <button onclick="window.trackRequests()" class="bg-indigo-600 text-white px-6 rounded-lg font-bold hover:bg-indigo-700 transition">Search</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Finds your sent and received requests (Partial ID search enabled).</p>
            </div>
            
            <div id="track-status" class="text-center text-sm font-medium text-gray-500 hidden">Searching database...</div>
            <div id="track-results" class="space-y-3"></div>
        </div>

        <!-- VIEW REQUEST (Details) -->
        <div id="view-request-view" class="hidden space-y-6">
            <div id="status-banner-container"></div>
            
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">Request Details</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Date of Change:</span>
                        <div id="view-shiftDate" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-indigo-700 font-bold rounded-lg"></div>
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-1">Reason:</span>
                        <div id="view-reason" class="w-full px-3 py-2 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- Requester Info -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                    <h3 class="text-lg font-semibold text-indigo-700 border-b pb-2">Requesting APO</h3>
                    <div><span class="text-sm font-medium">Name:</span> <div id="view-requesterName" class="font-bold"></div></div>
                    <div><span class="text-sm font-medium">ID / Team:</span> <div id="view-req-info" class="text-sm text-gray-600"></div></div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="bg-red-50 p-2 rounded border border-red-100 text-center"><span class="block text-xs text-red-600 font-bold">FROM</span><div id="view-requesterOriginalShift" class="font-bold"></div></div>
                        <div class="bg-green-50 p-2 rounded border border-green-100 text-center"><span class="block text-xs text-green-600 font-bold">TO</span><div id="view-requesterNewShift" class="font-bold"></div></div>
                    </div>
                </div>
                
                <!-- Colleague Info -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                    <h3 class="text-lg font-semibold text-orange-700 border-b pb-2">Changing with APO</h3>
                    <div><span class="text-sm font-medium">Name:</span> <div id="view-colleagueName" class="font-bold"></div></div>
                    <div><span class="text-sm font-medium">ID / Team:</span> <div id="view-col-info" class="text-sm text-gray-600"></div></div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="bg-red-50 p-2 rounded border border-red-100 text-center"><span class="block text-xs text-red-600 font-bold">FROM</span><div id="view-colleagueOriginalShift" class="font-bold"></div></div>
                        <div class="bg-green-50 p-2 rounded border border-green-100 text-center"><span class="block text-xs text-green-600 font-bold">TO</span><div id="view-colleagueNewShift" class="font-bold"></div></div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/75 space-y-4">
                <h2 class="text-xl font-semibold text-gray-900 border-b pb-2">3. Approval / Disapproval</h2>
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-1">TL/OC Comments:</span>
                    <div id="view-tl-oc-Comments" class="w-full px-3 py-3 border border-gray-100 bg-gray-50 text-gray-800 rounded-lg italic"></div>
                </div>
            </div>

            <div id="action-container" class="space-y-4"></div>
            
            <button onclick="window.switchView('track')" class="w-full text-center text-sm text-gray-500 hover:text-indigo-600 mt-6 pb-6">‚Üê Back to Tracker</button>
        </div>

        <!-- MESSAGE VIEW -->
        <div id="message-view" class="hidden space-y-6">
            <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 text-center">
                <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 text-3xl">üéâ</div>
                <h2 id="message-title" class="text-2xl font-bold text-gray-900">Success!</h2>
                <p id="message-text" class="mt-2 text-gray-600"></p>
            </div>
            <div id="share-section" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                <a id="whatsapp-btn" href="#" target="_blank" class="block w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-center transition flex items-center justify-center gap-2">
                    Send on WhatsApp
                </a>
            </div>
            <button onclick="window.location.reload()" class="block w-full text-center text-indigo-600 font-bold mt-4">Start New Request</button>
        </div>

    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, setDoc, serverTimestamp, query, where, getDoc, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBAL CONFIG
        let db, auth, requestsCol, linksCol, employeesCol, teamsCol, rosterCol;
        let allEmployees = [], teamsMap = new Map();
        let tomReq, tomCol;
        let currentRequestId = null, currentRequestAction = null, currentRequestData = null;
        const patternAnchorDate = '2025-01-01';

        // INIT
        async function init() {
            try {
                // Setup Firebase
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
                    authDomain: "roster-4a997.firebaseapp.com",
                    projectId: "roster-4a997",
                    storageBucket: "roster-4a997.firebasestorage.app",
                    messagingSenderId: "901381868881",
                    appId: "1:901381868881:web:92930481d6c1c85fedd770"
                };
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) await signInWithCustomToken(auth, token);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        requestsCol = collection(db, `artifacts/${appId}/public/data/shiftRequests`);
                        linksCol = collection(db, `artifacts/${appId}/public/data/shortLinks`);
                        employeesCol = collection(db, "employees");
                        teamsCol = collection(db, "teams");
                        rosterCol = collection(db, "roster");

                        await loadBaseData();
                        await checkUrlParams();
                    }
                });
            } catch (e) {
                console.error("Init Error", e);
                document.getElementById('loading-text').textContent = "System Error. Please refresh.";
            }
        }

        async function loadBaseData() {
            try {
                const [eSnap, tSnap] = await Promise.all([getDocs(employeesCol), getDocs(teamsCol)]);
                allEmployees = eSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name));
                tSnap.forEach(d => teamsMap.set(d.id, d.data()));
                
                initFormUI();
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('new-request-view').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
                try {
                    const snap = await getDoc(doc(linksCol, code));
                    if (snap.exists()) {
                        currentRequestId = snap.data().requestId;
                        currentRequestAction = snap.data().action;
                        loadViewRequest(currentRequestId);
                    }
                } catch(e) {}
            } else if (params.get('requestId')) {
                currentRequestId = params.get('requestId');
                loadViewRequest(currentRequestId);
            }
        }

        // --- FORM LOGIC ---
        function initFormUI() {
            if (tomReq) return;
            
            const opts = allEmployees.map(e => ({value: e.id, text: e.name}));
            tomReq = new TomSelect('#requesterName', {
                options: opts, valueField: 'value', labelField: 'text', searchField: 'text',
                onChange: (v) => updateEmpDetails(v, 'requester')
            });
            tomCol = new TomSelect('#colleagueName', {
                valueField: 'value', labelField: 'text', searchField: 'text',
                onChange: (v) => updateEmpDetails(v, 'colleague')
            });
            tomCol.disable();

            document.getElementById('shiftDate').addEventListener('change', () => fetchShifts());
            document.getElementById('new-request-form').addEventListener('submit', submitForm);
        }

        async function updateEmpDetails(id, role) {
            const emp = allEmployees.find(e => e.id === id);
            if (!emp) return;
            
            const rId = role === 'requester' ? 'requesterRankId' : 'colleagueRankId';
            const rTeam = role === 'requester' ? 'requesterTeam' : 'colleagueTeam';
            
            document.getElementById(rId).value = emp.emp_id || '-';
            document.getElementById(rTeam).value = teamsMap.get(emp.team_id)?.name || '-';

            if (role === 'requester') {
                tomCol.clear(); tomCol.clearOptions();
                const others = allEmployees.filter(e => e.id !== id);
                others.forEach(o => tomCol.addOption({value: o.id, text: o.name}));
                tomCol.enable();
                fetchShifts();
            } else {
                fetchColleagueShift();
            }
        }

        async function fetchShifts() {
            const reqId = tomReq.getValue();
            const date = document.getElementById('shiftDate').value;
            if (!reqId || !date) return;

            const shift = await getShiftFromRoster(reqId, date);
            // Default to empty logic, let user select
            if (shift) window.setShiftUI('requester', shift);
            else {
                document.getElementById('requesterOriginalShift').value = "";
                document.getElementById('req-radio-1').checked = false;
                document.getElementById('req-radio-2').checked = false;
            }
            if (tomCol.getValue()) fetchColleagueShift();
        }

        async function fetchColleagueShift() {
            const colId = tomCol.getValue();
            const date = document.getElementById('shiftDate').value;
            if (!colId || !date) return;
            
            const shift = await getShiftFromRoster(colId, date);
            if (shift) window.setShiftUI('colleague', shift);
        }

        async function getShiftFromRoster(id, date) {
            try {
                const snap = await getDoc(doc(rosterCol, id));
                if (snap.exists() && snap.data()[date]) return snap.data()[date];
            } catch(e) {}
            
            const emp = allEmployees.find(e => e.id === id);
            const team = teamsMap.get(emp.team_id);
            if (team?.shiftPattern) {
                const diff = Math.floor((new Date(date) - new Date(patternAnchorDate)) / (1000 * 60 * 60 * 24));
                const idx = ((diff % team.shiftPattern.length) + team.shiftPattern.length) % team.shiftPattern.length;
                return team.shiftPattern[idx];
            }
            return "";
        }

        // --- GLOBAL UI HELPERS ---
        
        window.setShiftUI = (role, val) => {
            val = val.replace(/[\[\]]/g, '').trim(); 
            const isMorning = val === '1' || val === 'Morning';
            const isNight = val === '2' || val === 'Night';
            const cleanVal = isMorning ? '1' : (isNight ? '2' : '');

            // Update Radio Buttons
            const prefix = role === 'requester' ? 'req' : 'col';
            const r1 = document.getElementById(`${prefix}-radio-1`);
            const r2 = document.getElementById(`${prefix}-radio-2`);
            if(r1) r1.checked = isMorning;
            if(r2) r2.checked = isNight;
            
            // Set hidden original shift value
            const hiddenId = role === 'requester' ? 'requesterOriginalShift' : 'colleagueOriginalShift';
            document.getElementById(hiddenId).value = cleanVal;

            // Update new shift display
            const targetId = role === 'requester' ? 'requesterNewShift' : 'colleagueNewShift';
            const newVal = cleanVal === '1' ? 'Night (2)' : (cleanVal === '2' ? 'Morning (1)' : '');
            document.getElementById(targetId).value = newVal;

            // SMART FEATURE: AUTO-SET OPPOSITE PERSON
            // Only trigger if initiated by requester to prevent loops
            if (role === 'requester') {
                const oppVal = cleanVal === '1' ? '2' : (cleanVal === '2' ? '1' : '');
                
                // Update Colleague UI directly without recursion
                const colR1 = document.getElementById('col-radio-1');
                const colR2 = document.getElementById('col-radio-2');
                const colHidden = document.getElementById('colleagueOriginalShift');
                const colTarget = document.getElementById('colleagueNewShift');
                
                if (colR1 && colR2) {
                    colR1.checked = oppVal === '1';
                    colR2.checked = oppVal === '2';
                }
                if (colHidden) colHidden.value = oppVal;
                if (colTarget) colTarget.value = oppVal === '1' ? 'Night (2)' : (oppVal === '2' ? 'Morning (1)' : '');
            }
        };

        window.switchView = (v) => {
            ['new-request-view','tracker-view','view-request-view','message-view'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            
            const target = v === 'form' ? 'new-request-view' : (v === 'track' ? 'tracker-view' : '');
            if(target) document.getElementById(target).classList.remove('hidden');
            
            // Fix Blue Line Logic
            const formBtn = document.getElementById('nav-btn-form');
            const trackBtn = document.getElementById('nav-btn-track');
            
            if (formBtn && trackBtn) {
                if (v === 'form') {
                    formBtn.className = "text-indigo-600 hover:text-indigo-800 border-b-2 border-indigo-600 pb-1";
                    trackBtn.className = "text-gray-500 hover:text-gray-800 pb-1";
                } else if (v === 'track') {
                    trackBtn.className = "text-indigo-600 hover:text-indigo-800 border-b-2 border-indigo-600 pb-1";
                    formBtn.className = "text-gray-500 hover:text-gray-800 pb-1";
                }
            }
        };

        window.trackRequests = async () => {
            const val = document.getElementById('track-id').value.trim().toLowerCase();
            const list = document.getElementById('track-results');
            const status = document.getElementById('track-status');
            
            if(!val) return;
            list.innerHTML = ""; status.classList.remove('hidden');

            try {
                // FUZZY SEARCH IMPLEMENTATION
                const q = query(requestsCol, orderBy('shiftDate', 'desc'), limit(500));
                const snap = await getDocs(q);
                
                const results = [];
                snap.forEach(d => {
                    const data = d.data();
                    let role = null;
                    const rID = String(data.requesterRankId || "").toLowerCase();
                    const cID = String(data.colleagueRankId || "").toLowerCase();
                    const rName = String(data.requesterName || "").toLowerCase();
                    const cName = String(data.colleagueName || "").toLowerCase();

                    // Check includes for partial match
                    if (rID.includes(val) || rName.includes(val)) role = 'Requester';
                    else if (cID.includes(val) || cName.includes(val)) role = 'Colleague';

                    if (role) results.push({id: d.id, ...data, role});
                });

                status.classList.add('hidden');
                if(results.length === 0) list.innerHTML = '<p class="text-center text-gray-400 text-sm">No records found.</p>';
                
                results.forEach(r => {
                    const color = r.status === 'approved' ? 'text-green-600 bg-green-50 border-green-100' : (r.status.includes('pending') ? 'text-yellow-600 bg-yellow-50 border-yellow-100' : 'text-red-600 bg-red-50 border-red-100');
                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md cursor-pointer transition";
                    item.onclick = () => loadViewRequest(r.id);
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-gray-900">${r.shiftDate}</span>
                            <span class="px-2 py-1 rounded text-xs font-bold border uppercase ${color}">${r.status.replace(/_/g,' ')}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            Swap with <span class="font-semibold text-indigo-600">${r.role === 'Requester' ? r.colleagueName : r.requesterName}</span>
                        </div>
                    `;
                    list.appendChild(item);
                });

            } catch(e) { console.error(e); status.textContent = "Error searching."; }
        };

        window.performAction = async (type) => {
            const ref = doc(requestsCol, currentRequestId);
            try {
                if (type === 'agree') {
                    await updateDoc(ref, { status: 'pending_tl_oc', colleagueSignatureTimestamp: serverTimestamp() });
                    const code = Math.random().toString(36).substring(2,8);
                    await setDoc(doc(linksCol, code), { requestId: currentRequestId, action: 'tl_oc' });
                    const link = `${window.location.href.split('?')[0]}?code=${code}`;
                    
                    document.getElementById('message-title').textContent = "Agreement Sent!";
                    document.getElementById('message-text').textContent = "Please forward the link below to your TL/OC for final approval.";
                    const waBtn = document.getElementById('whatsapp-btn');
                    waBtn.href = `https://wa.me/?text=${encodeURIComponent(`Shift Approval Needed: ${link}`)}`;
                    waBtn.textContent = "Send to TL/OC";
                    
                    window.switchView('message');
                    ['new-request-view','tracker-view','view-request-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
                    document.getElementById('message-view').classList.remove('hidden');
                } 
                else if (type === 'approve') {
                    const comment = document.getElementById('admin-comment').value;
                    await updateDoc(ref, { status: 'approved', tlOcComments: comment, tlOcSignatureTimestamp: serverTimestamp() });
                    alert("Approved!"); window.location.reload();
                } 
                else {
                    const st = type === 'reject_col' ? 'rejected_colleague' : 'rejected_tl_oc';
                    await updateDoc(ref, { status: st });
                    alert("Rejected."); window.location.reload();
                }
            } catch(e) { alert(e.message); }
        };

        async function submitForm(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-request-btn');
            const errBox = document.getElementById('error-message-container');
            errBox.classList.add('hidden');
            btn.disabled = true; btn.textContent = "Processing...";

            try {
                const reqId = tomReq.getValue(), colId = tomCol.getValue();
                const reqEmp = allEmployees.find(e => e.id === reqId);
                const colEmp = allEmployees.find(e => e.id === colId);

                const data = {
                    requesterId: reqId, requesterName: reqEmp.name, requesterRankId: reqEmp.emp_id, requesterTeam: document.getElementById('requesterTeam').value,
                    colleagueId: colId, colleagueName: colEmp.name, colleagueRankId: colEmp.emp_id, colleagueTeam: document.getElementById('colleagueTeam').value,
                    shiftDate: document.getElementById('shiftDate').value,
                    requesterOriginalShift: document.getElementById('requesterOriginalShift').value,
                    requesterNewShift: document.getElementById('requesterNewShift').value,
                    colleagueOriginalShift: document.getElementById('colleagueOriginalShift').value,
                    colleagueNewShift: document.getElementById('colleagueNewShift').value,
                    reason: document.getElementById('reason').value,
                    status: 'pending_colleague',
                    requesterSignatureTimestamp: serverTimestamp()
                };

                const ref = await addDoc(requestsCol, data);
                
                const code = Math.random().toString(36).substring(2,8);
                await setDoc(doc(linksCol, code), { requestId: ref.id, action: 'colleague' });
                const link = `${window.location.href.split('?')[0]}?code=${code}`;

                document.getElementById('message-title').textContent = "Request Sent!";
                document.getElementById('message-text').textContent = "Please share the link below with your colleague.";
                const waBtn = document.getElementById('whatsapp-btn');
                waBtn.href = `https://wa.me/?text=${encodeURIComponent(`Hi ${colEmp.name}, requesting a shift swap for ${data.shiftDate}. Link: ${link}`)}`;
                document.getElementById('share-section').classList.remove('hidden');
                
                window.switchView('message');
                ['new-request-view','tracker-view','view-request-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById('message-view').classList.remove('hidden');

            } catch (err) {
                document.getElementById('error-message-text').textContent = err.message;
                errBox.classList.remove('hidden');
                btn.disabled = false; btn.textContent = "Submit Request";
            }
        }

        async function loadViewRequest(id) {
            document.getElementById('loading-view').classList.remove('hidden');
            ['new-request-view','tracker-view','message-view'].forEach(v => document.getElementById(v).classList.add('hidden'));

            try {
                const snap = await getDoc(doc(requestsCol, id));
                if (!snap.exists()) throw new Error("Not found");
                const d = snap.data();
                currentRequestData = d;
                currentRequestId = id;

                document.getElementById('view-shiftDate').textContent = d.shiftDate;
                document.getElementById('view-reason').textContent = d.reason;
                document.getElementById('view-requesterName').textContent = d.requesterName;
                document.getElementById('view-req-info').textContent = `${d.requesterRankId} | ${d.requesterTeam}`;
                document.getElementById('view-requesterOriginalShift').textContent = d.requesterOriginalShift;
                document.getElementById('view-requesterNewShift').textContent = d.requesterNewShift;
                document.getElementById('view-colleagueName').textContent = d.colleagueName;
                document.getElementById('view-col-info').textContent = `${d.colleagueRankId} | ${d.colleagueTeam}`;
                document.getElementById('view-colleagueOriginalShift').textContent = d.colleagueOriginalShift;
                document.getElementById('view-colleagueNewShift').textContent = d.colleagueNewShift;
                document.getElementById('view-tl-oc-Comments').textContent = d.tlOcComments || "No comments.";

                const ban = document.getElementById('status-banner-container');
                let st = d.status.replace(/_/g, ' ').toUpperCase();
                let cl = d.status === 'approved' ? 'bg-green-100 text-green-800' : (d.status.includes('rejected') ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800');
                ban.innerHTML = `<div class="p-4 rounded-lg text-center font-bold text-lg ${cl}">${st}</div>`;

                const act = document.getElementById('action-container');
                act.innerHTML = '';
                
                if (d.status === 'pending_colleague' && currentRequestAction === 'colleague') {
                    act.innerHTML = `
                        <div class="bg-indigo-50 p-6 rounded-lg text-center border border-indigo-100">
                            <p class="font-bold text-lg text-indigo-900 mb-4">Do you agree to this swap?</p>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="window.performAction('agree')" class="bg-green-600 text-white py-3 rounded-lg font-bold shadow hover:bg-green-700">Yes, I Agree</button>
                                <button onclick="window.performAction('reject_col')" class="bg-white border-2 border-red-500 text-red-600 py-3 rounded-lg font-bold hover:bg-red-50">No, Reject</button>
                            </div>
                        </div>`;
                } else if (d.status === 'pending_tl_oc' && currentRequestAction === 'tl_oc') {
                    act.innerHTML = `
                        <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                            <p class="font-bold text-lg text-blue-900 mb-2">Admin Approval</p>
                            <textarea id="admin-comment" class="w-full border p-3 rounded-lg mb-4" placeholder="Optional comments..."></textarea>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="window.performAction('approve')" class="bg-green-600 text-white py-3 rounded-lg font-bold shadow hover:bg-green-700">Approve Request</button>
                                <button onclick="window.performAction('reject_tl')" class="bg-white border-2 border-red-500 text-red-600 py-3 rounded-lg font-bold hover:bg-red-50">Reject Request</button>
                            </div>
                        </div>`;
                }

                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('view-request-view').classList.remove('hidden');

            } catch(e) { console.error(e); alert("Error loading request."); }
        }

        // Start
        init();
    </script>
</body>
</html>


