<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Change Application</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loader { border: 3px solid #d1d5db; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ts-control { border-radius: 0.5rem; border-color: #d1d5db; padding: 8px 12px; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <div class="max-w-xl mx-auto p-4">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold text-gray-900">Shift Change</h1>
            <div class="text-xs font-medium text-gray-500" id="connection-status">Connecting...</div>
        </header>

        <!-- Debug / Loading Log -->
        <div id="system-log" class="bg-blue-50 border border-blue-200 text-blue-800 text-xs p-3 rounded-lg mb-4 font-mono">
            Initializing System...
        </div>

        <!-- MAIN VIEW CONTAINER -->
        <main id="main-container" class="hidden space-y-6">
            
            <!-- TABS -->
            <div class="flex p-1 bg-gray-200 rounded-lg">
                <button onclick="switchView('form')" id="tab-form" class="flex-1 py-2 text-sm font-bold rounded-md bg-white shadow-sm text-gray-900 transition">New Request</button>
                <button onclick="switchView('track')" id="tab-track" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 hover:text-gray-900 transition">Track Status</button>
            </div>

            <!-- FORM VIEW -->
            <div id="view-form" class="block space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-900 mb-4">1. Requester Details</h3>
                    <div class="space-y-3">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Your Name</label>
                        <select id="req-select" placeholder="Start typing name..."></select>
                        <div class="flex gap-2">
                            <input id="req-id" class="w-full bg-gray-50 border rounded p-2 text-xs" placeholder="ID" disabled>
                            <input id="req-team" class="w-full bg-gray-50 border rounded p-2 text-xs" placeholder="Team" disabled>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-900 mb-4">2. Shift Details</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                            <input type="date" id="shift-date" class="w-full border rounded p-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Current Shift</label>
                            <div class="flex gap-2">
                                <label class="flex-1 border rounded p-2 flex items-center gap-2 cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="req-shift" value="1">
                                    <span class="text-sm">Morning (1)</span>
                                </label>
                                <label class="flex-1 border rounded p-2 flex items-center gap-2 cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="req-shift" value="2">
                                    <span class="text-sm">Night (2)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-900 mb-4">3. Swap Partner</h3>
                    <div class="space-y-3">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Colleague Name</label>
                        <select id="col-select" placeholder="Select colleague..."></select>
                        <div class="flex gap-2">
                            <input id="col-id" class="w-full bg-gray-50 border rounded p-2 text-xs" placeholder="ID" disabled>
                            <input id="col-team" class="w-full bg-gray-50 border rounded p-2 text-xs" placeholder="Team" disabled>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Reason</label>
                    <textarea id="reason" class="w-full border rounded p-2" rows="2" placeholder="Reason..."></textarea>
                    <button id="btn-submit" onclick="submitRequest()" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow transition">Submit Request</button>
                </div>
            </div>

            <!-- TRACK VIEW -->
            <div id="view-track" class="hidden space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Search by ID or Name</label>
                    <div class="flex gap-2">
                        <input id="track-id" type="text" class="flex-1 border rounded p-2" placeholder="Enter number (e.g. 12345)">
                        <button onclick="trackRequests()" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">Search</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2">Partial match enabled (e.g., '123' finds 'S12345')</p>
                </div>
                
                <div id="track-status" class="text-center text-sm font-bold text-gray-500 hidden">Searching...</div>
                <div id="track-list" class="space-y-3"></div>
            </div>

            <!-- RESULT VIEW -->
            <div id="view-result" class="hidden bg-white p-8 rounded-xl shadow-lg border border-gray-200 text-center">
                <div class="text-4xl mb-4">ðŸŽ‰</div>
                <h2 class="text-xl font-bold text-gray-900 mb-2" id="res-title">Success</h2>
                <p class="text-gray-600 mb-6 text-sm" id="res-msg">Operation completed.</p>
                <a id="res-link" href="#" target="_blank" class="block w-full bg-green-500 text-white font-bold py-3 rounded-lg mb-3">Share on WhatsApp</a>
                <button onclick="window.location.reload()" class="text-indigo-600 text-sm font-bold">Back to Home</button>
            </div>

            <!-- DETAILS VIEW -->
            <div id="view-details" class="hidden space-y-5">
                <div id="status-banner" class="p-3 text-center font-bold rounded-lg border bg-gray-100 text-gray-600">Loading...</div>
                
                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                        <div>
                            <p class="text-xs text-gray-400 font-bold uppercase">Date</p>
                            <p id="det-date" class="text-lg font-bold text-gray-900">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400 font-bold uppercase">Reason</p>
                            <p id="det-reason" class="text-sm text-gray-600">-</p>
                        </div>
                    </div>

                    <!-- Swap Visual -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span id="det-req-name" class="font-bold text-gray-800">-</span>
                            <div class="flex items-center gap-1 text-xs">
                                <span id="det-req-shift-old" class="text-red-500 line-through">-</span>
                                <span>â†’</span>
                                <span id="det-req-shift-new" class="text-green-600 font-bold">-</span>
                            </div>
                        </div>
                        <div class="border-t border-gray-50"></div>
                        <div class="flex justify-between items-center text-sm">
                            <span id="det-col-name" class="font-bold text-gray-800">-</span>
                            <div class="flex items-center gap-1 text-xs">
                                <span id="det-col-shift-old" class="text-red-500 line-through">-</span>
                                <span>â†’</span>
                                <span id="det-col-shift-new" class="text-green-600 font-bold">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Comments -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-1">TL/OC Comments</p>
                    <p id="det-comments" class="text-sm text-gray-600 italic">No comments yet.</p>
                </div>

                <!-- Actions -->
                <div id="action-area" class="space-y-3"></div>
                
                <button onclick="switchView('track')" class="w-full text-center text-sm text-gray-500 mt-4">Back to Search</button>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, setDoc, serverTimestamp, query, where, getDoc, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // LOGGING
        const sysLog = document.getElementById('system-log');
        function log(msg, error = false) {
            console.log(msg);
            sysLog.textContent = msg;
            sysLog.className = error ? "bg-red-50 border border-red-200 text-red-800 text-xs p-3 rounded-lg mb-4 font-mono" : "bg-blue-50 border border-blue-200 text-blue-800 text-xs p-3 rounded-lg mb-4 font-mono";
        }

        // GLOBALS
        let db, auth, requestsCol, linksCol, employeesCol, teamsCol;
        let allEmployees = [], teamsMap = new Map();
        let tomReq, tomCol;
        let currentReqId = null, currentAction = null;

        // INIT
        async function init() {
            try {
                log("Starting Firebase...");
                
                let firebaseConfig;
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    firebaseConfig = {
                        apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
                        authDomain: "roster-4a997.firebaseapp.com",
                        projectId: "roster-4a997",
                        storageBucket: "roster-4a997.firebasestorage.app",
                        messagingSenderId: "901381868881",
                        appId: "1:901381868881:web:92930481d6c1c85fedd770"
                    };
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                log("Authenticating...");
                
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) await signInWithCustomToken(auth, token);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        log("Connected. Loading Data...");
                        document.getElementById('connection-status').textContent = "Online";
                        document.getElementById('connection-status').className = "text-xs font-medium text-green-600";

                        requestsCol = collection(db, `artifacts/${appId}/public/data/shiftRequests`);
                        linksCol = collection(db, `artifacts/${appId}/public/data/shortLinks`);
                        employeesCol = collection(db, "employees");
                        teamsCol = collection(db, "teams");

                        await loadData();
                        await checkDeepLink();
                    } else {
                        log("Auth lost. Retrying...");
                        await signInAnonymously(auth);
                    }
                });

            } catch (e) {
                log("Init Failed: " + e.message, true);
            }
        }

        async function checkDeepLink() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            
            if (code) {
                log("Resolving Link...");
                const snap = await getDoc(doc(linksCol, code));
                if (snap.exists()) {
                    currentReqId = snap.data().requestId;
                    currentAction = snap.data().action;
                    await loadDetails(currentReqId);
                } else {
                    alert("Invalid Link");
                }
            } else if (params.get('requestId')) {
                currentReqId = params.get('requestId');
                currentAction = params.get('action');
                await loadDetails(currentReqId);
            }
        }

        async function loadData() {
            try {
                const [eSnap, tSnap] = await Promise.all([getDocs(employeesCol), getDocs(teamsCol)]);
                allEmployees = eSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name));
                tSnap.forEach(d => teamsMap.set(d.id, d.data()));

                initUI();
                log("Ready.");
                setTimeout(() => sysLog.classList.add('hidden'), 500); 
                document.getElementById('main-container').classList.remove('hidden');
                
            } catch (e) {
                log("Data Load Failed: " + e.message, true);
            }
        }

        function initUI() {
            const opts = allEmployees.map(e => ({value: e.id, text: e.name}));
            
            tomReq = new TomSelect('#req-select', {
                options: opts, valueField: 'value', labelField: 'text', searchField: 'text',
                onChange: (v) => {
                    const emp = allEmployees.find(e => e.id === v);
                    if(emp) {
                        document.getElementById('req-id').value = emp.emp_id || '-';
                        document.getElementById('req-team').value = teamsMap.get(emp.team_id)?.name || '-';
                        
                        tomCol.clear();
                        tomCol.clearOptions();
                        const others = allEmployees.filter(e => e.id !== v);
                        others.forEach(o => tomCol.addOption({value: o.id, text: o.name}));
                        tomCol.enable();
                    }
                }
            });

            tomCol = new TomSelect('#col-select', {
                valueField: 'value', labelField: 'text', searchField: 'text',
                onChange: (v) => {
                    const emp = allEmployees.find(e => e.id === v);
                    if(emp) {
                        document.getElementById('col-id').value = emp.emp_id || '-';
                        document.getElementById('col-team').value = teamsMap.get(emp.team_id)?.name || '-';
                    }
                }
            });
            tomCol.disable();
        }

        // --- GLOBAL FUNCTIONS ---
        
        window.switchView = (view) => {
            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-track').classList.add('hidden');
            document.getElementById('view-result').classList.add('hidden');
            document.getElementById('view-details').classList.add('hidden');
            
            document.getElementById(`view-${view}`).classList.remove('hidden');
            
            const tForm = document.getElementById('tab-form');
            const tTrack = document.getElementById('tab-track');
            
            if(view === 'form') {
                tForm.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                tForm.classList.remove('text-gray-500');
                tTrack.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                tTrack.classList.add('text-gray-500');
            } else if (view === 'track') {
                tTrack.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                tTrack.classList.remove('text-gray-500');
                tForm.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                tForm.classList.add('text-gray-500');
            }
        };

        window.submitRequest = async () => {
            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.textContent = "Processing...";
            
            try {
                const reqId = tomReq.getValue();
                const colId = tomCol.getValue();
                const shift = document.querySelector('input[name="req-shift"]:checked')?.value;
                const date = document.getElementById('shift-date').value;
                
                if(!reqId || !colId || !shift || !date) throw new Error("Please fill all fields");

                const reqEmp = allEmployees.find(e => e.id === reqId);
                const colEmp = allEmployees.find(e => e.id === colId);

                const reqOrig = shift === '1' ? 'Morning (1)' : 'Night (2)';
                const reqNew = shift === '1' ? 'Night (2)' : 'Morning (1)'; 
                const colOrig = reqNew; 
                const colNew = reqOrig; 

                const data = {
                    requesterId: reqId, requesterName: reqEmp.name, requesterRankId: reqEmp.emp_id, requesterTeam: document.getElementById('req-team').value,
                    colleagueId: colId, colleagueName: colEmp.name, colleagueRankId: colEmp.emp_id, colleagueTeam: document.getElementById('col-team').value,
                    shiftDate: date,
                    requesterOriginalShift: reqOrig, requesterNewShift: reqNew,
                    colleagueOriginalShift: colOrig, colleagueNewShift: colNew,
                    reason: document.getElementById('reason').value,
                    status: 'pending_colleague',
                    requesterSignatureTimestamp: serverTimestamp()
                };

                const ref = await addDoc(requestsCol, data);
                
                const code = Math.random().toString(36).substring(2,8);
                await setDoc(doc(linksCol, code), { requestId: ref.id, action: 'colleague' });
                const link = `${window.location.href.split('?')[0]}?code=${code}`;

                document.getElementById('res-title').textContent = "Request Sent!";
                document.getElementById('res-msg').textContent = "Share the link below with your colleague.";
                document.getElementById('res-link').href = `https://wa.me/?text=${encodeURIComponent(`Shift Swap Request: ${link}`)}`;
                
                window.switchView('result');

            } catch(e) {
                alert("Error: " + e.message);
                btn.disabled = false; btn.textContent = "Submit Request";
            }
        };

        // --- FIXED FUZZY SEARCH ---
        window.trackRequests = async () => {
            const inputVal = document.getElementById('track-id').value.trim().toLowerCase();
            if(!inputVal) return;
            
            const list = document.getElementById('track-list');
            const status = document.getElementById('track-status');
            list.innerHTML = "";
            status.textContent = "Scanning database...";
            status.classList.remove('hidden');
            
            try {
                // FETCH LAST 500 RECORDS (Covers significant history)
                // This allows us to do proper fuzzy matching (e.g. "123" matching "S12345") in memory
                const q = query(requestsCol, orderBy('shiftDate', 'desc'), limit(500));
                const snap = await getDocs(q);
                
                const results = [];
                snap.forEach(d => {
                    const data = d.data();
                    let role = null;
                    
                    // Helper: Safe string conversion
                    const rID = String(data.requesterRankId || "").toLowerCase();
                    const cID = String(data.colleagueRankId || "").toLowerCase();
                    const rName = String(data.requesterName || "").toLowerCase();
                    const cName = String(data.colleagueName || "").toLowerCase();

                    // FUZZY MATCH LOGIC (Includes)
                    if (rID.includes(inputVal) || rName.includes(inputVal)) role = 'Requester';
                    else if (cID.includes(inputVal) || cName.includes(inputVal)) role = 'Colleague';

                    if (role) {
                        results.push({id: d.id, ...data, role: role});
                    }
                });

                status.classList.add('hidden');
                
                if (results.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">No records found matching that ID or Name.</div>';
                } else {
                    list.innerHTML = `<div class="text-xs text-center text-green-600 mb-2 font-bold">Found ${results.length} records</div>`;
                    
                    results.forEach(r => {
                        const color = r.status === 'approved' ? 'bg-green-100 text-green-800' : (r.status.includes('pending') ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');
                        const div = document.createElement('div');
                        div.className = "bg-white border rounded-lg p-3 shadow-sm cursor-pointer hover:border-indigo-300 transition";
                        div.onclick = () => loadDetails(r.id);
                        
                        div.innerHTML = `
                            <div class="flex justify-between mb-1">
                                <span class="font-bold text-sm text-gray-800">${r.shiftDate}</span>
                                <span class="text-[10px] px-2 py-0.5 rounded font-bold uppercase ${color}">${r.status.replace(/_/g,' ')}</span>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${r.role === 'Requester' ? 'Swap with ' + r.colleagueName : 'Req by ' + r.requesterName}
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }

            } catch(e) {
                status.textContent = "Error: " + e.message;
                status.classList.remove('hidden');
                console.error(e);
            }
        };

        async function loadDetails(id) {
            sysLog.classList.remove('hidden');
            log("Loading details...");
            
            try {
                const snap = await getDoc(doc(requestsCol, id));
                if (!snap.exists()) throw new Error("Not found");
                const d = snap.data();

                // Fill UI
                document.getElementById('det-date').textContent = d.shiftDate;
                document.getElementById('det-reason').textContent = d.reason;
                document.getElementById('det-req-name').textContent = d.requesterName;
                document.getElementById('det-req-shift-old').textContent = d.requesterOriginalShift;
                document.getElementById('det-req-shift-new').textContent = d.requesterNewShift;
                document.getElementById('det-col-name').textContent = d.colleagueName;
                document.getElementById('det-col-shift-old').textContent = d.colleagueOriginalShift;
                document.getElementById('det-col-shift-new').textContent = d.colleagueNewShift;
                document.getElementById('det-comments').textContent = d.tlOcComments || "No comments.";

                const ban = document.getElementById('status-banner');
                ban.textContent = d.status.replace(/_/g, ' ').toUpperCase();
                
                const act = document.getElementById('action-area');
                act.innerHTML = '';

                // If user is accessing via Link Action
                if (d.status === 'pending_colleague' && currentAction === 'colleague') {
                    act.innerHTML = `
                        <div class="bg-indigo-50 p-4 rounded-lg text-center">
                            <p class="font-bold text-indigo-900 mb-3">Do you agree?</p>
                            <div class="flex gap-2">
                                <button id="act-agree" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">Agree</button>
                                <button id="act-reject" class="flex-1 bg-white border border-red-300 text-red-600 py-2 rounded font-bold">Reject</button>
                            </div>
                        </div>`;
                    document.getElementById('act-agree').onclick = () => performAction(id, 'agree');
                    document.getElementById('act-reject').onclick = () => performAction(id, 'reject_col');
                } 
                else if (d.status === 'pending_tl_oc' && currentAction === 'tl_oc') {
                    act.innerHTML = `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-bold text-blue-900 mb-2">Approval</p>
                            <textarea id="admin-note" class="w-full border p-2 rounded mb-2 text-xs" placeholder="Comments"></textarea>
                            <div class="flex gap-2">
                                <button id="act-approve" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">Approve</button>
                                <button id="act-deny" class="flex-1 bg-red-600 text-white py-2 rounded font-bold">Reject</button>
                            </div>
                        </div>`;
                    document.getElementById('act-approve').onclick = () => performAction(id, 'approve');
                    document.getElementById('act-deny').onclick = () => performAction(id, 'reject_tl');
                }

                window.switchView('details');
                sysLog.classList.add('hidden');
            } catch (e) {
                log("Details Error: " + e.message, true);
                alert("Error loading request.");
            }
        }

        async function performAction(id, type) {
            const ref = doc(requestsCol, id);
            try {
                if (type === 'agree') {
                    await updateDoc(ref, { status: 'pending_tl_oc', colleagueSignatureTimestamp: serverTimestamp() });
                    const code = Math.random().toString(36).substring(2,8);
                    await setDoc(doc(linksCol, code), { requestId: id, action: 'tl_oc' });
                    const link = `${window.location.href.split('?')[0]}?code=${code}`;
                    
                    document.getElementById('res-title').textContent = "Agreed";
                    document.getElementById('res-msg').textContent = "Send this link to TL/OC";
                    document.getElementById('res-link').href = `https://wa.me/?text=${encodeURIComponent(`Approval Needed: ${link}`)}`;
                    window.switchView('result');
                } 
                else if (type === 'approve') {
                    const note = document.getElementById('admin-note').value;
                    await updateDoc(ref, { status: 'approved', tlOcComments: note, tlOcSignatureTimestamp: serverTimestamp() });
                    alert("Approved"); window.location.reload();
                }
                else {
                    await updateDoc(ref, { status: type === 'reject_col' ? 'rejected_colleague' : 'rejected_tl_oc' });
                    alert("Rejected"); window.location.reload();
                }
            } catch(e) { alert("Error: " + e.message); }
        }

        init();
    </script>
</body>
</html>


