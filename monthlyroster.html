<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Roster System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        
        #roster-grid {
            /* Calculate max height: 100% of viewport height (100vh) minus 190px for the header (mobile) */
            max-height: calc(100vh - 190px);
            overflow: auto;
        }
        
        @media (min-width: 768px) {
            #roster-grid {
                /* On desktop, revert to 70vh */
                max-height: 70vh;
            }
        }

        /* Custom scrollbar for the grid */
        #roster-grid::-webkit-scrollbar { width: 8px; height: 8px; }
        #roster-grid::-webkit-scrollbar-track { background: #f1f1ff; border-radius: 10px; }
        #roster-grid::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 10px; }
        #roster-grid::-webkit-scrollbar-thumb:hover { background: #78716c; }

        /* Sticky column Z-index setup */
        .sticky-col { position: -webkit-sticky; position: sticky; left: 0; z-index: 10; background-color: #ffffff; } /* Employee Names */
        .header-cell { position: -webkit-sticky; position: sticky; top: 0; z-index: 15; background-color: #f8fafc; } /* Dates */
        .sticky-header-col { top: 0; left: 0; z-index: 20; background-color: #f1f5f9; } /* Corner */
        
        .team-header-row { /* Not sticky */ }
        
        .team-li:hover .edit-team-btn { opacity: 1; }
        .employee-row:hover .delete-btn { opacity: 1; }

        .modal-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .auto-shift { opacity: 0.6; }
        .auto-shift:hover { opacity: 1; }

        .color-swatch {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .color-swatch.selected {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #4f46e5;
        }

        #team-filter-dropdown, #manage-dropdown, #name-filter-dropdown {
            max-height: 400px;
            overflow-y: auto;
        }
        
        #name-filter-search {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath fill-rule='evenodd' d='M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 0.75rem 0.65rem;
            padding-left: 2.5rem;
        }

        /* --- STYLES FOR CALENDAR MODAL --- */
        #employee-calendar-modal {
            max-height: 90vh;
        }
        #employee-calendar-modal > div {
             max-height: 90vh; /* Ensure modal content is scrollable */
        }
        #employee-calendar-grid {
            /* Ensure grid cells maintain a minimum height but can grow */
            grid-auto-rows: minmax(6rem, auto); 
        }

        /* --- PRINT STYLES --- */
        @media print {
            /* Hide everything by default */
            body.printing-daily-list > *:not(#daily-list-modal),
            body:not(.printing-daily-list) > *:not(.main-container) {
                display: none !important;
            }

            /* --- Daily List Print --- */
            body.printing-daily-list #daily-list-modal {
                display: block !important;
                visibility: visible !important;
                position: static !important;
                background: #fff !important;
            }
            body.printing-daily-list #daily-list-modal-content {
                box-shadow: none !important;
                border: none !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            body.printing-daily-list #daily-list-header {
                display: none !important; /* Hide modal header/buttons */
            }
            body.printing-daily-list #daily-list-print-header {
                display: block !important; /* Show print-only header */
            }
            body.printing-daily-list #daily-list-content {
                max-height: none !important;
                overflow: visible !important;
            }
            body.printing-daily-list h1, body.printing-daily-list h2, body.printing-daily-list h3 {
                page-break-after: avoid;
            }
            body.printing-daily-list table {
                page-break-inside: auto;
                width: 100% !important;
                border-collapse: collapse !important;
            }
            body.printing-daily-list tr {
                page-break-inside: avoid;
            }
            body.printing-daily-list th, body.printing-daily-list td {
                border: 1px solid #ddd !important;
                padding: 4px 6px !important;
                font-size: 10px !important;
            }
            body.printing-daily-list th {
                background-color: #f4f4f4 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body.printing-daily-list .shift-group-header {
                background-color: #e0e7ff !important; /* indigo-100 */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 12px !important;
                font-weight: bold !important;
                padding: 6px !important;
            }
            
            /* NEW: Print styles for the Unit dropdown */
            body.printing-daily-list .daily-unit-select {
                -webkit-appearance: none !important;
                appearance: none !important;
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 10px !important;
                color: #000 !important;
                width: 100%;
            }
            body.printing-daily-list .daily-unit-select option {
                display: none !important; /* Hide dropdown arrow in print */
            }


            /* --- Roster Grid Print --- */
            body:not(.printing-daily-list) .main-container {
                display: block !important;
                visibility: visible !important;
            }

            /* === PRINT: force centering & bold for all roster cells incl. OFF === */
            /* MODIFIED: Corrected selector to target data/ID cells, excluding the name cell */
            #roster-grid.grid > .employee-row:not(.font-medium),
            #roster-grid.grid .header-cell {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                text-align: center !important;
                font-size: 12px !important;
                font-weight: 700 !important;
                padding: 0 !important;
            }
            /* ensure inner tags also center */
            /* MODIFIED: Corrected selector */
            #roster-grid.grid > .employee-row:not(.font-medium) > * {
                display: block !important;
                width: 100% !important;
                text-align: center !important;
                margin: 0 auto !important;
            }
            /* keep colors and make text dark for print */
            #roster-grid.grid .employee-row[class*="bg-"],
            #roster-grid:not(.grid) .grid > div[class*="bg-"] {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            #roster-grid .employee-row [class*="text-"],
            #roster-grid:not(.grid) .grid > div [class*="text-"] {
                color: #000 !important;
            }

            /* Selective print visibility */
            .printing-selective .employee-row { display: none !important; }
            .printing-selective .employee-row.selected-for-print { display: grid !important; }


            /* Page setup */
            @page {
                size: A4 landscape;
                margin: 0.5cm;
            }
            
            body.printing-daily-list @page {
                size: A4 portrait;
                margin: 1cm;
            }

            /* Show only the roster */
            body:not(.printing-daily-list) .main-container, 
            body:not(.printing-daily-list) #roster-container, 
            body:not(.printing-daily-list) #roster-grid {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                max-height: none !important;
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Hide all UI elements */
            header, .modal, #print-modal, #header-actions, #batch-delete-container, 
            .delete-btn, .emp-checkbox, .edit-team-btn,
            #add-employee-btn, #team-filter-btn, #name-filter-btn, #manage-menu-btn, #print-btn, #daily-list-btn {
                display: none !important;
            }

            /* Force grid display */
            #roster-grid.grid {
                display: grid !important;
                font-size: 10px; /* UPDATED: Increased from 7px for readability */
                color: #000;
            }

            /* Reset sticky elements */
            .sticky-col, .header-cell, .sticky-header-col {
                position: static;
                left: auto;
                top: auto;
                z-index: 1;
                background-color: #f8fafc !important; /* Ensure header bg prints */
            }
            
            /* Style grid cells for printing */
            .header-cell, .employee-row, .team-header-row {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border: 1px solid #9ca3af !important; /* Force borders */
                color: #000 !important;
                padding: 2px 4px !important;
                min-width: 0 !important; /* Allow shrinking */
                white-space: nowrap; /* Prevent wrapping in cells */
            }
            
            /* UPDATED: Make shift labels bold */
            .employee-row {
                font-weight: 700; /* Bold */
            }
            /* Keep headers bold/semibold as well */
            .header-cell, .team-header-row {
                font-weight: 600; /* Semibold */
            }
            
            /* Keep text colors for labels */
            .text-teal-800 { color: #134e4a !important; }
            .text-yellow-800 { color: #854d0e !important; }
            .text-green-800 { color: #166534 !important; }
            .text-blue-800 { color: #1e40af !important; }
            .text-cyan-800 { color: #155e75 !important; }
            .text-lime-800 { color: #3f6212 !important; }
            .text-orange-800 { color: #9a3412 !important; }
            .text-red-800 { color: #991b1b !important; }
            .text-gray-800 { color: #1f2937 !important; }
            .text-gray-400 { color: #9ca3af !important; }
            
            /* Special handling for auto-shift opacity */
            .auto-shift { opacity: 1; border-style: dashed; }
            
            /* Hide role icons */
            .employee-row svg { display: none; }
            
            /* Selective printing */
            .printing-selective .no-print {
                display: none !important;
            }
            
            /* --- Print Styles for SINGLE EMPLOYEE CALENDAR VIEW --- */
            #roster-grid:not(.grid) {
                padding: 1rem;
            }
             #roster-grid:not(.grid) > div { /* This targets the header and calendar container */
                display: block !important;
                border: none !important;
                padding: 0 !important;
            }
            #roster-grid:not(.grid) .grid { /* This targets the calendar grid itself */
                padding: 0 !important;
                gap: 1px !important;
                background-color: #9ca3af; /* Use grid gap to create borders */
                border: 1px solid #9ca3af !important;
            }
            #roster-grid:not(.grid) .grid > div { /* All cells */
                background-color: #fff !important;
                padding: 2px !important;
                border: none !important;
                min-height: 4rem !important;
                font-size: 10px; /* UPDATED: Increased from 8px */
                font-weight: 700; /* UPDATED: Added bold */

                /* NEW: Flex properties to center label */
                display: flex !important;
                flex-direction: column !important;
                justify-content: flex-start !important;
            }
            /* NEW: Target the badge wrapper inside calendar cell */
            #roster-grid:not(.grid) .grid > div > div {
                display: flex !important;
                flex-grow: 1 !important;
                align-items: center !important;
                justify-content: center !important;
                width: 100% !important;
            }
            /* NEW: Ensure date (span) stays at top */
            #roster-grid:not(.grid) .grid > div > span {
                flex-grow: 0 !important;
                flex-shrink: 0 !important;
            }

            #roster-grid:not(.grid) .grid > div[class*=" bg-gray-50/50"] { /* Empty cells */
                background-color: #f9fafb !important;
            }
            #roster-grid:not(.grid) .grid .text-xs { font-size: 8px; } /* UPDATED: Increased from 7px */
            /* End Single Employee Print */
        }

    
/* === FORCE BLUE for Total Hours column === */
.total-hours-cell {
  color: #2563eb !important;    /* Tailwind text-blue-600 */
  font-weight: 700 !important;
  text-align: center !important;
}
@media print {
  .total-hours-cell { color: #1e40af !important; } /* darker blue for print */
}


/* === Embedded by ChatGPT: Daily Attendance A4 Portrait Fit === */
@media print {
  body.printing-daily-list @page { size: A4 portrait; margin: 10mm; }
  body.printing-daily-list table { width: 100% !important; table-layout: fixed !important; border-collapse: collapse !important; }
  body.printing-daily-list th, body.printing-daily-list td {
    border: 1px solid #999 !important; padding: 2px 4px !important;
    font-size: 11px !important; line-height: 1.15 !important;
    white-space: normal !important; word-break: break-word !important;
  }
  body.printing-daily-list th.col-sn,    body.printing-daily-list td.col-sn    { width: 6mm  !important; text-align:center !important; }
  body.printing-daily-list th.col-empid, body.printing-daily-list td.col-empid { width: 18mm !important; }
  body.printing-daily-list th.col-rank,  body.printing-daily-list td.col-rank  { width: 14mm !important; }
  body.printing-daily-list th.col-svc,   body.printing-daily-list td.col-svc   { width: 18mm !important; }
  body.printing-daily-list th.col-name,  body.printing-daily-list td.col-name  { width: auto !important; }
  body.printing-daily-list th.col-unit,  body.printing-daily-list td.col-unit  { width: 22mm !important; }
  body.printing-daily-list th.col-start, body.printing-daily-list td.col-start { width: 16mm !important; text-align:center !important; }
  body.printing-daily-list th.col-end,   body.printing-daily-list td.col-end   { width: 16mm !important; text-align:center !important; }
  body.printing-daily-list th.col-remark,body.printing-daily-list td.col-remark{ width: 26mm !important; }
  body.printing-daily-list th.col-10,   body.printing-daily-list td.col-10   { display: none !important; }
  body.printing-daily-list select, body.printing-daily-list .daily-unit-select {
    border:none !important; background:transparent !important;
    appearance:none !important; -webkit-appearance:none !important;
    font:inherit !important; padding:0 !important;
  }
}


/* === Embedded by ChatGPT: No-wrap + Single-page A4 tweaks (iPhone-safe) === */
@media print {
  html, body { -webkit-text-size-adjust: 100% !important; }
  body.printing-daily-list th,
  body.printing-daily-list td {
    white-space: nowrap !important;     /* don't wrap names/roles/teams */
    overflow: hidden !important;        /* clip overflow */
    text-overflow: ellipsis !important; /* show ... if clipped */
    font-size: 10.5px !important;       /* slightly smaller to fit */
    line-height: 1.1 !important;
    padding: 1.5px 3px !important;      /* tighter padding */
  }
  body.printing-daily-list table {
    width: 100% !important;
    max-width: 100% !important;
    table-layout: fixed !important;
  }
}


/* === Embedded by ChatGPT (05-Nov-2025): Remove TEAM & ROLE columns (screen + print) and expand NAME === */
#daily-list-content table th:nth-child(4),
#daily-list-content table td:nth-child(4),
#daily-list-content table th:nth-child(5),
#daily-list-content table td:nth-child(5) {
  display: none !important; /* hide TEAM and ROLE everywhere */
}
/* Fix NAME overlap by constraining width and adding ellipsis */
#daily-list-content table th:nth-child(3),
#daily-list-content table td:nth-child(3) {
  width: 70mm !important; /* Set fixed width */
  white-space: nowrap !important;
  overflow: hidden !important; /* STOP the overlap */
  text-overflow: ellipsis !important; /* Show ... for long names */
}

/* Ensure fit on A4 portrait both screen preview and print */
@media print {
  body.printing-daily-list @page { size: A4 portrait; margin: 10mm; }
  body.printing-daily-list #daily-list-content table { width:100% !important; table-layout: fixed !important; }
  body.printing-daily-list #daily-list-content th,
  body.printing-daily-list #daily-list-content td { font-size: 10.5px !important; padding: 2px 4px !important; white-space: nowrap !important; }
  /* Hide the same columns in print explicitly (safety) */
  body.printing-daily-list #daily-list-content table th:nth-child(4),
  body.printing-daily-list #daily-list-content table td:nth-child(4),
  body.printing-daily-list #daily-list-content table th:nth-child(5),
  body.printing-daily-list #daily-list-content table td:nth-child(5) { display:none !important; }
}


/* === Embedded by ChatGPT: Fix NAME overlap & rebalance widths (A4 portrait) === */
@media print {
  th.col-sn,    td.col-sn    { width: 6mm  !important; text-align:center !important; }
  th.col-empid, td.col-empid { width: 16mm !important; }
  th.col-rank,  td.col-rank  { width: 12mm !important; }
  th.col-svc,   td.col-svc   { width: 16mm !important; }
  th.col-name,  td.col-name  {
    width: 70mm !important;             /* much wider for long names */
    white-space: nowrap !important;
    overflow: hidden !important;        /* prevent overlap into UNIT */
    text-overflow: clip !important;     /* print full where possible; clip at edge */
    font-size: 10.5px !important;
  }
  th.col-unit,  td.col-unit  { width: 18mm !important; }
  th.col-start, td.col-start { width: 14mm !important; text-align:center !important; }
  th.col-end,   td.col-end   { width: 14mm !important; text-align:center !important; }
  th.col-remark,td.col-remark{ width: 20mm !important; }
}


/* === Embedded by ChatGPT: Daily Attendance print/layout fixes (Nov 5, 2025) === */
#daily-list-content table { table-layout: fixed !important; }
#daily-list-content table th, #daily-list-content table td { box-sizing: border-box !important; }

/* NAME (3rd column): fixed width, single line, ellipsis */
#daily-list-content table th:nth-child(3),
#daily-list-content table td:nth-child(3) {
  /* Shrink NAME column width slightly to free space for other columns */
  width: 60mm !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

/* UNIT (6th column): keep stable */
#daily-list-content table th:nth-child(6),
#daily-list-content table td:nth-child(6) {
  width: 22mm !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

/* START (7th) & END (8th): compact & centered */
#daily-list-content table th:nth-child(7),
#daily-list-content table td:nth-child(7),
#daily-list-content table th:nth-child(8),
#daily-list-content table td:nth-child(8) {
  width: 16mm !important;
  text-align: center !important;
  white-space: nowrap !important;
}

/* REMARKS (9th): ensure visible with width and ellipsis */
#daily-list-content table th:nth-child(9),
#daily-list-content table td:nth-child(9) {
  display: table-cell !important;
  width: 24mm !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

/*
  Responsive adjustments for small screens (mobile):
  When the viewport is narrow we can't display all seven columns at full width. To
  ensure the remarks column remains visible on mobile devices we make the
  following changes for screens 600px wide or less:
    • Hide the END TIME column to free horizontal space.
    • Reduce the width of the NAME, UNIT and START columns and allow them to wrap.
    • Allow the REMARKS column to wrap and increase its width slightly.
  These rules rely on the original column order (after hiding TEAM and ROLE) so
  nth‑child indices still reference the unhidden positions. If additional columns
  are added in the future adjust the indices accordingly.
*/
@media (max-width: 600px) {
  /* Hide END (8th child) column on mobile */
  #daily-list-content table th:nth-child(8),
  #daily-list-content table td:nth-child(8) {
    display: none !important;
  }

  /* NAME column: shrink width and allow wrapping */
  #daily-list-content table th:nth-child(3),
  #daily-list-content table td:nth-child(3) {
    width: 30mm !important;
    white-space: normal !important;
    word-break: break-word !important;
  }

  /* UNIT column: slightly narrower */
  #daily-list-content table th:nth-child(6),
  #daily-list-content table td:nth-child(6) {
    width: 18mm !important;
  }

  /* START column: slightly narrower */
  #daily-list-content table th:nth-child(7),
  #daily-list-content table td:nth-child(7) {
    width: 12mm !important;
  }

  /* REMARKS column: allow wrapping and widen a bit */
  #daily-list-content table th:nth-child(9),
  #daily-list-content table td:nth-child(9) {
    width: 28mm !important;
    white-space: normal !important;
    word-break: break-word !important;
  }
}

@media print {
  /* A4 portrait safe sizing for daily attendance only */
  body.printing-daily-list @page { size: A4 portrait; margin: 10mm; }
  #daily-list-content table th, #daily-list-content table td { font-size: 10.5px !important; padding: 2px 4px !important; }
  /* Ensure table headers and rows in the daily list behave correctly when printing */
  #daily-list-content thead { display: table-header-group !important; }
  #daily-list-content tr { page-break-inside: avoid !important; }
}


/* =========================
   PATCH v2 (06-Nov-2025): Match "Interactive Roster System" PDF layout
   Scope: Monthly roster print only (body:not(.printing-daily-list))
   Key points:
   - A4 landscape with ~8mm margins
   - Heavy grid borders, header banding, bold centered shift codes
   - Fixed widths for Service ID / Emp ID / Employee Name
   - Two-line day header: day number + weekday label stacked and centered
   - Team header row spans full width with stronger band
   ========================= */
@media print {
  /* Page size/margins (Monthly only) */
  body:not(.printing-daily-list) @page { size: A4 landscape; margin: 8mm; }
  body:not(.printing-daily-list) { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  /* Base font for print */
  body:not(.printing-daily-list) #roster-container, 
  body:not(.printing-daily-list) #roster-grid {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important;
    color: #000 !important;
  }

  /* Hide non-roster UI for monthly print */
  body:not(.printing-daily-list) header,
  body:not(.printing-daily-list) nav,
  body:not(.printing-daily-list) .toolbar,
  body:not(.printing-daily-list) .controls,
  body:not(.printing-daily-list) .modal,
  body:not(.printing-daily-list) #print-modal,
  body:not(.printing-daily-list) #header-actions,
  body:not(.printing-daily-list) #daily-list-btn,
  body:not(.printing-daily-list) #manage-menu-btn,
  body:not(.printing-daily-list) #add-employee-btn,
  body:not(.printing-daily-list) .delete-btn,
  body:not(.printing-daily-list) .emp-checkbox { display:none !important; }

  /* Reset stickies/fixed positioning for clean print */
  body:not(.printing-daily-list) .sticky-col,
  body:not(.printing-daily-list) .sticky-header-col,
  body:not(.printing-daily-list) .header-cell { position: static !important; left:auto !important; top:auto !important; box-shadow:none !important; }

  /* Grid container */
  body:not(.printing-daily-list) #roster-grid.grid {
    display: grid !important;
    width: 100% !important;
    gap: 0 !important;
    border: 1px solid #000 !important;
    background: #000 !important; /* hairline between cells */
  }

  /* Cells */
  body:not(.printing-daily-list) #roster-grid.grid > * {
    background: #fff !important;
    border: 1px solid #000 !important;
    margin: 0 !important;
  }

  /* Header row (days) */
  body:not(.printing-daily-list) .header-cell {
    font-weight: 700 !important;
    font-size: 12px !important;
    text-align: center !important;
    background: #e5e7eb !important; /* light gray band */
    padding: 2px 4px !important;
    line-height: 1.15 !important;
  }
  /* If day header contains two lines: number + weekday */
  body:not(.printing-daily-list) .header-cell .day-number { display:block; font-size: 12px !important; font-weight:700 !important; }
  body:not(.printing-daily-list) .header-cell .weekday   { display:block; font-size: 10px !important; font-weight:600 !important; }

  /* Team section header row (e.g., Alpha, Bravo, etc.) */
  body:not(.printing-daily-list) .team-header-row,
  body:not(.printing-daily-list) .team-header,
  body:not(.printing-daily-list) .team-title {
    grid-column: 1 / -1 !important;
    background: #d1d5db !important; /* darker band */
    color: #000 !important;
    font-weight: 700 !important;
    font-size: 14px !important;
    padding: 4px 6px !important;
    text-transform: none !important; /* keep as-is from data */
  }

  /* Row: shift cells */
  body:not(.printing-daily-list) .employee-row { font-size: 12px !important; font-weight: 700 !important; }
  body:not(.printing-daily-list) .employee-row > div,
  body:not(.printing-daily-list) .employee-row > span {
    display:flex !important; align-items:center !important; justify-content:center !important;
    padding: 0 !important; text-align: center !important; min-height: 16px !important;
    white-space: nowrap !important;
  }

  /* Left columns: Service ID / Emp ID / Employee Name with fixed widths and alignment */
  /* Try common class/id names used in previous versions; fall back to nth-child positions */
  body:not(.printing-daily-list) .col-service-id,
  body:not(.printing-daily-list) .service-id,
  body:not(.printing-daily-list) #col-service-id,
  body:not(.printing-daily-list) .employee-row > :nth-child(1) {
    width: 18mm !important; max-width:18mm !important; min-width:18mm !important;
    text-align: left !important; justify-content:flex-start !important; padding: 2px 3px !important; font-weight:600 !important;
  }
  body:not(.printing-daily-list) .col-emp-id,
  body:not(.printing-daily-list) .emp-id,
  body:not(.printing-daily-list) #col-emp-id,
  body:not(.printing-daily-list) .employee-row > :nth-child(2) {
    width: 22mm !important; max-width:22mm !important; min-width:22mm !important;
    text-align: left !important; justify-content:flex-start !important; padding: 2px 3px !important; font-weight:600 !important;
  }
  body:not(.printing-daily-list) .col-emp-name,
  body:not(.printing-daily-list) .emp-name,
  body:not(.printing-daily-list) #col-emp-name,
  body:not(.printing-daily-list) .employee-row > :nth-child(3) {
    width: 48mm !important; max-width:48mm !important; min-width:48mm !important;
    text-align: left !important; justify-content:flex-start !important; padding: 2px 3px !important;
    white-space: normal !important; word-break: break-word !important; line-height: 1.05 !important;
    font-weight:700 !important;
  }

  /* Day columns distribute the remaining width evenly */
  body:not(.printing-daily-list) .day-col, 
  body:not(.printing-daily-list) .day-cell,
  body:not(.printing-daily-list) .employee-row > :nth-child(n+4) {
    min-width: 0 !important;
  }

  /* OFF/shift tokens: always bold, centered, legible */
  body:not(.printing-daily-list) .employee-row .off,
  body:not(.printing-daily-list) .employee-row .OFF { font-weight: 800 !important; }
  body:not(.printing-daily-list) .employee-row .auto-shift { border-style: dashed !important; }

  /* Remove page-breaking surprises */
  body:not(.printing-daily-list) #roster-grid { page-break-inside: avoid !important; }
  body:not(.printing-daily-list) .employee-row { break-inside: avoid !important; page-break-inside: avoid !important; }

  /* Footer / watermark suppression */
  body:not(.printing-daily-list) footer { display:none !important; }
}

/* === Shift-change star highlight (final minimal, non-invasive) === */
.shift-star {
  color: red !important;
  font-weight: 900 !important;
  font-size: 1.15em !important;
  line-height: 1em !important;
}

</style>
</head>
<body class="bg-gray-100">

    <!-- Main container -->
    <div class="main-container w-full min-h-screen md:min-h-0 md:max-w-full md:my-8 md:mx-auto bg-white md:rounded-2xl md:shadow-lg overflow-hidden">
        
        <header class="p-3 sm:p-5 border-b border-gray-200 bg-gray-50">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <!-- Left Side: Title -->
                <div class="flex-1 w-full md:w-auto">
                    <h1 class="text-2xl font-bold text-gray-800 text-center md:text-left">PCC/APOs Roster</h1>
                </div>
                
                <!-- Center: Month Navigation -->
                <div class="flex-shrink-0">
                    <div class="flex items-center space-x-2 my-2 md:my-0">
                        <button id="prev-month" class="p-2 rounded-lg hover:bg-gray-200 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <span id="current-month-year" class="text-xl font-semibold text-indigo-600 w-48 text-center">November 2025</span>
                        <button id="next-month" class="p-2 rounded-lg hover:bg-gray-200 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </div>

                <!-- Right Side: Actions -->
                <div class="flex-1 w-full md:w-auto">
                    <!-- Action buttons container -->
                    <div id="header-actions" class="flex flex-wrap gap-2 justify-center md:justify-end">
                        
                        <!-- Team Filter Dropdown -->
                        <div class="relative">
                            <button id="team-filter-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition duration-150 flex items-center space-x-2">
                                <span>Filter Teams</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="team-filter-dropdown" class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl z-50 hidden border border-gray-200">
                                <div class="p-3 border-b border-gray-200">
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="select-all-teams-checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="font-medium text-gray-800">Select All</span>
                                    </label>
                                </div>
                                <div id="team-filter-list" class="p-3 space-y-2">
                                    <!-- Team checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Name Filter Dropdown -->
                        <div class="relative">
                            <button id="name-filter-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition duration-150 flex items-center space-x-2">
                                <span>Filter Names</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="name-filter-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-50 hidden border border-gray-200">
                                <div class="p-3 border-b border-gray-200">
                                    <input type="text" id="name-filter-search" placeholder="Search names..." class="w-full px-3 py-2 text-sm rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <div class="p-3 border-b border-gray-200 flex space-x-2">
                                    <!-- NEW: Two distinct buttons for clarity -->
                                    <button id="select-all-names-btn" class="flex-1 px-3 py-1 bg-indigo-500 text-white rounded-lg shadow hover:bg-indigo-600 transition text-sm flex items-center justify-center space-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                        <span>Select All</span>
                                    </button>
                                    <button id="unselect-all-names-btn" class="flex-1 px-3 py-1 bg-gray-500 text-white rounded-lg shadow hover:bg-gray-600 transition text-sm flex items-center justify-center space-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                        <span>Unselect All</span>
                                    </button>
                                </div>
                                <div id="name-filter-list" class="p-2">
                                    <!-- Name checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <button id="add-employee-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition duration-150">
                            Add Employee
                        </button>

                        <!-- Manage Dropdown -->
                        <div class="relative">
                            <button id="manage-menu-btn" class="p-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.096 2.573-1.066z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                            <div id="manage-dropdown" class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl z-50 hidden border border-gray-200 divide-y divide-gray-100">
                                <button id="manage-labels-btn" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 transition duration-150">Manage Labels & Shifts</button>
                                <button id="manage-teams-btn" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 transition duration-150">Manage Teams</button>
                                <button id="manage-staff-btn" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 transition duration-150">Edit Staff Profiles</button>
                            </div>
                        </div>
                        
                        <!-- NEW: Daily List Button -->
                        <button id="daily-list-btn" class="p-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700 transition duration-150">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </button>

                        <!-- Print Button -->
                        <button id="print-btn" class="p-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                            </svg>
                        </button>

                    </div>
                    <!-- Batch delete button (initially hidden) -->
                    <div id="batch-delete-container" class="hidden flex justify-center md:justify-end">
                        <button id="batch-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition duration-150">
                            Delete Selected (0)
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-state" class="p-10 text-center text-gray-500">
            <p>Authenticating...</p>
        </div>

        <!-- ROSTER GRID CONTAINER -->
        <div id="roster-container" class="roster-container w-full">
            <div id="roster-grid">
                <!-- Content generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Employee Calendar Modal -->
    <div id="employee-calendar-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-2xl mx-4 modal-fade-in overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="employee-calendar-name" class="text-2xl font-bold text-gray-900"></h3>
                    <p id="employee-calendar-details" class="text-sm text-gray-600 mt-1"></p>
                </div>
                <button id="close-employee-calendar-btn" class="text-gray-500 hover:text-gray-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Weekday headings -->
            <div id="employee-calendar-weekdays" class="grid grid-cols-7 gap-2 mb-2"></div>
            <!-- Day cells -->
            <div id="employee-calendar-grid" class="grid grid-cols-7 gap-2"></div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
            <h3 id="confirm-modal-title" class="text-xl font-semibold text-red-700">Confirm Action</h3>
            <p id="confirm-modal-body" class="my-4 text-gray-600">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-modal-cancel" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-modal-confirm" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm</button>
            </div>
        </div>
    </div>


    <!-- MODALS -->

    <!-- Shift Selector Modal (Main) -->
    <!-- UPDATED: Replaced items-center with items-start, added p-4 and overflow-y-auto -->
    <div id="shift-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start z-50 hidden p-4 overflow-y-auto">
        <!-- UPDATED: Removed mx-4 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Select Shift & Edit Details</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div class="mb-4 p-4 border rounded-lg bg-gray-50">
                <div class="space-y-3">
                    <div>
                        <label for="modal-employee-name-input" class="block text-sm font-medium text-gray-700">Employee Name</label>
                        <input type="text" id="modal-employee-name-input" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="modal-employee-id-input" class="block text-sm font-medium text-gray-700">Employee ID (e.g., 11997)</label>
                        <input type="text" id="modal-employee-id-input" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="modal-employee-role-input" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="modal-employee-role-input" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="member">Member</option>
                            <option value="Section I/C">Section I/C (Assistant)</option>
                            <option value="leader">Team Leader</option>
                        </select>
                    </div>
                    <div>
                        <label for="modal-employee-star-input" class="block text-sm font-medium text-gray-700">Star Display</label>
                        <select id="modal-employee-star-input" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="none">None</option>
                            <option value="yellow">Yellow Star (Section I/C)</option>
                            <option value="blue">Big Blue Star (Team Leader)</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <span id="save-details-status" class="text-sm text-green-600 h-4"></span>
                    <button id="save-details-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition duration-150">
                        Save Details
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Note: Service ID (e.g., 25...) cannot be edited here.</p>
            </div>
            
            <p class="mb-4 text-gray-600">Assign shift for <strong id="modal-date"></strong>.</p>
            <div id="shift-options" class="grid grid-cols-4 gap-3"></div>
            <button id="set-auto-shift-btn" class="w-full mt-4 px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition duration-150">
                Set to Auto (Remove Override)
            </button>
        </div>
    </div>

    <!-- Manage Shift Labels Modal -->
    <!-- UPDATED: Replaced items-center with items-start, added p-4 and overflow-y-auto -->
    <div id="manage-labels-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start z-50 hidden p-4 overflow-y-auto">
        <!-- UPDATED: Removed mx-4 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <!-- EDIT 2: Renamed title as requested -->
                <h3 class="text-xl font-semibold">Manage Labels & Shift Hours</h3>
                <!-- EDIT 1: Ensured 'X' exit button is present -->
                <button id="close-labels-modal" class="text-gray-400 hover:text-gray-600 rounded-full p-1 hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <form id="add-label-form" class="p-4 border rounded-lg bg-gray-50 mb-6">
                <!-- EDIT 2: Renamed subtitle as requested -->
                <h4 class="text-lg font-medium text-gray-800 mb-3">Create New Label / Shift</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="new-label-text" class="block text-sm font-medium text-gray-700">Label Text (e.g., "TRAIN")</label>
                        <input type="text" id="new-label-text" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" maxlength="5" required>
                    </div>
                    <div>
                        <label for="new-label-hours" class="block text-sm font-medium text-gray-700">Working Hours</label>
                        <input type="number" id="new-label-hours" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" value="0" min="0" max="24" step="0.5">
                    </div>
                    <div>
                        <label for="new-label-color" class="block text-sm font-medium text-gray-700">Color</label>
                        <select id="new-label-color" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" required>
                        </select>
                    </div>
                </div>
                <div id="add-label-color-grid" class="mt-4 flex flex-wrap gap-2">
                </div>
                <div id="add-label-error" class="text-red-600 text-sm mt-3 h-4"></div>
                <div class="text-right mt-3">
                    <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">Add Label</button>

                </div>
            </form>

            <div>
                <h4 class="text-lg font-medium text-gray-800 mb-2">Current Labels</h4>
                <div id="delete-label-error" class="text-red-600 text-sm mb-2 h-4"></div>
                <ul id="label-list-ul" class="divide-y divide-gray-200 h-64 overflow-y-auto border rounded-lg p-2 bg-gray-50">
                </ul>
            </div>
        </div>
    </div>

    <!-- Edit Shift Label Modal -->
    <!-- UPDATED: Replaced items-center with items-start, added p-4 and overflow-y-auto -->
    <div id="edit-label-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start z-[55] hidden p-4 overflow-y-auto">
        <!-- UPDATED: Removed mx-4 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <!-- EDIT 2: Renamed title as requested -->
                <h3 class="text-xl font-semibold">Edit Label & Shift Hours</h3>
                <!-- EDIT 1: Ensured 'X' exit button is present -->
                <button id="close-edit-label-modal" class="text-gray-400 hover:text-gray-600 rounded-full p-1 hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <form id="edit-label-form" class="p-4 border rounded-lg bg-gray-50 mb-6">
                <input type="hidden" id="edit-label-key">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="edit-label-text" class="block text-sm font-medium text-gray-700">Label Text (e.g., "TRAIN")</label>
                        <input type="text" id="edit-label-text" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" maxlength="5" required>
                    </div>
                    <div>
                        <label for="edit-label-hours" class="block text-sm font-medium text-gray-700">Working Hours</label>
                        <input type="number" id="edit-label-hours" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" value="0" min="0" max="24" step="0.5">
                    </div>
                    <div>
                        <label for="edit-label-color" class="block text-sm font-medium text-gray-700">Color</label>
                        <select id="edit-label-color" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" required>
                        </select>
                    </div>
                </div>
                <div id="edit-label-color-grid" class="mt-4 flex flex-wrap gap-2">
                </div>
                <div id="edit-label-error" classG="text-red-600 text-sm mt-3 h-4"></div>
                <div class="text-right mt-3">
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">Save Changes</button>

                </div>
            </form>
        </div>
    </div>
    
    <!-- Shift Selector Modal (for Pattern Builder) -->
    <!-- UPDATED: Replaced items-center with items-start, added p-4 and overflow-y-auto -->
    <div id="pattern-shift-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-start z-[60] hidden p-4 overflow-y-auto">
        <!-- UPDATED: Removed mx-4 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Set Pattern Shift</h3>
                 <button id="close-pattern-modal" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <p class="mb-4 text-gray-600">Select shift for <strong id="pattern-modal-day">Day X</strong> of the pattern.</p>
            <div id="pattern-shift-options" class="grid grid-cols-4 gap-3"></div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <!-- UPDATED: Replaced items-center with items-start, added p-4 and overflow-y-auto -->
    <div id="add-employee-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start z-50 hidden p-4 overflow-y-auto">
        <!-- UPDATED: Removed mx-4 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Add New Employee</h3>
                <button id="close-add-modal" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="add-employee-form">
                <div class="space-y-4">
                    <div>
                        <label for="emp-team-select" class="block text-sm font-medium text-gray-700">Team</label>
                        <select id="emp-team-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required></select>
                    </div>
                    <div>
                        <label for="emp-service-id" class="block text-sm font-medium text-gray-700">Service ID (e.g., 25...)</label>
                        <input type="text" id="emp-service-id" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="emp-short-id" class="block text-sm font-medium text-gray-700">Emp ID (e.g., 11997)</label>
                        <input type="text" id="emp-short-id" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="emp-name" class="block text-sm font-medium text-gray-700">Name (e.g., SGT (APF) CHEW...)</label>
                        <input type="text" id="emp-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div id="add-error" class="text-red-600 text-sm"></div>
                    <div class="text-right">
                        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition duration-150">Save Employee</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Employee Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
            <h3 class="text-xl font-semibold text-red-700">Confirm Deletion</h3>
            <p class="my-4 text-gray-600">Are you sure you want to delete <strong id="delete-modal-name"></strong> (Service ID: <strong id="delete-modal-id"></strong>)?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-delete-btn" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm Delete</button>
            </div>
        </div>
    </div>

    <!-- BATCH Delete Employee Confirmation Modal -->
    <div id="batch-delete-confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
            <h3 class="text-xl font-semibold text-red-700">Confirm Batch Deletion</h3>
            <p class="my-4 text-gray-600">Are you sure you want to delete the following <strong id="batch-delete-count">0</strong> employees?</p>
            <ul id="batch-delete-list" class="mb-4 max-h-48 overflow-y-auto text-sm text-gray-500 list-disc list-inside bg-gray-50 p-3 rounded-lg">
            </ul>
            <div class="flex justify-end space-x-3">
                <button id="cancel-batch-delete-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-batch-delete-btn" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm Delete</button>
            </div>
        </div>
    </div>

    <!-- 
    <!-- Edit Staff Profiles Modal -->
    <div id="manage-staff-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Edit Staff Profiles</h2>
                <button id="close-manage-staff-modal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">
                Select a staff below to edit their <strong>Name</strong>, <strong>User ID</strong>, and <strong>Star Rank</strong>.
            </p>
            <div class="border rounded-lg overflow-hidden">
                <div class="grid grid-cols-12 bg-gray-50 text-xs font-semibold text-gray-600 px-3 py-2">
                    <div class="col-span-3">Name</div>
                    <div class="col-span-2">User ID</div>
                    <div class="col-span-2">Team</div>
                    <div class="col-span-2">Role</div>
                    <div class="col-span-2">Star</div>
                    <div class="col-span-1 text-right">Edit</div>
                </div>
                <div id="manage-staff-list" class="max-h-96 overflow-y-auto text-sm divide-y divide-gray-100">
                    <!-- Staff rows will be rendered here dynamically -->
                </div>
            </div>
        </div>
    </div>

Manage Teams Modal -->
    <div id="manage-teams-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Manage Teams</h3>
                <button id="close-teams-modal" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="mb-6">
                <h4 class="text-lg font-medium text-gray-800 mb-2">Add New Team</h4>
                <form id="add-team-form" class="flex space-x-2">
                    <input type="text" id="new-team-name" class="flex-1 block w-full rounded-lg border-gray-300 shadow-sm" placeholder="New team name" required>
                    <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">Add</button>
                </form>
                <div id="add-team-error" class="text-red-600 text-sm mt-1"></div>
            </div>
            <div>
                <h4 class="text-lg font-medium text-gray-800 mb-2">Current Teams</h4>
                <div id="delete-team-error" class="text-red-600 text-sm mb-2"></div>
                <ul id="team-list-ul" class="divide-y divide-gray-200 h-64 overflow-y-auto border rounded-lg p-2 bg-gray-50">
                </ul>
            </div>
        </div>
    </div>

    <!-- Edit Team (Visual Pattern Builder) Modal -->
    <!-- UPDATED: Replaced items-center with items-start, added p-4 and overflow-y-auto -->
    <div id="edit-team-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start z-[55] hidden p-4 overflow-y-auto">
        <!-- UPDATED: Removed mx-4 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Edit Team & Pattern</h3>
                <button id="close-edit-team-modal" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="edit-team-form">
                <input type="hidden" id="edit-team-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-team-name" class="block text-sm font-medium text-gray-700">Team Name</label>
                        <input type="text" id="edit-team-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="edit-team-pattern-length" class="block text-sm font-medium text-gray-700">Pattern Length</label>
                            <input type="number" id="edit-team-pattern-length" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" min="1" max="31" value="6">
                        </div>
                        <div>
                            <label for="edit-team-anchor-date" class="block text-sm font-medium text-gray-700">Pattern Anchor Date</label>
                            <input type="date" id="edit-team-anchor-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm" required>
                            <p class="mt-1 text-xs text-gray-500">The "Day 1" of the rotation.</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Visual Pattern</label>
                        <p class="mt-1 text-xs text-gray-500">Click the cells below to set the repeating pattern.</p>
                        <div id="visual-pattern-cells" class="mt-2 flex flex-wrap gap-2 p-3 bg-gray-50 rounded-lg border">
                        </div>
                    </div>
                    <div id="edit-team-error" class="text-red-600 text-sm"></div>
                    <div class="text-right">
                        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <!-- Delete Team Confirmation Modal -->
    <div id="delete-team-confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
            <h3 class="text-xl font-semibold text-red-700">Confirm Team Deletion</h3>
            <p class="my-4 text-gray-600">Are you sure you want to delete <strong id="delete-team-modal-name"></strong>?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-team-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-delete-team-btn" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm Delete</button>
            </div>
        </div>
    </div>

    <!-- Print Options Modal -->
    <div id="print-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm mx-4 modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Print Roster</h3>
                <button id="close-print-modal" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <p class="text-gray-600 mb-4">Select which staff to include in the printout.</p>
            <div class="space-y-3">
                <button id="print-all-visible-btn" class="w-full px-5 py-3 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition duration-150 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    <span>Print All Visible Staff</span>
                </button>
                <button id="print-selected-btn" class="w-full px-5 py-3 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition duration-150 flex items-center justify-center space-x-2" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>

                    <span>Print Selected Staff (0)</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Daily Attendance List Modal -->
    <div id="daily-list-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-start justify-center z-50 hidden p-4 overflow-y-auto">
        <div id="daily-list-modal-content" class="bg-white rounded-2xl shadow-xl w-full max-w-5xl modal-fade-in mt-10"> <!-- MODIFIED: max-w-3xl to max-w-5xl -->
            <!-- Modal Header -->
            <div id="daily-list-header" class="flex justify-between items-center p-5 border-b border-gray-200">
                <div class="flex items-center space-x-4">
                    <h3 class="text-xl font-semibold text-gray-900">Daily Attendance List</h3>
                    <input type="date" id="daily-list-date" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div class="flex items-center space-x-2">
                    <button id="print-daily-list-btn" class="p-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                    </button>
                    <button id="close-daily-list-modal" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <button id="manage-units-btn" class="px-3 py-1 bg-gray-700 text-white rounded-lg shadow hover:bg-gray-800 transition text-sm">Manage Units</button>
                    <button id="add-adhoc-row-btn" class="px-3 py-1 bg-green-700 text-white rounded-lg shadow hover:bg-green-800 transition text-sm">+ Ad-hoc Row</button>
                    <button id="save-adhoc-btn" class="px-3 py-1 bg-indigo-700 text-white rounded-lg shadow hover:bg-indigo-800 transition text-sm">Save Ad-hoc</button>
                </div>
            </div>
            
            <!-- Print-Only Header -->
            <div id="daily-list-print-header" class="hidden p-4 border-b border-gray-300">
                <h1 class="text-2xl font-bold text-center">Daily Attendance Roster</h1>
                <h2 id="daily-list-print-date" class="text-lg font-semibold text-center text-gray-700"></h2>
            </div>

            <!-- Modal Body -->
            <div id="daily-list-content" class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Content generated by JavaScript -->
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, 
            collection, query, getDocs, writeBatch, setLogLevel,
            updateDoc, deleteField, limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. FIREBASE SETUP ---
        let firebaseConfig;
        const standaloneConfig = {
            apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
            authDomain: "roster-4a997.firebaseapp.com",
            projectId: "roster-4a997",
            storageBucket: "roster-4a997.firebasestorage.app",
            messagingSenderId: "901381868881",
            appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };

        if (typeof __firebase_config !== 'undefined') {
            console.log("Using environment-provided Firebase config.");
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            console.log("Using standalone Firebase config.");
            firebaseConfig = standaloneConfig;
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('Debug');

        // Firestore collection references
        let teamsCollection, employeesCollection, rosterCollection, shiftCodesCollection;
        let shiftCodesDocRef; // Single doc for all shift codes

        // Local data cache
        let teamsMap = new Map();
        let employeeData = [];
        let rosterData = {};
        let isDataLoaded = false;
        let selectedEmployeeIds = new Set();
        let tempPatternArray = [];
        
        // --- 1. DATA DEFINITIONS ---
        // UPDATED: Added 'hours' property to each shift code
        const defaultShiftCodes = {
            '1':    { text: '1',    color: 'bg-white', textColor: 'text-gray-800', isDefault: true, hours: 8 },
            '2':    { text: '2',    color: 'bg-white', textColor: 'text-gray-800', isDefault: true, hours: 8 },
            '1A':   { text: '1A',   color: 'bg-teal-100', textColor: 'text-teal-800', isDefault: true, hours: 12 },
            '2N':   { text: '2N',   color: 'bg-yellow-200', textColor: 'text-yellow-800', isDefault: true, hours: 12 },
            'OFF':  { text: 'OFF',  color: 'bg-green-200', textColor: 'text-green-800', isDefault: true, hours: 0 },
            'AL':   { text: 'AL',   color: 'bg-blue-200', textColor: 'text-blue-800', isDefault: true, hours: 0 },
            'AD':   { text: 'AD',   color: 'bg-cyan-200', textColor: 'text-cyan-800', isDefault: true, hours: 0 },
            'PPT':  { text: 'PPT',  color: 'bg-lime-200', textColor: 'text-lime-800', isDefault: true, hours: 0 },
            'PCT':  { text: 'PCT',  color: 'bg-orange-200', textColor: 'text-orange-800', isDefault: true, hours: 0 },
            'BCLS': { text: 'BCLS', color: 'bg-red-200', textColor: 'text-red-800', isDefault: true, hours: 0 },
            '_EMPTY': { text: '',   color: 'bg-gray-50', textColor: 'text-gray-400', isDefault: true, hours: 0 } // Empty
        };
        let shiftCodesMap = { ...defaultShiftCodes };

        const colorOptions = {
            'Amber': { color: 'bg-amber-200', textColor: 'text-amber-800' },
            'Blue': { color: 'bg-blue-200', textColor: 'text-blue-800' },
            'Cyan': { color: 'bg-cyan-200', textColor: 'text-cyan-800' },
            'Emerald': { color: 'bg-emerald-200', textColor: 'text-emerald-800' },
            'Fuchsia': { color: 'bg-fuchsia-200', textColor: 'text-fuchsia-800' },
            'Gray': { color: 'bg-gray-200', textColor: 'text-gray-800' },
            'Green': { color: 'bg-green-200', textColor: 'text-green-800' },
            'Indigo': { color: 'bg-indigo-200', textColor: 'text-indigo-800' },
            'Lime': { color: 'bg-lime-200', textColor: 'text-lime-800' },
            'Orange': { color: 'bg-orange-200', textColor: 'text-orange-800' },
            'Pink': { color: 'bg-pink-200', textColor: 'text-pink-800' },
            'Purple': { color: 'bg-purple-200', textColor: 'text-purple-800' },
            'Red': { color: 'bg-red-200', textColor: 'text-red-800' },
            'Rose': { color: 'bg-rose-200', textColor: 'text-rose-800' },
            'Sky': { color: 'bg-sky-200', textColor: 'text-sky-800' },
            'Stone': { color: 'bg-stone-200', textColor: 'text-stone-800' },
            'Teal': { color: 'bg-teal-100', textColor: 'text-teal-800' }, // Original
            'Violet': { color: 'bg-violet-200', textColor: 'text-violet-800' },
            'White': { color: 'bg-white', textColor: 'text-gray-800' }, // Original
            'Yellow': { color: 'bg-yellow-200', textColor: 'text-yellow-800' },
        };
        
        const patternAnchorDate = '2025-01-01';
        const defaultPattern = ['1', '1', '2', '2', 'OFF', 'OFF'];
        
        // --- 2. STATE & CONSTANTS ---
        let currentYear = 2025;
        let currentMonth = 10; // 0-indexed (10 = November)
        const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        
        let currentCellElement = null; // Used for modal updates
        let currentEmployeeId = null;
        let currentFullDate = null;
        let employeeIdToDelete = null;
        let teamIdToDelete = null;
        let visibleTeamIDs = new Set();
        let visibleEmployeeIDs = new Set(); 

        // --- 3. DOM ELEMENTS ---
        let grid, monthYearEl, prevMonthBtn, nextMonthBtn, loadingState, rosterContainer,
            headerActions, batchDeleteContainer, batchDeleteBtn, batchDeleteConfirmModal,
            batchDeleteCount, batchDeleteList, cancelBatchDeleteBtn, confirmBatchDeleteBtn,
            modal, closeModalBtn, shiftOptionsContainer, modalDate,
            setAutoShiftBtn, patternShiftModal, closePatternModalBtn, patternShiftOptionsContainer,
            patternModalDay, addEmployeeBtn, addEmployeeModal, closeAddModalBtn,
            addEmployeeForm, teamSelect, addError, deleteConfirmModal, cancelDeleteBtn,
            confirmDeleteBtn, deleteModalName, deleteModalId, manageTeamsBtn,
            manageTeamsModal, closeTeamsModalBtn, addTeamForm, newTeamNameInput,
            addTeamError, deleteTeamError, teamListUl, editTeamModal, closeEditTeamModalBtn,
            editTeamForm, editTeamId, editTeamName, editTeamPatternLength,
            editTeamAnchorDate, visualPatternCells, editTeamError, deleteTeamConfirmModal,
            cancelDeleteTeamBtn_TEAM, confirmDeleteTeamBtn_TEAM, 
            deleteTeamModalName,
            modalEmployeeNameInput, modalEmployeeIdInput, saveDetailsBtn, saveDetailsStatus, 
            manageLabelsBtn, manageLabelsModal, closeLabelsModalBtn, addLabelForm, 
            newLabelText, newLabelColor, newLabelHours, // <-- NEW: Added newLabelHours
            addLabelColorGrid, addLabelError, 
            deleteLabelError, labelListUl,
            teamFilterBtn, teamFilterDropdown, teamFilterList, selectAllTeamsCheckbox,
            manageMenuBtn, manageDropdown,
            modalEmployeeRoleInput, modalEmployeeStarInput,
            manageStaffBtn, manageStaffModal, manageStaffList, closeManageStaffModalBtn,
            nameFilterBtn, nameFilterDropdown, nameFilterSearch, nameFilterList,
            selectAllNamesBtn, unselectAllNamesBtn,
            editLabelModal, closeEditLabelModalBtn, editLabelForm, editLabelKey, 
            editLabelText, editLabelColor, editLabelHours, // <-- NEW: Added editLabelHours
            editLabelColorGrid, editLabelError,
            employeeCalendarModal, employeeCalendarName, employeeCalendarDetails, 
            employeeCalendarWeekdays, employeeCalendarGrid, closeEmployeeCalendarBtn,
            confirmModal, confirmModalTitle, confirmModalBody, confirmModalCancel, confirmModalConfirm,
            // Print Modal Elements
            printBtn, printModal, closePrintModalBtn, printAllVisibleBtn, printSelectedBtn,
            // NEW: Daily List Modal Elements
            dailyListBtn, dailyListModal, closeDailyListModalBtn, dailyListDate,
            dailyListContent, printDailyListBtn, dailyListPrintDate;


        // --- 4. HELPER FUNCTIONS ---
        // === SHIFT/AUTO-TIME + UNITS GLOBALS ===
        const SHIFT_TIME_RULES = {
            morning: { codes: ['1','1A'], start: '08:00', end: '20:00' },
            night:   { codes: ['2','2N'], start: '20:00', end: '08:00' }
        };
        function getStartEndByShiftCode(code){
            if(!code) return {start:'',end:''};
            const c=String(code).toUpperCase().trim();
            if (SHIFT_TIME_RULES.morning.codes.includes(c)) return {start:'08:00', end:'20:00'};
            if (SHIFT_TIME_RULES.night.codes.includes(c))   return {start:'20:00', end:'08:00'};
            return {start:'', end:''};
        }
        // Units list persisted locally (does not touch DB)
        const DEFAULT_UNITS = ["PCC","DIVISION SUPPORT","OPS","HQ","BUFFER"];
        function loadUnits(){ try { return JSON.parse(localStorage.getItem('unitsList')) || DEFAULT_UNITS.slice(); } catch(e){ return DEFAULT_UNITS.slice(); } }
        function saveUnits(list){ localStorage.setItem('unitsList', JSON.stringify(list)); }
        let unitsList = loadUnits();
        // Ad-hoc rows per-date
        const adhocKeyForDate = (isoDate)=> `dailyAdhoc:${isoDate}`;
        const loadAdhocRows = (d)=> { try { return JSON.parse(localStorage.getItem(adhocKeyForDate(d))) || []; } catch(e){ return []; } };
        const saveAdhocRows = (d, rows)=> localStorage.setItem(adhocKeyForDate(d), JSON.stringify(rows||[]));

        function getDaysBetween(dateStr1, dateStr2) {
            try {
                const [y1, m1, d1] = dateStr1.split('-').map(Number);
                const [y2, m2, d2] = dateStr2.split('-').map(Number);
                const utcDate1 = Date.UTC(y1, m1 - 1, d1);
                const utcDate2 = Date.UTC(y2, m2 - 1, d2);
                if (isNaN(utcDate1) || isNaN(utcDate2)) { return 0; }
                return Math.round((utcDate1 - utcDate2) / 86400000);
            } catch (e) { console.error("Error in getDaysBetween", e); return 0; }
        }

        function createCell(text, classes) {
            const cell = document.createElement('div');
            cell.className = classes;
            cell.textContent = text;
            return cell;
        }

        function getStarSortValue(emp) {
            if (emp.star === 'blue') return 1;      // Team Leader (I/C)
            if (emp.star === 'yellow') return 2;    // Section I/C (Assistant)
            return 3;                               // Normal
        }

        function getRoleSortValue(role) {
            switch (role) {
                case 'leader': return 1;
                case 'Section I/C': return 2;
                default: return 3;
            }
        }
        
        function getRoleDisplayName(role) {
            switch (role) {
                case 'leader': return 'Team Leader';
                case 'Section I/C': return 'Section I/C (Assistant)';
                default: return 'Member';
            }
        }

        function showConfirmationModal(title, body, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalBody.innerHTML = body; // Use innerHTML for strong tags
            
            const newConfirmBtn = confirmModalConfirm.cloneNode(true);
            confirmModalConfirm.parentNode.replaceChild(newConfirmBtn, confirmModalConfirm);
            confirmModalConfirm = newConfirmBtn;
            
            confirmModalConfirm.onclick = () => { 
                onConfirm(); 
                confirmModal.classList.add('hidden'); 
            };
            
            confirmModal.classList.remove('hidden');
        }

        function getShiftForEmployee(emp, fullDate) {
            if (!shiftCodesMap['_EMPTY']) {
                shiftCodesMap['_EMPTY'] = defaultShiftCodes['_EMPTY'];
            }
            const emptyShiftInfo = shiftCodesMap['_EMPTY'];
            const getShiftInfo = (code) => shiftCodesMap[code] || { ...emptyShiftInfo, text: code }; // Handle missing codes gracefully

            const empRoster = rosterData[emp.id] || {};
            const manualShift = empRoster[fullDate]; 
            let shift = '', shiftInfo = null, isAuto = false;

            if (manualShift !== undefined) {
                shift = manualShift;
                shiftInfo = getShiftInfo(shift);
            } else {
                const team = teamsMap.get(emp.team_id);
                if (team && team.shiftPattern && team.shiftPattern.length > 0) {
                    const pattern = team.shiftPattern;
                    const anchorDate = team.patternStartDate || patternAnchorDate;
                    const daysSinceAnchor = getDaysBetween(fullDate, anchorDate);
                    const patternIndex = (daysSinceAnchor % pattern.length + pattern.length) % pattern.length;
                    shift = pattern[patternIndex];
                    shiftInfo = getShiftInfo(shift);
                    isAuto = true;
                } else {
                    shiftInfo = emptyShiftInfo;
                }
            }
            return { shift, shiftInfo, isAuto };
        }
        
        // --- NEW: Daily List Functions ---
        function openDailyListModal() {
            const today = new Date();
            // Adjust for timezone offset to get local date in YYYY-MM-DD format
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            dailyListDate.value = today.toISOString().split('T')[0];
            
            renderDailyList();
            dailyListModal.classList.remove('hidden');
        }

        function closeDailyListModal() {
            dailyListModal.classList.add('hidden');
        }

        // === MODIFIED: renderDailyList() function ===
        function renderDailyList() {
            const selectedDate = dailyListDate.value;
            if (!selectedDate) {
                dailyListContent.innerHTML = `<p class="text-gray-500">Please select a date.</p>`;
                return;
            }
            
            const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            dailyListPrintDate.textContent = formattedDate;

            const shiftGroups = {};
            let totalStaff = 0;

            const visibleEmployees = employeeData.filter(emp => 
                visibleTeamIDs.has(emp.team_id) && visibleEmployeeIDs.has(emp.id)
            );
            
            // Sort employees by team, then role, then name
             visibleEmployees.sort((a, b) => {
                const teamAName = teamsMap.get(a.team_id)?.name || 'Unassigned';
                const teamBName = teamsMap.get(b.team_id)?.name || 'Unassigned';
                if (teamAName !== teamBName) return teamAName.localeCompare(teamBName);

                // First: sort by STAR priority
                const starA = getStarSortValue(a);
                const starB = getStarSortValue(b);
                if (starA !== starB) return starA - starB;

                // Then: sort by ROLE (leader / Section I/C / member)
                const roleAValue = getRoleSortValue(a.role);
                const roleBValue = getRoleSortValue(b.role);
                if (roleAValue !== roleBValue) return roleAValue - roleBValue;

                // Finally: by name
                return (a.name || '').localeCompare(b.name || '');
            });

            visibleEmployees.forEach(emp => {
                const { shiftInfo } = getShiftForEmployee(emp, selectedDate);
                const key = shiftInfo.text || 'Unassigned';
                
                if (!shiftGroups[key]) {
                    shiftGroups[key] = {
                        info: shiftInfo,
                        employees: []
                    };
                }
                shiftGroups[key].employees.push(emp);
                totalStaff++;
            });

            let html = `<h2 class="text-xl font-semibold mb-4">Attendance for ${formattedDate} (${totalStaff} Total Staff)</h2>`;
            
            const sortedKeys = Object.keys(shiftGroups).sort((a, b) => {
                // Sort 'OFF' and 'AL' to the bottom
                if (a === 'OFF' || a === 'AL') return 1;
                if (b === 'OFF' || b === 'AL') return -1;
                // Sort 'Unassigned' to the very bottom
                if (a === 'Unassigned') return 1;
                if (b === 'Unassigned') return -1;
                return a.localeCompare(b);
            });

            // Build options for Unit dropdown once
            const unitOptionsHtml = unitsList.map(u=>`<option>${u}</option>`).join('');

            if (sortedKeys.length === 0) {
                html += `<p class="text-gray-500">No visible staff for this date.</p>`;
                dailyListContent.innerHTML = html;
                return;
            }

            for (const key of sortedKeys) {
                const group = shiftGroups[key];
                const shiftInfo = group.info;
                const employees = group.employees;
                
                // NEW: Logic for Start and End Times based on Shift
                let startTime = '';
                let endTime = '';
                const codeUpper = String(shiftInfo.text||'').toUpperCase();
                if (['1','1A','AM','AM SHIFT','MORNING'].includes(codeUpper)) {
                    startTime = '08:00'; endTime = '20:00';
                } else if (['2','2N','PM','NIGHT','NIGHT SHIFT'].includes(codeUpper)) {
                    startTime = '20:00'; endTime = '08:00';
                }
                // Other shifts will remain blank

                html += `
                    <div class="mb-6">
                        <h3 class="shift-group-header text-lg font-bold p-3 rounded-t-lg ${shiftInfo.color} ${shiftInfo.textColor}">
                            ${shiftInfo.text || 'Unassigned'} 
                            <span class="font-medium">(${employees.length} Staff)</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">SN</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Emp ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Team</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Role</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Unit</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Start Time</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">End Time</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                `;

                employees.forEach((emp, index) => {
                    const teamName = teamsMap.get(emp.team_id)?.name || 'N/A';
                    html += `
                        <tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${index + 1}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${emp.emp_id || ''}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${emp.name}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${teamName}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${getRoleDisplayName(emp.role)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                                <select class="daily-unit-select w-full border border-gray-300 rounded px-1 py-0.5">
                                    ${unitOptionsHtml}
                                </select>
                            </td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${startTime}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${endTime}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                                <!-- Empty for remarks -->
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            // Append Ad-hoc section
            const adhocRows = loadAdhocRows(selectedDate);
            html += `
                <div class="mb-6">
                    <h3 class="shift-group-header text-lg font-bold p-3 rounded-t-lg bg-gray-700 text-white">
                        AD-HOC (Local Only) <span class="font-medium">(${adhocRows.length} Rows)</span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table id="adhoc-table" class="min-w-full divide-y divide-gray-200 border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 w-12 text-xs text-gray-500 uppercase">SN</th>
                                    <th class="px-4 py-2 w-32 text-xs text-gray-500 uppercase">Emp ID</th>
                                    <th class="px-4 py-2 text-xs text-gray-500 uppercase">Name</th>
                                    <th class="px-4 py-2 w-24 text-xs text-gray-500 uppercase">Rank</th>
                                    <th class="px-4 py-2 w-40 text-xs text-gray-500 uppercase">Team</th>
                                    <th class="px-4 py-2 w-32 text-xs text-gray-500 uppercase">Role</th>
                                    <th class="px-4 py-2 w-28 text-xs text-gray-500 uppercase">Unit</th>
                                    <th class="px-4 py-2 w-24 text-xs text-gray-500 uppercase">Start</th>
                                    <th class="px-4 py-2 w-24 text-xs text-gray-500 uppercase">End</th>
                                    <th class="px-4 py-2 w-40 text-xs text-gray-500 uppercase">Remarks</th>
                                    <th class="px-4 py-2 w-20 text-xs text-gray-500 uppercase"></th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>`;
            dailyListContent.innerHTML = html;
            // Fill adhoc body now (needs DOM)
            const adhocTBody = document.querySelector('#adhoc-table tbody');
            if (adhocTBody){
                const unitOptionsHtmlLocal = unitsList.map(u=>`<option>${u}</option>`).join('');
                adhocRows.forEach((r, i)=>{
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-2 text-sm text-gray-700 text-center">${i+1}</td>
                        <td class="px-4 py-2 text-sm text-gray-700" contenteditable="true">${r.emp_id||''}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 font-medium" contenteditable="true">${r.name||''}</td>
                        <td class="px-4 py-2 text-sm text-gray-700" contenteditable="true">${r.rank||''}</td>
                        <td class="px-4 py-2 text-sm text-gray-700" contenteditable="true">${r.team||''}</td>
                        <td class="px-4 py-2 text-sm text-gray-700" contenteditable="true">${r.role||''}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">
                            <select class="daily-unit-select w-full border border-gray-300 rounded px-1 py-0.5">
                                ${unitOptionsHtmlLocal}
                            </select>
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-700" contenteditable="true">${r.start||''}</td>
                        <td class="px-4 py-2 text-sm text-gray-700" contenteditable="true">${r.end||''}</td>
                        <td class="px-4 py-2 text-sm text-gray-700" contenteditable="true">${r.remarks||'ADHOC'}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 text-center">
                            <button class="del-adhoc px-2 py-1 text-xs bg-red-600 text-white rounded" data-idx="${i}">Delete</button>
                        </td>
                    `;
                    tr.querySelector('select').value = r.unit || (unitsList[0]||'PCC');
                    adhocTBody.appendChild(tr);
                });
                adhocTBody.querySelectorAll('.del-adhoc').forEach(btn=>{
                    btn.onclick=(e)=>{
                        const idx = Number(e.currentTarget.dataset.idx);
                        const d = dailyListDate.value;
                        const rows = loadAdhocRows(d);
                        rows.splice(idx,1);
                        saveAdhocRows(d, rows);
                        renderDailyList();
                    };
                });
            }
        }
        // === END of MODIFIED renderDailyList() ===
        
        function printDailyList() {
            document.body.classList.add('printing-daily-list');
            window.print();
        }

        // === Manage Units wiring ===
        (function(){
            const manageUnitsBtn = document.getElementById('manage-units-btn');
            const manageUnitsModal = document.getElementById('manage-units-modal');
            const closeManageUnits = document.getElementById('close-manage-units');
            const unitsUl = document.getElementById('units-ul');
            const newUnitInput = document.getElementById('new-unit-input');
            const addUnitBtn = document.getElementById('add-unit-btn');
            function renderUnitsList(){
              if(!unitsUl) return;
              unitsUl.innerHTML='';
              unitsList.forEach((u,idx)=>{
                const li=document.createElement('li');
                li.className='flex items-center justify-between px-3 py-2';
                li.innerHTML=`<span class="text-sm">${u}</span>
                  <button data-idx="${idx}" class="rm-unit px-2 py-1 text-xs bg-red-600 text-white rounded">Delete</button>`;
                unitsUl.appendChild(li);
              });
              unitsUl.querySelectorAll('.rm-unit').forEach(btn=>{
                btn.onclick=(e)=>{
                  const i=Number(e.currentTarget.dataset.idx);
                  unitsList.splice(i,1); saveUnits(unitsList); renderUnitsList();
                  // refresh dropdowns
                  if (typeof renderDailyList==='function') renderDailyList();
                };
              });
            }
            if (manageUnitsBtn){
              manageUnitsBtn.onclick = ()=>{ renderUnitsList(); manageUnitsModal.classList.remove('hidden'); };
            }
            if (closeManageUnits){ closeManageUnits.onclick = ()=> manageUnitsModal.classList.add('hidden'); }
            if (addUnitBtn){
              addUnitBtn.onclick = ()=>{
                const v=(newUnitInput.value||'').trim(); if(!v) return;
                if(!unitsList.includes(v)) unitsList.push(v); saveUnits(unitsList); newUnitInput.value=''; renderUnitsList(); 
                if (typeof renderDailyList==='function') renderDailyList();
              };
            }
        })();

        // === Ad-hoc handling ===
        (function(){
            const addBtn = document.getElementById('add-adhoc-row-btn');
            const saveBtn = document.getElementById('save-adhoc-btn');
            if (addBtn){
              addBtn.onclick = ()=>{
                const d = dailyListDate.value;
                const rows = loadAdhocRows(d);
                rows.push({emp_id:'',name:'',rank:'',team:'',role:'',unit: unitsList[0]||'PCC', start:'', end:'', remarks:'ADHOC'});
                saveAdhocRows(d, rows);
                renderDailyList();
              };
            }
            if (saveBtn){
              saveBtn.onclick = ()=>{
                const d = dailyListDate.value;
                const table = document.getElementById('adhoc-table');
                if (!table){ /* alert('No ad-hoc rows.'); */ console.log('No ad-hoc rows.'); return; }
                const rows=[];
                table.querySelectorAll('tbody tr').forEach(tr=>{
                  const tds = tr.querySelectorAll('td');
                  rows.push({
                    emp_id: tds[1].innerText.trim(),
                    name: tds[2].innerText.trim(),
                    rank: tds[3].innerText.trim(),
                    team: tds[4].innerText.trim(),
                    role: tds[5].innerText.trim(),
                    unit: tds[6].querySelector('select')?.value || '',
                    start: tds[7].innerText.trim(),
                    end:   tds[8].innerText.trim(),
                    remarks: tds[9].innerText.trim(),
                  });
                });
                saveAdhocRows(d, rows);
                // alert('Ad-hoc entries saved for '+d);
                console.log('Ad-hoc entries saved for '+d);
                renderDailyList();
              };
            }
        })();

        // --- End of Daily List Functions ---

        // --- 5. CORE RENDER FUNCTIONS ---

        function renderRoster() {
            if (!isDataLoaded || !grid) return;
            
            const date = new Date(currentYear, currentMonth);
            monthYearEl.textContent = `${date.toLocaleString('default', { month: 'long' })} ${currentYear}`;
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            grid.innerHTML = ''; // Clear the main container
            
            const visibleEmployees = employeeData.filter(emp => 
                visibleTeamIDs.has(emp.team_id) && visibleEmployeeIDs.has(emp.id)
            );

            if (visibleEmployees.length === 1) {
                grid.style.gridTemplateColumns = '1fr';
                grid.classList.remove('grid');
                renderSingleEmployeeCalendarView(visibleEmployees[0], daysInMonth);
            } else {
                // UPDATED: Added new 80px column for Total Hours
                grid.style.gridTemplateColumns = `100px 80px minmax(180px, 1fr) 80px repeat(${daysInMonth}, minmax(60px, 1fr))`;
                grid.classList.add('grid');
                renderMultiEmployeeGridView(visibleEmployees, daysInMonth);
            }
        }
        
        function renderMultiEmployeeGridView(visibleEmployees, daysInMonth) {
            
            // A. Render Header Row
            grid.appendChild(createCell('Service ID', 'header-cell font-semibold text-sm text-gray-700 p-3 border-b border-l border-gray-200 min-w-[100px] sm:min-w-[120px]'));
            grid.appendChild(createCell('Emp ID', 'sticky-header-col font-semibold text-sm text-gray-700 p-3 border-b border-l border-gray-200 min-w-[80px] sm:min-w-[100px]'));
            const nameHeader = document.createElement('div');
            nameHeader.className = 'header-cell font-semibold text-sm text-gray-700 p-3 border-b border-l border-gray-200 flex items-center space-x-3 min-w-[150px] sm:min-w-[200px]';
            nameHeader.innerHTML = `
                <input type="checkbox" id="select-all-checkbox" class="emp-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="select-all-checkbox" class="cursor-pointer">Employee Name</label>
            `;
            // RENAMED: Changed listener to the new function name
            nameHeader.querySelector('#select-all-checkbox').addEventListener('change', (e) => handleRosterSelectAll(e.target.checked));
            grid.appendChild(nameHeader);
            
            // NEW: Add Total Hours Header
            grid.appendChild(createCell('Total Hrs', 'header-cell font-semibold text-sm text-gray-700 p-3 border-b border-l border-gray-200 min-w-[80px] text-center'));

            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(currentYear, currentMonth, day);
                const dayName = weekdays[d.getDay()];
                const headerCell = document.createElement('div');
                headerCell.className = 'header-cell text-center p-2 border-b border-l border-gray-200';
                headerCell.innerHTML = `
                    <span class="text-lg font-bold block ${dayName === 'SAT' || dayName === 'SUN' ? 'text-red-500' : ''}">${day}</span>
                    <span class="text-xs text-gray-500 font-medium block">${dayName}</span>
                `;
                grid.appendChild(headerCell);
            }
            
            // B. Render Employee Rows
            let currentTeamName = '';
            
            visibleEmployees.sort((a, b) => {
                const teamAName = teamsMap.get(a.team_id)?.name || 'Unassigned';
                const teamBName = teamsMap.get(b.team_id)?.name || 'Unassigned';
                if (teamAName !== teamBName) return teamAName.localeCompare(teamBName);
                const roleAValue = getRoleSortValue(a.role);
                const roleBValue = getRoleSortValue(b.role);
                if (roleAValue !== roleBValue) return roleAValue - roleBValue;
                return (a.id || '').localeCompare(b.id || '');
            });
            
            if (visibleEmployees.length === 0) {
                 // UPDATED: Added 1 to span
                 const noDataCell = createCell('No employees to display. Check your team and name filters.', 'text-center p-6 text-gray-500');
                 noDataCell.style.gridColumn = `span ${4 + daysInMonth}`;
                 grid.appendChild(noDataCell);
            }

            visibleEmployees.forEach(emp => {
                const team = teamsMap.get(emp.team_id);
                const teamName = team?.name || 'Unassigned';

                if (teamName !== currentTeamName) {
                    currentTeamName = teamName;
                    // UPDATED: Added 1 to span
                    const teamHeader = createCell(currentTeamName, 'team-header-row text-left p-3 font-bold text-base text-indigo-700 bg-indigo-50 border-t border-b border-indigo-200');
                    teamHeader.style.gridColumn = `span ${4 + daysInMonth}`;
                    teamHeader.dataset.teamId = emp.team_id; 
                    grid.appendChild(teamHeader);
                }
                
                const rowCells = [];

                // Service ID Cell
                const empServiceIdCell = createCell(emp.id, 'employee-row text-sm p-3 border-b border-l border-gray-200 text-gray-600 min-w-[100px] sm:min-w-[120px]');
                empServiceIdCell.dataset.empId = emp.id;
                rowCells.push(grid.appendChild(empServiceIdCell));
                
                // Emp ID Cell (Sticky)
                const empShortIdCell = createCell(emp.emp_id || '', 'employee-row sticky-col text-sm p-3 border-b border-l border-gray-200 text-gray-600 min-w-[80px] sm:min-w-[100px]');
                empShortIdCell.dataset.empId = emp.id;
                rowCells.push(grid.appendChild(empShortIdCell));
                
                // Name Cell
                let roleIcon = '';
                if (emp.star === 'blue') {
                    // Team Leader (I/C) – BIG BLUE STAR
                    roleIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-7 w-7 text-blue-500"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             title="Team Leader (I/C)">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.54-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                    `;
                } else if (emp.star === 'yellow') {
                    // Section I/C (Assistant) – standard size YELLOW STAR
                    roleIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-5 w-5 text-yellow-400"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             title="Section I/C (Assistant)">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.54-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                    `;
                }
                const nameCell = document.createElement('div');
                nameCell.className = 'employee-row text-sm p-3 border-b border-gray-200 text-gray-700 font-medium flex justify-between items-center min-w-[150px] sm:min-w-[200px]';
                nameCell.dataset.empId = emp.id; 
                const nameContainer = document.createElement('div');
                nameContainer.className = 'flex items-center space-x-2 cursor-pointer';
                nameContainer.innerHTML = `
                    <input type="checkbox" class="emp-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-emp-id="${emp.id}">
                    ${roleIcon}
                    <span class="break-words whitespace-normal" title="${emp.name}">${emp.name}</span>
                `;
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-btn text-red-400 hover:text-red-700 font-bold text-xl ml-2 p-0 leading-none rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-100 opacity-0 transition-opacity duration-150';
                deleteButton.title = `Delete ${emp.name}`;
                deleteButton.innerHTML = '&#215;';
                nameCell.appendChild(nameContainer);
                nameCell.appendChild(deleteButton);
                nameCell.querySelector('.emp-checkbox').checked = selectedEmployeeIds.has(emp.id);
                nameCell.querySelector('.emp-checkbox').addEventListener('change', (e) => handleSelectEmployee(emp.id, e.target.checked));
                deleteButton.addEventListener('click', () => { openDeleteModal(emp.id, emp.name); });
                nameContainer.addEventListener('click', (e) => {
                    if (e.target.closest('input.emp-checkbox')) return;
                    openEmployeeCalendar(emp.id);
                });
                rowCells.push(grid.appendChild(nameCell));

                // C. NEW: Calculate Total Hours
                let totalHours = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    const fullDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const { shiftInfo } = getShiftForEmployee(emp, fullDate);
                    totalHours += (shiftInfo.hours || 0); // Add hours, default to 0 if not defined
                }

                // D. NEW: Append Total Hours Cell
                const totalHoursCell = createCell(totalHours + 'h', 'employee-row text-sm p-3 border-b border-l border-gray-200 font-bold text-center min-w-[80px] total-hours-cell text-blue-600');
                totalHoursCell.dataset.empId = emp.id;
                rowCells.push(grid.appendChild(totalHoursCell));


                // E. DYNAMIC ROSTER CELLS (Existing)
                for (let day = 1; day <= daysInMonth; day++) {
                    const fullDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const { shift, shiftInfo, isAuto } = getShiftForEmployee(emp, fullDate);
                    
                    const dataCell = createCell(shiftInfo.text, `employee-row text-center p-3 border-b border-l border-gray-200 cursor-pointer hover:bg-gray-100 transition duration-150 font-semibold ${shiftInfo.color} ${shiftInfo.textColor}`);
                    dataCell.dataset.empId = emp.id; 
                    if (isAuto) dataCell.classList.add('auto-shift');
                    dataCell.addEventListener('click', () => openModal(dataCell, emp.id, emp.name, fullDate));
                    rowCells.push(grid.appendChild(dataCell));
                }
                
                rowCells.forEach(cell => {
                    cell.addEventListener('mouseenter', () => rowCells.forEach(c => c.classList.add('bg-gray-50')));
                    cell.addEventListener('mouseleave', () => rowCells.forEach(c => c.classList.remove('bg-gray-50')));
                });
            });
            updateSelectAllCheckbox();
            if (typeof handleRosterScroll === 'function') {
                handleRosterScroll();
            }
        }

        function handleRosterScroll() {
            if (!grid || !grid.children || grid.children.length < 3) return;
            if (!grid.classList.contains('grid')) return;
            const scrollLeft = grid.scrollLeft;
            const firstCell = grid.children[0];
            if (!firstCell) return;
            const pinnedOffset = firstCell.offsetWidth;
            const newLeft = Math.max(0, pinnedOffset - scrollLeft);
            const empHeader = grid.children[1];
            if (empHeader) {
                empHeader.style.left = `${newLeft}px`;
            }
            const stickyIdCells = grid.querySelectorAll('.employee-row.sticky-col');
            stickyIdCells.forEach(cell => {
                cell.style.left = `${newLeft}px`;
            });
        }

        function renderSingleEmployeeCalendarView(emp, daysInMonth) {
            const team = teamsMap.get(emp.team_id);
            const teamName = team?.name || 'Unassigned';

            // NEW: Calculate Total Hours
            let totalHours = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const fullDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const { shiftInfo } = getShiftForEmployee(emp, fullDate);
                totalHours += (shiftInfo.hours || 0);
            }

            const infoHeader = document.createElement('div');
            infoHeader.className = 'p-4 bg-gray-50 border-b border-gray-200';
            // UPDATED: Added Total Hours to innerHTML
            infoHeader.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800">${emp.name}</h2>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600 mt-1">
                    <span><strong>Service ID:</strong> ${emp.id}</span>
                    <span><strong>Emp ID:</strong> ${emp.emp_id || 'N/A'}</span>
                    <span><strong>Team:</strong> ${teamName}</span>
                    <span class="font-bold text-indigo-600"><strong>Total:</strong> ${totalHours} Hours</span>
                </div>
            `;
            grid.appendChild(infoHeader);

            const calendarContainer = document.createElement('div');
            calendarContainer.className = 'grid grid-cols-7 gap-2 p-4';
            calendarContainer.style.gridAutoRows = 'minmax(6rem, auto)';

            weekdays.forEach(dayName => {
                calendarContainer.appendChild(
                    createCell(dayName, 'text-center text-sm font-medium text-gray-500 uppercase tracking-wider p-2')
                );
            });

            const firstDayOfWeek = new Date(currentYear, currentMonth, 1).getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                calendarContainer.appendChild(
                    createCell('', 'rounded-lg bg-gray-50/50')
                );
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const fullDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const { shift, shiftInfo, isAuto } = getShiftForEmployee(emp, fullDate);

                const dayCell = document.createElement('div');
                dayCell.className = 'rounded-lg p-2 flex flex-col bg-white border border-gray-200 cursor-pointer hover:bg-gray-50 transition duration-150';
                if (isAuto) dayCell.classList.add('auto-shift');
                
                const dateLabel = document.createElement('span');
                const weekdayIndex = new Date(currentYear, currentMonth, day).getDay();
                const weekend = (weekdayIndex === 0 || weekdayIndex === 6);
                dateLabel.className = `text-sm font-semibold ${weekend ? 'text-red-600' : 'text-gray-900'}`;
                dateLabel.textContent = day;
                
                dayCell.appendChild(dateLabel);

                const badgeWrapper = document.createElement('div');
                badgeWrapper.className = 'flex-1 flex items-center justify-center w-full';

                if (shiftInfo.text) {
                    const badge = document.createElement('span');
                    badge.className = `text-xs font-bold rounded-full px-2.5 py-0.5 ${shiftInfo.color} ${shiftInfo.textColor} ${isAuto ? 'opacity-60' : ''}`;
                    badge.textContent = shiftInfo.text;
                    
                    badgeWrapper.appendChild(badge);
                    dayCell.appendChild(badgeWrapper);
                }
                
                dayCell.addEventListener('click', () => {
                    openModal(dayCell, emp.id, emp.name, fullDate);
                });
                calendarContainer.appendChild(dayCell);
            }
            
            grid.appendChild(calendarContainer);
        }

        // --- 6. MODAL & DATA FUNCTIONS ---
        
        function openEmployeeCalendar(empId) {
            if (!employeeCalendarModal || !employeeCalendarName || !employeeCalendarDetails || !employeeCalendarWeekdays || !employeeCalendarGrid) return;
            
            const emp = employeeData.find(e => e.id === empId);
            if (!emp) return;

            employeeCalendarName.textContent = emp.name || '';
            const serviceId = emp.id || '';
            const empIdStr = emp.emp_id || '';
            const teamName = teamsMap.get(emp.team_id)?.name || 'Unassigned';
            
            // NEW: Calculate total hours for the modal
            const year = currentYear;
            const month = currentMonth;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let totalHours = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const { shiftInfo } = getShiftForEmployee(emp, fullDate);
                totalHours += (shiftInfo.hours || 0);
            }
            
            // UPDATED: Added Total Hours
            employeeCalendarDetails.textContent = `Service ID: ${serviceId}${empIdStr ? ' \u2022 Emp ID: ' + empIdStr : ''}${teamName ? ' \u2022 Team: ' + teamName : ''} \u2022 Total Hours: ${totalHours}`;
            
            employeeCalendarWeekdays.innerHTML = '';
            employeeCalendarGrid.innerHTML = '';
            
            const weekdayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            weekdayNames.forEach(dayName => {
                const headerCell = document.createElement('div');
                headerCell.className = 'text-center text-sm font-medium text-gray-500 uppercase tracking-wider';
                headerCell.textContent = dayName;
                employeeCalendarWeekdays.appendChild(headerCell);
            });
            
            const firstDayOfWeek = new Date(year, month, 1).getDay();
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'rounded-lg bg-gray-50/50 min-h-[6rem]';
                employeeCalendarGrid.appendChild(emptyCell);
            }
            
            const emptyShiftInfo = shiftCodesMap['_EMPTY'] || defaultShiftCodes['_EMPTY'];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const { shift, shiftInfo, isAuto } = getShiftForEmployee(emp, fullDate);
                
                const cell = document.createElement('div');
                cell.className = 'rounded-lg p-2 min-h-[6rem] flex flex-col bg-white border border-gray-200 transition-colors hover:bg-gray-50';

                const dateLabel = document.createElement('span');
                const weekdayIndex = new Date(year, month, day).getDay();
                const weekend = (weekdayIndex === 0 || weekdayIndex === 6);
                dateLabel.className = `text-sm font-semibold ${weekend ? 'text-red-600' : 'text-gray-900'}`;
                dateLabel.textContent = day;
                
                cell.appendChild(dateLabel);
                
                const badgeWrapper = document.createElement('div');
                badgeWrapper.className = 'flex-1 flex items-center justify-center w-full';
                
                const badge = document.createElement('span');
                badge.className = `text-xs font-bold rounded-full px-2.5 py-0.5 ${shiftInfo.color} ${shiftInfo.textColor} ${isAuto ? 'opacity-60' : ''}`;
                badge.textContent = shiftInfo.text || '';
                
                badgeWrapper.appendChild(badge);

                if (shiftInfo.text) {
                    cell.appendChild(badgeWrapper);
                }
                employeeCalendarGrid.appendChild(cell);
            }
            employeeCalendarModal.classList.remove('hidden');
        }

        function closeEmployeeCalendar() {
            if (employeeCalendarModal) {
                employeeCalendarModal.classList.add('hidden');
            }
        }


        function openModal(cellElement, empId, empName, fullDate) {
            currentCellElement = cellElement;
            currentEmployeeId = empId;
            currentFullDate = fullDate;
            
            const emp = employeeData.find(e => e.id === empId);
            if (emp) {
                modalEmployeeNameInput.value = emp.name;
                modalEmployeeIdInput.value = emp.emp_id || '';
                modalEmployeeRoleInput.value = emp.role || 'member';
                modalEmployeeStarInput.value = emp.star || 'none';
            } else {
                modalEmployeeNameInput.value = empName;
                modalEmployeeIdInput.value = '';
                modalEmployeeRoleInput.value = 'member';
                modalEmployeeStarInput.value = 'none';
            }
            saveDetailsStatus.textContent = '';
            
            modalDate.textContent = new Date(fullDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            shiftOptionsContainer.innerHTML = '';
            Object.keys(shiftCodesMap).sort().forEach(code => {
                const shiftInfo = shiftCodesMap[code];
                const button = document.createElement('button');
                button.textContent = shiftInfo.text || 'Empty';
                button.className = `p-3 rounded-lg border font-medium transition duration-150 ${shiftInfo.color} ${shiftInfo.textColor} hover:shadow-md hover:ring-2 hover:ring-indigo-400`;
                button.addEventListener('click', () => selectShift(code));
                shiftOptionsContainer.appendChild(button);
            });
            
            setAutoShiftBtn.classList.remove('hidden');
            modal.classList.remove('hidden');
        }

        async function handleSaveEmployeeDetails() {
            const newName = modalEmployeeNameInput.value.trim();
            const newEmpId = modalEmployeeIdInput.value.trim();
            const newRole = modalEmployeeRoleInput.value;
            const newStar = modalEmployeeStarInput.value;
            
            if (!newName || !currentEmployeeId) return;

            saveDetailsBtn.disabled = true;
            saveDetailsStatus.textContent = 'Saving...';
            try {
                const empDocRef = doc(employeesCollection, currentEmployeeId);
                await updateDoc(empDocRef, { 
                    name: newName,
                    emp_id: newEmpId,
                    role: newRole,
                    star: newStar 
                });
                saveDetailsStatus.textContent = 'Saved!';
                renderRoster();
                setTimeout(() => { saveDetailsStatus.textContent = ''; }, 2000);
            } catch (error) {
                console.error("Error saving details: ", error);
                saveDetailsStatus.textContent = 'Error.';
                 setTimeout(() => { saveDetailsStatus.textContent = ''; }, 2000);
            } finally {
                saveDetailsBtn.disabled = false;
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        async function selectShift(shiftCode) {
            if (!currentEmployeeId || !currentFullDate) return;
            const rosterDocRef = doc(rosterCollection, currentEmployeeId);
            try {
                if (shiftCode === 'AUTO') {
                    await updateDoc(rosterDocRef, { [currentFullDate]: deleteField() });
                } else {
                    await setDoc(rosterDocRef, { [currentFullDate]: shiftCode }, { merge: true });
                }
                closeModal();
                renderRoster();
            } catch (error) {
                console.error("Error saving shift: ", error);
            }
        }
        
        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderRoster();
        }

        // --- Add/Delete Employee ---
        function openAddModal() {
            addError.textContent = '';
            teamSelect.innerHTML = '<option value="">Select a team...</option>';
            const sortedTeams = [...teamsMap.values()].sort((a, b) => a.name.localeCompare(b.name));
            sortedTeams.forEach(team => {
                teamSelect.innerHTML += `<option value="${team.docId}">${team.name}</option>`;
            });
            addEmployeeModal.classList.remove('hidden');
        }

        function closeAddModal() {
            addEmployeeModal.classList.add('hidden');
            addEmployeeForm.reset();
            addError.textContent = '';
        }

        async function handleAddEmployee(e) {
            e.preventDefault();
            addError.textContent = '';
            const newEmployee = {
                team_id: document.getElementById('emp-team-select').value,
                id: document.getElementById('emp-service-id').value.trim(),
                emp_id: document.getElementById('emp-short-id').value.trim(),
                name: document.getElementById('emp-name').value.trim(),
                patternOffset: 0,
                role: 'member'
            };
            if (!newEmployee.team_id) { addError.textContent = 'Error: Please select a team.'; return; }
            if (employeeData.some(emp => emp.id === newEmployee.id)) { addError.textContent = 'Error: Service ID already exists.'; return; }
            if (!newEmployee.id || !newEmployee.emp_id || !newEmployee.name) { addError.textContent = 'Error: All fields are required.'; return; }
            try {
                await setDoc(doc(employeesCollection, newEmployee.id), {...newEmployee, docId: newEmployee.id});
                closeAddModal();
            } catch (error) {
                 console.error("Error adding employee: ", error);
                 addError.textContent = 'Error saving employee. Please try again.';
            }
        }

        function openDeleteModal(id, name) {
            employeeIdToDelete = id;
            deleteModalName.textContent = name;
            deleteModalId.textContent = id;
            deleteConfirmModal.classList.remove('hidden');
        }
        function closeDeleteModal() { deleteConfirmModal.classList.add('hidden'); }

        async function handleDeleteEmployee() {
            if (!employeeIdToDelete) return;
            try {
                const batch = writeBatch(db);
                batch.delete(doc(employeesCollection, employeeIdToDelete));
                batch.delete(doc(rosterCollection, employeeIdToDelete));
                await batch.commit();
                closeDeleteModal();
            } catch (error) {
                console.error("Error deleting employee: ", error);
            }
        }

        // --- Batch Delete ---
        function handleSelectEmployee(empId, isChecked) {
            if (isChecked) selectedEmployeeIds.add(empId); else selectedEmployeeIds.delete(empId);
            updateBatchDeleteUI();
            updateSelectAllCheckbox();
        }

        // RENAMED: Old handleSelectAll is now handleRosterSelectAll
        function handleRosterSelectAll(isChecked) {
            const allCheckboxes = document.querySelectorAll('.emp-checkbox');
            const visibleEmployeeIDs_set = new Set(employeeData
                .filter(emp => visibleTeamIDs.has(emp.team_id) && visibleEmployeeIDs.has(emp.id))
                .map(emp => emp.id)
            );

            if (isChecked) {
                visibleEmployeeIDs_set.forEach(id => selectedEmployeeIds.add(id));
                allCheckboxes.forEach(cb => {
                    if (visibleEmployeeIDs_set.has(cb.dataset.empId)) {
                        cb.checked = true;
                    }
                });
            } else {
                visibleEmployeeIDs_set.forEach(id => selectedEmployeeIds.delete(id));
                allCheckboxes.forEach(cb => cb.checked = false);
            }
            updateBatchDeleteUI();
        }
        
        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select-all-checkbox');
            if (!selectAll) return; 

            const visibleEmployeeIDs_array = employeeData
                .filter(emp => visibleTeamIDs.has(emp.team_id) && visibleEmployeeIDs.has(emp.id))
                .map(emp => emp.id);
            
            const totalVisibleEmployees = visibleEmployeeIDs_array.length;
            const selectedVisibleEmployees = visibleEmployeeIDs_array.filter(id => selectedEmployeeIds.has(id)).length;

            if (totalVisibleEmployees > 0 && selectedVisibleEmployees === totalVisibleEmployees) {
                selectAll.checked = true; selectAll.indeterminate = false;
            } else if (selectedVisibleEmployees > 0) {
                selectAll.checked = false; selectAll.indeterminate = true;
            } else {
                selectAll.checked = false; selectAll.indeterminate = false;
            }
        }

        function updateBatchDeleteUI() {
            const count = selectedEmployeeIds.size;
            if (count > 0) {
                headerActions.classList.add('hidden');
                batchDeleteContainer.classList.remove('hidden');
                batchDeleteBtn.textContent = `Delete Selected (${count})`;
            } else {
                headerActions.classList.remove('hidden');
                batchDeleteContainer.classList.add('hidden');
            }
            
            // NEW: Also update the print button count
            const printBtn = document.getElementById('print-selected-btn');
            if(printBtn) {
                const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                if (count > 0) {
                    printBtn.disabled = false;
                    printBtn.innerHTML = `${svgIcon} <span>Print Selected Staff (${count})</span>`;
                    printBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    printBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                } else {
                    printBtn.disabled = true;
                    printBtn.innerHTML = `${svgIcon} <span>Print Selected Staff (0)</span>`;
                    printBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    printBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                }
            }
        }
        
        function openBatchDeleteModal() {
            const count = selectedEmployeeIds.size;
            batchDeleteCount.textContent = count;
            batchDeleteList.innerHTML = '';
            selectedEmployeeIds.forEach(id => {
                const emp = employeeData.find(e => e.id === id);
                if (emp) batchDeleteList.innerHTML += `<li>${emp.name} (ID: ${emp.id})</li>`;
            });
            batchDeleteConfirmModal.classList.remove('hidden');
        }
        
        function closeBatchDeleteModal() { batchDeleteConfirmModal.classList.add('hidden'); }

        async function handleBatchDelete() {
            if (selectedEmployeeIds.size === 0) return;
            try {
                const batch = writeBatch(db);
                selectedEmployeeIds.forEach(id => {
                    batch.delete(doc(employeesCollection, id));
                    batch.delete(doc(rosterCollection, id));
                });
                await batch.commit();
                selectedEmployeeIds.clear();
                updateBatchDeleteUI();
                closeBatchDeleteModal();
            } catch (error) {
                console.error("Error batch deleting employees: ", error);
            }
        }
        
        // --- Team Management Functions ---
        function openManageTeamsModal() {
            deleteTeamError.textContent = '';
            addTeamError.textContent = '';
            populateManageTeamsModal();
            manageTeamsModal.classList.remove('hidden');
        }
        function closeManageTeamsModal() { 
            manageTeamsModal.classList.add('hidden');
            manageDropdown.classList.add('hidden');
        }
        
        function populateManageTeamsModal() {
            if (!teamListUl) return; 
            teamListUl.innerHTML = '';
            const sortedTeams = [...teamsMap.entries()].sort((a, b) => a[1].name.localeCompare(b[1].name));
            if (sortedTeams.length === 0) {
                teamListUl.innerHTML = '<li class="p-3 text-gray-500 italic">No teams found.</li>'; return;
            }
            sortedTeams.forEach(([docId, team]) => {
                const li = document.createElement('li');
                li.className = 'team-li flex justify-between items-center p-3';
                li.innerHTML = `
                    <span>${team.name}</span>
                    <div class="flex items-center">
                        <button class="edit-team-btn text-sm text-indigo-600 hover:text-indigo-800 font-medium mr-3 opacity-100 transition-opacity">Edit</button>
                        <button class="delete-team-btn text-red-400 hover:text-red-700 font-bold text-xl p-0 rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-100" title="Delete ${team.name}">&#215;</button>
                    </div>
                `;
                li.querySelector('.edit-team-btn').onclick = () => openEditTeamModal(docId);
                li.querySelector('.delete-team-btn').onclick = () => checkAndDeleteTeam(docId, team.name);
                teamListUl.appendChild(li);
            });
        }
        
        async function handleAddTeam(e) {
            e.preventDefault();
            addTeamError.textContent = '';
            const newTeamName = newTeamNameInput.value.trim();
            if (!newTeamName) { addTeamError.textContent = 'Please enter a name.'; return; }
            const newTeamDocId = newTeamName.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_{2,}/g, '_') + '_' + Date.now();
            if ([...teamsMap.values()].some(team => team.name.toLowerCase() === newTeamName.toLowerCase())) {
                addTeamError.textContent = 'A team with this name already exists.'; return;
            }
            try {
                const newTeam = { 
                    id: newTeamDocId, docId: newTeamDocId, name: newTeamName,
                    shiftPattern: defaultPattern, patternStartDate: patternAnchorDate
                };
                await setDoc(doc(teamsCollection, newTeamDocId), newTeam);
                newTeamNameInput.value = '';
            } catch (error) {
                console.error("Error adding team: ", error);
                addTeamError.textContent = 'Error saving team.';
            }
        }

        // --- Edit Team & Visual Pattern Builder ---
        function openEditTeamModal(teamId) {
            const team = teamsMap.get(teamId);
            if (!team) { console.error("Could not find team with ID:", teamId); return; }
            editTeamId.value = teamId;
            editTeamName.value = team.name;
            editTeamAnchorDate.value = team.patternStartDate || patternAnchorDate;
            tempPatternArray = [...(team.shiftPattern || defaultPattern)];
            editTeamPatternLength.value = tempPatternArray.length;
            renderVisualPatternCells();
            editTeamError.textContent = '';
            editTeamModal.classList.remove('hidden');
        }
        
        function renderVisualPatternCells() {
            if (!shiftCodesMap['_EMPTY']) {
                shiftCodesMap['_EMPTY'] = defaultShiftCodes['_EMPTY'];
            }
            const emptyShiftInfo = shiftCodesMap['_EMPTY'];
            
            const len = parseInt(editTeamPatternLength.value) || 0;
            while (tempPatternArray.length < len) tempPatternArray.push('');
            if (tempPatternArray.length > len) tempPatternArray = tempPatternArray.slice(0, len);
            visualPatternCells.innerHTML = '';
            for (let i = 0; i < len; i++) {
                const shiftCode = tempPatternArray[i] || '';
                const shiftInfo = shiftCodesMap[shiftCode] || emptyShiftInfo;
                const cell = document.createElement('div');
                cell.className = `w-16 h-16 flex flex-col items-center justify-center rounded-lg border-2 cursor-pointer ${shiftInfo.color} ${shiftInfo.textColor} hover:shadow-md`;
                cell.dataset.index = i;
                cell.innerHTML = `
                    <span class="text-xs font-medium text-gray-500">Day ${i + 1}</span>
                    <span class="text-lg font-bold">${shiftInfo.text || '...'}</span>
                `;
                cell.addEventListener('click', () => openPatternShiftModal(i));
                visualPatternCells.appendChild(cell);
            }
        }
        
        function openPatternShiftModal(index) {
            patternModalDay.textContent = `Day ${index + 1}`;
            patternShiftOptionsContainer.innerHTML = '';
            Object.keys(shiftCodesMap).sort().forEach(code => {
                const shiftInfo = shiftCodesMap[code];
                const button = document.createElement('button');
                button.textContent = shiftInfo.text || 'Empty';
                button.className = `p-3 rounded-lg border font-medium transition duration-150 ${shiftInfo.color} ${shiftInfo.textColor} hover:shadow-md hover:ring-2 hover:ring-indigo-400`;
                button.addEventListener('click', () => {
                    tempPatternArray[index] = code;
                    renderVisualPatternCells();
                    closePatternShiftModal();
                });
                patternShiftOptionsContainer.appendChild(button);
            });
            patternShiftModal.classList.remove('hidden');
        }
        
        function closePatternShiftModal() { patternShiftModal.classList.add('hidden'); }
        function closeEditTeamModal() { editTeamModal.classList.add('hidden'); editTeamForm.reset(); }

        async function handleEditTeam(e) {
            e.preventDefault();
            editTeamError.textContent = '';
            const teamId = editTeamId.value;
            if (tempPatternArray.some(code => code === undefined || code === null)) {
                editTeamError.textContent = 'All pattern days must have a shift selected.'; return;
            }
            const updatedData = {
                name: editTeamName.value.trim(),
                shiftPattern: tempPatternArray,
                patternStartDate: editTeamAnchorDate.value
            };
            try {
                await updateDoc(doc(teamsCollection, teamId), updatedData);
                closeEditTeamModal();
            } catch (error) {
                console.error("Error updating team: ", error);
                editTeamError.textContent = 'Error saving changes.';
            }
        }

        // --- Delete Team Functions ---
        function checkAndDeleteTeam(teamId, teamName) {
            deleteTeamError.textContent = '';
            const employeesOnTeam = employeeData.filter(emp => emp.team_id === teamId);
            if (employeesOnTeam.length > 0) {
                deleteTeamError.textContent = `Cannot delete "${teamName}". ${employeesOnTeam.length} employee(s) are still assigned.`; return;
            }
            teamIdToDelete = teamId;
            deleteTeamModalName.textContent = teamName;
            deleteTeamConfirmModal.classList.remove('hidden');
        }
        async function performDeleteTeam() {
            if (!teamIdToDelete) return;
            try {
                await deleteDoc(doc(teamsCollection, teamIdToDelete));
            } catch (error) {
                console.error("Error deleting team: ", error);
                deleteTeamError.textContent = 'Error deleting team.';
            }
            closeDeleteTeamModal();
        }
        function closeDeleteTeamModal() {
            teamIdToDelete = null;
            deleteTeamConfirmModal.classList.add('hidden');
        }

        // --- Label Management Functions ---
        function closeEditLabelModal() {
            editLabelModal.classList.add('hidden');
            editLabelError.textContent = '';
        }

        function openEditLabelModal(labelKey) {
            const shift = shiftCodesMap[labelKey];
            if (!shift) {
                console.error('Cannot find label to edit:', labelKey);
                return;
            }

            editLabelError.textContent = '';
            editLabelKey.value = labelKey;
            editLabelText.value = shift.text;
            editLabelHours.value = shift.hours || 0; // NEW: Set hours
            
            editLabelColor.innerHTML = '';
            editLabelColorGrid.innerHTML = '';
            
            let currentColorName = null;
            
            Object.keys(colorOptions).forEach(colorName => {
                const { color, textColor } = colorOptions[colorName];
                
                if (color === shift.color) {
                    currentColorName = colorName;
                }
                
                editLabelColor.innerHTML += `<option value="${colorName}" class="${color} ${textColor} font-medium">${colorName}</option>`;
                
                const swatch = document.createElement('div');
                swatch.className = `color-swatch ${color}`;
                swatch.dataset.colorName = colorName;
                swatch.title = colorName;
                swatch.addEventListener('click', () => {
                    editLabelColor.value = colorName;
                    document.querySelectorAll('#edit-label-color-grid .color-swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                });
                editLabelColorGrid.appendChild(swatch);
            });
            
            if (currentColorName) {
                editLabelColor.value = currentColorName;
                const currentSwatch = editLabelColorGrid.querySelector(`[data-color-name="${currentColorName}"]`);
                if (currentSwatch) {
                    currentSwatch.classList.add('selected');
                }
            } else {
                const firstColorKey = Object.keys(colorOptions)[0];
                editLabelColor.value = firstColorKey;
                const firstSwatch = editLabelColorGrid.querySelector(`[data-color-name="${firstColorKey}"]`);
                if (firstSwatch) {
                    firstSwatch.classList.add('selected');
                }
            }

            editLabelModal.classList.remove('hidden');
        }

        async function handleEditLabel(e) {
            e.preventDefault();
            editLabelError.textContent = '';
            
            const labelKey = editLabelKey.value;
            const newText = editLabelText.value.trim().toUpperCase();
            const newHours = parseFloat(editLabelHours.value) || 0; // NEW: Get hours
            
            if (!newText) {
                editLabelError.textContent = 'Label text is required.';
                return;
            }
            
            if (newText !== labelKey && shiftCodesMap[newText]) {
                editLabelError.textContent = 'This label text (key) already exists.';
                return;
            }
            
            const selectedColorName = editLabelColor.value;
            const colorInfo = colorOptions[selectedColorName];
            
            const isDefault = shiftCodesMap[labelKey] ? shiftCodesMap[labelKey].isDefault : false;

            // UPDATED: Added hours
            const updatedShiftData = {
                text: newText,
                color: colorInfo.color,
                textColor: colorInfo.textColor,
                isDefault: isDefault,
                hours: newHours
            };

            // *** START OF FIX ***
            try {
                const updatePayload = {};
                
                if (newText === labelKey) {
                    // Just update the existing field
                    updatePayload[`data.${labelKey}`] = updatedShiftData;
                } else {
                    // This is a rename. Add the new field and delete the old one.
                    updatePayload[`data.${newText}`] = updatedShiftData; // Add the new field
                    updatePayload[`data.${labelKey}`] = deleteField(); // Delete the old field
                }
                
                await updateDoc(shiftCodesDocRef, updatePayload);
                closeEditLabelModal();
                
            } catch (error) {
                console.error("Error editing label: ", error);
                editLabelError.textContent = 'Error saving changes.';
            }
            // *** END OF FIX ***
        }

        function openAddLabelModal() {
            addLabelError.textContent = '';
            deleteLabelError.textContent = '';
            newLabelText.value = '';
            newLabelHours.value = 0; // NEW: Reset hours field
            newLabelColor.innerHTML = '';
            addLabelColorGrid.innerHTML = '';
            let firstColorKey = null;
            
            Object.keys(colorOptions).forEach(colorName => {
                const { color, textColor } = colorOptions[colorName];
                if (!firstColorKey) firstColorKey = colorName;
                newLabelColor.innerHTML += `<option value="${colorName}" class="${color} ${textColor} font-medium">${colorName}</option>`;
                
                const swatch = document.createElement('div');
                swatch.className = `color-swatch ${color}`;
                swatch.dataset.colorName = colorName;
                swatch.title = colorName;
                swatch.addEventListener('click', () => {
                    newLabelColor.value = colorName;
                    document.querySelectorAll('#add-label-color-grid .color-swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                });
                addLabelColorGrid.appendChild(swatch);
            });
            
            if (firstColorKey) {
                newLabelColor.value = firstColorKey;
                const firstSwatch = addLabelColorGrid.querySelector(`[data-color-name="${firstColorKey}"]`);
                if (firstSwatch) {
                    firstSwatch.classList.add('selected');
                }
            }

            labelListUl.innerHTML = '';
            Object.keys(shiftCodesMap).sort().forEach(code => {
                if (code === '_EMPTY') return;
                const shift = shiftCodesMap[code];
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3';
                
                // REFINEMENT 2: Emphasized the hours display with a badge
                li.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="font-medium px-3 py-1 rounded-lg ${shift.color} ${shift.textColor}">${shift.text}</span>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-200 text-gray-700">${shift.hours || 0}h</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${shift.isDefault ? '<span class="text-sm text-gray-500 italic">Default</span>' : ''}
                        <button class="edit-label-btn text-sm text-indigo-600 hover:text-indigo-800 font-medium" data-label-key="${code}">Edit</button>
                        ${!shift.isDefault ? 
                            `<button class="delete-label-btn text-red-400 hover:text-red-700 font-bold text-xl p-0 rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-100" title="Delete ${shift.text}">&#215;</button>` :
                            ''
                        }
                    </div>
                `;
                
                li.querySelector('.edit-label-btn').addEventListener('click', (e) => {
                    const key = e.target.getAttribute('data-label-key');
                    openEditLabelModal(key);
                });
                
                if (!shift.isDefault) {
                    li.querySelector('.delete-label-btn').addEventListener('click', () => handleDeleteLabel(code, shift.text));
                }
                
                labelListUl.appendChild(li);
            });
            manageLabelsModal.classList.remove('hidden');
        }
        
        
        function renderManageStaffList() {
            if (!manageStaffList) return;
            manageStaffList.innerHTML = '';

            const sorted = [...employeeData].sort((a, b) => {
                const teamAName = teamsMap.get(a.team_id)?.name || 'Unassigned';
                const teamBName = teamsMap.get(b.team_id)?.name || 'Unassigned';
                if (teamAName !== teamBName) return teamAName.localeCompare(teamBName);

                const starA = getStarSortValue(a);
                const starB = getStarSortValue(b);
                if (starA !== starB) return starA - starB;

                const roleA = getRoleSortValue(a.role);
                const roleB = getRoleSortValue(b.role);
                if (roleA !== roleB) return roleA - roleB;

                return (a.name || '').localeCompare(b.name || '');
            });

            let lastTeamName = null;

            sorted.forEach(emp => {
                const teamName = teamsMap.get(emp.team_id)?.name || 'Unassigned';

                // Insert a team header row whenever the team changes
                if (teamName !== lastTeamName) {
                    lastTeamName = teamName;

                    const headerRow = document.createElement('div');
                    headerRow.className = 'px-3 py-2 bg-gray-100 text-xs font-semibold text-gray-500 uppercase tracking-wide';
                    headerRow.textContent = teamName;
                    manageStaffList.appendChild(headerRow);
                }

                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 items-center px-3 py-2 hover:bg-gray-50 text-gray-700';

                const roleName = getRoleDisplayName(emp.role);
                const starLabel = emp.star === 'blue' ? 'Big Blue Star' :
                                  emp.star === 'yellow' ? 'Yellow Star' : 'None';

                row.innerHTML = `
                    <div class="col-span-3 truncate" title="${emp.name || ''}">${emp.name || ''}</div>
                    <div class="col-span-2 truncate">${emp.emp_id || ''}</div>
                    <div class="col-span-2 truncate">${teamName}</div>
                    <div class="col-span-2 truncate">${roleName}</div>
                    <div class="col-span-2 truncate">${starLabel}</div>
                    <div class="col-span-1 text-right">
                        <button class="px-2 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700 edit-staff-btn" data-emp-id="${emp.id || ''}">
                            Edit
                        </button>
                    </div>
                `;

                manageStaffList.appendChild(row);
            });

            // Attach click handlers for edit buttons
            manageStaffList.querySelectorAll('.edit-staff-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const empId = e.currentTarget.dataset.empId;
                    const emp = employeeData.find(x => x.id === empId);
                    if (!emp) return;

                    currentEmployeeId = empId;
                    modalEmployeeNameInput.value = emp.name || '';
                    modalEmployeeIdInput.value = emp.emp_id || '';
                    modalEmployeeRoleInput.value = emp.role || 'member';
                    modalEmployeeStarInput.value = emp.star || 'none';
                    saveDetailsStatus.textContent = '';

                    // We open the same details modal (no date context needed)
                    modalDate.textContent = 'Edit Staff Profile';

                    // Close the staff list modal so only one modal is visible at a time
                    manageStaffModal.classList.add('hidden');

                    // Show the main shift/details modal
                    modal.classList.remove('hidden');
                });
            });
        }

        function openManageStaffModal() {
            // Ensure the shift/details modal is closed first
            closeModal();
            renderManageStaffList();
            manageStaffModal.classList.remove('hidden');
        }

        function closeManageStaffModal() {
            manageStaffModal.classList.add('hidden');
        }

function closeAddLabelModal() { 
            manageLabelsModal.classList.add('hidden');
            manageDropdown.classList.add('hidden');
        }

        async function handleAddLabel(e) {
            e.preventDefault();
            addLabelError.textContent = '';
            const newCode = newLabelText.value.trim().toUpperCase();
            const newHours = parseFloat(newLabelHours.value) || 0; // NEW: Get hours
            if (!newCode) { addLabelError.textContent = 'Label text is required.'; return; }
            if (shiftCodesMap[newCode]) { addLabelError.textContent = 'This label already exists.'; return; }
            
            const selectedColorName = newLabelColor.value;
            const colorInfo = colorOptions[selectedColorName];
            
            // UPDATED: Add hours
            const newShiftData = {
                text: newCode, color: colorInfo.color,
                textColor: colorInfo.textColor, isDefault: false,
                hours: newHours
            };
            try {
                await updateDoc(shiftCodesDocRef, { [`data.${newCode}`]: newShiftData });
                addLabelForm.reset();
                newLabelHours.value = 0; // NEW: Reset hours field after submit
                
                const firstColorKey = Object.keys(colorOptions)[0];
                newLabelColor.value = firstColorKey;
                document.querySelectorAll('#add-label-color-grid .color-swatch').forEach(s => s.classList.remove('selected'));
                const firstSwatch = addLabelColorGrid.querySelector(`[data-color-name="${firstColorKey}"]`);
                if (firstSwatch) {
                    firstSwatch.classList.add('selected');
                }

            } catch (error) {
                console.error("Error adding label: ", error);
                addLabelError.textContent = 'Error saving label.';
            }
        }
        
        async function handleDeleteLabel(code, text) {
            deleteLabelError.textContent = '';
            showConfirmationModal(
                'Delete Label',
                `Are you sure you want to delete the label "<strong>${text}</strong>"? This action cannot be undone.`,
                async () => {
                    try {
                        await updateDoc(shiftCodesDocRef, { [`data.${code}`]: deleteField() });
                    } catch (error) {
                        console.error("Error deleting label: ", error);
                        deleteLabelError.textContent = 'Error deleting label.';
                    }
                }
            );
        }

        // --- Team Filter Functions ---
        function populateTeamFilter() {
            if (!teamFilterList) return;
            teamFilterList.innerHTML = '';
            const sortedTeams = [...teamsMap.values()].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedTeams.forEach(team => {
                const li = document.createElement('li');
                li.className = 'flex items-center space-x-3';
                li.innerHTML = `
                    <input type="checkbox" id="team-filter-${team.docId}" data-team-id="${team.docId}" class="team-filter-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="team-filter-${team.docId}" class="text-gray-700 cursor-pointer">${team.name}</label>
                `;
                const checkbox = li.querySelector('input');
                checkbox.checked = visibleTeamIDs.has(team.docId);
                checkbox.addEventListener('change', (e) => {
                    handleTeamFilterChange(team.docId, e.target.checked);
                });
                teamFilterList.appendChild(li);
            });
            updateSelectAllTeamsCheckbox();
        }

        function handleTeamFilterChange(teamId, isChecked) {
            if (isChecked) {
                visibleTeamIDs.add(teamId);
            } else {
                visibleTeamIDs.delete(teamId);
            }
            updateSelectAllTeamsCheckbox();
            renderRoster();
        }

        function updateSelectAllTeamsCheckbox() {
            if (!selectAllTeamsCheckbox) return;
            const totalTeams = teamsMap.size;
            if (visibleTeamIDs.size === totalTeams) {
                selectAllTeamsCheckbox.checked = true;
                selectAllTeamsCheckbox.indeterminate = false;
            } else if (visibleTeamIDs.size > 0) {
                selectAllTeamsCheckbox.checked = false;
                selectAllTeamsCheckbox.indeterminate = true;
            } else {
                selectAllTeamsCheckbox.checked = false;
                selectAllTeamsCheckbox.indeterminate = false;
            }
        }

        function handleSelectAllTeams(isChecked) {
            if (isChecked) {
                teamsMap.forEach(team => visibleTeamIDs.add(team.docId));
            } else {
                visibleTeamIDs.clear();
            }
            document.querySelectorAll('.team-filter-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });
            renderRoster();
        }

        function toggleTeamFilterDropdown() {
            teamFilterDropdown.classList.toggle('hidden');
        }

        // --- Name Filter Functions (Grouped) ---
        function populateNameFilter() {
            if (!nameFilterList) return;
            
            const searchTerm = nameFilterSearch.value.toLowerCase();
            nameFilterList.innerHTML = '';
            
            const sortedTeams = [...teamsMap.values()].sort((a, b) => a.name.localeCompare(b.name));
            let totalMatches = 0;

            sortedTeams.forEach(team => {
                const employeesOnTeam = employeeData
                    .filter(emp => emp.team_id === team.docId)
                    .sort((a, b) => a.name.localeCompare(b.name));

                const filteredEmployees = employeesOnTeam.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm)
                );

                if (filteredEmployees.length > 0) {
                    totalMatches += filteredEmployees.length;

                    const teamHeader = document.createElement('li');
                    teamHeader.className = 'pt-2 pb-1 px-2 text-xs font-semibold text-indigo-700 uppercase';
                    teamHeader.textContent = team.name;
                    nameFilterList.appendChild(teamHeader);

                    filteredEmployees.forEach(emp => {
                        const li = document.createElement('li');
                        li.innerHTML = ` 
                            <label for="name-filter-${emp.id}" class="w-full flex items-center space-x-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" id="name-filter-${emp.id}" data-emp-id="${emp.id}" class="name-filter-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="text-gray-700 text-sm">${emp.name}</span>
                            </label>
                        `;
                        const checkbox = li.querySelector('input');
                        // FIX #2: Ensure individual checkboxes reflect global state on render
                        checkbox.checked = visibleEmployeeIDs.has(emp.id);
                        checkbox.addEventListener('change', (e) => {
                            handleNameFilterChange(emp.id, e.target.checked);
                        });
                        nameFilterList.appendChild(li);
                    });
                }
            });

            if (totalMatches === 0) {
                nameFilterList.innerHTML = `<li class="text-gray-500 text-sm italic px-2">No names found.</li>`;
            }
        }

        function handleNameFilterChange(empId, isChecked) {
            if (isChecked) {
                visibleEmployeeIDs.add(empId);
            } else {
                visibleEmployeeIDs.delete(empId);
            }
            renderRoster();
        }
        
        // --- NEW: Explicit Select All function (RENAMED) ---
        function handleNameFilterSelectAll() {
            // SELECT ALL: add all employee IDs to the visible set
            employeeData.forEach(emp => visibleEmployeeIDs.add(emp.id));
            
            // Clear search term (optional, but good practice)
            if (nameFilterSearch) {
                nameFilterSearch.value = "";
            }

            // Force update UI (Dropdown content) and Roster immediately
            populateNameFilter();
            renderRoster();
        }

        // --- NEW: Explicit Unselect All function (RENAMED) ---
        function handleNameFilterUnselectAll() {
            // UNSELECT ALL: clear the visible set immediately
            visibleEmployeeIDs.clear();

            // FIX: Clear search box input field physically
            if (nameFilterSearch) {
                nameFilterSearch.value = "";
            }

            // Force update UI (Dropdown content) and Roster immediately
            populateNameFilter();
            renderRoster();
        }
				

        function toggleNameFilterDropdown() {
            nameFilterDropdown.classList.toggle('hidden');
            // When opening the dropdown, ensure the list is populated based on current search/state
            if (!nameFilterDropdown.classList.contains('hidden')) {
                populateNameFilter();
            }
        }


        // --- Manage Menu Function ---
        function toggleManageDropdown() {
            manageDropdown.classList.toggle('hidden');
        }
        
        // --- Print Functions ---
        function openPrintModal() {
            const count = selectedEmployeeIds.size;
            const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            
            if (count > 0) {
                printSelectedBtn.disabled = false;
                printSelectedBtn.innerHTML = `${svgIcon} <span>Print Selected Staff (${count})</span>`;
                printSelectedBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                printSelectedBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            } else {
                printSelectedBtn.disabled = true;
                printSelectedBtn.innerHTML = `${svgIcon} <span>Print Selected Staff (0)</span>`;
                printSelectedBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                printSelectedBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            }
            printModal.classList.remove('hidden');
        }

        function closePrintModal() {
            printModal.classList.add('hidden');
        }
        
        function handlePrint(isSelective) {
            closePrintModal();
            
            if (isSelective) {
                document.body.classList.add('printing-selective');
                const visibleEmployees = employeeData.filter(emp => 
                    visibleTeamIDs.has(emp.team_id) && visibleEmployeeIDs.has(emp.id)
                );
                const printedTeamIDs = new Set();
                
                visibleEmployees.forEach(emp => {
                    if (selectedEmployeeIds.has(emp.id)) {
                        printedTeamIDs.add(emp.team_id);
                    } else {
                        // Find all cells for this employee and hide them
                        document.querySelectorAll(`[data-emp-id="${emp.id}"]`).forEach(cell => cell.classList.add('no-print'));
                    }
                });
                
                // Hide team headers that have no selected employees under them
                document.querySelectorAll('.team-header-row[data-team-id]').forEach(header => {
                    if (!printedTeamIDs.has(header.dataset.teamId)) {
                        header.classList.add('no-print');
                    }
                });
            }
            
            // Set a short timeout to allow the DOM to update before printing
            setTimeout(() => {
                window.print();
            }, 100); 
        }

        // --- Firebase Init & MIGRATION ---
        async function populateInitialShiftCodes() {
            console.log("Populating initial shift codes...");
            try {
                await setDoc(shiftCodesDocRef, { data: defaultShiftCodes });
                console.log("Initial shift codes populated.");
            } catch (error) {
                console.error("Error populating initial shift codes:", error);
            }
        }
        
        async function populateInitialData() {
            const batch = writeBatch(db);
            const teamIDs = {
                alpha: 'alpha_' + Date.now(), bravo: 'bravo_' + Date.now(), charlie: 'charlie_' + Date.now(),
                foyer: 'foyer_' + Date.now(), support: 'support_' + Date.now()
            };
            const weekPattern = ['OFF', '1', '1', '1', '1', '1', 'OFF'];
            const weekAnchorDate = '2025-01-05';
            const teams = [
                { id: teamIDs.alpha, docId: teamIDs.alpha, name: 'Alpha', shiftPattern: ['1', '1', '2', '2', 'OFF', 'OFF'], patternStartDate: '2025-01-01' },
                { id: teamIDs.bravo, docId: teamIDs.bravo, name: 'Bravo', shiftPattern: ['1', '1', '2', '2', 'OFF', 'OFF'], patternStartDate: '2025-01-01' },
                { id: teamIDs.charlie, docId: teamIDs.charlie, name: 'Charlie', shiftPattern: ['1', '1', '2', '2', 'OFF', 'OFF'], patternStartDate: '2025-01-01' },
                { id: teamIDs.foyer, docId: teamIDs.foyer, name: 'Foyer', shiftPattern: weekPattern, patternStartDate: weekAnchorDate },
                { id: teamIDs.support, docId: teamIDs.support, name: 'Support', shiftPattern: weekPattern, patternStartDate: weekAnchorDate }
            ];
            teams.forEach(team => batch.set(doc(teamsCollection, team.id), team));
            
            const employees = [
                { id: '25013575', emp_id: '11997', name: 'SGT (APF) DAHLIA SHAFIQ', team_id: teamIDs.alpha, role: 'leader' }, 
                { id: '25001375', emp_id: '11977', name: 'SGT (APF) CHEW WAI HOO', team_id: teamIDs.alpha, role: 'Section I/C' },
                { id: '25001153', emp_id: '33748', name: 'CPL (APF) RAVILO VEERASAMY', team_id: teamIDs.alpha }, 
                { id: '25010549', emp_id: '119566', name: 'CPL (APF) LUA YIEN SIA', team_id: teamIDs.alpha },
                { id: '25010533', emp_id: '12140', name: 'CPL (APF) ISYARIYAN YAZID', team_id: teamIDs.alpha }, 
                { id: '25012454', emp_id: '114567', name: 'L/CPL (APF) MUJILAN RAJENDRAN', team_id: teamIDs.alpha },
                { id: '25001254', emp_id: '114567', name: 'L/CPL (APF) ARAVINDAN MUNANDY', team_id: teamIDs.alpha }, 
                { id: '25001420', emp_id: '71407', name: 'PC (APF) JAGTHEESWARAN MANIMARAN', team_id: teamIDs.alpha },
                { id: '2501595', emp_id: '106722', name: 'SGT (APF) KALAIARACHE A/P NAGARATNAM', team_id: teamIDs.alpha }, 
                { id: '25012687', emp_id: '114392', name: 'SGT (APF) DAHLAN THAQARAJAN', team_id: teamIDs.alpha },
                { id: '25007705', emp_id: '112844', name: 'SGT (APF) LEE SOON THAI', team_id: teamIDs.bravo }, 
                { id: '25080785', emp_id: '112888', name: 'SGT (APF) HO CHIE TIN', team_id: teamIDs.bravo },
                { id: '25001731', emp_id: '70895', name: 'SGT (APF) HO KOK MAN', team_id: teamIDs.bravo }, 
                { id: '25000421', emp_id: '104545', name: 'L/CPL (APF) THEVANANTHAN A/L KANAPATHY', team_id: teamIDs.bravo },
                { id: '25011682', emp_id: '114573', name: 'L/CPL (APF) LIM CHIA MING', team_id: teamIDs.bravo }, 
                { id: '25016179', emp_id: '114547', name: 'L/CPL (APF) JENNY WONG JOANN', team_id: teamIDs.bravo },
                { id: '25002330', emp_id: '115005', name: 'CPL (APF) KRISHNA KUMAR DEVADAS', team_id: teamIDs.bravo }, 
                { id: '25013556', emp_id: '112281', name: 'CPL (APF) CHUA YEN KAI', team_id: teamIDs.bravo },
                { id: '25001355', emp_id: '107483', name: 'SGT (APF) DHARM AL ILBUGANATHAN', team_id: teamIDs.bravo }, 
                { id: '25013354', emp_id: '114518', name: 'L/CPL (APF) VIVEKANANTHAN SANKARAN', team_id: teamIDs.bravo },
                { id: '25000772', emp_id: '9431', name: 'SGT (APF) YONG KAH WHYE', team_id: teamIDs.charlie }, 
                { id: '25080180', emp_id: '113414', name: 'SGT (APF) LIEW TAN HOU THIAN', team_id: teamIDs.charlie },
                { id: '25080200', emp_id: '115716', name: 'SGT (APF) LIEW TECK LEE', team_id: teamIDs.charlie }, 
                { id: '25006095', emp_id: '112048', name: 'CPL (APF) LO KOK BONG', team_id: teamIDs.charlie },
                { id: '25011208', emp_id: '115904', name: 'CPL (APF) THEVARAJAN SUBRAMANIAM', team_id: teamIDs.charlie }, 
                { id: '25012057', emp_id: '112907', name: 'CPL (APF) LAWRENCE A/L MICHAEL', team_id: teamIDs.charlie },
                { id: '25012122', emp_id: '114221', name: 'L/CPL (APF) MUSTAQIM BIN JAILANI', team_id: teamIDs.charlie }, 
                { id: '25012906', emp_id: '114406', name: 'L/CPL (APF) KAMASHNAKAR RAJIAH', team_id: teamIDs.charlie },
                { id: '25012093', emp_id: '114208', name: 'PC (APF) ANISH PARITHAN', team_id: teamIDs.charlie }, 
                { id: '25013927', emp_id: '114605', name: 'SGT (APF) HOE TIN HAN', team_id: teamIDs.charlie },
                { id: '25011181', emp_id: '115893', name: 'SGT (APF) RAVITHRA RAJENDRAN', team_id: teamIDs.charlie }, 
                { id: '25000178', emp_id: '9248', name: 'SGT (APF) TONY BOO KIAN BENG', team_id: teamIDs.foyer },
                { id: '25000173', emp_id: '9260', name: 'SGT (APF) FONG TAI YING', team_id: teamIDs.foyer }, 
                { id: '25004336', emp_id: '111757', name: 'SGT (APF) LYE CHEE MIN', team_id: teamIDs.foyer },
                { id: '25011447', emp_id: '9111757', name: 'CPL (APF) ZHENG YAO RONG', team_id: teamIDs.support }
            ];
            
            employees.forEach(emp => {
                const empDoc = { ...emp, docId: emp.id, patternOffset: 0, role: emp.role || 'member' };
                batch.set(doc(employeesCollection, emp.id), empDoc);
            });
            await batch.commit();
        }
        
        let authStateProcessed = false;
        
        function setupDataListeners() {
            onSnapshot(query(teamsCollection), (snapshot) => {
                console.log("Real-time: Teams data updated.");
                let needsFilterUpdate = false;
                snapshot.docChanges().forEach((change) => {
                    needsFilterUpdate = true;
                    if (change.type === "added") {
                        teamsMap.set(change.doc.id, {docId: change.doc.id, ...change.doc.data()});
                        visibleTeamIDs.add(change.doc.id); 
                    }
                    if (change.type === "modified") {
                        teamsMap.set(change.doc.id, {docId: change.doc.id, ...change.doc.data()});
                    }
                    if (change.type === "removed") {
                        teamsMap.delete(change.doc.id);
                        visibleTeamIDs.delete(change.doc.id); 
                    }
                });
                
                if (needsFilterUpdate) {
                    populateTeamFilter();
                    populateNameFilter();
                }
                if (isDataLoaded) renderRoster();
                if (manageTeamsModal && !manageTeamsModal.classList.contains('hidden')) populateManageTeamsModal(); 
            });

            onSnapshot(query(employeesCollection), (snapshot) => {
                console.log("Real-time: Employee data updated.");
                let needsNameFilterUpdate = false;
                snapshot.docChanges().forEach((change) => {
                    const docData = {docId: change.doc.id, ...change.doc.data()};
                    if (change.type === "added") {
                         if (!employeeData.some(emp => emp.docId === docData.docId)) employeeData.push(docData);
                         visibleEmployeeIDs.add(docData.id); 
                         needsNameFilterUpdate = true; 
                    }
                    if (change.type === "modified") {
                        const index = employeeData.findIndex(emp => emp.docId === docData.docId);
                        if (index > -1) employeeData[index] = docData;
                        else employeeData.push(docData);
                        needsNameFilterUpdate = true;
                    }
                    if (change.type === "removed") {
                        employeeData = employeeData.filter(emp => emp.docId !== docData.docId);
                        selectedEmployeeIds.delete(docData.docId);
                        visibleEmployeeIDs.delete(docData.id);
                        needsNameFilterUpdate = true;
                    }
                });
                if (needsNameFilterUpdate) populateNameFilter();
                if (isDataLoaded) { updateBatchDeleteUI(); renderRoster(); }
            });

            onSnapshot(query(rosterCollection), (snapshot) => {
                 console.log("Real-time: Roster data updated.");
                 snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" || change.type === "modified") rosterData[change.doc.id] = change.doc.data();
                    if (change.type === "removed") delete rosterData[change.doc.id];
                 });
                if (isDataLoaded) renderRoster();
            });

            onSnapshot(shiftCodesDocRef, (docSnap) => {
                console.log("Real-time: Shift codes updated.");
                if (docSnap.exists() && docSnap.data().data) {
                    shiftCodesMap = docSnap.data().data;
                } else {
                    shiftCodesMap = { ...defaultShiftCodes };
                }
                
                if (!shiftCodesMap['_EMPTY']) {
                    console.warn("'_EMPTY' shift code not found, adding default.");
                    shiftCodesMap['_EMPTY'] = defaultShiftCodes['_EMPTY'];
                }

                if (isDataLoaded) renderRoster();
                if (manageLabelsModal && !manageLabelsModal.classList.contains('hidden')) {
                    if (editLabelModal && editLabelModal.classList.contains('hidden')) {
                        openAddLabelModal();
                    }
                }
            }, (error) => console.error("Error listening to shift codes: ", error));
        }
        
        async function initFirebase() {
            const authTimeout = setTimeout(() => {
                if (!authStateProcessed) {
                    console.error("Authentication timed out.");
                    if (loadingState) loadingState.textContent = "Authentication Timed Out. Please check your network and refresh.";
                }
            }, 10000);

            onAuthStateChanged(auth, async (user) => {
                authStateProcessed = true;
                clearTimeout(authTimeout);

                if (user) {
                    console.log("User authenticated:", user.uid);
                    teamsCollection = collection(db, "teams");
                    employeesCollection = collection(db, "employees");
                    rosterCollection = collection(db, "roster");
                    shiftCodesCollection = collection(db, "shift_codes");
                    shiftCodesDocRef = doc(shiftCodesCollection, "all");

                    try {
                        const teamCheckSnap = await getDocs(query(teamsCollection, limit(1)));
                        if (teamCheckSnap.empty) {
                            console.log("Teams collection is empty. Populating initial data...");
                            loadingState.textContent = "Uploading initial teams and staff list...";
                            await populateInitialData();
                            console.log("Initial data populated.");
                        }

                        const shiftCheckSnap = await getDoc(shiftCodesDocRef);
                        if (!shiftCheckSnap.exists()) {
                            console.log("Shift codes collection is empty. Populating...");
                            loadingState.textContent = "Populating initial shift codes...";
                            await populateInitialShiftCodes();
                        } else {
                            console.log("Shift codes already exist.");
                        }

                        loadingState.textContent = "Loading Roster Data...";
                        const [teamsSnapshot, employeesSnapshot, rosterSnapshot, shiftCodesDocSnap] = await Promise.all([
                            getDocs(query(teamsCollection)),
                            getDocs(query(employeesCollection)),
                            getDocs(query(rosterCollection)),
                            getDoc(shiftCodesDocRef)
                        ]);

                        console.log("Populating initial cache...");
                        teamsMap.clear();
                        teamsSnapshot.forEach(doc => teamsMap.set(doc.id, {docId: doc.id, ...doc.data()}));
                        
                        visibleTeamIDs.clear();
                        teamsMap.forEach(team => visibleTeamIDs.add(team.docId));

                        employeeData = [];
                        employeesSnapshot.forEach(doc => employeeData.push({docId: doc.id, ...doc.data()}));
                        
                        visibleEmployeeIDs.clear();
                        employeeData.forEach(emp => visibleEmployeeIDs.add(emp.id));

                        rosterData = {};
                        rosterSnapshot.forEach(doc => rosterData[doc.id] = doc.data());
                        if (shiftCodesDocSnap.exists() && shiftCodesDocSnap.data().data) {
                            shiftCodesMap = shiftCodesDocSnap.data().data;
                        } else {
                            console.warn("Shift codes doc not found, using defaults.");
                            shiftCodesMap = { ...defaultShiftCodes };
                        }
                        
                        if (!shiftCodesMap['_EMPTY']) {
                            console.warn("'_EMPTY' shift code not found on init, adding default.");
                            shiftCodesMap['_EMPTY'] = defaultShiftCodes['_EMPTY'];
                        }
                        
                        console.log(`Cache populated: ${teamsMap.size} teams, ${employeeData.length} employees, ${Object.keys(shiftCodesMap).length} shift codes.`);
                        isDataLoaded = true;
                        loadingState.classList.add('hidden');
                        rosterContainer.classList.remove('hidden');
                        
                        populateTeamFilter(); 
                        populateNameFilter();
                        renderRoster(); 
                        
                        console.log("Attaching real-time listeners...");
                        setupDataListeners(); 

                    } catch (error) {
                        console.error("Error during init:", error);
                        loadingState.textContent = `Error during init: ${error.message} (Code: ${error.code})`;
                    }
                } else {
                    console.log("User not signed in.");
                    loadingState.textContent = "Authentication Failed. User is not signed in.";
                }
            });

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                authStateProcessed = true;
                clearTimeout(authTimeout);
                loadingState.textContent = "Authentication Failed. Please refresh.";
            }
        }

        // --- 7. EVENT LISTENERS (DOM) ---
        function assignDOMListeners() {
            prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            nextMonthBtn.addEventListener('click', () => changeMonth(1));
            
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            setAutoShiftBtn.addEventListener('click', () => selectShift('AUTO'));
            saveDetailsBtn.addEventListener('click', handleSaveEmployeeDetails);

            
            manageStaffBtn.addEventListener('click', openManageStaffModal);
            closeManageStaffModalBtn.addEventListener('click', closeManageStaffModal);
            manageStaffModal.addEventListener('click', (e) => { if (e.target === manageStaffModal) closeManageStaffModal(); });
            manageLabelsBtn.addEventListener('click', openAddLabelModal);
            closeLabelsModalBtn.addEventListener('click', closeAddLabelModal);
            addLabelForm.addEventListener('submit', handleAddLabel);
            manageLabelsModal.addEventListener('click', (e) => { if (e.target === manageLabelsModal) closeAddLabelModal(); });

            closeEditLabelModalBtn.addEventListener('click', closeEditLabelModal);
            editLabelForm.addEventListener('submit', handleEditLabel);
            editLabelModal.addEventListener('click', (e) => { if (e.target === editLabelModal) closeEditLabelModal(); });

            manageTeamsBtn.addEventListener('click', openManageTeamsModal);
            closeTeamsModalBtn.addEventListener('click', closeManageTeamsModal);
            manageTeamsModal.addEventListener('click', (e) => { if (e.target === manageTeamsModal) closeManageTeamsModal(); });
            addTeamForm.addEventListener('submit', handleAddTeam);

            closePatternModalBtn.addEventListener('click', closePatternShiftModal);
            patternShiftModal.addEventListener('click', (e) => { if (e.target === patternShiftModal) closePatternShiftModal(); });

            addEmployeeBtn.addEventListener('click', openAddModal);
            closeAddModalBtn.addEventListener('click', closeAddModal);
            addEmployeeForm.addEventListener('submit', handleAddEmployee);
            addEmployeeModal.addEventListener('click', (e) => { if (e.target === addEmployeeModal) closeAddModal(); });

            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            confirmDeleteBtn.addEventListener('click', handleDeleteEmployee);
            deleteConfirmModal.addEventListener('click', (e) => { if (e.target === deleteConfirmModal) closeDeleteModal(); });
            
            batchDeleteBtn.addEventListener('click', openBatchDeleteModal);
            cancelBatchDeleteBtn.addEventListener('click', closeBatchDeleteModal);
            confirmBatchDeleteBtn.addEventListener('click', handleBatchDelete);
            batchDeleteConfirmModal.addEventListener('click', (e) => { if (e.target === batchDeleteConfirmModal) closeBatchDeleteModal(); });

            closeEditTeamModalBtn.addEventListener('click', closeEditTeamModal);
            editTeamForm.addEventListener('submit', handleEditTeam);
            editTeamModal.addEventListener('click', (e) => { if (e.target === editTeamModal) closeEditTeamModal(); });
            editTeamPatternLength.addEventListener('change', renderVisualPatternCells);
            
            cancelDeleteTeamBtn_TEAM.addEventListener('click', closeDeleteTeamModal); 
            confirmDeleteTeamBtn_TEAM.addEventListener('click', performDeleteTeam);
            deleteTeamConfirmModal.addEventListener('click', (e) => { if (e.target === deleteTeamConfirmModal) closeDeleteTeamModal(); });

            // Team Filter Listeners
            teamFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                toggleTeamFilterDropdown();
            });
            selectAllTeamsCheckbox.addEventListener('change', (e) => {
                handleSelectAllTeams(e.target.checked);
            });
            teamFilterDropdown.addEventListener('click', (e) => {
                e.stopPropagation(); 
            });

            // Name Filter Listeners
            nameFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNameFilterDropdown();
            });
            
            // --- NEW: Separate Button Listeners ---
            if (selectAllNamesBtn) {
                selectAllNamesBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    handleNameFilterSelectAll();
                });
            }
            if (unselectAllNamesBtn) {
                unselectAllNamesBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    handleNameFilterUnselectAll();
                });
            }
            
            nameFilterSearch.addEventListener('input', populateNameFilter);
            nameFilterDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });


            // Manage Menu Listeners
            manageMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleManageDropdown();
            });
            manageDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Print Listeners
            printBtn.addEventListener('click', openPrintModal);
            closePrintModalBtn.addEventListener('click', closePrintModal);
            printModal.addEventListener('click', (e) => { if (e.target === printModal) closePrintModal(); });
            printAllVisibleBtn.addEventListener('click', () => handlePrint(false));
            printSelectedBtn.addEventListener('click', () => handlePrint(true));
            
            // NEW: Daily List Listeners
            dailyListBtn.addEventListener('click', openDailyListModal);
            closeDailyListModalBtn.addEventListener('click', closeDailyListModal);
            dailyListModal.addEventListener('click', (e) => { if (e.target === dailyListModal) closeDailyListModal(); });
            dailyListDate.addEventListener('change', renderDailyList);
            printDailyListBtn.addEventListener('click', printDailyList);


            window.onafterprint = () => {
                document.body.classList.remove('printing-selective');
                document.body.classList.remove('printing-daily-list');
                document.querySelectorAll('.no-print').forEach(cell => cell.classList.remove('no-print'));
            };


            confirmModalCancel.addEventListener('click', () => confirmModal.classList.add('hidden'));
            confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) confirmModal.classList.add('hidden'); });

            if (closeEmployeeCalendarBtn) {
                closeEmployeeCalendarBtn.addEventListener('click', closeEmployeeCalendar);
            }
            if (employeeCalendarModal) {
                employeeCalendarModal.addEventListener('click', (e) => {
                    if (e.target === employeeCalendarModal) closeEmployeeCalendar();
                });
            }

            // Global click listener to close dropdowns
            document.addEventListener('click', (e) => {
                if (teamFilterDropdown && !teamFilterDropdown.classList.contains('hidden') && !teamFilterDropdown.contains(e.target) && e.target !== teamFilterBtn) {
                    toggleTeamFilterDropdown();
                }
                if (nameFilterDropdown && !nameFilterDropdown.classList.contains('hidden') && !nameFilterDropdown.contains(e.target) && e.target !== nameFilterBtn) {
                    toggleNameFilterDropdown();
                }
                if (manageDropdown && !manageDropdown.classList.contains('hidden') && !manageDropdown.contains(e.target) && e.target !== manageMenuBtn) {
                    toggleManageDropdown();
                }
            });

            if (grid) {
                grid.addEventListener('scroll', handleRosterScroll);
            }
        }
        
        function assignDOMElements() {
            grid = document.getElementById('roster-grid');
            monthYearEl = document.getElementById('current-month-year');
            prevMonthBtn = document.getElementById('prev-month');
            nextMonthBtn = document.getElementById('next-month');
            loadingState = document.getElementById('loading-state');
            rosterContainer = document.getElementById('roster-container');
            headerActions = document.getElementById('header-actions');
            batchDeleteContainer = document.getElementById('batch-delete-container');
            batchDeleteBtn = document.getElementById('batch-delete-btn');
            batchDeleteConfirmModal = document.getElementById('batch-delete-confirm-modal');
            batchDeleteCount = document.getElementById('batch-delete-count');
            batchDeleteList = document.getElementById('batch-delete-list');
            cancelBatchDeleteBtn = document.getElementById('cancel-batch-delete-btn');
            confirmBatchDeleteBtn = document.getElementById('confirm-batch-delete-btn');
            modal = document.getElementById('shift-modal');
            closeModalBtn = document.getElementById('close-modal');
            shiftOptionsContainer = document.getElementById('shift-options');
            modalDate = document.getElementById('modal-date');
            setAutoShiftBtn = document.getElementById('set-auto-shift-btn');
            patternShiftModal = document.getElementById('pattern-shift-modal');
            closePatternModalBtn = document.getElementById('close-pattern-modal');
            patternShiftOptionsContainer = document.getElementById('pattern-shift-options');
            patternModalDay = document.getElementById('pattern-modal-day');
            addEmployeeBtn = document.getElementById('add-employee-btn');
            addEmployeeModal = document.getElementById('add-employee-modal');
            closeAddModalBtn = document.getElementById('close-add-modal');
            addEmployeeForm = document.getElementById('add-employee-form');
            teamSelect = document.getElementById('emp-team-select');
            addError = document.getElementById('add-error');
            deleteConfirmModal = document.getElementById('delete-confirm-modal');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            deleteModalName = document.getElementById('delete-modal-name');
            deleteModalId = document.getElementById('delete-modal-id');
            manageTeamsBtn = document.getElementById('manage-teams-btn');
            manageTeamsModal = document.getElementById('manage-teams-modal');
            closeTeamsModalBtn = document.getElementById('close-teams-modal');
            manageTeamsModal = document.getElementById('manage-teams-modal');
            closeTeamsModalBtn = document.getElementById('close-teams-modal');
            addTeamForm = document.getElementById('add-team-form');
            newTeamNameInput = document.getElementById('new-team-name');
            addTeamError = document.getElementById('add-team-error');
            deleteTeamError = document.getElementById('delete-team-error');
            teamListUl = document.getElementById('team-list-ul');
            editTeamModal = document.getElementById('edit-team-modal');
            closeEditTeamModalBtn = document.getElementById('close-edit-team-modal');
            editTeamForm = document.getElementById('edit-team-form');
            editTeamId = document.getElementById('edit-team-id');
            editTeamName = document.getElementById('edit-team-name');
            editTeamPatternLength = document.getElementById('edit-team-pattern-length');
            editTeamAnchorDate = document.getElementById('edit-team-anchor-date');
            visualPatternCells = document.getElementById('visual-pattern-cells');
            editTeamError = document.getElementById('edit-team-error');
            deleteTeamConfirmModal = document.getElementById('delete-team-confirm-modal');
            cancelDeleteTeamBtn_TEAM = document.getElementById('cancel-delete-team-btn');
            confirmDeleteTeamBtn_TEAM = document.getElementById('confirm-delete-team-btn');
            deleteTeamModalName = document.getElementById('delete-team-modal-name');
            modalEmployeeNameInput = document.getElementById('modal-employee-name-input');
            modalEmployeeIdInput = document.getElementById('modal-employee-id-input');
            saveDetailsBtn = document.getElementById('save-details-btn');
            saveDetailsStatus = document.getElementById('save-details-status');
            manageLabelsBtn = document.getElementById('manage-labels-btn');
            manageLabelsModal = document.getElementById('manage-labels-modal');
            closeLabelsModalBtn = document.getElementById('close-labels-modal');
            addLabelForm = document.getElementById('add-label-form');
            newLabelText = document.getElementById('new-label-text');
            newLabelColor = document.getElementById('new-label-color');
            newLabelHours = document.getElementById('new-label-hours'); // <-- NEW
            addLabelColorGrid = document.getElementById('add-label-color-grid');
            addLabelError = document.getElementById('add-label-error');
            deleteLabelError = document.getElementById('delete-label-error');
            labelListUl = document.getElementById('label-list-ul');
            teamFilterBtn = document.getElementById('team-filter-btn');
            teamFilterDropdown = document.getElementById('team-filter-dropdown');
            teamFilterList = document.getElementById('team-filter-list');
            selectAllTeamsCheckbox = document.getElementById('select-all-teams-checkbox');
            manageMenuBtn = document.getElementById('manage-menu-btn');
            manageDropdown = document.getElementById('manage-dropdown');
            modalEmployeeRoleInput = document.getElementById('modal-employee-role-input');
            modalEmployeeStarInput = document.getElementById('modal-employee-star-input');
            manageStaffBtn = document.getElementById('manage-staff-btn');
            manageStaffModal = document.getElementById('manage-staff-modal');
            manageStaffList = document.getElementById('manage-staff-list');
            closeManageStaffModalBtn = document.getElementById('close-manage-staff-modal');
            nameFilterBtn = document.getElementById('name-filter-btn');
            nameFilterDropdown = document.getElementById('name-filter-dropdown');
            nameFilterSearch = document.getElementById('name-filter-search');
            nameFilterList = document.getElementById('name-filter-list');
            // NEW ASSIGNMENT (buttons)
            selectAllNamesBtn = document.getElementById('select-all-names-btn');
            unselectAllNamesBtn = document.getElementById('unselect-all-names-btn');

            editLabelModal = document.getElementById('edit-label-modal');
            closeEditLabelModalBtn = document.getElementById('close-edit-label-modal');
            editLabelForm = document.getElementById('edit-label-form');
            editLabelKey = document.getElementById('edit-label-key');
            editLabelText = document.getElementById('edit-label-text');
            editLabelColor = document.getElementById('edit-label-color');
            editLabelHours = document.getElementById('edit-label-hours'); // <-- NEW
            editLabelColorGrid = document.getElementById('edit-label-color-grid');
            editLabelError = document.getElementById('edit-label-error');

            confirmModal = document.getElementById('confirm-modal');
            confirmModalTitle = document.getElementById('confirm-modal-title');
            confirmModalBody = document.getElementById('confirm-modal-body');
            confirmModalCancel = document.getElementById('confirm-modal-cancel');
            confirmModalConfirm = document.getElementById('confirm-modal-confirm');

            employeeCalendarModal = document.getElementById('employee-calendar-modal');
            employeeCalendarName = document.getElementById('employee-calendar-name');
            employeeCalendarDetails = document.getElementById('employee-calendar-details');
            employeeCalendarWeekdays = document.getElementById('employee-calendar-weekdays');
            employeeCalendarGrid = document.getElementById('employee-calendar-grid');
            closeEmployeeCalendarBtn = document.getElementById('close-employee-calendar-btn');

            // Assign Print Modal Elements
            printBtn = document.getElementById('print-btn');
            printModal = document.getElementById('print-modal');
            closePrintModalBtn = document.getElementById('close-print-modal');
            printAllVisibleBtn = document.getElementById('print-all-visible-btn');
            printSelectedBtn = document.getElementById('print-selected-btn');
            
            // NEW: Assign Daily List Modal Elements
            dailyListBtn = document.getElementById('daily-list-btn');
            dailyListModal = document.getElementById('daily-list-modal');
            closeDailyListModalBtn = document.getElementById('close-daily-list-modal');
            dailyListDate = document.getElementById('daily-list-date');
            dailyListContent = document.getElementById('daily-list-content');
            printDailyListBtn = document.getElementById('print-daily-list-btn');
            dailyListPrintDate = document.getElementById('daily-list-print-date');
        }

        // --- 8. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Assigning elements and listeners.");
            assignDOMElements();
            assignDOMListeners();
            initFirebase();
        });

    
// === Print Selected Staff: robust selectors & updates ===
(function(){
  function qsel(){
    // Accept any checkbox inside an employee row
    return Array.from(document.querySelectorAll('.employee-row input[type="checkbox"]'));
  }
  function checkedBoxes(){
    return qsel().filter(cb => cb.checked);
  }
  function updateCount(){
    const n = checkedBoxes().length;
    const btn = document.getElementById('print-selected-btn');
    if (!btn) return;
    btn.disabled = n === 0;
    const span = btn.querySelector('span');
    if (span) span.textContent = `Print Selected Staff (${n})`;
    else btn.textContent = `Print Selected Staff (${n})`;
  }
  function markSelected(){
    document.body.classList.add('printing-selective');
    document.querySelectorAll('.employee-row').forEach(r=>r.classList.remove('selected-for-print'));
    checkedBoxes().forEach(cb => {
      const row = cb.closest('.employee-row');
      if (row) row.classList.add('selected-for-print');
    });
  }
  function clearMark(){
    document.body.classList.remove('printing-selective');
    document.querySelectorAll('.employee-row.selected-for-print').forEach(r=>r.classList.remove('selected-for-print'));
  }

  // Delegate changes on any checkbox (covers dynamic rows)
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.matches('.employee-row input[type="checkbox"]')) updateCount();
  }, true);

  // Update when opening the print modal and on first paint
  const printOpenBtn = document.getElementById('print-btn');
  if (printOpenBtn) printOpenBtn.addEventListener('click', ()=> setTimeout(updateCount, 0));
  setTimeout(updateCount, 500);

  // Button bindings
  const btnAll = document.getElementById('print-all-visible-btn');
  if (btnAll) btnAll.addEventListener('click', ()=>{ clearMark(); window.print(); });

  const btnSel = document.getElementById('print-selected-btn');
  if (btnSel) btnSel.addEventListener('click', ()=>{
    markSelected();
    // iOS Safari sometimes needs a tick before print
    setTimeout(()=>{ window.print(); setTimeout(clearMark, 400); }, 50);
  });
})();

</script>

<script>
(function(){
  function run(){
    const grid = document.getElementById('roster-grid');
    if (!grid || !grid.classList.contains('grid')) return;
    // find Total Hrs header col index
    const headers = grid.querySelectorAll('.header-cell');
    let th=null;
    headers.forEach(h=>{
      const t=(h.textContent||'').trim().toLowerCase();
      if (t==='total hrs' || t==='total hours') th=h;
    });
    if (!th) return;
    const col = parseInt(getComputedStyle(th).gridColumnStart,10);
    if (!col) return;
    const cells = grid.querySelectorAll('.employee-row');
    cells.forEach(c=>{
      const cs = parseInt(getComputedStyle(c).gridColumnStart,10);
      if (cs===col) c.classList.add('total-hours-cell');
    });
  }
  const grid = document.getElementById('roster-grid');
  if (grid) {
    run();
    const obs = new MutationObserver(run);
    obs.observe(grid, {childList:true, subtree:true});
  } else {
    document.addEventListener('DOMContentLoaded', run);
  }
})();
</script>


    <!-- Manage Units Modal -->
    <div id="manage-units-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-[61] flex items-start justify-center p-4">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 modal-fade-in mt-16">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Manage Units</h3>
          <button id="close-manage-units" class="text-gray-400 hover:text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div class="space-y-2">
          <ul id="units-ul" class="divide-y border rounded-lg bg-gray-50 max-h-60 overflow-y-auto"></ul>
          <div class="flex gap-2">
            <input id="new-unit-input" type="text" placeholder="Add unit (e.g., DIVISION SUPPORT)" class="flex-1 rounded-lg border-gray-300 shadow-sm px-3 py-2">
            <button id="add-unit-btn" class="px-3 py-2 bg-indigo-600 text-white rounded-lg">Add</button>
          </div>
        </div>
      </div>
    </div>

<script>
/* === Embedded by ChatGPT: tag Daily Attendance columns for print-fit === */
(function(){
  function tagDailyColumns(scope){
    try{
      (scope||document).querySelectorAll('#daily-list-content table').forEach(function(tbl){
        var map = ['col-sn','col-empid','col-rank','col-svc','col-name','col-unit','col-start','col-end','col-remark','col-act'];
        var head = tbl.querySelector('thead tr');
        if(head){ Array.from(head.children).forEach(function(th,i){ th.classList.add(map[i]||('col-'+i)); }); }
        Array.from(tbl.querySelectorAll('tbody tr')).forEach(function(tr){
          Array.from(tr.children).forEach(function(td,i){ td.classList.add(map[i]||('col-'+i)); });
        });
      });
    }catch(e){}
  }
  document.addEventListener('daily-list-rendered', function(){ tagDailyColumns(); });
  window.addEventListener('beforeprint', function(){ tagDailyColumns(); });
  setTimeout(function(){ tagDailyColumns(); }, 1200);
})();

</script>

<script>
(function () {
  function byId(id){return document.getElementById(id)}
  var monthlyBtn = byId('print-btn');
  if (monthlyBtn && !monthlyBtn.__patchedPrintV2) {
    monthlyBtn.__patchedPrintV2 = true;
    monthlyBtn.addEventListener('click', function (e) {
      document.body.classList.remove('printing-daily-list');
      // small defer to let layout settle
      setTimeout(function(){ window.print(); }, 0);
    }, true);
  }
  var dailyBtn = byId('daily-list-btn');
  if (dailyBtn && !dailyBtn.__patchedPrintV2) {
    dailyBtn.__patchedPrintV2 = true;
    dailyBtn.addEventListener('click', function (e) {
      document.body.classList.add('printing-daily-list');
      setTimeout(function(){ window.print(); }, 0);
    }, true);
  }
})();
</script>


<!-- Star Highlight v3: robust text-node replacement across all roster UIs -->
<script>
(function(){
  function wrapTextNode(node){
    if (!node || !node.nodeValue) return;
    // Skip if already inside a highlighted span
    if (node.parentElement && node.parentElement.closest('.shift-star')) return;
    if (node.nodeValue.indexOf('*') === -1) return;
    const span = document.createElement('span');
    // Only replace the literal star; keep surrounding text exactly as-is
    span.innerHTML = node.nodeValue.replace(/\*/g, '<span class="shift-star">*</span>');
    node.parentNode.replaceChild(span, node);
  }

  function walkAndWrap(root){
    if (!root) return;
    try {
      const tw = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      const targets = [];
      let n;
      while ((n = tw.nextNode())) {
        if (n.nodeValue && n.nodeValue.indexOf('*') !== -1) targets.push(n);
      }
      targets.forEach(wrapTextNode);
    } catch(e){ /* no-op */ }
  }

  function runOnce(){
    // Main roster grid (monthly view)
    walkAndWrap(document.getElementById('roster-grid'));
    // Single-employee calendar modal (if present)
    walkAndWrap(document.getElementById('employee-calendar-modal'));
    walkAndWrap(document.getElementById('employee-calendar-grid'));
    // Shift selector modal (labels list / preview)
    walkAndWrap(document.getElementById('shift-modal'));
    // Fallback: any other late-rendered containers
    walkAndWrap(document.body);
  }

  function observe(container){
    if (!container) return;
    const mo = new MutationObserver((muts)=>{
      for (const m of muts){
        if (m.type === 'characterData'){
          wrapTextNode(m.target);
        }
        m.addedNodes && m.addedNodes.forEach(node=>{
          if (node.nodeType === 1) walkAndWrap(node);
          else if (node.nodeType === 3) wrapTextNode(node);
        });
      }
    });
    mo.observe(container, {subtree:true, childList:true, characterData:true});
  }

  // Run at DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>{
      runOnce();
      observe(document.getElementById('roster-grid'));
      observe(document.getElementById('employee-calendar-modal'));
      observe(document.getElementById('shift-modal'));
      observe(document.body); // safety
    });
  } else {
    runOnce();
    observe(document.getElementById('roster-grid'));
    observe(document.getElementById('employee-calendar-modal'));
    observe(document.getElementById('shift-modal'));
    observe(document.body);
  }
})();
</script>

</body>
</html>

