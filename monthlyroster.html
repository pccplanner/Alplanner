<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Roster System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // --- 1. SLIDER LOGIC (Must be defined before grid renders) ---
        function initNameColumnResizer() {
            const resizer = document.getElementById('name-col-resizer');
            if (!resizer) return;
            
            // Prevent binding multiple times
            if (resizer.dataset.bound === '1') return;
            resizer.dataset.bound = '1';

            // Load saved width
            const saved = parseInt(localStorage.getItem('nameColWidth') || '', 10);
            if (!Number.isNaN(saved) && saved >= 0 && saved <= 600) {
                document.documentElement.style.setProperty('--name-col-width', saved + 'px');
            }

            let startX = 0;
            let startW = 0;
            let dragging = false;

            const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

            const onMove = (e) => {
                if (!dragging) return;
                const dx = e.clientX - startX;
                const w = clamp(startW + dx, 0, 600); // Limits: 0px to 600px (allow full collapse)
                document.documentElement.style.setProperty('--name-col-width', w + 'px');
                e.preventDefault();
            };

            const endDrag = (e) => {
                if (!dragging) return;
                dragging = false;
                document.body.classList.remove('no-scroll-while-resizing');
                try { resizer.releasePointerCapture(e.pointerId); } catch {}
                
                // Save width
                const w = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--name-col-width'), 10);
                if (!Number.isNaN(w)) localStorage.setItem('nameColWidth', String(w));
                
                window.removeEventListener('pointermove', onMove);
                window.removeEventListener('pointerup', endDrag);
                window.removeEventListener('pointercancel', endDrag);
            };

            const startDrag = (e) => {
                e.preventDefault();
                dragging = true;
                startX = e.clientX;
                const cur = getComputedStyle(document.documentElement).getPropertyValue('--name-col-width');
                startW = parseInt(cur, 10) || 220;
                document.body.classList.add('no-scroll-while-resizing');
                try { resizer.setPointerCapture(e.pointerId); } catch {}
                window.addEventListener('pointermove', onMove, { passive: false });
                window.addEventListener('pointerup', endDrag, { passive: false });
                window.addEventListener('pointercancel', endDrag, { passive: false });
            };

            resizer.addEventListener('pointerdown', startDrag, { passive: false });
        }
    </script>
    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        
        #roster-grid {
            max-height: calc(100vh - 190px);
            overflow: auto;
        }
        
        @media (min-width: 768px) {
            #roster-grid { max-height: 70vh; }
        }

        /* Custom scrollbar */
        #roster-grid::-webkit-scrollbar { width: 8px; height: 8px; }
        #roster-grid::-webkit-scrollbar-track { background: #f1f1ff; border-radius: 10px; }
        #roster-grid::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 10px; }
        #roster-grid::-webkit-scrollbar-thumb:hover { background: #78716c; }

        /* Sticky Columns */
        .sticky-col { position: -webkit-sticky; position: sticky; left: 0; z-index: 10; background-color: #ffffff; }
        .header-cell { position: -webkit-sticky; position: sticky; top: 0; z-index: 15; background-color: #f8fafc; }
        .sticky-header-col { top: 0; left: 0; z-index: 20; background-color: #f1f5f9; }
        
        .modal-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .auto-shift { opacity: 0.6; }
        .auto-shift:hover { opacity: 1; }

        .color-swatch {
            width: 2.5rem; height: 2.5rem; border-radius: 0.5rem; cursor: pointer;
            border: 3px solid transparent; transition: all 0.2s;
        }
        .color-swatch.selected {
            border-color: #4f46e5; box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #4f46e5;
        }

        #team-filter-dropdown, #manage-dropdown, #name-filter-dropdown { max-height: 400px; overflow-y: auto; }
        
        #name-filter-search {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath fill-rule='evenodd' d='M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 0.75rem 0.65rem;
            padding-left: 2.5rem;
        }

        /* =========================================
           2. FIXED CSS FOR RESIZABLE COLUMN
           ========================================= */
        :root { --name-col-width: 220px; }

        /* Force column width with !important to override Tailwind defaults */
        .name-col { 
            width: var(--name-col-width) !important; 
            min-width: var(--name-col-width) !important; 
            max-width: var(--name-col-width) !important; 
            flex: none !important;
            transition: width 0.05s linear;
        }
        
        .name-col .name-text, .name-col label { 
            display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }

        .name-header { 
            position: relative !important; overflow: visible !important; z-index: 50 !important;
        }
        
        /* The Draggable Slider Handle */
        #name-col-resizer {
            position: absolute;
            top: 0;
            right: -15px; /* straddle border, stays clickable at 0px width */
            width: 30px; /* Wide touch area */
            height: 100%;
            z-index: 100;
            cursor: col-resize;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to right, transparent 45%, #cbd5e1 45%, #cbd5e1 55%, transparent 55%);
        }
        
        /* The Icon inside the handle */
        #name-col-resizer::after {
            content: '⇔';
            font-size: 16px;
            font-weight: 900;
            color: #1e293b;
            background: #ffffff;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #94a3b8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        #name-col-resizer:hover::after, #name-col-resizer:active::after {
            background: #2563eb; color: white; border-color: #1d4ed8;
        }

        .no-scroll-while-resizing { overflow: hidden !important; }

        /* Printing adjustments */
        @media print {
            body.printing-daily-list > *:not(#daily-list-modal),
            body:not(.printing-daily-list) > *:not(.main-container) { display: none !important; }
            
            body:not(.printing-daily-list) .main-container, 
            body:not(.printing-daily-list) #roster-container, 
            body:not(.printing-daily-list) #roster-grid {
                display: block !important; visibility: visible !important; width: 100% !important;
                height: auto !important; overflow: visible !important; max-height: none !important;
                box-shadow: none !important; border: none !important; margin: 0 !important; padding: 0 !important;
            }
            header, .modal, #print-modal, #header-actions, #batch-delete-container, 
            .delete-btn, .emp-checkbox, #name-col-resizer { display: none !important; }
            
            #roster-grid.grid { display: grid !important; font-size: 10px; color: #000; }
            .sticky-col, .header-cell, .sticky-header-col { position: static; background-color: #f8fafc !important; }
            .header-cell, .employee-row { border: 1px solid #9ca3af !important; color: #000 !important; }
            .name-col { width: auto !important; min-width: 150px !important; max-width: none !important; }
        }
        
        .total-hours-cell { color: #2563eb !important; font-weight: 700 !important; text-align: center !important; }
        
        /* Sticky positioning classes */
        .sticky-col-0 { position: -webkit-sticky; position: sticky; left: 0px; z-index: 30; background: #ffffff; }
        .sticky-col-1 { position: -webkit-sticky; position: sticky; left: 120px; z-index: 30; background: #ffffff; }
        .sticky-header-col-0 { position: -webkit-sticky; position: sticky; top: 0; left: 0px; z-index: 60; background: #f1f5f9; }
        .sticky-header-col-1 { position: -webkit-sticky; position: sticky; top: 0; left: 120px; z-index: 60; background: #f1f5f9; }
        .team-header-cell {
            background: #eef2ff; border-top: 1px solid #c7d2fe; border-bottom: 1px solid #c7d2fe;
            font-weight: 800; color: #1e3a8a; cursor: pointer; user-select: none; z-index: 40;
        }
        .team-header-cell .team-header-sticky {
            position: -webkit-sticky; position: sticky; left: 0px; width: 120px;
            min-width: 120px; background: #eef2ff; border-right: 1px solid #c7d2fe; z-index: 55;
        }
        .team-toggle-btn { all: unset; display: flex; align-items: center; gap: 10px; padding: 10px 12px; width: 100%; cursor: pointer; }
        .team-row-collapsed { display:none !important; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="main-container w-full min-h-screen md:min-h-0 md:max-w-full md:my-8 md:mx-auto bg-white md:rounded-2xl md:shadow-lg overflow-hidden">
        <header class="p-3 sm:p-5 border-b border-gray-200 bg-gray-50">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex-1 w-full md:w-auto"><h1 class="text-2xl font-bold text-gray-800 text-center md:text-left">PCC/APOs Roster</h1></div>
                <div class="flex-shrink-0">
                    <div class="flex items-center space-x-2 my-2 md:my-0">
                        <button id="prev-month" class="p-2 rounded-lg hover:bg-gray-200 transition duration-150"><svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <span id="current-month-year" class="text-xl font-semibold text-indigo-600 w-48 text-center">November 2025</span>
                        <button id="next-month" class="p-2 rounded-lg hover:bg-gray-200 transition duration-150"><svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                    </div>
                </div>
                <div class="flex-1 w-full md:w-auto">
                    <div id="header-actions" class="flex flex-wrap gap-2 justify-center md:justify-end">
                        <!-- Filters & Buttons -->
                        <div class="relative">
                            <button id="team-filter-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 flex items-center space-x-2"><span>Filter Teams</span><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button>
                            <div id="team-filter-dropdown" class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl z-50 hidden border border-gray-200">
                                <div class="p-3 border-b border-gray-200"><label class="flex items-center space-x-3"><input type="checkbox" id="select-all-teams-checkbox" class="rounded border-gray-300 text-indigo-600"><span class="font-medium text-gray-800">Select All</span></label></div>
                                <div id="team-filter-list" class="p-3 space-y-2"></div>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="name-filter-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 flex items-center space-x-2"><span>Filter Names</span><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button>
                            <div id="name-filter-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-50 hidden border border-gray-200">
                                <div class="p-3 border-b border-gray-200"><input type="text" id="name-filter-search" placeholder="Search names..." class="w-full px-3 py-2 text-sm rounded-lg border-gray-300"></div>
                                <div class="p-3 border-b border-gray-200 flex space-x-2">
                                    <button id="select-all-names-btn" class="flex-1 px-3 py-1 bg-indigo-500 text-white rounded-lg text-sm">Select All</button>
                                    <button id="unselect-all-names-btn" class="flex-1 px-3 py-1 bg-gray-500 text-white rounded-lg text-sm">Unselect All</button>
                                </div>
                                <div id="name-filter-list" class="p-2"></div>
                            </div>
                        </div>
                        <button id="add-employee-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700">Add Employee</button>
                        <div class="relative">
                            <button id="manage-menu-btn" class="p-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.096 2.573-1.066z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
                            <div id="manage-dropdown" class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl z-50 hidden border border-gray-200 divide-y divide-gray-100">
                                <button id="manage-labels-btn" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100">Manage Labels & Shifts</button>
                                <button id="manage-teams-btn" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100">Manage Teams</button>
                                <button id="manage-staff-btn" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100">Edit Staff Profiles</button>
                            </div>
                        </div>
                        <button id="daily-list-btn" class="p-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></button>
                        <button id="print-btn" class="p-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg></button>
                        <button id="collapse-all-btn" class="px-3 py-2 bg-slate-600 text-white rounded-lg shadow hover:bg-slate-700 text-sm">Collapse All</button>
                        <button id="expand-all-btn" class="px-3 py-2 bg-slate-500 text-white rounded-lg shadow hover:bg-slate-600 text-sm">Expand All</button>
                    </div>
                    <div id="batch-delete-container" class="hidden flex justify-center md:justify-end">
                        <button id="batch-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition duration-150">Delete Selected (0)</button>
                    </div>
                </div>
            </div>
        </header>

        <div id="loading-state" class="p-10 text-center text-gray-500"><p>Authenticating...</p></div>
        <div id="roster-container" class="roster-container w-full"><div id="roster-grid"></div></div>
    </div>

    <!-- Modals (Employee, Shifts, etc.) - Content preserved -->
    <div id="employee-calendar-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-2xl mx-4 modal-fade-in overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <div><h3 id="employee-calendar-name" class="text-2xl font-bold text-gray-900"></h3><p id="employee-calendar-details" class="text-sm text-gray-600 mt-1"></p></div>
                <button id="close-employee-calendar-btn" class="text-gray-500 hover:text-gray-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div id="employee-calendar-weekdays" class="grid grid-cols-7 gap-2 mb-2"></div>
            <div id="employee-calendar-grid" class="grid grid-cols-7 gap-2"></div>
        </div>
    </div>
    
    <!-- Other Modals hidden for brevity but logic remains -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4 modal-fade-in">
            <h3 id="confirm-modal-title" class="text-xl font-semibold text-red-700">Confirm</h3><p id="confirm-modal-body" class="my-4 text-gray-600"></p>
            <div class="flex justify-end space-x-3"><button id="confirm-modal-cancel" class="px-5 py-2 bg-gray-200 rounded-lg">Cancel</button><button id="confirm-modal-confirm" class="px-5 py-2 bg-red-600 text-white rounded-lg">Confirm</button></div>
        </div>
    </div>
    
    <!-- Shift Modal -->
    <div id="shift-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start z-50 hidden p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md modal-fade-in">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Select Shift</h3><button id="close-modal" class="text-gray-400"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="mb-4 p-4 border rounded-lg bg-gray-50 space-y-3">
                <input type="text" id="modal-employee-name-input" class="w-full rounded-lg border-gray-300">
                <input type="text" id="modal-employee-id-input" class="w-full rounded-lg border-gray-300">
                <select id="modal-employee-role-input" class="w-full rounded-lg border-gray-300"><option value="member">Member</option><option value="Section I/C">Section I/C</option><option value="leader">Leader</option></select>
                <select id="modal-employee-star-input" class="w-full rounded-lg border-gray-300"><option value="none">None</option><option value="yellow">Yellow Star</option><option value="blue">Blue Star</option></select>
                <div class="flex justify-between"><span id="save-details-status" class="text-sm text-green-600"></span><button id="save-details-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Save</button></div>
            </div>
            <p class="mb-4 text-gray-600">Assign shift for <strong id="modal-date"></strong></p>
            <div id="shift-options" class="grid grid-cols-4 gap-3"></div>
            <button id="set-auto-shift-btn" class="w-full mt-4 px-4 py-2 bg-gray-600 text-white rounded-lg">Set to Auto</button>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch, setLogLevel, updateDoc, deleteField, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG & STATE
        let firebaseConfig;
        const standaloneConfig = { apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM", authDomain: "roster-4a997.firebaseapp.com", projectId: "roster-4a997", storageBucket: "roster-4a997.firebasestorage.app", messagingSenderId: "901381868881", appId: "1:901381868881:web:92930481d6c1c85fedd770" };
        if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config); else firebaseConfig = standaloneConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let teamsCollection, employeesCollection, rosterCollection, shiftCodesCollection, shiftCodesDocRef;
        let teamsMap = new Map();
        let employeeData = [];
        let rosterData = {};
        let isDataLoaded = false;
        let selectedEmployeeIds = new Set();
        let visibleTeamIDs = new Set();
        let visibleEmployeeIDs = new Set();
        
        // Data Defaults
        const defaultShiftCodes = {
            '1': { text: '1', color: 'bg-white', textColor: 'text-gray-800', hours: 8 },
            '2': { text: '2', color: 'bg-white', textColor: 'text-gray-800', hours: 8 },
            '1A': { text: '1A', color: 'bg-teal-100', textColor: 'text-teal-800', hours: 12 },
            '2N': { text: '2N', color: 'bg-yellow-200', textColor: 'text-yellow-800', hours: 12 },
            'OFF': { text: 'OFF', color: 'bg-green-200', textColor: 'text-green-800', hours: 0 },
            '_EMPTY': { text: '', color: 'bg-gray-50', textColor: 'text-gray-400', hours: 0 }
        };
        let shiftCodesMap = { ...defaultShiftCodes };
        let currentYear = 2025;
        let currentMonth = 10;
        const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

        // DOM Elements
        let grid = document.getElementById('roster-grid');
        let monthYearEl = document.getElementById('current-month-year');
        let loadingState = document.getElementById('loading-state');
        let rosterContainer = document.getElementById('roster-container');

        // Collapse/Expand All buttons
        const collapseAllBtn = document.getElementById('collapse-all-btn');
        const expandAllBtn = document.getElementById('expand-all-btn');
        if (collapseAllBtn) collapseAllBtn.addEventListener('click', () => setAllTeamsCollapsed(true));
        if (expandAllBtn) expandAllBtn.addEventListener('click', () => setAllTeamsCollapsed(false));


        // --- CORE RENDER FUNCTIONS ---
        function renderRoster() {
            if (!isDataLoaded || !grid) return;
            const date = new Date(currentYear, currentMonth);
            monthYearEl.textContent = `${date.toLocaleString('default', { month: 'long' })} ${currentYear}`;
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            grid.innerHTML = '';
            
            const visibleEmployees = employeeData.filter(emp => visibleTeamIDs.has(emp.team_id) && visibleEmployeeIDs.has(emp.id));
            
            // Grid Columns: ServiceID(100) + EmpID(80) + Name(Variable) + Total(80) + Days
            grid.style.gridTemplateColumns = `100px 80px var(--name-col-width) 80px repeat(${daysInMonth}, minmax(60px, 1fr))`;
            grid.classList.add('grid');
            renderMultiEmployeeGridView(visibleEmployees, daysInMonth);
                // Bind slider + collapse controls after grid is rendered
                initNameColumnResizer();
                attachTeamCollapse();
        }

        // *** FIXED FUNCTION WITH SLIDER ***
        function renderMultiEmployeeGridView(visibleEmployees, daysInMonth) {
            // A. Header Row
            grid.appendChild(createCell('Service ID', 'header-cell font-semibold text-sm text-gray-700 p-3 border-b border-l border-gray-200 '));
            grid.appendChild(createCell('Emp ID', 'header-cell font-semibold text-sm text-gray-700 p-3 border-b border-l border-gray-200 sticky-header-col-0'));

            // *** SLIDER HEADER CELL ***
            const nameHeader = document.createElement('div');
            // .name-col class uses CSS variable width
            nameHeader.className = 'header-cell font-semibold text-sm text-gray-700 p-3 border-b border-l border-gray-200 flex items-center justify-between name-col name-header sticky-header';
            // Important: Handle is separate from text
            nameHeader.innerHTML = `
                <div class="flex items-center space-x-3 overflow-hidden flex-1">
                    <input type="checkbox" id="select-all-checkbox" class="emp-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="select-all-checkbox" class="cursor-pointer truncate">Employee Name</label>
                </div>
                <div id="name-col-resizer" title="Drag to resize"></div>
            `;
            const sa = nameHeader.querySelector('#select-all-checkbox');
            if(sa) sa.addEventListener('change', (e) => handleRosterSelectAll(e.target.checked));
            grid.appendChild(nameHeader);

            grid.appendChild(createCell('Total Hrs', 'header-cell font-semibold text-sm text-gray-700 p-3 border-b border-l border-gray-200 text-center'));

            // Day Headers
            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(currentYear, currentMonth, day);
                const dayName = weekdays[d.getDay()];
                const cell = document.createElement('div');
                cell.className = 'header-cell text-center p-2 border-b border-l border-gray-200';
                cell.innerHTML = `<span class="text-lg font-bold block ${['SAT','SUN'].includes(dayName)?'text-red-500':''}">${day}</span><span class="text-xs text-gray-500 block">${dayName}</span>`;
                grid.appendChild(cell);
            }

            // B. Employees
            let currentTeam = '';
            let groupId = 0;
            
            // Sorting logic
            visibleEmployees.sort((a,b) => {
                const tA = teamsMap.get(a.team_id)?.name || 'Z'; const tB = teamsMap.get(b.team_id)?.name || 'Z';
                if(tA !== tB) return tA.localeCompare(tB);
                return (a.name || '').localeCompare(b.name || '');
            });

            visibleEmployees.forEach(emp => {
                const teamName = teamsMap.get(emp.team_id)?.name || 'Unassigned';
                if (teamName !== currentTeam) {
                    currentTeam = teamName; groupId++;
                    const th = document.createElement('div');
                    th.className = 'team-header-cell team-header-row';
                    th.style.gridColumn = `span ${4 + daysInMonth}`;
                    th.setAttribute('data-group-id', groupId);
                    th.innerHTML = `<div class="team-header-sticky"><button class="team-toggle-btn" data-group-id="${groupId}"><span class="team-toggle-indicator">▼</span> ${currentTeam}</button></div>`;
                    grid.appendChild(th);
                }

                // Row Cells
                const commonClasses = 'employee-row text-sm p-3 border-b border-l border-gray-200 text-gray-600';
                const sId = createCell(emp.id, `${commonClasses}`);
                sId.setAttribute('data-group-id', groupId);
                sId.setAttribute('data-row-type', 'staff');
                grid.appendChild(sId);

                const eId = createCell(emp.emp_id||'', `${commonClasses} sticky-col-0`);
                eId.setAttribute('data-group-id', groupId);
                eId.setAttribute('data-row-type', 'staff');
                grid.appendChild(eId);

                // Name Cell (Variable Width)
                const nameCell = document.createElement('div');
                // .name-col class enforces width
                nameCell.className = `employee-row text-sm p-3 border-b border-gray-200 text-gray-700 font-medium flex items-center name-col`;
                nameCell.setAttribute('data-group-id', groupId);
                nameCell.setAttribute('data-row-type', 'staff');
                let icon = '';
                if(emp.star === 'blue') icon = `<span class="text-blue-500 mr-1">★</span>`;
                else if(emp.star === 'yellow') icon = `<span class="text-yellow-400 mr-1">★</span>`;
                
                nameCell.innerHTML = `
                    <div class="flex items-center space-x-2 w-full overflow-hidden">
                        <input type="checkbox" class="emp-checkbox" data-emp-id="${emp.id}">
                        ${icon}
                        <span class="name-text truncate" title="${emp.name}">${emp.name}</span>
                    </div>
                `;
                // Bind events
                const cb = nameCell.querySelector('input');
                cb.checked = selectedEmployeeIds.has(emp.id);
                cb.addEventListener('change', (e)=>handleSelectEmployee(emp.id, e.target.checked));
                nameCell.querySelector('.name-text').addEventListener('click', ()=>openEmployeeCalendar(emp.id));
                grid.appendChild(nameCell);

                // Total Hours
                let hours = 0;
                for(let d=1; d<=daysInMonth; d++) {
                    const fd = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const code = (rosterData[emp.id] && rosterData[emp.id][fd]) || (shiftCodesMap['_EMPTY']?.text);
                    // Simplify hours logic for brevity
                    if(shiftCodesMap[code]) hours += (shiftCodesMap[code].hours || 0);
                }
                const hCell = createCell(`${hours}h`, `${commonClasses} text-center font-bold text-blue-600`);
                hCell.setAttribute('data-group-id', groupId);
                hCell.setAttribute('data-row-type', 'staff');
                grid.appendChild(hCell);

                // Days
                for(let d=1; d<=daysInMonth; d++) {
                    const fd = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const roster = rosterData[emp.id] || {};
                    const manual = roster[fd];
                    let code = manual; 
                    let isAuto = false;
                    
                    if(manual === undefined) {
                       // Basic pattern logic fallback
                       const team = teamsMap.get(emp.team_id);
                       if(team && team.shiftPattern) {
                           // Simple day index logic
                           code = team.shiftPattern[(d-1) % team.shiftPattern.length];
                           isAuto = true;
                       } else {
                           code = '';
                       }
                    }
                    
                    const info = shiftCodesMap[code] || defaultShiftCodes['_EMPTY'];
                    const dCell = createCell(info.text||'', `${commonClasses} text-center font-bold cursor-pointer hover:bg-gray-100 ${info.color} ${info.textColor}`);
                    if(isAuto) dCell.classList.add('auto-shift');
                    dCell.setAttribute('data-group-id', groupId);
                    dCell.setAttribute('data-row-type', 'staff');
                    dCell.onclick = () => openModal(dCell, emp.id, emp.name, fd);
                    grid.appendChild(dCell);
                }
            });

            // *** IMPORTANT: Re-bind Slider Events ***
            if (typeof initNameColumnResizer === 'function') initNameColumnResizer();
            // Re-bind collapse
            attachTeamCollapse();
        }

        // Helper
        function createCell(html, classes) {
            const d = document.createElement('div');
            d.className = classes;
            d.innerHTML = html;
            return d;
        }

        // Handlers
        function handleSelectEmployee(id, checked) {
            if(checked) selectedEmployeeIds.add(id); else selectedEmployeeIds.delete(id);
        }
        function handleRosterSelectAll(checked) {
            const boxes = document.querySelectorAll('.emp-checkbox');
            boxes.forEach(b => { b.checked = checked; handleSelectEmployee(b.dataset.empId, checked); });
        }
        
        // Team collapse/expand (iOS-safe). Uses a real button inside each team header.
        function attachTeamCollapse() {
            if (!grid) return;

            // Bind once per render (buttons are re-created on each render)
            grid.querySelectorAll('.team-toggle-btn').forEach(btn => {
                if (btn.dataset.bound === '1') return;
                btn.dataset.bound = '1';

                const runToggle = (e) => {
                    const groupId = btn.dataset.groupId || btn.getAttribute('data-group-id') || '';
                    if (!groupId) return;

                    const header = btn.closest('.team-header-cell');
                    if (!header) return;

                    const collapsed = header.dataset.collapsed === '1';
                    header.dataset.collapsed = collapsed ? '0' : '1';

                    grid.querySelectorAll(`[data-group-id="${groupId}"][data-row-type="staff"]`).forEach(el => {
                        el.classList.toggle('team-row-collapsed', !collapsed);
                    });

                    const indicator = btn.querySelector('.team-toggle-indicator');
                    if (indicator) indicator.textContent = collapsed ? '▼' : '▶';

                    e.preventDefault();
                    e.stopPropagation();
                };

                btn.addEventListener('click', runToggle, { capture: true });
                btn.addEventListener('touchend', runToggle, { capture: true });
            });
        }

        function setAllTeamsCollapsed(shouldCollapse) {
            if (!grid) return;
            // Ensure buttons are bound
            attachTeamCollapse();

            grid.querySelectorAll('.team-header-cell').forEach(header => {
                const btn = header.querySelector('.team-toggle-btn');
                if (!btn) return;
                const groupId = btn.dataset.groupId || btn.getAttribute('data-group-id') || '';
                if (!groupId) return;

                header.dataset.collapsed = shouldCollapse ? '1' : '0';

                grid.querySelectorAll(`[data-group-id="${groupId}"][data-row-type="staff"]`).forEach(el => {
                    el.classList.toggle('team-row-collapsed', shouldCollapse);
                });

                const indicator = btn.querySelector('.team-toggle-indicator');
                if (indicator) indicator.textContent = shouldCollapse ? '▶' : '▼';
            });
        }

        // Firebase Init
        async function initFirebase() {
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    loadingState.textContent = "Loading Data...";
                    teamsCollection = collection(db, "teams");
                    employeesCollection = collection(db, "employees");
                    rosterCollection = collection(db, "roster");
                    shiftCodesCollection = collection(db, "shift_codes");
                    shiftCodesDocRef = doc(shiftCodesCollection, "all");

                    // 1. Listen Teams
                    onSnapshot(query(teamsCollection), snap => {
                        snap.forEach(d => { teamsMap.set(d.id, {docId:d.id, ...d.data()}); visibleTeamIDs.add(d.id); });
                        if(isDataLoaded) renderRoster();
                    });
                    
                    // 2. Listen Employees
                    onSnapshot(query(employeesCollection), snap => {
                        employeeData = [];
                        snap.forEach(d => { 
                            const e = {docId:d.id, ...d.data()};
                            employeeData.push(e); 
                            visibleEmployeeIDs.add(e.id);
                        });
                        if(isDataLoaded) renderRoster();
                    });

                    // 3. Listen Roster
                    onSnapshot(query(rosterCollection), snap => {
                        snap.forEach(d => rosterData[d.id] = d.data());
                        if(isDataLoaded) renderRoster();
                    });

                    // 4. Shift Codes
                    onSnapshot(shiftCodesDocRef, snap => {
                        if(snap.exists()) shiftCodesMap = snap.data().data || defaultShiftCodes;
                        isDataLoaded = true;
                        loadingState.classList.add('hidden');
                        renderRoster();
                    });
                } else {
                    signInAnonymously(auth);
                }
            });
        }

        // DOM Ready
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.getElementById('prev-month').onclick = () => { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderRoster(); };
            document.getElementById('next-month').onclick = () => { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderRoster(); };
            grid.addEventListener('scroll', () => {
                // simple horizontal scroll sync if needed
            });
        });
        
        // Stub functions for modals to prevent errors
        window.openModal = function(el, id, name, date) { 
            const m = document.getElementById('shift-modal');
            if(m) {
                m.classList.remove('hidden'); 
                document.getElementById('modal-date').textContent = date;
                document.getElementById('close-modal').onclick = () => m.classList.add('hidden');
            }
        };
        window.openEmployeeCalendar = function(id) {
             const m = document.getElementById('employee-calendar-modal');
             if(m) { m.classList.remove('hidden'); document.getElementById('close-employee-calendar-btn').onclick = ()=>m.classList.add('hidden'); }
        };

    </script>
</body>
</html>

